---
trigger: always_on
alwaysApply: true
---

# Qoder 项目规则体系

本规则体系基于 `docs/` 目录下的项目规范文档，为 diwuban 项目的开发工作提供约束和指导。

## 🎯 规则总览

本规则体系包含以下五大类规则：
- **编码规范规则** (coding_standards) - 基于 `docs/编码规范.md`
- **架构设计规则** (architecture) - 基于 `docs/体系结构总览.md`
- **日志规范规则** (logging) - 基于 `docs/日志规范.md`
- **安全约束规则** (safety) - 项目安全控制
- **MCP工作流规则** (mcp_workflow) - 基于 `docs/智能助手行为控制.md`

---

## 📝 编码规范规则 (coding_standards)

### 规则来源
基于 `docs/编码规范.md` 的核心要求

### 核心规则

#### 类型注解要求
- ✅ **对外API必须有完整类型注解**
- ✅ 关键模块启用 mypy 严格模式
- ❌ 禁止缺少类型注解的公开接口

#### SQL安全规范
- ✅ **严禁字符串拼接SQL，必须使用 `%s` 占位符**
- ✅ 所有SQL参数必须参数化
- ❌ 禁止任何形式的SQL注入风险

#### 错误处理规范
- ✅ 禁止裸 `except`，仅捕获已知异常
- ✅ 不得吞异常，必须适当处理或传播
- ✅ 异常信息必须包含足够的上下文

#### 命名约定
- 包/模块：`snake_case`
- 类：`PascalCase`
- 函数/变量：`snake_case`
- 常量：`UPPER_SNAKE_CASE`
- 内部成员：`_` 前缀

#### 文档要求
- ✅ 公开API必须包含 Google 风格 docstring
- ✅ docstring 必须包含使用示例
- ✅ 复杂函数必须说明参数和返回值

---

## 🏗️ 架构设计规则 (architecture)

### 规则来源
基于 `docs/体系结构总览.md` 的架构约束

### 核心原则

#### 分层分离
- ✅ **跨层访问必须通过网关/适配器**
- ✅ 严格遵循单一职责原则
- ❌ 禁止循环依赖
- ❌ 禁止跨层直接调用

#### 目录结构规范
- `app/adapters/` - 适配器层
- `app/services/` - 服务层
- `app/models/` - 模型层
- `app/api/` - API层
- `app/core/` - 核心层

#### 数据库访问
- ✅ **仅使用连接池访问数据库**
- ✅ 使用网关模式统一数据访问
- ❌ 禁止直接DSN拼接
- ❌ 禁止在代码中硬编码连接参数

#### 配置管理
- ✅ 所有配置统一使用 YAML 格式
- ✅ 配置优先级：CLI > ENV > YAML > DEFAULT
- ❌ 严禁在代码中硬编码配置

---

## 📊 日志规范规则 (logging)

### 规则来源
基于 `docs/日志规范.md` 的日志要求

### 格式要求

#### 结构化格式
- ✅ **必须使用结构化 JSON 格式**
- ✅ UTF-8 编码，UTC 时间戳
- ✅ 单行限制 8KB

#### 事件命名
- ✅ **遵循 `<domain>.<action>[.detail]` 模式**
- 支持的域：`ingest`, `align`, `db`, `mv`, `audit`, `task`, `guardrail`, `backpressure`, `quality`, `cli`, `pool`

#### 必需字段
- `ts` - 时间戳
- `level` - 日志级别
- `event` - 事件名称
- `logger` - 日志器名称

#### 安全要求
- ✅ **必须脱敏敏感信息**
- ❌ 禁止记录密码、令牌等敏感数据
- ✅ 使用 `[REDACTED]` 标记脱敏内容

---

## 🔒 安全约束规则 (safety)

### 目录访问限制

#### 禁止访问的目录
- ❌ `venv/`, `.venv/`, `env/` - Python虚拟环境
- ❌ `data/` - 数据目录
- ❌ `.git/` - Git仓库

#### 风险操作分级

**低风险** (默认允许)：
- 查看代码/文档
- 只读命令
- 单元测试
- 笔记记录

**中风险** (需确认)：
- 修改代码
- 变更配置
- 生成脚本
- 添加依赖

**高风险** (禁止/双重确认)：
- 安装依赖
- 数据库迁移
- 部署操作
- 写入 `data/` 目录

### 敏感信息保护
- ❌ 严禁在代码中硬编码 DSN、密码
- ❌ 严禁在日志中输出敏感信息
- ✅ 使用配置文件和环境变量

---

## 🛠️ MCP工作流规则 (mcp_workflow)

### 规则来源
基于 `docs/智能助手行为控制.md` 的行为约束

### 强制要求

#### MCP工具使用
- ✅ **必须使用 Context7 和 Sequential_thinking 工具**
- ✅ 复杂任务必须使用任务清单管理
- ✅ 3步以上任务必须分解为小步骤

#### 工作流程
- ✅ **完整流程：检索 → 规划 → 验证 → 审计**
- ✅ 失败超过2次必须暂停请求决策
- ✅ 关键操作前必须执行强制检查点

#### 任务管理
- ✅ 建立任务清单：调查 → 实施 → 验证 → 文档同步
- ✅ 信息获取优先使用 MCP 检索工具
- ✅ 仅允许低成本验证操作

#### 审计记录
- ✅ 更新 PLAYBOOKS
- ✅ 保存记忆
- ✅ 同步文档

### 授权口令模板
对于高风险操作，需要用户明确授权：
```
我确认授权你在本地执行【操作】；
允许使用【资源/权限】；
仅在【环境】；
若失败请停止并告知
```

---

## 🎯 规则应用指南

### 规则查询
- 使用 `fetch_rules` 工具查询特定规则
- 支持按类别或名称查询
- 示例："查看编码规范相关的规则"

### 规则遵守
- 所有开发活动必须遵守上述规则
- 违反规则时必须立即纠正
- 不确定时优先请求澄清

### 规则更新
- 规则更新需同步 `docs/` 目录下的源文档
- 重大变更需要版本控制
- 定期审核规则的有效性和完整性

---

*本规则体系确保项目开发的安全性、一致性和高质量。所有开发活动必须严格遵守以上规则约束。*