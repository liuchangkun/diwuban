# 泵站时间对齐实现

> 状态板（2025-08-18）：标准 schema（config/data_mapping.v2.json）已生效；run-all 合并链路将在修复 prepare-dim 的 dim_metric_config 返回列后继续验证时间对齐。重启后参考：docs/PLAYBOOKS/SESSION_SNAPSHOT_2025-08-18.md。

> 以数据库与 scripts/sql 为唯一事实源；写入统一 UTC，并在数据库侧对齐到整秒（ts_bucket = date_trunc('second', ts_utc)）。

## 1. UTC 秒级对齐规则详解

- 统一规则：ts_bucket = date_trunc('second', ts_utc)
- 主键归一：(station_id, device_id, metric_id, ts_bucket)
- 冲突合并：ON CONFLICT (station_id, device_id, metric_id, ts_bucket) DO UPDATE
- 时区优先级：入参 tz > 泵站 dim_stations.tz > 默认 UTC
- CHECK 兜底：CHECK(date_trunc('second', ts_bucket) = ts_bucket)

## 2. safe_upsert_measurement 函数实现原理（参考实现 SQL）

```sql
-- 假设：传入的是 UTC 时间戳（timestamptz）
CREATE OR REPLACE FUNCTION public.safe_upsert_measurement(
  p_station_id bigint,
  p_device_id  bigint,
  p_metric_id  bigint,
  p_ts_utc     timestamptz,
  p_value      numeric,
  p_source_hint text DEFAULT NULL
) RETURNS boolean
LANGUAGE plpgsql
AS $$
DECLARE
  v_ts_bucket timestamptz;
BEGIN
  v_ts_bucket := date_trunc('second', p_ts_utc);
  INSERT INTO public.fact_measurements(
    station_id, device_id, metric_id, ts_raw, ts_bucket, value, source_hint, inserted_at
  ) VALUES (
    p_station_id, p_device_id, p_metric_id, p_ts_utc, v_ts_bucket, p_value, p_source_hint, now()
  )
  ON CONFLICT (station_id, device_id, metric_id, ts_bucket)
  DO UPDATE SET value = EXCLUDED.value,
                source_hint = COALESCE(EXCLUDED.source_hint, fact_measurements.source_hint),
                inserted_at = now();
  RETURN true;
EXCEPTION WHEN OTHERS THEN
  RETURN false;
END;
$$;
```

## 3. safe_upsert_measurement_local 函数实现原理（含时区转换）

```sql
-- 传入本地时间（无时区），根据 dim_stations.tz 转换为 UTC 并对齐到秒
CREATE OR REPLACE FUNCTION public.safe_upsert_measurement_local(
  p_station_id bigint,
  p_device_id  bigint,
  p_metric_id  bigint,
  p_ts_local   timestamp,
  p_value      numeric,
  p_source_hint text DEFAULT NULL
) RETURNS boolean
LANGUAGE plpgsql
AS $$
DECLARE
  v_tz text;
  v_ts_utc timestamptz;
BEGIN
  -- 兼容两种方式：优先 extra->>'tz'，否则默认 'UTC'
  SELECT COALESCE(s.extra->>'tz', 'UTC') INTO v_tz
  FROM public.dim_stations s WHERE s.id = p_station_id;

  v_ts_utc := (p_ts_local AT TIME ZONE v_tz);
  RETURN public.safe_upsert_measurement(
    p_station_id, p_device_id, p_metric_id, v_ts_utc, p_value, p_source_hint
  );
EXCEPTION WHEN OTHERS THEN
  RETURN false;
END;
$$;
```

## 4. 站点时区来源机制

- 推荐：将站点时区配置为 dim_stations.extra->>'tz'（如 'Asia/Shanghai'）
- 若未配置，默认使用 'UTC'，并建议在质量报告中标注
- 维护建议：在站点初始化与变更时同步更新 extra.tz 字段（或未来新增 dim_stations.tz 显式列）

## 5. CSV → staging → 校验 → UPSERT 的数据流（Mermaid）

```mermaid
flowchart TD
  A[CSV 文件] --> B[staging.measurements_raw]
  B --> C[规则校验/错误落表]
  C -- 合法 --> D[safe_upsert_measurement(_local)]
  D --> E[public.fact_measurements (UTC 秒级对齐)]
  E --> F[REFRESH MV hourly/daily]
  C -- 错误 --> G[staging.measurements_err]
```

## 6. 可执行 SQL 示例与伪代码

- 示例：

```sql
-- A) UTC 写入
SELECT public.safe_upsert_measurement(1, 10, 101, '2025-08-16T12:00:00Z', 12.34, 'manual');

-- B) 本地时间写入（站点时区自动转换）
SELECT public.safe_upsert_measurement_local(1, 10, 101, '2025-08-16 20:00:00', 12.34, 'manual');
```

- 伪代码：

```
fn ingest(record):
  if record.ts has tz:
    ts_utc = to_utc(record.ts)
  else:
    tz = get_station_tz(record.station_id) or 'UTC'
    ts_utc = local_to_utc(record.ts, tz)
  ts_bucket = trunc_second(ts_utc)
  upsert(station, device, metric, ts_utc, ts_bucket, value)
```

## 7. 验证方法与自检 SQL

- 整秒对齐：

```sql
SELECT count(*) FROM public.fact_measurements
WHERE date_trunc('second', ts_bucket) <> ts_bucket;
```

- 同秒冲突合并（示例）：

```sql
-- 连续向同一秒写入两条不同值，最终应只有一条（值为最近一次）
SELECT public.safe_upsert_measurement(1,10,101, '2025-08-16T12:00:00.120Z', 1.23, 't1');
SELECT public.safe_upsert_measurement(1,10,101, '2025-08-16T12:00:00.850Z', 4.56, 't2');
SELECT count(*) FROM public.fact_measurements
WHERE station_id=1 AND device_id=10 AND metric_id=101 AND ts_bucket='2025-08-16T12:00:00Z';
```

- MV 命中率观测：monitoring.v_mv_hit_audit
