# 文档地图与导航

> 本文为中文文档总入口。所有技术事实以数据库与 scripts/sql 为准；旧英文文档已归档至 docs/\_archive/2025-08-16/。

> 状态说明（预对齐）
> - 运行产物：logs/runs/YYYYMMDD/<job_id>/ 下 app.ndjson/sql.ndjson/perf.ndjson/summary.json 已落地
> - 报表产物：reports/data_quality_report.<run_id>.json 将随 S1 Quick Wins 落地
> - 日志模式：json/by_run 稳定；text/by_module 提供最小可用路由，字段模板将在里程碑2补齐

## 环境与访问信息

- 项目目录：D:/Augment/diwuban
- 虚拟环境目录：D:/Augment/diwuban/.venv
- 数据库免密登录：已配置（开发环境）；通过本机 pg_hba/.pgpass 配置实现，访问详见 docs/表结构与数据库.md
- 环境限制：开发环境禁止修改任何表（结构/数据），仅允许变更函数/视图/触发器；写表操作须切换到专用测试库/DSN 执行；E2E 验证强制使用 config/data_mapping.v2.json

## 程序现状快照（2025-08-18）

- CLI：中文帮助；方案B日志开关（--log-run/--log-dir）

- check-mapping：--out 导出、--show-all 聚类；聚类统计按站/设/指标

- db-ping：--verbose 打印 host/db/user(脱敏)/时区/版本

- 映射：已生成标准 schema 文件 config/data_mapping.v2.json

- 运行：run-all 执行到 prepare-dim（已修 tz CAST、device.type；待修 metric_config RETURNING 列）

- 新默认：导入模式 auto（total_mb=50/per_file_mb=10/max_file_count=20 满足倾向 direct，否则 staging）；日志默认 json，可切 text；支持按模块文件输出；配置拆分 configs/{logging,ingest,database}.yaml（中文注释），启动打印参数与配置快照（不脱敏）

- 快速恢复：docs/PLAYBOOKS/SESSION_SNAPSHOT_2025-08-18.md

- 示例：env.json.sources（里程碑1）

  - 见 README.md “附：env.json.sources 示例”
  - 运行：`python -m app.cli.main run-all ... --log-run --log-dir logs/runs/demo --log-format text --log-routing by_module`

- 日志模式切换与按模块路由（里程碑2 最小实现）

  - 参考：docs/日志规范.md、docs/日志运维.md
  - 运行示例：`python -m app.cli.main run-all ... --log-run --log-dir logs/runs/demo --log-format text --log-routing by_module`
  - 输出：logs/modules/\*.log（sql/perf/root 等），便于按模块排障

- 治理与约束

  - 智能助手行为控制.md（本仓库内 AI 助手的行为边界与执行策略）

- 验证日志/案例精选

  - 参考：docs/测试指南.md（E2E 示例命令与期望产物）
  - 参考：docs/日志规范.md（样例片段：MERGE 成功与合并窗口完成）

- 行为与个人规范

  - 智能助手行为控制.md（治理规范）

  - 严格模式-核对清单.md（执行清单）

  - 个人工作守则.md（个人层面执行与连通仓库规范）

  - 使用 MCP 工具（强制）：见 docs/智能助手行为控制.md“使用 MCP 工具”章节；PR 模板含 MCP 勾选；严格模式清单含 MCP 勾选

## 流程与模板同步（MCP 豁免说明，2025-08-20）

- PR 模板（【必选】MCP 默认工具确认）：.github/PULL_REQUEST_TEMPLATE.md（豁免说明需附替代验证证据与风险评估）

- 严格模式-核对清单：docs/严格模式-核对清单.md（新增“若豁免：已提供替代验证证据与风险评估，并在 PR 模板‘豁免说明’中记录”核对项）

- 智能助手行为控制：docs/智能助手行为控制.md（新增“效率提升与一致性”规则：必须使用 MCP 工具提升效率并保持审计闭环）

- PLAYBOOKS 索引：

  - 配置变更记录：docs/PLAYBOOKS/配置变更记录.md（CONF-20250820-004，CONF-20250820-005）
  - 决策记录：docs/PLAYBOOKS/决策记录.md（DEC-20250820-002）
  - 运行手册变更：docs/PLAYBOOKS/运行手册变更.md（2025-08-20 流程与模板同步）

- 知识图谱（方案A）

  - 更新：scripts/tools/kg_update.py
  - 查询：scripts/tools/kg_query.py（示例见 PLAYBOOKS/使用说明.md）
  - 数据：docs/PLAYBOOKS/知识图谱.json

## 运行与观察（里程碑2现状对齐）

- 进度与合并埋点验证：docs/测试指南.md（run_all 验证步骤、Select-String/jq 示例）
- 日志规范：docs/日志规范.md（事件字段表、采样参数配置、示例片段）
- 运行产物：logs/runs/\<日期>/\<时间-pid>/ 下的 app.ndjson/sql.ndjson/perf.ndjson/summary.json

## 最近变更（自动生成）

<!-- memory_index:BEGIN -->

- 2025-08-20 \[DEC-001\] 默认启用 Context 7 与 Sequential thinking（MCP 工具集）
- 2025-08-20 \[DEC-002\] 在行为约束新增“必须使用 MCP 工具以提升效率与一致性”的规则
- 2025-08-17 \[BENCH-001\] 阶段1 最小造数与秒级对齐验证（dev）
- 2025-08-17 \[IMP-009\] 本地质量门禁稳定全绿；pcv.ps1 UTF-8 无乱码；memory_index 幂等兼容 mdformat
- 2025-08-17 \[IMP-010\] 补齐 safe_upsert_measurement_local（按 extra->>'tz'）与最小造数脚本
- 2025-08-17 \[LES-002\] 避免 mdformat 与自定义脚本（memory_index）互相改写导致循环
- 2025-08-16 \[CONF-006\] 添加整秒对齐 CHECK 约束；停用 Windows 计划任务，启用 APScheduler
- 2025-08-16 \[CONF-007\] 新增中文文档与导航，归档英文旧文档到 docs/\_archive/2025-08-16/
- 2025-08-16 \[DEC-008\] 统一按 UTC 秒级对齐、移除 Windows 计划任务、保留 APScheduler、提供本地时间 UPSERT 接口
- 2025-08-16 \[DEC-009\] 文档体系中文化重构与归档迁移（采用方案A：归档旧英文 → 重建中文文档体系）

<!-- memory_index:END -->

记忆保存（PLAYBOOKS 自动化提醒）：

- 关键字触发："记录变更/更新 PLAYBOOKS/保存记忆/按照 PLAYBOOKS 流程完成/记忆和文档都更新了吗？/PLAYBOOKS"（同义词：记录决策/记录配置变更/记录改进/记录经验教训/记录性能基准）

- 三步：1) 更新 PLAYBOOKS；2) 保存记忆；3) 同步文档

- 使用指南：docs/PLAYBOOKS/USAGE.md（包含触发词、三步流程、条目模板）

- 索引：docs/PLAYBOOKS/INDEX.md（自动生成的全量索引）

- 项目技术选型 → docs/项目技术选型.md

- 体系结构总览 → 现状：docs/体系结构总览.md

- 架构落地计划（v1，仅保留 32/33/34/35/37） → 执行：docs/架构落地计划_v1.md

- 表结构与数据库（UTC 秒级对齐/分区/MV/索引） → 事实：docs/表结构与数据库.md

- 数据库函数参考（写入秒级对齐契约/查询函数） → 参考：docs/数据库函数参考.md

- 程序工作流程（高性能导入方案A：CSV→staging(UNLOGGED)→集合式合并→UTC周界窗口→背压自适应） → docs/程序工作流程.md

- 泵站时间对齐实现 → docs/泵站时间对齐实现.md

- 测试指南（APScheduler/集成测试/对齐回归） → 测试：docs/测试指南.md

- 数据质量与校验（骨架，后续补充缺失/清理/阈值/校验） → 质量：docs/数据质量与校验.md

- PLAYBOOKS（决策/配置/改进/经验） → 知识库：docs/PLAYBOOKS/

  - 表结构明细（附录） → docs/表结构明细_附录.md
  - 逐函数详解（附录） → docs/逐函数详解_附录.md

- 规范与运维（权威规范，已充实）：

  - 编码规范 → docs/编码规范.md
  - 日志规范 → docs/日志规范.md
  - 日志运维 → docs/日志运维.md

- 扩展文档（已建目录，逐步充实）：

  - 数据清理指南 → docs/数据清理指南.md
  - 缺失与补齐策略 → docs/缺失与补齐策略.md
  - 特性曲线拟合 → docs/特性曲线拟合.md
  - 曲线校验与评估 → docs/曲线校验与评估.md
  - 泵组优化 → docs/泵组优化.md
  - 应用接口说明 → docs/应用接口说明.md
  - 可视化 → docs/可视化.md
  - 机器学习与深度学习 → docs/机器学习与深度学习.md
