# 体系结构总览

> 状态板（2025-08-18）：CLI 方案B（--log-run/--log-dir）；check-mapping 支持 --out/--show-all 聚类；db-ping --verbose；标准 schema（config/data_mapping.v2.json）已生效；run-all 正在修复 prepare-dim 的 dim_metric_config 返回列。恢复步骤与详情：docs/PLAYBOOKS/SESSION_SNAPSHOT_2025-08-18.md。

> 状态板（2025-08-19）：配置外置（configs/{logging,ingest,database}.yaml）与启动快照（env.json，含 sources 来源标注 DEFAULT|YAML|ENV|CLI）已完成里程碑1最小实现；run-all 产出 env.json 与 summary.json；日志默认 json，可切 text，支持 routing=by_module；source_hint v2 与分段合并已上线。

> 状态板（2025-08-19）：里程碑2（最小实现）已完成，支持 logging.format=text 与 logging.routing=by_module；下一步进入“关键事件字段族补齐与文本模板细化”的深化阶段。

> 状态板（2025-08-20）：已放弃 dev-suite MCP（删除脚本/Docker/VSCode 配置，PLAYBOOKS 留痕）；PR 模板新增“【必选】MCP 默认工具确认”并与严格模式清单一致；文档与地图/规范已同步。

> 本文以数据库与 scripts/sql 为唯一事实源；如与其它文档冲突，以本文件与数据库脚本为准。

- 组件与分层：PostgreSQL 16 / public, reporting, monitoring, api
- 数据流：CSV → staging → 校验/UPSERT → fact_measurements（UTC 秒级对齐）→ MV（hourly/daily）
- 调度：APScheduler（应用内跨平台，不使用 Windows 计划任务）
- 观测：pg_stat_statements 快照、命中率审计（v_mv_hit_audit）、活跃分区与索引审计
- 回滚：禁用 APScheduler 作业；DROP MV/函数（按依赖顺序）

详见：docs/架构落地计划_v1.md（章节 32/33/34/35/37）
