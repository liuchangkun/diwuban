# 体系结构总览

> 来源代码路径：app/main.py、app/api/v1/router.py、app/adapters/db/*、app/core/config/*、app/cli/main.py
> 数据库验证日期：2025-08-26
> 最近校对日期：2025-08-26

- 组件与分层：PostgreSQL 16 / public, reporting, monitoring, api
- 数据流：CSV → staging → 校验/UPSERT → fact_measurements（UTC 秒级对齐）→ MV（hourly/daily）
- 调度：APScheduler（应用内跨平台，不使用 Windows 计划任务）
- 观测：pg_stat_statements 快照、命中率审计（v_mv_hit_audit）、活跃分区与索引审计
- 回滚：禁用 APScheduler 作业；DROP MV/函数（按依赖顺序）

详见：docs/架构落地计划_v1.md（章节 32/33/34/35/37）

## 架构组成（基于实际代码）

- 应用入口：app/main.py（lifespan 初始化：日志→配置→连接池；路由注册 app/api/v1/router.py；静态资源）
- 配置系统：app/core/config/loader.py、loader_new.py（Settings；configs/\*.yaml）
- API 分层：app/api/v1/endpoints/{data,monitoring,logs}.py
- 数据访问：app/adapters/db（init_database/cleanup_database/get_conn；pool 统计）
- 服务层：app/services（ingest 导入链路、merge 对齐与合并）
- CLI：app/cli/main.py（prepare-dim/create-staging/ingest-copy/merge-fact/run-all 等）

## 启动流程（文字版）

1. 读取 configs/\*.yaml → load_settings（web/server）
1. 初始化日志（setup_api_logging）
1. 初始化数据库连接池（init_database）
1. 注册路由（/api/v1/\*）与静态资源（/static）
1. 运行期间：健康检查、请求日志、连接池统计
1. 关闭时：cleanup_database

## 数据流（文字版）

## 根路径与静态资源（与实现对齐）

- GET /health：应用根健康检查（非 /api/v1 前缀），由 app/main.py 提供；用于最小存活探测
- GET /：若存在 app/static/index.html 则返回静态首页

> 注：版本化 API 仍以 /api/v1/\* 为主，根路径仅作探活与静态资源入口。

CSV → ingest.copy（staging_raw）→ merge.fact（UTC 对齐/去重）→ fact\_\* → 统计/视图

## 备注

- 若与其它文档冲突，以代码与 configs/\*.yaml 为准；定期校对“最近校对日期”。
