# 测试指南

> 调度与刷新：统一使用 APScheduler（不使用 Windows 计划任务）。

- 环境与准备
  - 数据库：PostgreSQL 16；TEST_DB_DSN 示例：postgresql://user:pass@localhost:5432/dbname
  - 数据准备：api.upsert_measurements_json 写入少量样本；测试后 delete_measurements_by_filter 清理
- 测试类型
  - 只读查询（reporting.\* 日/小时/多站）
  - 明细 CRUD（api.\*）
  - 刷新与调度：REFRESH MV + APScheduler 作业试运行
  - 观测与基线：pg_stat_statements 快照 + 命中率审计
- 基本流程
  1. 写入样本（JSON 批量）
  1. 刷新 MV（或等待 APScheduler）
  1. 查询验证（日/小时聚合 + 明细）
  1. 更新/删除验证
  1. 观测与命中率
- 对齐回归
  - tests/integration/test_time_alignment_and_conflict.py：整秒对齐 + 同秒 UPSERT 合并
  - 自检：ts_bucket 非整秒行数应为 0
