# 数据质量与校验

> 状态板（2025-08-18）：导入链路使用标准 schema（config/data_mapping.v2.json）；check-mapping 提供结构与路径聚类统计与导出；run-all 当前修复 prepare-dim 的 dim_metric_config 返回列；质量阈值与对齐契约不变。会话快照：docs/PLAYBOOKS/SESSION_SNAPSHOT_2025-08-18.md。

目的：为导入/入库/对齐后的数据提供质量保障与可审计报告框架；与数据库事实（UTC 秒级对齐、UPSERT、CHECK 约束）一致。

## 1. 入库质量闸（与数据库事实一致）

- UTC + 秒级对齐：ts_bucket = date_trunc('second', ts_utc)
- 主键合并：PRIMARY KEY (station_id, device_id, metric_id, ts_bucket) → UPSERT 合并
- CHECK 兜底：CHECK(date_trunc('second', ts_bucket) = ts_bucket)（父表与分区 NOT VALID，后续 VALIDATE）
- 入参语义：safe_upsert_measurement（UTC），safe_upsert_measurement_local（本地时间+站点 tz）

## 2. 缺失识别与补齐

- 统计策略：
  - 维度：站/设备/测点/时间窗（如 1h/1d）
  - 指标：缺失率%、最长连续缺失段、缺失分布（直方图）
- 阈值建议：
  - 总缺失率 > 30%：标注为“高缺失”，拟合/优化默认剔除
  - 连续缺失段 > 10×采样周期：标注“长缺失”
- 补齐策略（谨慎）：
  - 瞬时量：最近邻/线性插值（可选）；默认仅最近邻，不跨长缺失
  - 累计量：严禁插值（保持阶梯）
  - 标注补齐来源与方法（quality_labels）

## 3. 数据清理

- 非法值：非数/NaN/Inf → 置 NULL 并落表
- 越界值：超软阈（警告保留）、超硬阈（置 NULL）
- 去重：同主键（秒）多值 → 取最终规则（按 safe_upsert 合并）
- 时间异常：倒序/乱序记录 → 统一按 ts_bucket 升序归并

## 4. 校验与一致性

- 交叉校验：
  - 电功率：S≈√3·U·I，P≈S·PF；U/I/P/PF 一致性检查
  - 水力功率：P_h=ρgQH 与电功率（扣效率）对比
  - 积分一致性：ΔkWh/Δ累计流量 vs 瞬时功率/流量积分
- 单位与范围：dim_metric_config 提供单位/上下限；硬/软阈逻辑

## 5. 错误落表与审计

- 建议表：staging_err、quality_labels（字段：station/device/metric/time_range/reason/code/method）
- 质量报告：
  - 统计项：缺失率、离群率、阈值违规占比、交叉校验偏差
  - 样例：典型问题片段（时间范围与样本）
  - SQL 片段：用于复现实验

## 6. 验收阈值（示例）

- 缺失率 ≤ 30%
- 离群率 ≤ 5%
- 阈值违规占比 ≤ 2%

## 7. 测试与回归

- 对齐回归：tests/integration/test_time_alignment_and_conflict.py（整秒对齐+同秒 UPSERT 合并）
- 质量回归：构造小样本 CSV，验证“缺失/清理/阈值/交叉校验”路径
- 自检 SQL：`SELECT count(*) FROM public.fact_measurements WHERE date_trunc('second', ts_bucket) <> ts_bucket;`
