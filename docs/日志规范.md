# 日志规范（项目版）

本规范定义应用层日志的结构、字段与行为，作为“唯一的日志规范”。运维落地与目录结构见《日志运维.md》。

## 1. 目标与原则

- 结构化：NDJSON（每行一个 JSON），UTF-8，UTC 时间
- 可观测：可关联（trace_id/job_id/batch_id）、可统计（rows、耗时）、可审计（字段齐备）
- 低开销：采样/限流、队列异步、摘要化 SQL
- 安全合规：脱敏、长度截断、最小可见

## 2. 事件命名与域

- 格式：`<domain>.<action>[.detail]`
- 域：ingest/align/db/mv/audit/task/guardrail/backpressure/quality/cli

## 3. 字段规范（核心字典）

- 通用：ts/level/event/logger/module/func/line/file/pid/thread
- 追踪：trace_id/job_id/batch_id
- 业务：station_id/\_name、device_id/\_name、metric_id/\_key
- 文件：file_path/file_name/file_hash/file_offset/bytes_read
- 数据量：rows_total/rows_read/rows_loaded/rows_deduped/rows_merged/rows_failed
- 窗口：window_start/window_end
- 数据库：sql_op/sql_cost_ms/affected_rows/target_table
- 重试：attempt/max_attempts/backoff_ms
- 异常：exc_type/exc_message/stack

## 4. 配置与初始化（configs/logging.yaml 模板）

```yaml
level: INFO
format: json             # json|text
console: true
file:
  enabled: true
  path: logs/app.log
  rotate: daily          # daily|size
  max_bytes: 10485760    # size 模式有效
  backup_count: 10
  retention_days: 14
sampling:
  debug_sample_rate: 0.0
  loop_log_every_n: 1000
context:
  include_fields: [trace_id, job_id, batch_id, station_id, device_id, file_path]
  include_sql_cost: true
  include_stack: true
redaction:
  enable: true
  patterns:
    - '(?i)(password|passwd|pwd|secret|token)=[^&\s]+'
  replacement: '***'
performance:
  queue_handler: true
  flush_on_exit: true
```

## 5. 上下文注入与异步日志

- contextvars + LoggerAdapter 注入 trace_id/job_id
- QueueHandler/QueueListener 异步写盘（退出前 stop()）

## 6. 采样、限流与长度

- debug_sample_rate（仅 DEBUG 生效）
- loop_log_every_n：高频循环进度日志节流
- 单行最大 8KB（超限截断并加 `truncated=true`）

## 7. 错误、重试与背压

- 错误字段：exc_type/exc_message/stack/hint
- 可重试（连接/超时/deadlock/40001）：指数退避+抖动，记录 attempt/backoff_ms
- 背压：当 p95/失败率/锁等待超阈，输出 backpressure.enter/exit 与 guardrail.stop

## 8. 关键节点（最少集）

- ingest.load.begin/progress/end
- align.merge.window/conflict
- mv.refresh.begin/end
- audit.mv
- task.summary（程序退出前输出一次总览）

## 9. SQL 执行日志（状态/语句/计划）

- 状态：sql_state(sql started/succeeded/failed/retried)/sql_try/sql_op/target_table/affected_rows/sql_cost_ms
- 语句：logging.sql.text (none|summary|normalized|full_debug，默认 summary)
  - sql_hash 指纹；sql_text 仅在 normalized/full_debug 输出，截断 2KB，`truncated=true`
  - sql_params_logged=false（默认）；开启时也需脱敏 redaction.patterns
- 计划：explain 摘要（on_error|sampled|always，默认 on_error）
- 错误：pgcode/pgerror/hint/detail/constraint

## 10. 领域增强字段（业务/性能/文件/线程）

- 业务：biz_domain/biz_action/scenario、conflict_count/dedupe_ratio/merge_strategy/source_priority
- 性能：batch_cost_ms/merge_cost_ms/rows_per_sec/p95_batch_ms/lock_waits/adjustment
- 文件：file_size/encoding/compress、ts_min/ts_max、chunk_idx/chunks_total、read_cost_ms/read_bytes_per_sec
- 线程：thread_id/thread_name/worker_index/pool、task_id/station_group/window_key、instance_id

## 11. 测试、验收与安全

- 单测：caplog 验证字段/采样/截断/脱敏；开关项覆盖
- 集成：并发 COPY + 合并下日志吞吐与丢失率（队列溢出检测）
- E2E：run-all 后检查 task.summary 与 audit.mv
- 安全：严禁明文凭据/PII；仅记录摘要，不落完整 SQL/参数

> 运维细则（目录结构、轮转保留、检索与排障）见《日志运维.md》。

## 附A. 上下文自动补全（建议）

- 入口：CLI 生成 trace_id/job_id，并通过 contextvars 传递
- 文件/批次：file_path/file_size/bytes_read、chunk_idx/chunks_total、rows\_\*、batch_cost_ms/rows_per_sec
- 业务三元：station_id/device_id/metric_id（在合并阶段补齐），对齐窗口 window_start/window_end

## 附B. 事件命名扩展（建议）

- ingest.path.resolve：路径迁移/适配证据（base_dir + 受限 globFallback）
- ingest.columns.validated：固定列名（TagName/DataTime/DataValue）校验通过
- backpressure.enter / backpressure.exit / guardrail.stop：自适应与门禁
- db.exec.started / db.exec.succeeded / db.exec.failed / db.exec.retried：SQL 状态与摘要

### 背压日志示例（JSON，建议）

```json
{"event":"backpressure.enter","p95_batch_ms":2300,"fail_rate":0.012,"action":"shrink_batch","from_batch":1000000,"to_batch":500000}
{"event":"backpressure.exit","p95_batch_ms":1800,"fail_rate":0.003,"action":"recover","new_workers":6}
```

- 说明：enter 记录触发阈值与动作；exit 记录恢复后的关键参数（如回升并发）
