# 架构落地计划 v1（仅保留 32/33/34/35/37）

## 32完整目录结构（一次性创建清单，职责明确）

以下为“目标完整版（To‑Be Full）”目录树，建议一次性创建（允许空目录内放置 README.md 占位），并与本文既有章节的职责/流程保持一致。已对齐 PostgreSQL 中心化与渐进式演进原则。

```text
pump_station_optimization/
├── app/                          # 应用主目录（HTTP 网关，薄封装）
│   ├── __init__.py
│   ├── main.py                   # FastAPI 应用入口（健康检查/路由注册/中间件）
│   ├── config/                   # 配置管理
│   │   ├── __init__.py
│   │   ├── settings.py           # Pydantic Settings（.env 加载）
│   │   ├── database.py           # 只读/只写连接（psycopg3/asyncpg，直调 DB 函数）
│   │   └── logging.py            # 结构化日志（JSON），等级按环境
│   ├── core/                     # 核心模块（横切关注点）
│   │   ├── __init__.py
│   │   ├── dependencies.py       # 依赖注入（DB 连接、鉴权占位）
│   │   ├── exceptions.py         # 统一异常与错误模型
│   │   └── middleware.py         # 日志/跟踪/限流（按需）
│   ├── api/                      # API 路由
│   │   ├── __init__.py
│   │   ├── v1/
│   │   │   ├── __init__.py
│   │   │   ├── endpoints/
│   │   │   │   ├── __init__.py
│   │   │   │   ├── stations.py   # 泵站管理（后续绑定 DB 函数）
│   │   │   │   ├── devices.py    # 设备管理
│   │   │   │   ├── data.py       # 明细 CRUD（api.*）/ 报表（reporting.*）
│   │   │   │   ├── curves.py     # 特性曲线（阶段三）
│   │   │   │   ├── optimization.py # 多目标优化（阶段四）
│   │   │   │   └── monitoring.py # 监控接口（v_mv_hit_audit/health）
│   │   │   └── router.py         # 路由汇总（版本化）
│   │   └── websocket/            # WebSocket（阶段五，可选）
│   │       ├── __init__.py
│   │       ├── manager.py        # 连接管理
│   │       └── handlers.py       # 消息处理
│   ├── models/                   # 可选：只读 ORM 映射（严禁写业务逻辑）
│   │   ├── __init__.py
│   │   ├── base.py
│   │   ├── station.py
│   │   ├── device.py
│   │   ├── operation_data.py
│   │   ├── curve.py
│   │   └── optimization.py
│   ├── schemas/                  # Pydantic 模式（入参/出参契约）
│   │   ├── __init__.py
│   │   ├── base.py
│   │   ├── station.py
│   │   ├── device.py
│   │   ├── data.py
│   │   ├── curve.py
│   │   └── optimization.py
│   ├── services/                 # 业务服务（薄层：参数校验/编排→DB 函数）
│   │   ├── __init__.py
│   │   ├── base.py
│   │   ├── data_import.py        # 调用 CSV 导入流程（staging/COPY/UPSERT）
│   │   ├── data_completion.py    # 数据补齐（阶段二）
│   │   ├── curve_fitting.py      # 曲线拟合（阶段三）
│   │   ├── optimization.py       # 优化服务（阶段四）
│   │   └── monitoring.py         # 观测服务（pgss/命中率）
│   ├── algorithms/               # 算法模块（ML/深度学习/优化/数据处理）
│   │   ├── __init__.py
│   │   ├── machine_learning/     # 传统ML（sklearn/Optuna）
│   │   │   ├── feature_engineering.py
│   │   │   ├── trainers/
│   │   │   └── evaluators/
│   │   ├── deep_learning/        # 深度学习（PyTorch/TF）
│   │   │   ├── models/
│   │   │   ├── trainers/
│   │   │   └── inference/
│   │   ├── optimization/         # 多目标优化/启发式
│   │   ├── data_processing/      # 插值/异常/质量评估
│   │   ├── pipelines/            # 训练/评估/发布流水线
│   │   └── model_registry/       # 模型版本与元数据
│   ├── utils/                    # 工具模块（避免与 config/database.py 重叠）
│   │   ├── __init__.py
│   │   ├── file_handler.py
│   │   ├── math_utils.py
│   │   ├── time_utils.py
│   │   └── validation.py
│   └── tasks/                    # 调度任务（优先 APScheduler；Celery 视需求）
│       ├── __init__.py
│       ├── scheduler.py          # APScheduler 入口（跨平台）
│       ├── jobs/
│       │   ├── refresh_mv.py     # 调用 DB 刷新或 psql 脚本
│       │   ├── vacuum_analyze.py # smart_vacuum/auto_performance_tuning
│       │   └── snapshot_pgss.py  # capture_pgss_snapshot
│       └── celery_app.py         # 可选：分布式任务（出现需求再启用）
├── tests/                        # 测试目录
│   ├── __init__.py
│   ├── conftest.py               # 测试配置（数据准备/清理钩子）
│   ├── unit/                     # 单元测试（schema/路由入参校验）
│   ├── integration/              # 集成测试（写入→刷新→查询→清理）
│   └── performance/              # 性能测试（pgss/EXPLAIN/ANALYZE）
├── scripts/                      # 数据库“唯一真相源”（SQL/MV/维护脚本）
│   ├── sql/                      # 所有 *.sql（reporting/api/monitoring/public）
│   ├── maintenance/              # 计划任务/批处理（*.bat）
│   └── tools/                    # 可选：Python 工具脚本（导入/导出包装）
├── docs/                         # 文档目录（架构/API/测试/性能/规范）
│   └── PLAYBOOKS/                # 决策/配置/改进/经验（强制记录）
├── data/                         # 数据目录（样本/测试数据；生产慎用）
├── logs/                         # 日志目录
├── config/                       # 配置文件（示例与非敏感）
│   ├── settings.py               # 可选：全局配置样例（以 .env 为准）
│   ├── database.py               # 可选：连接样例（应用侧使用 app/config/database.py）
│   └── logging.conf              # 可选：日志配置（或使用 logging.py 动态配置）
├── .env.example                  # 环境变量示例（DB/日志/时区）
├── pyproject.toml                # 推荐：Poetry 依赖管理（或 requirements.txt 二选一）
├── requirements.txt              # 备选：pip 依赖（避免与 Poetry 同时使用）
├── README.md                     # 项目说明/快速开始
└── Makefile                      # 可选：常用命令封装（Windows 可用 .bat 代替）
```

- 重要约束
  - scripts/ 仅存放数据库相关脚本（*.sql、*.bat）；Python 工具移入 scripts/tools 或 app/tasks/jobs/
  - 应用所有业务逻辑以“调用数据库函数”为准；禁止在 models/services 内复制 SQL 逻辑
  - 空目录建议放置 README.md，避免误删/丢失

> 更新（2025-08-19）：运行产物与配置外置

- run-all 产出 env.json（args_summary + config_snapshot + sources）与 summary.json（copy/merge 用时、背压、tz_fallback）

- 配置外置：configs/{logging.yaml,ingest.yaml,database.yaml}（中文注释）；优先级 CLI>ENV>YAML>默认；base_dir 固定 data

- 日志：format=json|text、routing=by_run|by_module（里程碑2将完善文本模板与 by_module 目录）

  - 里程碑2（最小实现）完成：format=text、routing=by_module、db.exec.\* 埋点；深化进行中（字段族补齐与模板细化）

## 33. 目录创建指引（一次性创建 + 最小可运行）

- 建议一次性创建上述目录，并至少补齐以下最小可运行文件：
  - app/main.py、app/api/v1/router.py、app/api/v1/endpoints/{data.py,health.py}
  - app/config/{settings.py,database.py,logging.py}、.env.example
  - tests/integration/ 基础用例骨架（按 TESTING_GUIDE）
  - scripts/sql/ 下保留现有 \*.sql；scripts/maintenance/ 下保留现有 \*.bat
- 运行建议：先通过 psql 验证 DB 函数与 MV，再启动 app/ 接口做联调

（以上为文档整合与目录一次性创建方案。若你确认该结构，我可据此批量创建目录与最小骨架文件，并在 PLAYBOOKS 登记本次体系化落地。）

## 34. 现状与目录映射（As‑Is → To‑Be 对齐清单）

### 34.1 现状资产（As‑Is）

- 数据库（PostgreSQL 16，已落地）
  - reporting：get_metrics_daily/hourly/\_multi/auto、v_metrics_daily、mv_measurements_hourly/daily
  - api：get_measurements、upsert_measurement、upsert_measurements_json、update_measurement_value、delete_measurements_by_filter、delete_measurement
  - monitoring：pgss_snapshot 表与 capture/cleanup 函数、v_mv_hit_audit、v_active_partitions/\_last7d/\_index_coverage、v_query_coverage、ensure_active_indexes、run_ab_test
  - public：safe_upsert_measurement、smart_vacuum_strategy、auto_performance_tuning、auto_space_reclaim、database_health_check（详见 docs/数据库函数参考.md / docs/逐函数详解_附录.md）
- 脚本（scripts/，已落地）
  - SQL：perf_snapshot.sql、active_partition_audit.sql、ab_validation.sql、mv_blueprints.sql、query_rewrite_examples.sql、get_metrics_hourly.sql、get_metrics_multi.sql、get_metrics_auto.sql、api_crud.sql、mv_hit_audit.sql
  - 维护：run_pgss_snapshot.bat、run_smart_vacuum.bat、run_auto_analyze.bat、refresh_mv_hourly.bat、refresh_mv_daily.bat
- 文档（docs/，已落地）
  - ARCHITECTURE_OVERVIEW.md、API_FUNCTIONS_REFERENCE.md、TESTING_GUIDE.md、PERF_BENCHMARKING.md、CONTRIBUTING_DB_FUNCTIONS.md、ARCHITECTURE_PLAN_v1.md（本文件）
  - PLAYBOOKS：DECISIONS.md、CONFIGURATION_CHANGES.md、IMPROVEMENTS.md、LESSONS_LEARNED.md
- 调度（APScheduler，现行方案）
  - snapshot_pgss（30m）、smart_vacuum（4h）、auto_analyze（30m）、refresh_mv_hourly（15m）、refresh_mv_daily（02:30）

### 34.2 目录映射（To‑Be 目标结构）

- app/ → 以“调用 DB 函数”为唯一业务入口
  - api/v1/endpoints/data.py → reporting.get_metrics\_\*（聚合）/ api.get_measurements & CRUD（明细）
  - api/v1/endpoints/monitoring.py → monitoring.v_mv_hit_audit / public.database_health_check
  - services/\*.py → 薄编排层（参数校验→调用 DB 函数）
  - config/database.py → 只读/只写连接池（psycopg3/asyncpg）
- tasks/ → 调度触发器
  - scheduler.py → APScheduler jobs 注册
  - jobs/refresh_mv.py → 调用 REFRESH/MV 刷新函数或 scripts/maintenance/ 对应 .bat
  - jobs/vacuum_analyze.py → 调用 smart_vacuum_strategy / auto_performance_tuning
  - jobs/snapshot_pgss.py → 调用 capture_pgss_snapshot
- scripts/
  - sql/（规划迁移）：现有 \*.sql 逐步归档入此；当前保持向后兼容（不立即移动）
  - maintenance/（规划迁移）：现有 \*.bat 逐步归档入此；当前保持兼容
- tests/
  - integration/：写入样本→REFRESH→查询→清理（严格按 TESTING_GUIDE）
  - performance/：pgss 采样与 EXPLAIN/ANALYZE（按 PERF_BENCHMARKING）

## 35. 应用接口 ↔ 数据库函数 对照（附录 A）

- GET /api/v1/metrics/daily → reporting.get_metrics_daily(...)
- GET /api/v1/metrics/hourly → reporting.get_metrics_hourly(...)
- GET /api/v1/metrics/auto → reporting.get_metrics_auto(...)
- GET /api/v1/measurements → api.get_measurements(...)
- POST /api/v1/measurements/upsert → api.upsert_measurement(...)
- POST /api/v1/measurements/batch → api.upsert_measurements_json(jsonb)
- PUT /api/v1/measurements/value → api.update_measurement_value(...)
- DELETE /api/v1/measurements → api.delete_measurements_by_filter(...)

## 37. 对齐实施计划（不影响现网）

- 步骤 1：目录一次性创建；空目录用 README 占位
- 步骤 2：最小可运行骨架；只调用 DB 函数，不复制 SQL
- 步骤 3：集成测试 3–5 条（写入→刷新→查询→清理）
- 步骤 4：APScheduler 替代 Windows 计划任务
- 步骤 5：PLAYBOOKS 记录与验收（SLO：MV P95\<300ms；明细 P95\<800ms）
