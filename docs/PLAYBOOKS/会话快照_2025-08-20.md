# 会话快照_2025-08-20（程序现状与记忆对齐摘要）

## 摘要
- 已完成对 docs 全量文档的阅读与对齐：程序现状、约束、流程、日志、配置外置、E2E 验证与产物、数据库事实
- 已放弃 dev-suite MCP：删除脚本与 Docker/VSCode 配置，修复所有引用并在配置变更中留痕
- PR 模板新增“【必选】MCP 默认工具确认”小节；严格模式核对清单同步

## 现状要点
- 数据库与表结构：PostgreSQL 16；fact_measurements 周分区 + 站点 HASH 子分区；父表 BRIN(ts_bucket)，叶子分区 btree(..., ts_bucket) INCLUDE(value)；CHECK 秒级对齐
- 写入契约：UTC + ts_bucket 秒级对齐；safe_upsert_measurement/_local；同秒 UPSERT 合并；禁止从文件路径推断维度/指标（唯一来源：config/data_mapping.v2.json）
- 导入流程（方案A）：auto/direct/staging；大吞吐并发 COPY → staging_raw/rejects → 集合式合并；分段合并与背压自适应
- 配置外置与来源标注：configs/{logging,ingest,database}.yaml；sources 标注 DEFAULT|YAML|ENV|CLI；CLI 覆盖 DSN 需 --allow-cli-dsn
- 日志：JSON/文本模式；by_run/by_module；关键事件 db.exec.* 与 align.merge.window；env.json/summary.json 运行产物
- 测试与验收：最小窗口 E2E；not_aligned=0；pre-commit 全绿要求

## 待办与差异
- 修复 prepare-dim 中 dim_metric_config 返回列名不匹配（RETURNING id 或 DO NOTHING + SELECT id）
- 协调文档状态板里“run-all 正在修复”语句，在修复提交后统一刷新
- 确认 safe_upsert_measurement_local 已部署并更新采集清单（_routines.tsv）

## 风险提示
- 开发库严禁写表；仅在测试库执行导入/合并
- 日志默认不脱敏，分享前需处理敏感字段

## 关联文档
- 程序工作流程：docs/程序工作流程.md
- 表结构与数据库：docs/表结构与数据库.md
- 数据库函数参考：docs/数据库函数参考.md
- 日志规范/运维：docs/日志规范.md、docs/日志运维.md
- 测试指南：docs/测试指南.md
- 严格模式与行为控制：docs/严格模式-核对清单.md、docs/智能助手行为控制.md
- 配置与快照示例：docs/配置与快照-示例.md
- 变更与审计：docs/PLAYBOOKS/配置变更记录.md、docs/PLAYBOOKS/决策记录.md、docs/PLAYBOOKS/错误与修复记录.md


