______________________________________________________________________

## id: CONF-20250816-006 date: 2025-08-16 module: db | scheduler summary: 添加整秒对齐 CHECK 约束；停用 Windows 计划任务，启用 APScheduler

- 数据库配置变更：
  - 新增脚本 scripts/sql/constraints_time_alignment.sql（父表与现有分区添加 NOT VALID CHECK）
  - 新增函数脚本 scripts/sql/safe_upsert_measurement_local.sql（站点时区感知写入）
- 调度配置变更：
  - 文档中标注移除 Windows 计划任务；后续仅使用 APScheduler 管理刷新/维护/采样任务
- 回滚方案：
  - DB：DROP FUNCTION public.safe_upsert_measurement_local; ALTER TABLE ... DROP CONSTRAINT ...
  - 调度：若需回退，可临时启用手动脚本触发刷新

# CONFIGURATION_CHANGES（配置变更记录）

______________________________________________________________________

## id: CONF-20250816-007 date: 2025-08-16 module: docs summary: 新增中文文档与导航，归档英文旧文档到 docs/\_archive/2025-08-16/

- 新增：docs/文档地图与导航.md、docs/体系结构总览.md、docs/架构落地计划_v1.md、docs/表结构与数据库.md、docs/数据库函数参考.md、docs/测试指南.md、docs/数据质量与校验.md
- 归档：ARCHITECTURE_OVERVIEW.md、ARCHITECTURE_PLAN_v1.md、SCHEMA_AND_DB.md、API_FUNCTIONS_REFERENCE.md、TESTING_GUIDE.md、PERF_BENCHMARKING.md、CONTRIBUTING_DB_FUNCTIONS.md
- 链接更新：中文文档为新入口，后续逐步清理英文文档活动链接

目的：记录系统配置的变更历史，便于回滚、审计和问题排查。

## 记录模板（复制使用）

______________________________________________________________________

## id: CONF-YYYYMMDD-001 date: YYYY-MM-DD module: ingest | align | validate | derive | fit | optimize | viz | infra | docs change_type: add | modify | remove | migrate environment: dev | test | staging | prod risk_level: low | medium | high | critical rollback_plan: 'rollback steps' tags: \[ 'database', 'connection', 'performance' \]

- 变更标题：简要描述配置变更
- 变更原因：为什么需要这个变更
- 变更内容：
  - 变更前：原配置内容
  - 变更后：新配置内容
  - 影响范围：哪些组件受影响
- 变更步骤：详细的执行步骤
- 验证方法：如何验证变更成功
- 回滚方案：如何回滚到变更前状态
- 风险评估：潜在的风险和缓解措施
- 监控指标：需要关注的监控项
- 参考链接：相关文档、工具、脚本

## 记录

______________________________________________________________________

## id: CONF-20250816-001 date: 2025-08-16 module: infra change_type: modify environment: dev risk_level: low rollback_plan: 'ALTER SYSTEM RESET shared_preload_libraries; 重启服务；DROP EXTENSION pg_stat_statements;' tags: \[ 'database', 'postgresql', 'pg_stat_statements', 'observability' \]

- 变更标题：启用 pg_stat_statements 并重启数据库
- 变更原因：采集查询观测指标（calls/rows/blk_read_time 等），支持 A/B 验证与容量规划
- 变更内容：
  - 变更前：shared_preload_libraries 未包含 pg_stat_statements
  - 变更后：ALTER SYSTEM SET shared_preload_libraries = 'pg_stat_statements'; 重启服务；CREATE EXTENSION pg_stat_statements
  - 影响范围：全局参数变更，需要重启生效
- 变更步骤：
  1. ALTER SYSTEM SET shared_preload_libraries = 'pg_stat_statements'
  1. 使用 pg_ctl 重启 PostgreSQL 服务
  1. CREATE EXTENSION IF NOT EXISTS pg_stat_statements
- 验证方法：
  - SHOW shared_preload_libraries → pg_stat_statements
  - SELECT extname FROM pg_extension WHERE extname='pg_stat_statements' → 存在
  - 采样 pg_stat_statements → 返回数据
- 回滚方案：
  - ALTER SYSTEM RESET shared_preload_libraries；重启服务
  - DROP EXTENSION pg_stat_statements
- 风险评估：低（标准扩展，重启切换需在维护窗口执行）
- 监控指标：
  - monitoring.pgss_snapshot 快照数量
  - pg_stat_statements.calls/rows/blk\_\* 时间
- 参考链接：docs/PERFORMANCE_OPTIMIZATION.md, scripts/perf_snapshot.sql

______________________________________________________________________

## id: CONF-20250816-002 date: 2025-08-16 module: optimize change_type: create environment: dev risk_level: low rollback_plan: 'DROP MATERIALIZED VIEW reporting.mv_measurements_hourly; DROP MATERIALIZED VIEW reporting.mv_measurements_daily; 删除计划任务 PG_MV_Refresh\_\*' tags: \[ 'postgresql', 'materialized-view', 'scheduling' \]

- 变更标题：创建汇总层MV与首次刷新（方案B），并建立刷新计划任务
- 变更原因：加速看板/报表查询，控制成本，降低事实表压力
- 变更内容：
  - 新建 MV：mv_measurements_hourly/daily（WITH NO DATA）
  - 创建唯一索引以支持 CONCURRENTLY 刷新
  - 首次刷新：先非并发填充，再并发刷新
  - 创建计划任务：PG_MV_Refresh_Hourly（每15分钟）、PG_MV_Refresh_Daily（每日02:30）
- 验证方法：
  - SELECT count(\*) FROM reporting.mv_measurements_hourly/daily → 当前均为0（无源数据时属正常）
  - pg_total_relation_size 显示各 24kB（结构占用）
- 回滚方案：
  - 删除计划任务 PG_MV_Refresh\_\*；DROP MATERIALIZED VIEW ...
- 风险评估：低（只读缓存层，首次刷新在维护窗口执行）
- 参考链接：scripts/mv_blueprints.sql, scripts/refresh_mv_hourly.bat, scripts/refresh_mv_daily.bat

______________________________________________________________________

## id: CONF-20250815-001 date: 2025-08-15 module: infra change_type: modify environment: dev risk_level: low rollback_plan: '对指定分区逐一回滚存储参数；删除新增索引' tags: \[ 'database', 'postgresql', 'performance', 'autovacuum', 'indexing' \]

- 变更标题：数据库第一阶段性能优化（分区存储参数 + BRIN 索引 + 优化函数）
- 变更原因：支撑频繁 CRUD 工作负载，降低 MVCC 膨胀、提升查询性能
- 变更内容：
  - 变更前：父表未设置存储参数；无 BRIN 分区化索引；缺少监控/一致性函数
  - 变更后：对所有叶子分区设置 fillfactor=70、autovacuum 参数；创建 BRIN(ts_bucket) 分区化索引；部署 check_data_consistency、v_storage_monitoring 等
  - 影响范围：public.fact_measurements 及其所有叶子分区
- 变更步骤：
  1. 执行 scripts/crud_optimization_functions.sql 部署函数与视图
  1. 执行 scripts/phase1_adjust_storage.sql 调整叶子分区存储参数
  1. 创建 BRIN(ts_bucket) 分区化索引 idx_fm_brin_ts
- 验证方法：
  - SELECT * FROM check_data_consistency() LIMIT 5 → 0 行
  - SELECT * FROM v_storage_monitoring LIMIT 10 → 正常显示分区与指标
- 回滚方案：
  - 对受影响分区执行 ALTER TABLE ... RESET (fillfactor, autovacuum\_\*)
  - DROP INDEX IF EXISTS idx_fm_brin_ts
- 风险评估：低风险（在线执行、无锁表风险，分区级参数可安全回滚）
- 监控指标：
  - get_performance_metrics() 锁等待/连接数
  - v_storage_monitoring 死元组比例
- 参考链接：docs/PERFORMANCE_OPTIMIZATION.md, scripts/phase1_adjust_storage.sql, scripts/crud_optimization_functions.sql

______________________________________________________________________

## id: CONF-20250115-001 date: 2025-01-15 module: infra change_type: add environment: dev risk_level: low rollback_plan: '删除数据库和表结构' tags: \[ 'database', 'schema', 'postgresql' \]

- 变更标题：创建 pump_station_optimization 数据库和完整表结构
- 变更原因：建立项目的数据存储基础设施
- 变更内容：
  - 变更前：无数据库结构
  - 变更后：完整的数据库、表、分区、索引、约束
  - 影响范围：整个数据存储层
- 变更步骤：
  1. 创建数据库 pump_station_optimization
  1. 执行 scripts/create_tables_clean.sql
  1. 验证表结构和分区创建
- 验证方法：\\dt 查看表列表，\\d+ 查看表结构，验证分区和索引
- 回滚方案：DROP DATABASE pump_station_optimization
- 风险评估：低风险，开发环境，无数据丢失风险
- 监控指标：数据库连接状态，表创建状态
- 参考链接：scripts/create_tables_clean.sql, docs/SCHEMA_AND_DB.md

______________________________________________________________________

## id: CONF-20250115-002 date: 2025-01-15 module: infra change_type: add environment: dev risk_level: low rollback_plan: '删除分区管理函数' tags: \[ 'database', 'partitioning', 'automation' \]

- 变更标题：添加自动分区管理函数 ensure_week_partition()
- 变更原因：实现分区的自动化管理，支持未来数据增长
- 变更内容：
  - 变更前：无分区管理机制
  - 变更后：自动分区创建函数，预创建13周分区
  - 影响范围：fact_measurements 表的分区管理
- 变更步骤：
  1. 创建 ensure_week_partition() 函数
  1. 执行 DO 块创建未来13周分区
  1. 验证分区和子分区创建
- 验证方法：查询 pg_tables 验证分区表创建，测试函数调用
- 回滚方案：DROP FUNCTION ensure_week_partition()，手动删除分区
- 风险评估：低风险，仅影响分区管理，不影响数据
- 监控指标：分区数量，分区大小，查询性能
- 参考链接：ensure_week_partition() 函数定义

______________________________________________________________________

## id: CONF-20250115-003 date: 2025-01-15 module: docs change_type: modify environment: dev risk_level: low rollback_plan: 'git revert 相关提交' tags: \[ 'documentation', 'consistency', 'schema' \]

- 变更标题：更新核心规范文档使其与实际实施一致
- 变更原因：消除文档与实施的不一致，提升开发效率
- 变更内容：
  - 变更前：文档中使用 metric 文本字段，ts_local/ts_utc 时间字段
  - 变更后：统一使用 metric_id 外键，ts_raw/ts_bucket 时间字段
  - 影响范围：DATA_SPEC.md, ALIGNMENT_POLICY.md, DERIVATIONS.md, SCHEMA_AND_DB.md
- 变更步骤：
  1. 逐个更新4个核心文档
  1. 统一字段定义和命名约定
  1. 记录实施与原规划的差异
- 验证方法：对比文档描述与实际表结构，确保100%一致
- 回滚方案：git revert 到变更前版本
- 风险评估：低风险，仅文档变更，不影响代码
- 监控指标：文档一致性，开发者反馈
- 参考链接：docs/ 目录，scripts/create_tables_clean.sql

______________________________________________________________________

## id: CONF-20250115-004 date: 2025-01-15 module: docs change_type: add environment: dev risk_level: low rollback_plan: '删除 PLAYBOOKS 相关文件' tags: \[ 'knowledge_management', 'automation', 'process' \]

- 变更标题：建立 PLAYBOOKS 知识管理机制
- 变更原因：确保重要变更和经验得到系统性记录
- 变更内容：
  - 变更前：无系统化的知识记录机制
  - 变更后：完整的 PLAYBOOKS 体系，包含5种记录类型
  - 影响范围：整个项目的知识管理流程
- 变更步骤：
  1. 创建 DECISIONS.md, LESSONS_LEARNED.md, PERFORMANCE_BENCHMARKS.md, CONFIGURATION_CHANGES.md
  1. 建立关键词触发的自动记录机制
  1. 记录已完成工作的关键信息
- 验证方法：测试关键词触发机制，验证记录完整性
- 回滚方案：删除 docs/PLAYBOOKS/ 目录下新增文件
- 风险评估：低风险，仅增加文档，不影响系统功能
- 监控指标：记录数量，记录质量，使用频率
- 参考链接：docs/PLAYBOOKS/ 目录，remember 工具

______________________________________________________________________

## id: CONF-20250817-001 date: 2025-08-17 module: tooling | docs change_type: modify environment: dev risk_level: low rollback_plan: '还原 pcv.ps1 到上一个版本；恢复 VSCode settings 中 ruff 修复策略；回退 memory_index 变更' tags: \[ 'pre-commit', 'powershell', 'mdformat', 'playbooks', 'tooling' \]

- 变更标题：质量工具链调整（pcv.ps1 UTF-8、VSCode 保存策略 explicit、memory_index 幂等兼容 mdformat）
- 变更原因：避免 pre-commit 中 memory-index 与 mdformat 互相改写导致循环失败；消除 PowerShell 控制台中文乱码，提升可读性
- 变更内容：
  - 变更前：
    - pcv.ps1 编码设置滞后，部分终端中文乱码
    - VSCode settings：ruff 修复与组织 imports 为 true（可能导致保存即触发大范围修改）
    - memory_index：对导航区/索引的写入未做语义比较，表头识别与转义与 mdformat 不完全一致
  - 变更后：
    - pcv.ps1 将 UTF-8 设置前移并兼容 PowerShell 5，输出中文无乱码（scripts/dev/pcv.ps1）
    - VSCode settings："source.fixAll.ruff" 与 "source.organizeImports.ruff" 改为 "explicit"
    - memory_index：加入表头分隔线兼容、下划线与管道转义对齐、语义级比较与稳定换行（scripts/tools/memory_index.py）
  - 影响范围：开发体验、CI 稳定性、文档索引一致性
- 变更步骤：
  1. 更新 scripts/dev/pcv.ps1 的编码设置顺序与方式
  1. 调整 .vscode/settings.json 的保存即修复策略为 explicit
  1. 升级 scripts/tools/memory_index.py 的幂等逻辑与 mdformat 兼容
  1. 运行 pcv.ps1 与 pre-commit run --all-files 验证全绿
- 验证方法：
  - 本地多次运行 pre-commit 全量体检，所有钩子通过（含 memory-index、mdformat）
  - pcv.ps1 执行输出中文正常，无乱码

______________________________________________________________________

## id: CONF-20250817-002 date: 2025-08-17 module: db change_type: add environment: dev risk_level: low rollback_plan: '删除 demo 造数；回退函数脚本' tags: \['db','ingest','alignment'\]

- 标题：补充 safe_upsert_measurement_local（UTF-8 + extra->>'tz'）与演示造数脚本

- 原因：文档要求在阶段1进行最小造数验证，需提供可执行函数与脚本

- 内容：

  - scripts/sql/safe_upsert_measurement_local.sql：加入 SET client_encoding UTF8；读取 dim_stations.extra->>'tz'
  - scripts/dev/seed_minimal_demo.sql：新增、能在 dev 快速造数并完成对齐检查

- 验证：已在本机 dev 成功执行，not_aligned=0

- 回滚：DROP FUNCTION public.safe_upsert_measurement_local；DELETE 演示数据

- 回滚方案：

  - git revert 对应提交，恢复至变更前版本
  - 暂时关闭 memory-index 钩子（如需紧急合并），待修复后再开启

- 风险评估：低；变更均为本地开发工具链与生成脚本，不影响生产数据

- 监控指标：

  - PR/CI 通过率、pre-commit 报告稳定性

- 参考链接：PROJECT_RULES.md §4/§6，scripts/dev/pcv.ps1，scripts/tools/memory_index.py，docs/PLAYBOOKS/INDEX.md
