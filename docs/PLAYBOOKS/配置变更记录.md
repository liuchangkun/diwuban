______________________________________________________________________

## id: CONF-20250816-006 date: 2025-08-16 module: db | scheduler summary: 添加整秒对齐 CHECK 约束；停用 Windows 计划任务，启用 APScheduler

- 数据库配置变更：
  - 新增脚本 scripts/sql/constraints_time_alignment.sql（父表与现有分区添加 NOT VALID CHECK）
  - 新增函数脚本 scripts/sql/safe_upsert_measurement_local.sql（站点时区感知写入）
- 调度配置变更：
  - 文档中标注移除 Windows 计划任务；后续仅使用 APScheduler 管理刷新/维护/采样任务
- 回滚方案：
  - DB：DROP FUNCTION public.safe_upsert_measurement_local; ALTER TABLE ... DROP CONSTRAINT ...
  - 调度：若需回退，可临时启用手动脚本触发刷新

# CONFIGURATION_CHANGES（配置变更记录）

______________________________________________________________________

## id: CONF-20250816-007 date: 2025-08-16 module: docs summary: 新增中文文档与导航，归档英文旧文档到 docs/\_archive/2025-08-16/

- 新增：docs/文档地图与导航.md、docs/体系结构总览.md、docs/架构落地计划_v1.md、docs/表结构与数据库.md、docs/数据库函数参考.md、docs/测试指南.md、docs/数据质量与校验.md
- 归档：ARCHITECTURE_OVERVIEW.md、ARCHITECTURE_PLAN_v1.md、SCHEMA_AND_DB.md、API_FUNCTIONS_REFERENCE.md、TESTING_GUIDE.md、PERF_BENCHMARKING.md、CONTRIBUTING_DB_FUNCTIONS.md
- 链接更新：中文文档为新入口，后续逐步清理英文文档活动链接

目的：记录系统配置的变更历史，便于回滚、审计和问题排查。

## 记录模板（复制使用）

______________________________________________________________________

## id: CONF-YYYYMMDD-001 date: YYYY-MM-DD module: ingest | align | validate | derive | fit | optimize | viz | infra | docs change_type: add | modify | remove | migrate environment: dev | test | staging | prod risk_level: low | medium | high | critical rollback_plan: 'rollback steps' tags: \[ 'database', 'connection', 'performance' \]

- 变更标题：简要描述配置变更
- 变更原因：为什么需要这个变更
- 变更内容：
  - 变更前：原配置内容
  - 变更后：新配置内容
  - 影响范围：哪些组件受影响
- 变更步骤：详细的执行步骤
- 验证方法：如何验证变更成功
- 回滚方案：如何回滚到变更前状态
- 风险评估：潜在的风险和缓解措施
- 监控指标：需要关注的监控项
- 参考链接：相关文档、工具、脚本

## 记录

______________________________________________________________________

## id: CONF-20250816-001 date: 2025-08-16 module: infra change_type: modify environment: dev risk_level: low rollback_plan: 'ALTER SYSTEM RESET shared_preload_libraries; 重启服务；DROP EXTENSION pg_stat_statements;' tags: \[ 'database', 'postgresql', 'pg_stat_statements', 'observability' \]

- 变更标题：启用 pg_stat_statements 并重启数据库
- 变更原因：采集查询观测指标（calls/rows/blk_read_time 等），支持 A/B 验证与容量规划
- 变更内容：
  - 变更前：shared_preload_libraries 未包含 pg_stat_statements
  - 变更后：ALTER SYSTEM SET shared_preload_libraries = 'pg_stat_statements'; 重启服务；CREATE EXTENSION pg_stat_statements
  - 影响范围：全局参数变更，需要重启生效
- 变更步骤：
  1. ALTER SYSTEM SET shared_preload_libraries = 'pg_stat_statements'
  1. 使用 pg_ctl 重启 PostgreSQL 服务
  1. CREATE EXTENSION IF NOT EXISTS pg_stat_statements
- 验证方法：
  - SHOW shared_preload_libraries → pg_stat_statements
  - SELECT extname FROM pg_extension WHERE extname='pg_stat_statements' → 存在
  - 采样 pg_stat_statements → 返回数据
- 回滚方案：
  - ALTER SYSTEM RESET shared_preload_libraries；重启服务
  - DROP EXTENSION pg_stat_statements
- 风险评估：低（标准扩展，重启切换需在维护窗口执行）
- 监控指标：
  - monitoring.pgss_snapshot 快照数量
  - pg_stat_statements.calls/rows/blk\_\* 时间
- 参考链接：docs/PERFORMANCE_OPTIMIZATION.md, scripts/perf_snapshot.sql

______________________________________________________________________

## id: CONF-20250816-002 date: 2025-08-16 module: optimize change_type: create environment: dev risk_level: low rollback_plan: 'DROP MATERIALIZED VIEW reporting.mv_measurements_hourly; DROP MATERIALIZED VIEW reporting.mv_measurements_daily; 删除计划任务 PG_MV_Refresh\_\*' tags: \[ 'postgresql', 'materialized-view', 'scheduling' \]

- 变更标题：创建汇总层MV与首次刷新（方案B），并建立刷新计划任务
- 变更原因：加速看板/报表查询，控制成本，降低事实表压力
- 变更内容：
  - 新建 MV：mv_measurements_hourly/daily（WITH NO DATA）
  - 创建唯一索引以支持 CONCURRENTLY 刷新
  - 首次刷新：先非并发填充，再并发刷新
  - 创建计划任务：PG_MV_Refresh_Hourly（每15分钟）、PG_MV_Refresh_Daily（每日02:30）
- 验证方法：
  - SELECT count(\*) FROM reporting.mv_measurements_hourly/daily → 当前均为0（无源数据时属正常）
  - pg_total_relation_size 显示各 24kB（结构占用）
- 回滚方案：
  - 删除计划任务 PG_MV_Refresh\_\*；DROP MATERIALIZED VIEW ...
- 风险评估：低（只读缓存层，首次刷新在维护窗口执行）
- 参考链接：scripts/mv_blueprints.sql, scripts/refresh_mv_hourly.bat, scripts/refresh_mv_daily.bat

______________________________________________________________________

## id: CONF-20250815-001 date: 2025-08-15 module: infra change_type: modify environment: dev risk_level: low rollback_plan: '对指定分区逐一回滚存储参数；删除新增索引' tags: \[ 'database', 'postgresql', 'performance', 'autovacuum', 'indexing' \]

- 变更标题：数据库第一阶段性能优化（分区存储参数 + BRIN 索引 + 优化函数）
- 变更原因：支撑频繁 CRUD 工作负载，降低 MVCC 膨胀、提升查询性能
- 变更内容：
  - 变更前：父表未设置存储参数；无 BRIN 分区化索引；缺少监控/一致性函数
  - 变更后：对所有叶子分区设置 fillfactor=70、autovacuum 参数；创建 BRIN(ts_bucket) 分区化索引；部署 check_data_consistency、v_storage_monitoring 等
  - 影响范围：public.fact_measurements 及其所有叶子分区
- 变更步骤：
  1. 执行 scripts/crud_optimization_functions.sql 部署函数与视图
  1. 执行 scripts/phase1_adjust_storage.sql 调整叶子分区存储参数
  1. 创建 BRIN(ts_bucket) 分区化索引 idx_fm_brin_ts
- 验证方法：
  - SELECT * FROM check_data_consistency() LIMIT 5 → 0 行
  - SELECT * FROM v_storage_monitoring LIMIT 10 → 正常显示分区与指标
- 回滚方案：
  - 对受影响分区执行 ALTER TABLE ... RESET (fillfactor, autovacuum\_\*)
  - DROP INDEX IF EXISTS idx_fm_brin_ts
- 风险评估：低风险（在线执行、无锁表风险，分区级参数可安全回滚）
- 监控指标：
  - get_performance_metrics() 锁等待/连接数
  - v_storage_monitoring 死元组比例
- 参考链接：docs/PERFORMANCE_OPTIMIZATION.md, scripts/phase1_adjust_storage.sql, scripts/crud_optimization_functions.sql

______________________________________________________________________

## id: CONF-20250115-001 date: 2025-01-15 module: infra change_type: add environment: dev risk_level: low rollback_plan: '删除数据库和表结构' tags: \[ 'database', 'schema', 'postgresql' \]

- 变更标题：创建 pump_station_optimization 数据库和完整表结构
- 变更原因：建立项目的数据存储基础设施
- 变更内容：
  - 变更前：无数据库结构
  - 变更后：完整的数据库、表、分区、索引、约束
  - 影响范围：整个数据存储层
- 变更步骤：
  1. 创建数据库 pump_station_optimization
  1. 执行 scripts/create_tables_clean.sql
  1. 验证表结构和分区创建
- 验证方法：\\dt 查看表列表，\\d+ 查看表结构，验证分区和索引
- 回滚方案：DROP DATABASE pump_station_optimization
- 风险评估：低风险，开发环境，无数据丢失风险
- 监控指标：数据库连接状态，表创建状态
- 参考链接：scripts/create_tables_clean.sql, docs/SCHEMA_AND_DB.md

______________________________________________________________________

## id: CONF-20250115-002 date: 2025-01-15 module: infra change_type: add environment: dev risk_level: low rollback_plan: '删除分区管理函数' tags: \[ 'database', 'partitioning', 'automation' \]

- 变更标题：添加自动分区管理函数 ensure_week_partition()
- 变更原因：实现分区的自动化管理，支持未来数据增长
- 变更内容：
  - 变更前：无分区管理机制
  - 变更后：自动分区创建函数，预创建13周分区
  - 影响范围：fact_measurements 表的分区管理
- 变更步骤：
  1. 创建 ensure_week_partition() 函数
  1. 执行 DO 块创建未来13周分区
  1. 验证分区和子分区创建
- 验证方法：查询 pg_tables 验证分区表创建，测试函数调用
- 回滚方案：DROP FUNCTION ensure_week_partition()，手动删除分区
- 风险评估：低风险，仅影响分区管理，不影响数据
- 监控指标：分区数量，分区大小，查询性能
- 参考链接：ensure_week_partition() 函数定义

______________________________________________________________________

## id: CONF-20250115-003 date: 2025-01-15 module: docs change_type: modify environment: dev risk_level: low rollback_plan: 'git revert 相关提交' tags: \[ 'documentation', 'consistency', 'schema' \]

- 变更标题：更新核心规范文档使其与实际实施一致
- 变更原因：消除文档与实施的不一致，提升开发效率
- 变更内容：
  - 变更前：文档中使用 metric 文本字段，ts_local/ts_utc 时间字段
  - 变更后：统一使用 metric_id 外键，ts_raw/ts_bucket 时间字段
  - 影响范围：DATA_SPEC.md, ALIGNMENT_POLICY.md, DERIVATIONS.md, SCHEMA_AND_DB.md
- 变更步骤：
  1. 逐个更新4个核心文档
  1. 统一字段定义和命名约定
  1. 记录实施与原规划的差异
- 验证方法：对比文档描述与实际表结构，确保100%一致
- 回滚方案：git revert 到变更前版本
- 风险评估：低风险，仅文档变更，不影响代码
- 监控指标：文档一致性，开发者反馈
- 参考链接：docs/ 目录，scripts/create_tables_clean.sql

______________________________________________________________________

## id: CONF-20250115-004 date: 2025-01-15 module: docs change_type: add environment: dev risk_level: low rollback_plan: '删除 PLAYBOOKS 相关文件' tags: \[ 'knowledge_management', 'automation', 'process' \]

- 变更标题：建立 PLAYBOOKS 知识管理机制
- 变更原因：确保重要变更和经验得到系统性记录
- 变更内容：
  - 变更前：无系统化的知识记录机制
  - 变更后：完整的 PLAYBOOKS 体系，包含5种记录类型
  - 影响范围：整个项目的知识管理流程
- 变更步骤：
  1. 创建 DECISIONS.md, LESSONS_LEARNED.md, PERFORMANCE_BENCHMARKS.md, CONFIGURATION_CHANGES.md
  1. 建立关键词触发的自动记录机制
  1. 记录已完成工作的关键信息
- 验证方法：测试关键词触发机制，验证记录完整性
- 回滚方案：删除 docs/PLAYBOOKS/ 目录下新增文件
- 风险评估：低风险，仅增加文档，不影响系统功能
- 监控指标：记录数量，记录质量，使用频率
- 参考链接：docs/PLAYBOOKS/ 目录，remember 工具

______________________________________________________________________

______________________________________________________________________

## id: CONF-20250819-001 date: 2025-08-19 module: ingest|logging change_type: modify environment: dev risk_level: low rollback_plan: '回退到 write_run_snapshot，不含 sources；loader 使用旧 load_settings' tags: \[ 'config', 'loader', 'logging', 'snapshot' \]

- 变更标题：配置外置与启动快照（含来源标注）最小实现
- 变更原因：需要将配置文件外置并在启动时记录参数/配置快照及来源，便于排障与审计
- 变更内容：
  - 新增 load_settings_with_sources(config_dir) 返回 (Settings, sources)
  - 新增 write_run_snapshot_with_sources(...) 将 sources 一并写入 env.json
  - run-all 接入来源标注；支持 CLI --log-format/--log-routing 并标注为 CLI
- 验证方法：
  - 运行 run-all 带 --log-format text --log-routing by_module
  - 检查 logs/runs/milestone1_cli/env.json → sources.logging.format=CLI、sources.logging.routing=CLI
- 回滚方案：
  - CLI 改回 write_run_snapshot；删除 sources 字段；使用旧 load_settings
- 影响范围：低；仅新增快照字段与 loader API，不影响业务逻辑

## id: CONF-20250817-001 date: 2025-08-17 module: tooling | docs change_type: modify environment: dev risk_level: low rollback_plan: '还原 pcv.ps1 到上一个版本；恢复 VSCode settings 中 ruff 修复策略；回退 memory_index 变更' tags: \[ 'pre-commit', 'powershell', 'mdformat', 'playbooks', 'tooling' \]

- 变更标题：质量工具链调整（pcv.ps1 UTF-8、VSCode 保存策略 explicit、memory_index 幂等兼容 mdformat）
- 变更原因：避免 pre-commit 中 memory-index 与 mdformat 互相改写导致循环失败；消除 PowerShell 控制台中文乱码，提升可读性
- 变更内容：
  - 变更前：
    - pcv.ps1 编码设置滞后，部分终端中文乱码
    - VSCode settings：ruff 修复与组织 imports 为 true（可能导致保存即触发大范围修改）
    - memory_index：对导航区/索引的写入未做语义比较，表头识别与转义与 mdformat 不完全一致
  - 变更后：
    - pcv.ps1 将 UTF-8 设置前移并兼容 PowerShell 5，输出中文无乱码（scripts/dev/pcv.ps1）
    - VSCode settings："source.fixAll.ruff" 与 "source.organizeImports.ruff" 改为 "explicit"
    - memory_index：加入表头分隔线兼容、下划线与管道转义对齐、语义级比较与稳定换行（scripts/tools/memory_index.py）
  - 影响范围：开发体验、CI 稳定性、文档索引一致性
- 变更步骤：
  1. 更新 scripts/dev/pcv.ps1 的编码设置顺序与方式
  1. 调整 .vscode/settings.json 的保存即修复策略为 explicit
  1. 升级 scripts/tools/memory_index.py 的幂等逻辑与 mdformat 兼容
  1. 运行 pcv.ps1 与 pre-commit run --all-files 验证全绿
- 验证方法：
  - 本地多次运行 pre-commit 全量体检，所有钩子通过（含 memory-index、mdformat）
  - pcv.ps1 执行输出中文正常，无乱码

______________________________________________________________________

## id: CONF-20250817-002 date: 2025-08-17 module: db change_type: add environment: dev risk_level: low rollback_plan: '删除 demo 造数；回退函数脚本' tags: \['db','ingest','alignment'\]

______________________________________________________________________

## id: CONF-20250818-003 date: 2025-08-18 module: docs change_type: modify environment: dev risk_level: low rollback_plan: 'git revert 提交，恢复 docs/规范.md 与 docs/日志.md 并回滚链接' tags: \['documentation','navigation','consistency'\]

- 变更标题：整合编码与日志规范文档（统一入口）

- 变更原因：减少规范分散，统一权威入口，符合 PROJECT_RULES.md 的“唯一入口/一致性”要求

- 变更内容：

  - 将 docs/规范.md 全量并入 docs/编码规范.md，并删除 docs/规范.md
  - 将 docs/日志.md 全量并入 docs/日志规范与运维.md，并删除 docs/日志.md
  - 修复文内引用至《docs/日志规范与运维.md》
  - 确认 docs/文档地图与导航.md 的指向与标题一致

- 验证方法：

  - 打开 docs/编码规范.md 与 docs/日志规范与运维.md，核对目录与段落完整
  - 搜索仓库内对 docs/规范.md、docs/日志.md 的引用应为 0

______________________________________________________________________

## id: CONF-20250818-004 date: 2025-08-18 module: docs change_type: modify environment: dev risk_level: low rollback_plan: 'git revert 提交，恢复 docs/日志规范与运维.md 并回滚引用' tags: \['documentation','logging','ops'\]

- 变更标题：拆分《日志规范与运维.md》为《日志规范.md》与《日志运维.md》

- 变更原因：职责分离（规范定义 vs 运维操作），便于开发与运维各自查阅与维护

- 变更内容：

  - 新增 docs/日志规范.md（技术规范：格式/字段/事件命名/配置模板/采样限流/错误处理/SQL日志/测试验收）
  - 新增 docs/日志运维.md（运维操作：目录结构/轮转/保留/检索/建议/排障）
  - 更新引用：docs/编码规范.md、docs/程序工作流程.md、docs/文档地图与导航.md
  - 删除 docs/日志规范与运维.md

- 验证方法：

  - 全局搜索“日志规范与运维.md”应为 0 处
  - 文档导航新增两条目且能打开
  - pre-commit run --all-files 全绿

- 回滚方案：

  - 恢复删除文件并还原引用

- 风险评估：低，仅文档与引用变更

  - pre-commit run --all-files 全绿（含 mdformat/memory-index）

- 回滚方案：

  - git revert 此条提交，恢复被删除文件与旧链接

- 风险评估：低，仅文档与引用变更

______________________________________________________________________

## id: CONF-20250819-010 date: 2025-08-19 module: docs|process change_type: modify environment: dev risk_level: low rollback_plan: 'git revert 对应提交；恢复旧模板与文档' tags: \[ 'documentation','process','governance','strict-mode' \]

- 变更标题：行为治理升级（严格模式 + PR 门禁 + 个人守则）

- 变更原因：将对 AI 助手/开发者的行为约束制度化，确保每次改动有说明、可验证、可回滚、可审计

- 变更内容：

  - 更新 docs/智能助手行为控制.md：新增“严格模式执行规则与完成定义（DoD）”
  - 更新 docs/严格模式-核对清单.md：补充 Why/What/Impact/Risk/Rollback 与验证细节
  - 更新 .github/PULL_REQUEST_TEMPLATE.md：新增“变更说明（必填）”与更严格的 E2E 产物要求
  - 新增 docs/个人工作守则.md，并在文档地图接入

- 验证方法：

  - 打开上述文档与 PR 模板，检查新增段落存在且可导航
  - 新建 PR 草稿，验证模板出现“变更说明”“严格模式核对”“E2E 验证与产物”区块

- 回滚方案：

  - git revert 文档与模板变更提交，还原到上一版

- 影响范围：

  - 研发流程与 PR 自检门槛提升；不影响运行逻辑

- 标题：补充 safe_upsert_measurement_local（UTF-8 + extra->>'tz'）与演示造数脚本

- 原因：文档要求在阶段1进行最小造数验证，需提供可执行函数与脚本

- 内容：

  - scripts/sql/safe_upsert_measurement_local.sql：加入 SET client_encoding UTF8；读取 dim_stations.extra->>'tz'
  - scripts/dev/seed_minimal_demo.sql：新增、能在 dev 快速造数并完成对齐检查

- 验证：已在本机 dev 成功执行，not_aligned=0

- 回滚：DROP FUNCTION public.safe_upsert_measurement_local；DELETE 演示数据

- 回滚方案：

  - git revert 对应提交，恢复至变更前版本
  - 暂时关闭 memory-index 钩子（如需紧急合并），待修复后再开启

- 风险评估：低；变更均为本地开发工具链与生成脚本，不影响生产数据

- 监控指标：

  - PR/CI 通过率、pre-commit 报告稳定性

- 参考链接：PROJECT_RULES.md §4/§6，scripts/dev/pcv.ps1，scripts/tools/memory_index.py，docs/PLAYBOOKS/INDEX.md

______________________________________________________________________

______________________________________________________________________

## id: CONF-20250819-011 date: 2025-08-19 module: docs|process change_type: modify environment: dev risk_level: low rollback_plan: 'git revert 对应提交；恢复旧规范与模板' tags: \[ 'documentation','process','MCP','strict-mode' \]

- 变更标题：启用“使用 MCP 工具”行为规范（强制）

- 变更原因：将“任务分解—信息获取—执行—验证—审计”的流程标准化，降低遗漏与误操作风险

- 变更内容：

  - docs/智能助手行为控制.md：新增“使用 MCP 工具（强制规则）”章节
  - docs/严格模式-核对清单.md：加入“使用任务清单管理（MCP）”“低成本验证（MCP）”
  - .github/PULL_REQUEST_TEMPLATE.md：新增“## MCP 使用（必选）”区块

- 验证方法：

  - 打开上述文档检查章节存在并可导航
  - 新建 PR 草稿查看 MCP 勾选区块是否出现

- 回滚方案：

  - git revert 文档与模板变更提交，还原到上一版

- 影响范围：

  - 提交与评审流程更规范；不影响业务运行

## id: CONF-20250818-005 date: 2025-08-18 module: docs change_type: modify environment: dev risk_level: low rollback_plan: 'git revert 此次提交，恢复变更前文档并回滚引用' tags: \['documentation','ingest','logging','ops'\]

- 变更标题：方案A文档重排与规范强化（流程/结构/日志/规则/贡献指南）
- 变更原因：CSV 高性能导入落地，确保规范一致、职责清晰、可审查
- 变更内容：
  - 程序工作流程：重排 + 配置片段示例 + UTC周界窗口 \[start,end)
  - 表结构与数据库：附录A + 合并 SQL 示例
  - 编码规范：目录规范（方案A）+ 典型文件清单 + 并发/背压契约 + CSV 入契约 + 配置优先级
  - 日志规范：上下文自动补全 + 事件命名扩展 + 背压日志示例
  - 日志运维：迁移证据留存与检索/排障清单
  - 数据库函数参考：集合式合并 vs 函数写入边界
  - 导航：方案A短描述
  - 规则/贡献：导入与日志强制规范、导入模块贡献指南
- 验证方法：pre-commit run --all-files 全绿；人工校验链接与章节编号
- 回滚方案：git revert 当前提交
- 风险评估：低（仅文档）

______________________________________________________________________

## id: CONF-20250820-001 date: 2025-08-20 module: docs|process change_type: modify environment: dev risk_level: low rollback_plan: 'git revert 文档更新；恢复到未声明默认工具的版本' tags: \['documentation','MCP','process'\]

- 变更标题：在多处文档声明默认启用 Context 7 与 Sequential thinking
- 变更原因：统一规范，让编码阶段默认走“检索→规划→验证”的闭环
- 变更内容：
  - docs/智能助手行为控制.md：在“使用 MCP 工具（强制规则）”下新增“默认启用工具集（MCP）”条款
  - docs/开发环境-DevSuiteMCP-接入指南.md：新增“默认工具说明”章节
  - docs/VSCode-Augment-MCP-Docker-使用指南.md：新增“默认工具说明”章节
  - docs/严格模式-核对清单.md：新增“MCP 默认工具确认”检查项
- 验证方法：打开上述文档，看到新增章节与条款
- 回滚方案：git revert 本次提交
- 风险评估：低（仅文档变更）

## 2025-08-19

- 新增 Settings.ingest.enhanced_source_hint=True（可配置关闭）；Settings.merge.segmented.enabled=True, granularity='1h'（可配置关闭与调节）。
- CLI 新增 data-report 命令（只读）。

______________________________________________________________________

## id: CONF-20250820-002 date: 2025-08-20 module: docs|tooling change_type: remove environment: dev risk_level: low rollback_plan: 'git revert 此次提交，恢复被删除的脚本与文档' tags: \['dev-suite','docker','mcp-server','documentation'\]

- 变更标题：移除 dev-suite MCP 相关内容（脚本与 Docker 文件）
- 变更原因：不再维护 dev-suite MCP 服务端与 Docker 方案
- 变更内容：
  - 删除 scripts/mcp/dev_suite_server.py、scripts/mcp/dev_suite_server.cmd
  - 删除 scripts/docker/build_dev_suite.ps1、scripts/docker/run_dev_suite.ps1
  - 删除 docker/dev-suite.Dockerfile
  - 文档：移除 docs/智能助手行为控制.md 中对“Dev-Suite MCP 接入指南”的导航；文档地图标注“已移除 dev-suite 说明”
- 验证方法：全局搜索 dev_suite/dev-suite 无匹配（或仅保留历史 PLAYBOOKS 记录）
- 回滚方案：git revert 恢复以上文件与链接
- 风险评估：低（仅工具与文档移除，不影响业务逻辑）

______________________________________________________________________

## id: CONF-20250820-003 date: 2025-08-20 module: logging change_type: add environment: dev risk_level: low rollback_plan: 'git revert 此次提交' tags: \['logging','observability','sampling'\]

- 变更标题：里程碑2 埋点与模板细化（ingest.load.\* / align.merge.window 扩展 / task.summary 汇总）
- 变更内容：
  - 新增 app/utils/logging_ext.py，提供 JsonFormatter/EventLogger/SamplingGate/TaskSummaryCollector 与埋点 helper
  - 更新 docs/日志规范.md：补充“事件字段表与示例片段”，加入 rows_read/bytes/rows_per_sec/batch_cost_ms、affected_rows/dedup_ratio、task.summary 汇总
  - 新增 tests/test_logging_ext.py，验证采样节流与 JSON 结构
- 验证：pytest 全量通过（18 passed, 4 skipped）；样例日志见 docs/日志规范.md
- 风险与回滚：仅新增与文档修改，低风险；如需回滚，直接 revert 提交

______________________________________________________________________

## id: CONF-20250820-004 date: 2025-08-20 module: docs|process change_type: modify environment: dev risk_level: low rollback_plan: 'git revert 提交' tags: \['documentation','process','MCP'\]

- 变更标题：在行为约束增加规则——必须使用 MCP 工具提升效率与一致性
- 变更内容：
  - 更新 docs/智能助手行为控制.md，在“信息与执行策略”段落新增“效率提升与一致性（新增）”条目，明确要求使用 MCP 工具（Context 7 + Sequential thinking）
- 验证：打开上述文档查看新增条目；PR 模板含“【必选】MCP 默认工具确认”与严格模式清单对应
- 风险与回滚：低；如需回滚，git revert 本次提交

______________________________________________________________________

## id: CONF-20250820-005 date: 2025-08-20 module: process|templates change_type: modify environment: dev risk_level: low rollback_plan: 'git revert 提交' tags: \['PR-template','MCP','process'\]

- 变更标题：PR 模板细化 MCP 豁免说明（要求替代验证与风险评估）
- 变更内容：
  - 更新 .github/PULL_REQUEST_TEMPLATE.md 的“【必选】MCP 默认工具确认”区块，将“豁免说明”补充为“需提供替代验证证据与风险评估”
  - 更新 docs/严格模式-核对清单.md：在“六、MCP 默认工具确认”新增“若豁免：已提供替代验证证据与风险评估，并在 PR 模板‘豁免说明’中记录”核对项
- 验证：打开 PR 模板查看新增文案；打开 docs/严格模式-核对清单.md 查看新增核对项；新建 PR 时应显示该要求
- 风险与回滚：低；如需回滚，git revert 本次提交

______________________________________________________________________

## id: CONF-20250820-006 date: 2025-08-20 module: logging|ingest|merge change_type: modify environment: dev risk_level: low rollback_plan: 'git revert 提交' tags: \['observability','task.summary','sampling','slow-sql'\]

- 变更标题：run_all 使用 TaskSummaryCollector 统一 task.summary，并新增慢 SQL Top 与背压次数
- 变更内容：
  - app/services/ingest/run_all.py：引入 TaskSummaryCollector/SqlStat/log_task_summary，归一 rows_total/rows_merged/rows_per_sec/duration_ms/backpressure_count/slow_sql_top
  - 从 sql.ndjson 汇总 db.exec.succeeded 的 sql_cost_ms Top-5，形成 slow_sql_top
  - 参数化 progress 采样：使用 settings.logging.sampling.loop_log_every_n；最小时间间隔内置 1s
  - docs/测试指南.md：新增“如何通过 run_all 验证进度与合并埋点”章节
  - docs/日志规范.md：新增“配置采样参数”小节
- 验证：pytest -q 全部通过；运行 run_all 后检查 summary.json 与 app.ndjson/task.summary、sql.ndjson/db.exec.succeeded
- 风险与回滚：低；如需回滚，git revert 本次提交

______________________________________________________________________

## id: CONF-20250820-007 date: 2025-08-20 module: logging|ingest|run-all change_type: modify environment: dev risk_level: low rollback_plan: 'git revert 提交' tags: \['observability','sampling','slow-sql','docs'\]

- 变更标题：开放采样最小间隔/慢 SQL Top-N 配置，并补齐文档示例
- 变更内容：
  - app/core/config/loader.py：新增 logging.sampling.min_interval_sec、logging.sql.top_n_slow；解析 YAML 并提供默认
  - app/services/ingest/copy_workers.py：采样节流使用 settings.logging.sampling.min_interval_sec
  - app/services/ingest/run_all.py：slow_sql_top 的 Top-N 从 settings.logging.sql.top_n_slow 读取
  - docs/日志规范.md：新增 align.merge.window 完整 JSON 示例与采样参数章节
  - docs/测试指南.md：补充 slow SQL Top-N 可配置说明
- 验证：pytest -q 全部通过；手动检查配置读取与日志输出字段一致
- 风险与回滚：低；如需回滚，git revert 本次提交


______________________________________________________________________

## id: CONF-20250820-008 date: 2025-08-20 module: config|logging|ingest|db change_type: modify environment: dev risk_level: low rollback_plan: 'git revert 提交，恢复 loader 与示例 YAML；撤回接入改动' tags: [ 'config','loader','logging','ingest','database' ]

- 变更标题：配置结构扩展与接入（DB pool/timeouts/retry；日志 rotation/formatting/performance/采样；导入 csv/batch/error_handling/performance）
- 变更原因：统一配置分层规则与默认值，提供更细粒度的可观测与吞吐管理能力，减少硬编码
- 变更内容：
  - Settings.db：新增 pool(min/max/max_inactive_connection_lifetime)、timeouts(connect/statement/query)_ms、retry(max_retries/retry_delay_ms/backoff_multiplier)
  - Settings.logging：新增 rotation(max_bytes/backup_count/rotation_interval)、formatting(timestamp_format/max_message_length/field_order)、performance(buffer_size/flush_interval/async_handler_queue_size)、采样扩展(default_rate/high_frequency_events/burst_limit)
  - Settings.ingest：新增 csv(delimiter/encoding/quote_char/escape_char/allow_bom)、batch(size/max_memory_mb/parallel_batches)、error_handling(max_errors_per_file/error_threshold_percent/continue_on_error)、performance(read/write_buffer_size/connection_pool_size)
  - 更新示例 YAML：configs/database.yaml、configs/logging.yaml、configs/ingest.yaml
  - 接入点：logging.init 支持轮转/队列处理/时间戳格式；db.gateway 支持连接/语句超时与简单重试；ingest 读取 CSV 方言与批大小/错误阈值
- 验证方法：pytest -q；运行 run-all 检查 logs/runs/<job>/env.json、app.ndjson/sql.ndjson/perf.ndjson 结构
- 回滚方案：
  1) 还原 app/core/config/loader.py 到扩展前版本
  2) 还原 configs/*.yaml 到扩展前内容
  3) 还原 adapters.logging/db/ingest 接入点改动
- 影响范围：日志初始化、数据库连接与 COPY 导入流程；不影响数据库表结构
