# 改进与优化记录（增量）

## id: IMP-20250820-011 date: 2025-08-20 module: ingest|logging change_type: improve
- 标题：事件常量集中化 + 事件级采样接入 + 背压 enter/exit 结构化埋点
- 动机：减少魔法字符串，降低维护成本；降低高频事件日志量；提升背压观测性
- 变更：
  - 新增 app/utils/logging_ext.py 中的事件常量与 get_event_sampling_rate()
  - ingest.copy.batch 按事件级采样；backpressure.enter/exit 结构化埋点
  - 文档更新：docs/日志规范.md（7.1/7.2），docs/配置说明.md（backpressure.thresholds）
- 验证：pytest -q 25 passed；查看 perf/root 日志包含新事件与采样生效
- 风险：极低；采样降低日志量但不影响统计正确性（非关键计量项）

______________________________________________________________________

## id: IMP-20250816-005 date: 2025-08-16 area: data-quality | db-functions | tests summary: 增强时间对齐与本地时间写入支持，新增整秒对齐约束与集成测试

- 痛点：CSV/本地时间写入导致时间不对齐、冲突合并不生效
- 动作：
  - ARCHITECTURE_PLAN_v1.md 第16节补充“时间对齐规范”与示例
  - API_FUNCTIONS_REFERENCE.md 增加“时间对齐与时区语义”
  - 新增 scripts/sql/constraints_time_alignment.sql、safe_upsert_measurement_local.sql
  - 新增 tests/integration/test_time_alignment_and_conflict.py 回归用例
- 效果：所有写入统一 UTC 秒级对齐；同秒主键冲突合并；可回归验证

# IMPROVEMENTS（改进与优化记录）

______________________________________________________________________

## id: IMP-20250816-006 date: 2025-08-16 area: docs summary: 文档体系中文化重构与导航整合（不继承旧错误内容）

- 动作：
  - 新建中文文档与导航；将英文旧文档归档至 docs/\_archive/2025-08-16/
  - 统一“数据库为事实源、UTC秒级对齐、APScheduler、不用Docker/Kafka、可选Redis3.0.504”
- 效果：
  - 文档入口统一、互链清晰、与数据库事实一致；便于后续扩展与审计

目的：记录工程、性能、可维护性与可用性的改进，形成可复用经验。

## 记录模板（复制使用）

______________________________________________________________________

## id: IMP-YYYYMMDD-001 date: YYYY-MM-DD module: ingest | align | validate | derive | fit | optimize | viz | infra | docs impact: perf | maintainability | usability | reliability | security tests_added: true | false pr: '' adr: '' tags: \[ 'perf', 'chunksize', 'bulk-insert' \]

- 场景/痛点：
- 改进内容：
- 效果/指标：
- 验证方式：
- 影响范围：
- 参考链接：

## 记录

______________________________________________________________________

## id: IMP-20250115-001 date: 2025-01-15 module: docs impact: maintainability tests_added: false pr: '' adr: '' tags: \[ 'docs', 'schema', 'alignment', 'consistency', 'database' \]

- 场景/痛点：实际数据库实施与规范文档不一致，开发时需要对比多个文件才能确定正确的字段结构和策略
- 改进内容：统一更新 DATA_SPEC.md、ALIGNMENT_POLICY.md、DERIVATIONS.md、SCHEMA_AND_DB.md，使其与实际数据库表结构完全一致
- 效果/指标：文档与实施 100% 一致，字段定义统一使用 metric_id、ts_raw、ts_bucket 等实际字段名
- 验证方式：对比 scripts/create_tables_clean.sql 与更新后的文档描述
- 影响范围：docs/DATA_SPEC.md, docs/ALIGNMENT_POLICY.md, docs/DERIVATIONS.md, docs/SCHEMA_AND_DB.md
- 参考链接：scripts/create_tables_clean.sql, fact_measurements 表结构, dim_metric_config 表设计

______________________________________________________________________

## id: IMP-20250115-002 date: 2025-01-15 module: infra impact: maintainability tests_added: false pr: '' adr: '' tags: \[ 'database', 'schema', 'postgresql', 'partitioning', 'performance' \]

- 场景/痛点：海量时序数据存储与查询性能需求，需要支持按泵站并发写入与按时间范围高效查询
- 改进内容：设计并实施 PostgreSQL 分区策略：按周 RANGE 分区 + station_id HASH 子分区（16片），建立覆盖索引
- 效果/指标：支持高并发写入，查询性能优化，自动分区管理
- 验证方式：成功创建分区函数 ensure_week_partition()，预创建未来12周分区
- 影响范围：fact_measurements 表设计，查询性能，数据导入策略
- 参考链接：scripts/create_tables_clean.sql, ensure_week_partition() 函数

______________________________________________________________________

## id: IMP-20250115-003 date: 2025-01-15 module: docs impact: usability tests_added: false pr: '' adr: '' tags: \[ 'memory', 'playbooks', 'knowledge-management', 'automation' \]

- 场景/痛点：重要变更后容易遗忘记录，导致知识流失和重复犯错
- 改进内容：建立 PLAYBOOKS 自动记录机制，通过关键词"PLAYBOOKS"触发三步流程：更新记录、保存记忆、更新文档
- 效果/指标：确保每次重要变更都有完整记录，提升知识沉淀效率
- 验证方式：成功建立记忆机制，完成首次完整记录流程
- 影响范围：所有模块的变更记录，长期知识管理
- 参考链接：docs/PLAYBOOKS/错误与修复记录.md, docs/PLAYBOOKS/改进与优化记录.md

______________________________________________________________________

## id: IMP-20250815-001 date: 2025-08-15 module: ingest impact: perf tests_added: true pr: '' adr: '' tags: \[ 'perf', 'chunksize', 'bulk-insert' \]

- 场景/痛点：端到端运行耗时较长
- 改进内容：CSV 分块读取 + 批量写入
- 效果/指标：总体耗时下降 40%
- 验证方式：对同一数据集前后对比性能测试
- 影响范围：ingest、SCHEMA_AND_DB
- 参考链接：docs/SCHEMA_AND_DB.md

______________________________________________________________________

## id: IMP-20250816-001 date: 2025-08-16 module: optimize impact: perf tests_added: false pr: '' adr: 'DEC-20250816-007' tags: \[ 'materialized-view', 'aggregation', 'scheduling', 'query-rewrite', 'observability' \]

- 场景/痛点：看板与报表查询在事实表上执行成本高、延迟不稳定
- 改进内容：
  - 建立小时/天两个物化视图蓝本与刷新函数
  - 创建并发刷新所需唯一索引，首次刷新采用“先非并发、后并发”方式
  - 建立计划任务：小时级每15分钟刷新；天级每日02:30刷新
  - 提供查询改写样例与接口：get_metrics_daily()/get_metrics_hourly()
  - 基于 pg_stat_statements 的命中率审计视图
- 效果/指标：为后续查询改写提供缓存层；当前 mv 行数为0（无源数据时正常），命中率视图已上线
- 验证方式：手动试运行计划任务与刷新；查询命中率视图；函数签名与索引校验
- 影响范围：reporting、monitoring schema；计划任务；查询路径
- 参考链接：scripts/mv_blueprints.sql, scripts/refresh_mv_hourly.bat, scripts/refresh_mv_daily.bat, scripts/query_rewrite_examples.sql, scripts/get_metrics_hourly.sql, scripts/mv_hit_audit.sql

______________________________________________________________________

## id: IMP-20250816-002 date: 2025-08-16 module: optimize impact: usability tests_added: false pr: '' adr: 'DEC-20250816-007' tags: \[ 'query-rewrite', 'api', 'filtering', 'mv' \]

- 场景/痛点：看板查询需要按多个站点/设备/指标组合过滤，手写 SQL 成本高且易出错
- 改进内容：新增多维过滤函数
  - reporting.get_metrics_daily_multi(station_ids, start_date, end_date, device_ids?, metric_ids?)
  - reporting.get_metrics_hourly_multi(station_ids, start_ts, end_ts, device_ids?, metric_ids?)
- 效果/指标：统一接口、便于前端/应用层直接调用，默认命中 MV，降低事实表压力
- 验证方式：函数创建成功；签名校验；在有数据时可对比调用前后延迟
- 注意事项：
  - 参数顺序中，非默认参数在前，默认数组参数在后（PostgreSQL 要求）
  - 时间参数按粒度截断（小时级对齐到整点）
- 参考链接：scripts/get_metrics_multi.sql, scripts/query_rewrite_examples.sql, scripts/get_metrics_hourly.sql

______________________________________________________________________

## id: IMP-20250816-003 date: 2025-08-16 module: optimize impact: usability tests_added: false pr: '' adr: 'DEC-20250816-007' tags: \[ 'api', 'crud', 'query-rewrite', 'mv' \]

- 场景/痛点：应用层需要统一、易用且高性能的读写接口
- 改进内容（精简汇总）：
  - 聚合查询接口：
    - reporting.get_metrics_daily()/hourly()/daily_multi()/hourly_multi()
    - 视图：reporting.v_metrics_daily
  - 命中率观测：monitoring.v_mv_hit_audit
  - 明细 CRUD 接口（api schema）：
    - 查询：api.get_measurements(...)
    - 写入：api.upsert_measurement(...), api.upsert_measurements_json(jsonb)
    - 更新：api.update_measurement_value(...)
    - 删除：api.delete_measurements_by_filter(...), api.delete_measurement(...)
- 效果/指标：统一接口降低调用方复杂度；默认命中 MV；批操作具备限流与容错
- 验证方式：函数签名校验、样例调用、pg_stat_statements 观测
- 参考链接（脚本）：
  - scripts/query_rewrite_examples.sql, scripts/get_metrics_hourly.sql, scripts/get_metrics_multi.sql
  - scripts/mv_hit_audit.sql
  - scripts/api_crud.sql

______________________________________________________________________

## id: IMP-20250816-004 date: 2025-08-16 module: docs impact: maintainability | perf tests_added: false pr: '' adr: 'DEC-20250816-007' tags: \[ 'documentation', 'consistency', 'benchmarking', 'explain-analyze', 'playbooks' \]

- 场景/痛点：文档缺乏统一的上下文链接，A/B 验证报告缺少更细粒度的执行计划与缓冲观测指导
- 改进内容：
  - 在 API_FUNCTIONS_REFERENCE.md 增加“上下文链接与追踪”章节，统一导航到架构/测试/性能/PLAYBOOKS
  - 在 PERF_BENCHMARKING.md 增加“EXPLAIN/ANALYZE 步骤”以支持更细粒度 A/B 诊断
- 效果/指标：提升文档可导航性与可操作性；A/B 报告包含执行计划与缓冲指标
- 验证方式：打开两份文档可见新增章节；按示例命令可复现实验
- 参考链接：docs/API_FUNCTIONS_REFERENCE.md, docs/PERF_BENCHMARKING.md

______________________________________________________________________

## id: IMP-20250816-008 date: 2025-08-16 area: docs | db-docs summary: 新增“泵站时间对齐实现”文档；自动采集字段/函数清单；补齐计划文档 32/33/34/35/37

- 动作：创建 docs/泵站时间对齐实现.md 并加入文档导航；生成 docs/\_columns.tsv 与 docs/\_routines.tsv 并补写到中文文档；补齐架构落地计划 5 章
- 效果：时间对齐链路清晰、文档与数据库事实一致，便于审查与扩展

______________________________________________________________________

## id: IMP-20250817-009 date: 2025-08-17 area: tooling | quality summary: 本地质量门禁稳定全绿；pcv.ps1 UTF-8 无乱码；memory_index 幂等兼容 mdformat

- 场景/痛点：pre-commit 中 memory-index 与 mdformat 来回改写导致循环失败；PowerShell 控制台中文乱码影响可读性
- 改进内容：
  - pcv.ps1 将 UTF-8 设置前移并兼容 PS5；输出中文无乱码
  - memory_index：导航区语义比较、表头识别兼容、转义对齐与稳定换行，避免反复写入
  - VSCode 保存即修复策略改为 explicit，减少无意触发
- 效果/指标：pre-commit 本地全绿稳定；pcv.ps1 输出中文正常；导航索引不再反复改写
- 验证方式：多次运行 pcv.ps1 与 pre-commit 全量体检，均通过

______________________________________________________________________

## id: IMP-20250817-010 date: 2025-08-17 area: db | ingest summary: 补齐 safe_upsert_measurement_local（按 extra->>'tz'）与最小造数脚本

- 动机：文档与实现对齐；在 dev 环境做阶段1验证需写入少量数据

- 变更：

  - 修正 safe_upsert_measurement_local 读取时区为 dim_stations.extra->>'tz'
  - seed_minimal_demo.sql：解决 CTE 歧义、同秒 UPSERT 合并、main_pipeline 小写
  - generate_seed_from_mapping.py：生成 SQL 时统一编码与类型约束

- 验证：最小造数脚本执行成功，not_aligned=0；计数与示例符合预期

- 影响：入库函数与脚本更贴合当前表结构与文档

- 影响范围：开发体验、文档索引一致性、CI 通过率

- 参考链接：scripts/dev/pcv.ps1, scripts/tools/memory_index.py, docs/PLAYBOOKS/INDEX.md

______________________________________________________________________

## id: IMP-20250819-011 date: 2025-08-19 module: docs impact: maintainability tests_added: false pr: '' adr: '' tags: \[ 'docs','governance','MCP','navigation' \]

- 场景/痛点：开发流程中对 MCP 的使用分散在多处，执行时容易遗漏“任务分解/受影响范围自检/最小验证/文档同步”步骤
- 改进内容：
  - 在 docs/程序工作流程.md 与 docs/编码规范.md 中新增 MCP 提醒（实施前先分解与自检，实施后最小验证与文档/PLAYBOOKS 同步）
  - 与行为规范 docs/智能助手行为控制.md 的“使用 MCP 工具（强制规则）”形成互链
- 效果/指标：流程一致性提升；新同学按文档即可遵循 MCP 流程；PR 自检更聚焦
- 验证方式：打开上述文档可见 MCP 提示与链接；PR 模板出现 MCP 勾选区块
- 影响范围：开发流程文档、评审习惯
- 参考链接：docs/智能助手行为控制.md、docs/程序工作流程.md、docs/编码规范.md、.github/PULL_REQUEST_TEMPLATE.md

## 2025-08-19 溯源/合并/报表 三项优化

- 溯源增强（B）：source_hint v2 上线，格式 data/相对路径|batch=\<run_id>|ver=2；默认开启，可配置回退；Windows 路径统一 as_posix。
- 分段合并（C）：新增 segmented 合并，默认 1h 粒度，支持关闭回退；新增解析与切分函数并加单测；运行时延迟导入 DB 网关避免测试失败。
- 数据质量报表（D）：新增 data-report 命令，生成覆盖/拒绝 TopN 与越界样例 JSON 报表，输出至 logs/reports/\<run_id>/data_quality_report.json。
