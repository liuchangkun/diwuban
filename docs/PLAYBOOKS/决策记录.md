______________________________________________________________________

## id: DEC-20250816-008 date: 2025-08-16 scope: time-alignment | scheduling | interfaces summary: 统一按 UTC 秒级对齐、移除 Windows 计划任务、保留 APScheduler、提供本地时间 UPSERT 接口

- 背景：写入时间存在毫秒与不同时区混用，计划任务存在平台差异
- 决策：
  - 数据写入全部转换为 UTC，并在 DB 侧对齐到整秒（ts_bucket = date_trunc('second', ts_utc)）
  - 为 fact_measurements 及分区添加对齐 CHECK 约束（NOT VALID，后续 VALIDATE）
  - 提供 safe_upsert_measurement_local，支持“本地时间 + 站点时区 → UTC 秒对齐”
  - 调度统一使用 APScheduler（移除 Windows 计划任务）
- 影响：
  - 新老数据对齐校验需逐步清洗并 VALIDATE
  - 接口入参语义明确（可传带时区或本地时间 + 站点 tz）
  - 调度与部署更跨平台

# DECISIONS（技术决策记录）

______________________________________________________________________

## id: DEC-20250816-009 date: 2025-08-16 scope: docs-refactor summary: 文档体系中文化重构与归档迁移（采用方案A：归档旧英文 → 重建中文文档体系）

- 选择方案A：归档旧文档至 docs/\_archive/2025-08-16/；在 docs/ 下重建中文文档（文档地图、总览、计划、数据库、函数参考、测试、质量）
- 不继承旧文错误内容，所有事实以数据库与 scripts/sql 为准
- 导航与互链全部指向中文文档；英文旧文不再作为现行依据

目的：记录重要技术决策的背景、选项、权衡与结果，便于后续回顾与学习。

## 记录模板（复制使用）

______________________________________________________________________

## id: DEC-YYYYMMDD-001 date: YYYY-MM-DD module: ingest | align | validate | derive | fit | optimize | viz | infra | docs decision_type: architecture | technology | process | design | performance status: proposed | accepted | rejected | superseded stakeholders: \[ 'team_member1', 'team_member2' \] tags: \[ 'database', 'performance', 'architecture' \]

- 决策标题：一句话描述决策
- 背景与问题：为什么需要做这个决策
- 考虑的选项：
  - 选项A：描述 + 优缺点
  - 选项B：描述 + 优缺点
  - 选项C：描述 + 优缺点
- 决策结果：选择了哪个选项
- 决策理由：为什么选择这个选项
- 影响与后果：对系统/团队的影响
- 验证方式：如何验证决策正确性
- 回顾计划：何时重新评估
- 参考链接：相关文档/讨论/PR

## 记录

______________________________________________________________________

## id: DEC-20250815-004 date: 2025-08-15 module: infra decision_type: performance status: accepted stakeholders: \[ 'developer', 'user' \] tags: \[ 'database', 'postgresql', 'partitioning', 'indexing' \]

- 决策标题：活跃数据索引改为“叶子分区 btree 索引”，历史数据使用 BRIN 分区化索引
- 背景与问题：频繁 CRUD 工作负载下，父表部分索引需 IMMUTABLE 谓词，无法使用 now()；且在分区父表上部分索引不可直接满足活跃区查询加速需求
- 考虑的选项：
  - 选项A：父表部分索引（基于 now()）→ 不可行（谓词非 IMMUTABLE）
  - 选项B：父表统一 btree 索引 → 写放大、维护成本高
  - 选项C：叶子分区 btree 索引（仅近7天分区）+ 父表 BRIN(ts_bucket) 分区化索引（历史）→ 可行且维护成本低
- 决策结果：选择选项C
- 决策理由：
  - 保持活跃数据高性能查询/更新
  - 历史数据采用轻量 BRIN，减少索引空间和维护
  - 分区级别索引，避免全局索引的维护和锁影响
- 影响与后果：
  - 需要枚举近7天叶子分区进行索引创建与维护
  - 索引策略需随时间滚动更新
- 验证方式：
  - 成功创建父表 BRIN(ts_bucket) 分区化索引 idx_fm_brin_ts
  - 计划对近7天分区创建 (station_id, device_id, metric_id, ts_bucket) INCLUDE(value) 索引，并验证查询延迟
- 回顾计划：1 个月后评估活跃区索引收益与开销
- 参考链接：docs/PERFORMANCE_OPTIMIZATION.md, scripts/crud_optimization_functions.sql

______________________________________________________________________

## id: DEC-20250815-005 date: 2025-08-15 module: infra decision_type: performance status: accepted stakeholders: \[ 'developer', 'user' \] tags: \[ 'database', 'pg_stat_statements', 'observability' \]

- 决策标题：启用 pg_stat_statements 作为性能观测与优化依据
- 背景与问题：需要获取稳定的查询耗时/QPS/命中率指标以评估优化收益
- 考虑的选项：
  - 选项A：不启用，仅人工采样 → 数据片段化，难以长期对比
  - 选项B：启用 pg_stat_statements（需重启）→ 可持续观测，利于回归与容量规划
- 决策结果：选择选项B
- 决策理由：官方扩展、低成本、指标全面；长期演进需要
- 影响与后果：需在维护窗口重启数据库；共享预加载库配置变更
- 验证方式：CREATE EXTENSION pg_stat_statements; 查询视图 pg_stat_statements 存在并有数据
- 回顾计划：启用后两周评估指标粒度与开销
- 参考链接：docs/PERFORMANCE_OPTIMIZATION.md

______________________________________________________________________

## id: DEC-20250815-006 date: 2025-08-15 module: infra decision_type: design status: accepted stakeholders: \[ 'developer' \] tags: \[ 'database', 'partitioned-table', 'storage-parameters' \]

- 决策标题：分区表存储参数仅设置在叶子分区（不在父表）
- 背景与问题：PostgreSQL 不允许在分区父表上设置 fillfactor/autovacuum 等存储参数
- 考虑的选项：
  - 选项A：在父表设置 → 不被支持
  - 选项B：在所有叶子分区设置 → 被支持且行为符合预期
- 决策结果：选择选项B
- 决策理由：符合 PostgreSQL 约束与最佳实践；支持差异化（活跃分区/历史分区）调优
- 影响与后果：需要批量脚本按分区设置与滚动维护
- 验证方式：对叶子分区执行 ALTER TABLE ... SET (...)，参数生效
- 回顾计划：根据负载变化调整活跃/历史分区参数
- 参考链接：scripts/phase1_adjust_storage.sql

______________________________________________________________________

## id: DEC-20250115-001 date: 2025-01-15 module: infra decision_type: technology status: accepted stakeholders: \[ 'developer', 'user' \] tags: \[ 'database', 'postgresql', 'timescaledb' \]

- 决策标题：选择 PostgreSQL 而不是 TimescaleDB 作为数据库
- 背景与问题：需要选择适合海量时序数据存储的数据库方案
- 考虑的选项：
  - 选项A：PostgreSQL + TimescaleDB - 专业时序数据库，性能优秀，但需要安装扩展
  - 选项B：纯 PostgreSQL - 标准数据库，易于维护，但时序功能需要自建
  - 选项C：ClickHouse - 分析性能强，但行级更新复杂
- 决策结果：选择纯 PostgreSQL
- 决策理由：简化部署与维护，避免扩展依赖，当前数据量下性能足够
- 影响与后果：需要自建分区策略，但降低了系统复杂度
- 验证方式：成功实施周分区+子分区策略，性能满足需求
- 回顾计划：数据量增长10倍时重新评估
- 参考链接：docs/SCHEMA_AND_DB.md, scripts/create_tables_clean.sql

______________________________________________________________________

## id: DEC-20250115-002 date: 2025-01-15 module: infra decision_type: design status: accepted stakeholders: \[ 'developer', 'user' \] tags: \[ 'database', 'schema', 'metric_id' \]

- 决策标题：使用 metric_id 外键而不是 metric 文本字段
- 背景与问题：需要决定指标在事实表中的存储方式
- 考虑的选项：
  - 选项A：metric 文本字段 - 直观易读，但存储冗余，难以统一管理
  - 选项B：metric_id 外键 - 节省存储，便于统一配置，但需要关联查询
- 决策结果：选择 metric_id 外键
- 决策理由：便于统一管理指标配置（单位、策略），节省存储空间，提升查询性能
- 影响与后果：需要建立 dim_metric_config 表，查询时需要关联
- 验证方式：成功建立指标配置表，查询性能良好
- 回顾计划：无需回顾，设计稳定
- 参考链接：docs/SCHEMA_AND_DB.md, dim_metric_config 表设计

______________________________________________________________________

## id: DEC-20250115-003 date: 2025-01-15 module: infra decision_type: performance status: accepted stakeholders: \[ 'developer' \] tags: \[ 'database', 'partitioning', 'performance' \]

- 决策标题：采用周分区而不是月分区策略
- 背景与问题：需要为 fact_measurements 表选择合适的分区粒度
- 考虑的选项：
  - 选项A：月分区 - 分区数量少，管理简单，但单分区可能过大
  - 选项B：周分区 - 分区数量适中，便于维护，单分区大小可控
  - 选项C：日分区 - 分区数量多，管理复杂，但查询性能最优
- 决策结果：选择周分区
- 决策理由：平衡了分区数量与单分区大小，便于自动化管理
- 影响与后果：需要创建分区管理函数，但查询性能与维护性良好
- 验证方式：成功实施 ensure_week_partition() 函数
- 回顾计划：数据量评估后可调整为日分区
- 参考链接：ensure_week_partition() 函数, fact_measurements 分区设计

______________________________________________________________________

## id: DEC-20250816-007 date: 2025-08-16 module: optimize decision_type: performance status: accepted stakeholders: \[ 'developer', 'user' \] tags: \[ 'materialized-views', 'aggregation', 'query-acceleration', 'scheduling' \]

- 决策标题：第三阶段启动——构建汇总层（小时/天）与刷新机制，配合查询覆盖审计
- 背景与问题：看板/报表类查询需要低延迟，直接扫事实表成本高；需引入可控刷新与缓存
- 考虑的选项：
  - 选项A：仅实时查询事实表 → 高峰期延迟高、成本大
  - 选项B：物化视图汇总层（小时/天）+ 定时刷新 → 查询稳定、成本可控
  - 选项C：外部引擎（如 ClickHouse） → 引入额外系统复杂性
- 决策结果：选择选项B
- 决策理由：在现有 PostgreSQL 体系内即可落地，风险低；与现有分区策略相容
- 影响与后果：需维护刷新计划与失效窗口；需要配合查询改写（命中汇总层）
- 验证方式：创建 mv_blueprints.sql 蓝本与 refresh 函数；执行查询覆盖审计并形成建议
- 回顾计划：两周后评估汇总层命中率、刷新成本与查询延迟改进
- 参考链接：scripts/mv_blueprints.sql, scripts/query_coverage_audit.sql

## id: DEC-20250818-INGEST-PLAN-APP title: 在 app/ 目录下落地可运行导入程序（方案A） date: 2025-08-18

- 背景：用户要求在 app 目录下，按程序目录与架构落地可运行的 Python 导入程序
- 决策：维持方案A总体思路，新增工程化约束：
  - 在 app/ 下创建 ingest CLI（子命令：prepare-dim/create-staging/ingest:copy/merge:fact/refresh:mv/audit:mv/run-all）
  - 模块化：app/ingest/{cli,config,io,copy_workers,merge,logging,utils}
  - 配置参数来源：命令行+环境变量，默认 DSN 来自本地 dev
- 前置：待补充编码规范与日志功能要求后开始实现
- 影响：与 docs/程序工作流程.md 一致，便于团队直接本地运行与 CI 验证
