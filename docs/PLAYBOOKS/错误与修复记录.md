## 2025-08-19 修复 dev_suite_server.py IndentationError

- 影响范围：scripts/mcp/dev_suite_server.py
- 错误现象：运行脚本时报错 IndentationError: expected an indented block after 'except' statement on line 170
- 根因分析：tool_playbooks_write 中 try/except 的 except 分支缺少返回语句，导致 except: 后无可执行块；此外下方存在一行孤立缩进行（第338行）
- 修复措施：
  1. 在 except Exception as e: 下补充返回：返回 JSON 错误对象，包含异常类型与消息
  1. 移除第338行意外缩进的 return 语句
- 校验：python -m py_compile scripts/mcp/dev_suite_server.py 通过（exit code 0）
- 影响评估：仅为最小修复，不改变工具行为语义；新增的错误返回更清晰
- 后续建议：为脚本添加最小单元/集成测试，覆盖 --self-test 路径与 tools/call 主干

# 错误与修复记录（2025-08-18）

- 问题1：prepare_dim 向 dim_metric_config 仅插入 metric_key，违反 unit NOT NULL 约束；同时向 dim_mapping_items 仅插 station/device/metric，违反 mapping_hash/source_hint NOT NULL 约束。
  - 修复：
    - 新增默认单位映射 \_default_unit()；插入 dim_metric_config 时写入 (metric_key, unit, unit_display, decimals_policy='as_is')。
    - 建立映射时加入 mapping_hash=sha1("station::device::metric") 与固定 source_hint=e2e_test，改用名称字段。
- 问题2：设备类型校验失败（Main_pipeline 触发 chk_device_type）。
  - 修复：
    - 新增 \_normalize_device_type()，将 Main_pipeline 归一化为 main_pipeline；仅允许 {pump, main_pipeline, pipeline, unknown}。
- 问题3：copy_from_mapping 中引用未定义的 BackpressureController/Thresholds。
  - 修复：
    - 在 copy_workers.py 内实现 Thresholds dataclass 与 BackpressureController，支持基于 p95/失败率的批量调节；记录 perf 指标。
- 问题4：CSV 列头校验失败（BOM 与 DataTime 大小写/拼写），报 CSV列缺失。
  - 修复：
    - REQUIRED_COLS 使用 datatime（兼容 DataTime 列名），\_normalize 去除 BOM；读取时已兼容大小写。
- 问题5：JSON 日志格式化报 datetime 不可序列化。
  - 修复：
    - JsonFormatter.dumps 增加 default=str 以兼容 datetime/Path 等。

影响：

- 解决 run-all 首段维表准备与 COPY/合并链路的阻塞错误，流程可推进至 merge。
- 新增的默认单位与映射快照逻辑与 docs/表结构与数据库.md 一致。

后续：

- 运行端到端验证，检查 fact_measurements 与 staging_rejects 计数；补齐 dim_metric_config 其他字段值类型/范围策略（value_type/valid_min/max）。
- 优化 BackpressureController 的恢复/回升策略，加入自适应目标吞吐。
- 将 source_hint 使用实际文件路径标识（当前为 e2e_test）。

## 测试覆盖

- 新增 tests/test_reader_and_logging.py：
  - 覆盖 \_normalize 去 BOM、validate_header 对 DataTime/Datatime 的兼容
  - 覆盖 iter_rows 值解析
  - 覆盖 JsonFormatter 的 default=str 可序列化
  - 覆盖 BackpressureController 决策基础路径
- 将 BackpressureController/Thresholds 抽离至 app/services/ingest/backpressure.py，避免测试导入触发数据库依赖。

# 错误与修复记录（ERRORS & FIXES）

## id: FIX-20250818-001 date: 2025-08-18 module: ingest.prepare_dim impact: reliability status: open

- 症状：run-all 在 prepare-dim 阶段失败
- 触发命令：`python -m app.cli.main run-all config/data_mapping.v2.json --window-start 2000-01-01T00:00:00Z --window-end 2100-01-01T00:00:00Z --log-run --log-dir logs/runs/e2e4`
- 根因：向 dim_metric_config 插入时使用 `RETURNING metric_id`，而实际表主键列为 `id`；导致 UndefinedColumn 错误
- 影响范围：端到端导入中断（无法进入 COPY 与合并阶段）
- 修复方案（两选一）：
  1. 将 `RETURNING metric_id` 改为 `RETURNING id`
  1. 使用 `INSERT ... ON CONFLICT (metric_key) DO NOTHING;` 然后 `SELECT id FROM dim_metric_config WHERE metric_key=%s`
- 关联文档需更新：
  - docs/程序工作流程.md：统一使用 `config/data_mapping.v2.json`
  - docs/表结构与数据库.md：“合并 SQL 示例”将 `m.metric_id` 改为 `m.id` 或 `m.id AS metric_id`
- 验证：修复后再次执行 run-all，核对 logs/runs/.../sql.ndjson 与 perf.ndjson；随机抽样对齐自检

## 2025-08-18 补充记录：策略与追溯增强

- dim_metric_config：新增 \_default_policy 并通过 UPSERT + COALESCE 仅补齐缺失字段，不覆盖人工配置；与文档“默认策略与 UPSERT 规则”对齐。
- dim_mapping_items：source_hint 由固定 e2e_test 改为映射文件路径，提升追溯性。
- ensure partitions：在合并前自动确保周分区，并为每周创建 16 份 station_id HASH 子分区与索引，避免窗口落入无分区导致失败。
- 测试与合规：
  - 单元测试新增 metric_policy；integration 测试缺依赖时自动 importorskip 跳过。
  - 新增 config/data_mapping.json 以满足规则检查；保持 config/data_mapping.v2.json 作为真实导入清单。

## 2025-08-19：里程碑0 E2E 最小解锁（基线产出）

- 变更内容：run-all 收尾产出 summary.json（含 copy/merge 用时、背压 enter/exit、tz_fallback_count）并与 env.json 同步落盘；task.begin → task.summary 日志闭环。
- 验证窗口：\[2025-02-28T02:00:00Z, 2025-02-28T03:00:00Z)
- 验证结果：
  - env.json：包含 args_summary、config_snapshot、ts、run_id、run_dir（本次 run_id=20250819T015111Z）
  - summary.json：copy.files_total=112、rows_loaded=806400、rows_rejected=0；timing_ms.copy_total_ms=8730、merge_total_ms=93651；backpressure enter/exit=0；tz_fallback_count=0
- 产物位置：logs/runs/milestone0/env.json 与 logs/runs/milestone0/summary.json
- 影响范围：新增只读产物文件；为后续报表与验收提供基线
- 回滚方案：如需关闭 summary.json，可移除收尾写入（不建议）
