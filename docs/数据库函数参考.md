# 数据库函数参考

> 时间与对齐：写入统一 UTC，并在数据库侧对齐到整秒（ts_bucket = date_trunc('second', ts_utc)）。

- public
  - safe_upsert_measurement(station_id, device_id, metric_id, ts_raw timestamptz, value, source_hint) → boolean
  - safe_upsert_measurement_local(station_id, device_id, metric_id, ts_local timestamp, value, source_hint) → boolean
  - smart_vacuum_strategy()、auto_performance_tuning()、auto_space_reclaim()、database_health_check()
- reporting
  - get_metrics_daily/hourly/\_multi/auto，v_metrics_daily
- monitoring
  - capture_pgss_snapshot()/cleanup_pgss_snapshot()、v_mv_hit_audit、v_active_partitions/\_last7d/\_index_coverage、v_query_coverage、ensure_active_indexes(window_days)、run_ab_test(...)
- api
  - get_measurements(...)、upsert_measurement(...)、upsert_measurements_json(jsonb) → processed/succeeded/failed
  - update_measurement_value(...)、delete_measurement(...)、delete_measurements_by_filter(...)

时间对齐与时区语义：

- 入参 tz 优先；无 tz 则按泵站 dim_stations.tz；再无则默认 UTC
- 主键： (station_id, device_id, metric_id, ts_bucket)；同秒 UPSERT 合并
- CSV 建议：staging 用 timestamp（无时区），由函数完成 tz→UTC→整秒对齐

## 函数详解（自动采集于 2025-08-16）

文件：docs/\_routines.tsv（schema|routine|args|return_type|comment）

- 说明：如注释存在乱码，后续用 COMMENT ON FUNCTION 统一中文注释

### api

- upsert_measurement(p_station_id bigint, p_device_id bigint, p_metric_id bigint, p_ts_raw timestamptz, p_value numeric, p_source_hint text) → boolean
  - 用途：明细写入（UTC），秒级对齐与合并
  - 示例：`SELECT api.upsert_measurement(1,10,101, now(), 12.34, 'source');`
- upsert_measurements_json(p_rows jsonb) → record
  - 用途：批量写入（JSON 数组）
  - 示例：`SELECT api.upsert_measurements_json('[{"station_id":1,...}]'::jsonb);`
- get_measurements(... limit int default 1000, offset int default 0) → setof record
  - 用途：明细查询（分页）
- update_measurement_value(...), delete_measurement(...), delete_measurements_by_filter(...) → integer

### reporting

- get_metrics_daily/hourly/auto/\_multi(...) → setof record
  - 用途：汇总查询（命中 MV 或事实表），auto 根据阈值路由
  - 示例：`SELECT reporting.get_metrics_daily(1,'2025-08-01','2025-08-16', ARRAY[101]);`

### monitoring

- capture_pgss_snapshot(), cleanup_pgss_snapshot(retention_days int default 7) → integer
- ensure_active_indexes(window_days int default 7) → integer
- run_ab_test(...) → bigint（返回 run_id）
- 视图：v_mv_hit_audit, v_active_partitions, v_active_partitions_last7d, v_active_index_coverage, v_query_coverage

### public

- safe_upsert_measurement(...), safe_upsert_measurement_local(...), smart_vacuum_strategy(), auto_performance_tuning(), auto_space_reclaim(), database_health_check()

## 使用说明

## 集合式合并 vs 函数写入的边界（强制）

- 选择原则：

  - 小规模/实时（低吞吐、低并发）→ 可直接调用 safe_upsert_measurement/\_local（更简洁）
  - 大规模/批处理（高吞吐、大并发）→ 必须走 staging_raw + 集合式合并（COPY→UNLOGGED→库端一次性 JOIN/对齐/去重/UPSERT）

- 一致性约束：

  - 两种路径都必须满足 UTC 秒级对齐与主键 UPSERT；禁止从文件名/路径推断维度/指标（唯一来源：data_mapping.json）
  - 合并窗口边界按 UTC ISO 周界（周一 00:00:00），窗口 \[start, end)

- CSV 固定列与转换：

  - CSV 列固定为 TagName（变量名称）、DataTime（数据时间）、DataValue（数据值）；大小写兼容
  - 建议在集合式合并时按站点时区将 DataTime → ts_utc → ts_bucket（秒对齐），解析失败行沉淀到 staging_rejects

- 路径建议：

  - 新导入链路以集合式合并为主；函数写入主要用于增量修复、小量直写或实时单条入库

- 写入：优先调用 api.\* 或 public.safe_upsert\_\* 函数；入库对齐到秒

- 查询：reporting.\* 聚合优先；必要时 api.get_measurements 明细

- 运维：monitoring.\* 观测与审计；确保 pg_stat_statements 已启用

- 自检 SQL：SELECT count(\*) FROM public.fact_measurements WHERE date_trunc('second', ts_bucket) \<> ts_bucket;

## 数据入库契约与示例（与《程序工作流程》一致）

- 契约

  - 维度准备：dim_stations、dim_devices、dim_metric_config、dim_mapping_items 已根据 data_mapping.json 生成
  - 时间与对齐：UTC + 秒级对齐（ts_bucket = date_trunc('second', ts_utc)）
  - 主键： (station_id, device_id, metric_id, ts_bucket)，同秒 UPSERT 合并
  - 时区优先级：入参 tz > dim_stations.extra->>'tz' > 默认 UTC
  - 禁止使用 CSV 文件名/路径推断维度/指标

- 示例

  - UTC 写入：
    - SELECT public.safe_upsert_measurement(1, 10, 101, '2025-08-16T12:00:00Z', 12.34, 'ingest');
  - 本地时间写入（按站点时区转换）：
    - SELECT public.safe_upsert_measurement_local(1, 10, 101, '2025-08-16 20:00:00', 12.34, 'ingest');

- 参考

  - 文档：docs/程序工作流程.md、docs/泵站时间对齐实现.md
  - 表结构：docs/表结构与数据库.md

更多逐函数详解，请见：docs/逐函数详解_附录.md
