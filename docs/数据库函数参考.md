# 数据库函数参考

> 状态板（2025-08-18）：集合式合并链路使用标准 schema（config/data_mapping.v2.json）；run-all 待修 prepare-dim 中 dim_metric_config 返回列；函数写入契约与对齐规则不变。参考会话快照：docs/PLAYBOOKS/SESSION_SNAPSHOT_2025-08-18.md。

> 时间与对齐：写入统一 UTC，并在数据库侧对齐到整秒（ts_bucket = date_trunc('second', ts_utc)）。

- public（数据库实况，2025-08-28 查询）
  - get_device_metrics_by_time_range(device_id bigint, start_ts timestamptz, end_ts timestamptz, limit integer) → (record_timestamp timestamptz, metrics_data jsonb, total_records bigint)
  - get_station_devices_metrics_by_time_range(station_id bigint, start_ts timestamptz, end_ts timestamptz, limit integer) → (record_timestamp timestamptz, metrics_data jsonb, total_records bigint)
  - safe_upsert_measurement(station_id bigint, device_id bigint, metric_id bigint, ts_raw timestamptz, value numeric, source_hint text) → boolean
  - safe_upsert_measurement_local(station_id bigint, device_id bigint, metric_id bigint, ts_local timestamp, value numeric, source_hint text) → boolean
  - smart_vacuum_strategy() → text
  - auto_performance_tuning() → text
  - auto_space_reclaim() → text
  - database_health_check() → record
- 其他 schema（以实际数据库为准；当前实例检测到 monitoring/reporting 相关函数与视图，详见 docs/\_archive/reports/db_schema_snapshot.md）

时间对齐与时区语义：

- 入参 tz 优先；无 tz 则按泵站 dim_stations.tz；再无则默认 UTC
- 主键： (station_id, device_id, metric_id, ts_bucket)；同秒 UPSERT 合并
- CSV 建议：staging 用 timestamp（无时区），由函数完成 tz→UTC→整秒对齐

## 函数详解（自动采集于 2025-08-16）

文件：docs/\_routines.tsv（schema|routine|args|return_type|comment）

- 说明：如注释存在乱码，后续用 COMMENT ON FUNCTION 统一中文注释

### api

- upsert_measurement(p_station_id bigint, p_device_id bigint, p_metric_id bigint, p_ts_raw timestamptz, p_value numeric, p_source_hint text) → boolean
  - 用途：明细写入（UTC），秒级对齐与合并
  - 示例：`SELECT api.upsert_measurement(1,10,101, now(), 12.34, 'source');`
- upsert_measurements_json(p_rows jsonb) → record
  - 用途：批量写入（JSON 数组）
  - 示例：`SELECT api.upsert_measurements_json('[{"station_id":1,...}]'::jsonb);`
- get_measurements(... limit int default 1000, offset int default 0) → setof record
  - 用途：明细查询（分页）
- update_measurement_value(...), delete_measurement(...), delete_measurements_by_filter(...) → integer

### reporting

- get_metrics_daily/hourly/auto/\_multi(...) → setof record
  - 用途：汇总查询（命中 MV 或事实表），auto 根据阈值路由
  - API 现状：聚合端点统一调用 get_metrics_auto_multi，由数据库端决定小时/天
  - 示例：`SELECT reporting.get_metrics_daily(1,'2025-08-01','2025-08-16', ARRAY[101]);`

### monitoring

- capture_pgss_snapshot(), cleanup_pgss_snapshot(retention_days int default 7) → integer
- ensure_active_indexes(window_days int default 7) → integer
- run_ab_test(...) → bigint（返回 run_id）
- 视图：v_mv_hit_audit, v_active_partitions, v_active_partitions_last7d, v_active_index_coverage, v_query_coverage

### public

- safe_upsert_measurement(...), safe_upsert_measurement_local(...), smart_vacuum_strategy(), auto_performance_tuning(), auto_space_reclaim(), database_health_check()

## 集合式合并与分段策略（对齐实现）

- run_merge_window：对一个 UTC 窗口执行去重与 UPSERT；进入前尽力确保周分区与子分区存在
- 分段合并：merge.segmented.enabled=true 时，按 granularity（如 1h）拆分 \[start,end) 窗口并依次执行
- 失败诊断：
  - db.exec.failed：sql.log 含 error 与（在 explain=on_error 时）EXPLAIN 文本摘要（截断）
  - 建议：先检查维表/映射是否完整，再检查时间格式解析与 tz 配置

## 日志事件与诊断（db.exec.\*）

- started：sql_op、target_table、window_start/window_end、window_size_seconds
- succeeded：affected_rows、sql_cost_ms；window_start/window_end
- failed：error、sql_cost_ms、explain（可选）
- 指标来源（实现）：
  - affected_rows/成本来自游标执行后的 rowcount 和 perf_counter 计时
  - 分段合并的窗口参数来自 settings.merge.segmented 配置

## 使用说明

## 集合式合并 vs 函数写入的边界（强制）

- 选择原则：

  - 小规模/实时（低吞吐、低并发）→ 可直接调用 safe_upsert_measurement/\_local（更简洁）
  - 大规模/批处理（高吞吐、大并发）→ 必须走 staging_raw + 集合式合并（COPY→UNLOGGED→库端一次性 JOIN/对齐/去重/UPSERT）

- 一致性约束：

  - 两种路径都必须满足 UTC 秒级对齐与主键 UPSERT；禁止从文件名/路径推断维度/指标（唯一来源：data_mapping.json）
  - 合并窗口边界按 UTC ISO 周界（周一 00:00:00），窗口 \[start, end)

- CSV 固定列与转换：

  - CSV 列固定为 TagName（变量名称）、DataTime（数据时间）、DataValue（数据值）；大小写兼容
  - 建议在集合式合并时按站点时区将 DataTime → ts_utc → ts_bucket（秒对齐），解析失败行沉淀到 staging_rejects

- 路径建议：

  - 新导入链路以集合式合并为主；函数写入主要用于增量修复、小量直写或实时单条入库

- 写入：优先调用 api.\* 或 public.safe_upsert\_\* 函数；入库对齐到秒

- 查询：reporting.\* 聚合优先；必要时 api.get_measurements 明细

- 运维：monitoring.\* 观测与审计；确保 pg_stat_statements 已启用

- 自检 SQL：SELECT count(\*) FROM public.fact_measurements WHERE date_trunc('second', ts_bucket) \<> ts_bucket;

## 数据库连接池

项目实现了基于 psycopg 的数据库连接池管理，以提高数据库操作性能并减少连接建立/关闭的开销。

### 特性

- **连接复用**：避免频繁建立和关闭数据库连接
- **并发支持**：支持多线程并发访问
- **健康检查**：自动检测和处理连接超时、断开等问题
- **统计监控**：提供连接使用统计信息用于性能分析
- **自动恢复**：连接异常时自动重连

### 配置

- **min_size**：最小连接数，默认为 1
- **max_size**：最大连接数，默认为 10
- **max_inactive_connection_lifetime**：非活跃连接生存时间，默认为 3600 秒

### 使用

连接池在 CLI 程序启动时自动初始化，通过 `app.adapters.db.init_database()` 函数完成。在数据库操作中，优先使用连接池获取连接，未初始化时回退到直连模式。

### 日志事件

连接池相关操作会生成以下日志事件：

- `pool.initialized`：连接池初始化完成
- `pool.connection.created`：创建新连接
- `pool.connection.acquired`：获取连接成功
- `pool.connection.create_failed`：创建连接失败
- `pool.closed`：连接池关闭

## 数据入库契约与示例（与《程序工作流程》一致）

- 契约

  - 维度准备：dim_stations、dim_devices、dim_metric_config、dim_mapping_items 已根据 data_mapping.json 生成
  - 时间与对齐：UTC + 秒级对齐（ts_bucket = date_trunc('second', ts_utc)）
  - 主键： (station_id, device_id, metric_id, ts_bucket)，同秒 UPSERT 合并
  - 时区优先级：入参 tz > dim_stations.extra->>'tz' > 默认 UTC
  - 禁止使用 CSV 文件名/路径推断维度/指标

- 示例

  - UTC 写入：
    - SELECT public.safe_upsert_measurement(1, 10, 101, '2025-08-16T12:00:00Z', 12.34, 'ingest');
  - 本地时间写入（按站点时区转换）：
    - SELECT public.safe_upsert_measurement_local(1, 10, 101, '2025-08-16 20:00:00', 12.34, 'ingest');

- 参考

  - 文档：docs/程序工作流程.md、docs/泵站时间对齐实现.md
  - 表结构：docs/表结构与数据库.md

更多逐函数详解，请见：docs/逐函数详解_附录.md
