# 表结构明细（附录）

> 状态板（2025-08-18）：字段清单以数据库为准；导入链路使用标准 schema；run-all 待修 prepare-dim 的 dim_metric_config 返回列后，将复核字段与注释一致性。参考：docs/PLAYBOOKS/SESSION_SNAPSHOT_2025-08-18.md、docs/表结构与数据库.md。

说明

- 范围：汇总各 schema 的“逻辑表/物化视图”的完整字段清单及中文注释；不逐一展开按周与子分片的分区子表（其结构与父表一致）。
- 数据来源：docs/\_columns.tsv（只读采集于 2025-08-16）；个别缺失/乱码注释按项目语义补充中文说明。
- 相关：分区/索引策略详见“表结构与数据库.md”。

目录

- public：维表与事实表
- reporting：物化视图（按小时/按日）
- monitoring：运行监控与快照
- api：无物理表（提供函数接口）

______________________________________________________________________

## public

### dim_stations（泵站维表）

| 字段       | 类型        | 可空 | 默认                                     | 注释                                      |
| ---------- | ----------- | ---- | ---------------------------------------- | ----------------------------------------- |
| id         | bigint      | NO   | nextval('dim_stations_id_seq'::regclass) | 主键                                      |
| name       | text        | NO   |                                          | 泵站名称（唯一）                          |
| extra      | jsonb       | YES  |                                          | 扩展信息，建议包含 tz（如 Asia/Shanghai） |
| created_at | timestamptz | YES  | now()                                    | 创建时间                                  |

表说明：记录站点基本信息与时区配置。

### dim_devices（设备维表）

| 字段       | 类型        | 可空 | 默认                                    | 注释                           |
| ---------- | ----------- | ---- | --------------------------------------- | ------------------------------ |
| id         | bigint      | NO   | nextval('dim_devices_id_seq'::regclass) | 主键                           |
| station_id | bigint      | NO   |                                         | 站点 ID（FK dim_stations.id）  |
| name       | text        | NO   |                                         | 设备名称（同站内唯一）         |
| type       | text        | NO   |                                         | 设备类型：pump                 |
| pump_type  | text        | YES  |                                         | 泵驱动类型：variable_frequency |
| extra      | jsonb       | YES  |                                         | 扩展信息（设备标签/参数）      |
| created_at | timestamptz | YES  | now()                                   | 创建时间                       |

表说明：记录泵/总管等设备信息与属性。

### dim_metric_config（指标配置）

| 字段            | 类型        | 可空 | 默认                                          | 注释                                  |
| --------------- | ----------- | ---- | --------------------------------------------- | ------------------------------------- |
| id              | bigint      | NO   | nextval('dim_metric_config_id_seq'::regclass) | 主键                                  |
| metric_key      | text        | NO   |                                               | 指标键（唯一），如 voltage_b/pressure |
| unit            | text        | NO   |                                               | 物理单位（内部统一口径）              |
| unit_display    | text        | YES  |                                               | 展示单位（可与 unit 不同）            |
| decimals_policy | text        | YES  | 'as_is'                                       | 小数位策略：as_is/fixed               |
| fixed_decimals  | smallint    | YES  |                                               | 固定小数位（当 policy=fixed 时生效）  |
| value_type      | text        | YES  |                                               | 值类型（如 numeric/text）             |
| valid_min       | numeric     | YES  |                                               | 软/硬阈使用的下限参考值               |
| valid_max       | numeric     | YES  |                                               | 软/硬阈使用的上限参考值               |
| created_at      | timestamptz | YES  | now()                                         | 创建时间                              |
| updated_at      | timestamptz | YES  | now()                                         | 更新时间                              |

表说明：统一各测点的单位与有效范围，以及显示精度策略。

### device_rated_params（设备额定参数）

| 字段           | 类型        | 可空 | 默认                                            | 注释                                                       |
| -------------- | ----------- | ---- | ----------------------------------------------- | ---------------------------------------------------------- |
| id             | bigint      | NO   | nextval('device_rated_params_id_seq'::regclass) | 主键                                                       |
| device_id      | bigint      | NO   |                                                 | 设备 ID（FK dim_devices.id）                               |
| param_key      | text        | NO   |                                                 | 参数键：rated_flow/rated_head/rated_power/pipe_diameter 等 |
| value_numeric  | numeric     | YES  |                                                 | 数值型值（与 value_text 二选一）                           |
| value_text     | text        | YES  |                                                 | 文本型值（与 value_numeric 二选一）                        |
| unit           | text        | YES  |                                                 | 单位（与 param_key 匹配）                                  |
| source         | text        | YES  |                                                 | 来源（铭牌/资料/估算/其他）                                |
| effective_from | timestamptz | YES  |                                                 | 生效开始时间（可空）                                       |
| effective_to   | timestamptz | YES  |                                                 | 生效结束时间（可空）                                       |
| created_at     | timestamptz | YES  | now()                                           | 创建时间                                                   |
| updated_at     | timestamptz | YES  | now()                                           | 更新时间                                                   |

表说明：存放泵/设备的额定参数与单位，用于派生/拟合/优化。

### dim_mapping_items（映射快照）

| 字段         | 类型        | 可空 | 默认                                          | 注释                                      |
| ------------ | ----------- | ---- | --------------------------------------------- | ----------------------------------------- |
| id           | bigint      | NO   | nextval('dim_mapping_items_id_seq'::regclass) | 主键                                      |
| mapping_hash | text        | NO   |                                               | 映射版本哈希                              |
| station_name | text        | NO   |                                               | 站点名称（来自映射）                      |
| device_name  | text        | NO   |                                               | 设备名称（来自映射）                      |
| metric_key   | text        | NO   |                                               | 指标键（FK dim_metric_config.metric_key） |
| source_hint  | text        | NO   |                                               | 源标识/路径提示                           |
| created_at   | timestamptz | YES  | now()                                         | 创建时间                                  |

表说明：导入映射的结构化快照，用于追溯与审计。

### fact_measurements（时序事实表，父表）

| 字段        | 类型        | 可空 | 默认                                          | 注释                                         |
| ----------- | ----------- | ---- | --------------------------------------------- | -------------------------------------------- |
| id          | bigint      | NO   | nextval('fact_measurements_id_seq'::regclass) | 主键（可选）                                 |
| station_id  | bigint      | NO   |                                               | 站点 ID                                      |
| device_id   | bigint      | NO   |                                               | 设备 ID                                      |
| metric_id   | bigint      | NO   |                                               | 指标 ID（FK dim_metric_config.id）           |
| ts_raw      | timestamptz | NO   |                                               | 原始时间（建议 UTC）                         |
| ts_bucket   | timestamptz | NO   |                                               | UTC 秒对齐时间：date_trunc('second', ts_utc) |
| value       | numeric     | NO   |                                               | 测量值                                       |
| source_hint | text        | YES  |                                               | 来源提示                                     |
| inserted_at | timestamptz | YES  | now()                                         | 插入时间                                     |

表说明：

- 主键：(station_id, device_id, metric_id, ts_bucket)，同秒 UPSERT 合并
- 约束：CHECK(date_trunc('second', ts_bucket) = ts_bucket)
- 分区：按周 RANGE；子分区：站点 HASH（16 片）；叶子分区同构父表

______________________________________________________________________

## reporting

### mv_measurements_hourly（按小时聚合，物化视图）

| 字段       | 类型        | 可空 | 默认 | 注释                    |
| ---------- | ----------- | ---- | ---- | ----------------------- |
| station_id | bigint      | YES  |      | 站点 ID                 |
| device_id  | bigint      | YES  |      | 设备 ID                 |
| metric_id  | bigint      | YES  |      | 指标 ID                 |
| ts_hour    | timestamptz | YES  |      | 小时对齐时间            |
| value_avg  | numeric     | YES  |      | 平均值                  |
| value_min  | numeric     | YES  |      | 最小值                  |
| value_max  | numeric     | YES  |      | 最大值                  |
| value_sum  | numeric     | YES  |      | 累计（针对累计/能量类） |

说明：查询接口 reporting.get_metrics_hourly/\_multi 优先命中此 MV。

### mv_measurements_daily（按日聚合，物化视图）

| 字段       | 类型    | 可空 | 默认 | 注释                    |
| ---------- | ------- | ---- | ---- | ----------------------- |
| station_id | bigint  | YES  |      | 站点 ID                 |
| device_id  | bigint  | YES  |      | 设备 ID                 |
| metric_id  | bigint  | YES  |      | 指标 ID                 |
| date       | date    | YES  |      | 日粒度日期              |
| value_avg  | numeric | YES  |      | 平均值                  |
| value_min  | numeric | YES  |      | 最小值                  |
| value_max  | numeric | YES  |      | 最大值                  |
| value_sum  | numeric | YES  |      | 累计（针对累计/能量类） |

说明：查询接口 reporting.get_metrics_daily/\_multi 优先命中此 MV。

______________________________________________________________________

## monitoring

### ab_test_runs（A/B 测试运行记录）

| 字段       | 类型        | 可空 | 默认                                                | 注释            |
| ---------- | ----------- | ---- | --------------------------------------------------- | --------------- |
| id         | bigint      | NO   | nextval('monitoring.ab_test_runs_id_seq'::regclass) | 主键            |
| run_time   | timestamptz | NO   | now()                                               | 运行时间        |
| station_id | bigint      | YES  |                                                     | 站点 ID（可空） |
| start_ts   | timestamptz | YES  |                                                     | 起始时间        |
| end_ts     | timestamptz | YES  |                                                     | 结束时间        |
| metric_ids | bigint\[\]  | YES  |                                                     | 涉及指标集合    |

### ab_test_results（A/B 测试结果）

| 字段        | 类型             | 可空 | 默认  | 注释                 |
| ----------- | ---------------- | ---- | ----- | -------------------- |
| run_id      | bigint           | YES  |       | 对应 ab_test_runs.id |
| phase       | text             | YES  |       | 阶段/方案标签        |
| rows_count  | bigint           | YES  |       | 采样行数             |
| duration_ms | double precision | YES  |       | 耗时（毫秒）         |
| created_at  | timestamptz      | NO   | now() | 创建时间             |

### pgss_snapshot（查询统计快照）

| 字段              | 类型             | 可空 | 默认  | 注释       |
| ----------------- | ---------------- | ---- | ----- | ---------- |
| snapshot_time     | timestamptz      | NO   | now() | 快照时间   |
| dbname            | text             | YES  |       | 数据库名   |
| userid            | oid              | YES  |       | 用户 ID    |
| queryid           | bigint           | YES  |       | 查询指纹   |
| calls             | bigint           | YES  |       | 调用次数   |
| rows              | bigint           | YES  |       | 返回行数   |
| blk_read_time     | double precision | YES  |       | 读块耗时   |
| blk_write_time    | double precision | YES  |       | 写块耗时   |
| temp_blks_read    | bigint           | YES  |       | 临时块读取 |
| temp_blks_written | bigint           | YES  |       | 临时块写入 |

说明：由 monitoring.capture_pgss_snapshot 采集，支持命中率/性能分析。

______________________________________________________________________

## api

- 无物理表；提供写入/查询/删除等函数接口（见“数据库函数参考.md”）。

______________________________________________________________________

备注

- 分区子表（如 public.fact_measurements_2025w33_p0 等）与父表结构一致，此处不重复列出。
- 若需导出“全量物理表（含所有分区子表）”，建议生成单独机器可读清单文件避免主文档膨胀。
