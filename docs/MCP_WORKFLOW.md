# MCP_WORKFLOW（MCP 工具与工作流规范）

目标：通过标准化使用 MCP 工具与任务流，提升开发效率、降低风险、保证代码与文档一致性。

## 1. 总则
- 所有开发活动默认遵循本规范；如需豁免，必须在 PR 说明并获批准。
- 任何访问、搜索与编辑操作都应以“最小化、可追溯、可回滚”为原则。
- 严格不访问 venv/.venv/env 目录（除非明确授权）。

## 2. 任务与流程（Tasklist 驱动）
- 触发条件（任一满足即启用任务清单）：
  - 多文件或跨层改动；>2 次编辑/验证或 >5 次信息收集；用户请求进度/计划。
- 初始任务：创建“Investigate/Triage/Understand the problem”，状态设为 IN_PROGRESS。
- 增量规划：调查完成后再创建 1–3 个最小后续任务；保持“每次只有一个任务处于 IN_PROGRESS”。
- 批量更新：切换任务时使用批量状态更新（将前一任务 COMPLETE、下一任务 IN_PROGRESS）。
- 复盘与回退：如实现偏离需求，恢复相关任务为 IN_PROGRESS 并记录修正。


## 流程图（Mermaid）

```mermaid
flowchart TD
  A[接收需求/任务] --> B{是否触发任务清单?}
  B -- 否 --> C[直接执行小变更]
  B -- 是 --> T[创建任务清单: Investigate]
  T --> P[计划: 增量创建 1–3 个任务]
  P --> I[实现: 小步编辑(≤150行)/最小改动]
  I --> V{是否需要验证?}
  V -- 是 --> R[运行命令/测试并校验]
  V -- 否 --> W[跳过执行]
  R --> L{验证通过?}
  L -- 否 --> D[诊断并最小修复] --> R
  L -- 是 --> Q[提交 PR + 自检]
  Q --> G[质量闸 quality_gate + 测试]
  G -->|通过| M[合并]
  G -->|失败| D2[修复后重跑]
```

## 3. 信息收集工具的使用
- 高信号优先，限制调用次数：
  - 初期最多一次高信号信息收集（例如定位核心配置/入口代码）。
- 选择合适工具：
  - view（文件/目录查看）：当已知具体文件或需查看特定代码段。
    - view + search_query_regex：在单文件内查引用/定义/符号；限定上下文行数。
  - grep-search：在多文件范围内精准查找符号/文本；限制目录/模式，避免广泛扫描。
  - codebase-retrieval：当不清楚文件位置或需高层概览时使用。
- 使用前先说明做什么、为什么；获得所需最小信息后立即停止，避免重复调用。
- 在编辑前必须确认将要用到的函数/类/常量是否存在与签名匹配。

## 4. 编辑工具与原则
- 仅使用 str_replace_editor 修改现有文件；新文件使用 save-file；不得整文件重写覆盖已有文件。
- 单次编辑块 ≤150 行；必要时拆分多次小改动。
- 编辑前：收集最小必要上下文；避免大范围浏览无关文件。
- 保守变更：尊重现有风格与结构，优先最小可行改动（MVP）。

## 5. 执行与验证（Execution & Validation）
- 当用户要求“确保/验证/运行/测试”时，应实际执行相关命令并验证退出码与日志：
  - 短命令：launch-process(wait=true)；长进程用 wait=false 并通过 read-process 监控。
  - 成功标准：退出码为 0 且日志无明显错误；输出运行摘要（cwd/exit code/关键日志）。
- 安全-默认策略：
  - 允许的自动验证：本地单元/集成测试、lint/type-check、构建、CLI --help 等低风险命令。
  - 需显式授权：安装依赖、数据库迁移/修改持久数据、部署、耗时或昂贵的外部调用。
- 失败处理：定位原因→最小修复→重跑；如受限于权限/环境，及时询问用户。

## 6. 依赖与包管理
- 一律通过包管理器添加/移除依赖：
  - JS：npm/yarn/pnpm；Python：pip/poetry/conda；Rust：cargo；Go：go get；Ruby：bundler；PHP：composer；.NET：dotnet；Java：Maven/Gradle。
- 不直接手改 package 配置/锁定文件；除非是无法通过命令完成的自定义配置。

## 7. 代码展示与输出规范
- 代码片段必须用 `<augment_code_snippet>` 包裹，包含 path 与 mode="EXCERPT"，且展示 <10 行示例。
- 文本输出简洁、分节清晰；必要时用要点列表，避免大段文字墙。

## 8. 沟通准则
- 在采取重要操作前简要说明意图（一次话术即可，无需每步都说明）。
- 需求不明确时先提问澄清；潜在破坏性操作（安装/迁移/部署/删改数据）需征得明确许可。
- 严格按照用户要求的范围执行，不擅自扩展范围；合理的后续建议以“可选项”形式提出。

## 9. 性能、成本与效率
- 优先使用最小集合的高价值工具调用；合并相关信息收集与编辑步骤。
- 重复尝试无进展时立即求助用户；达到“收益递减”时停止深挖并说明残余风险。

## 10. 质量闸与 PR 自检
- PR 必须填写“规则合规清单”，包括 MCP_WORKFLOW 勾选项。
- 提交前至少运行：`python scripts/quality_gate.py`；可选：`pytest -q`。

## 11. 常见误区（避免）
- 反复广泛搜索无明确目标；
- 未确认函数/类存在与签名就修改调用点；
- 大规模编辑或全文件替换；
- 未经许可安装依赖或更改系统/数据库；
- 忽略 venv/.venv 忽略约束；
- 展示代码时未使用 augment_code_snippet。

## 12. 合规检查清单（在 PR 中逐项自查）
- [ ] 是否按任务清单驱动流程，仅一个任务处于 IN_PROGRESS？
- [ ] 信息收集是否“高信号优先、最少调用、最小范围”？
- [ ] 编辑是否使用 str_replace_editor/save-file，且单块 ≤150 行？
- [ ] 是否执行了所需验证命令并输出结果摘要？
- [ ] 是否未访问 venv/.venv/env？
- [ ] 是否遵守包管理规则？
- [ ] 是否使用 augment_code_snippet 展示代码？
- [ ] 是否在 PR 模板中勾选 MCP_WORKFLOW？
