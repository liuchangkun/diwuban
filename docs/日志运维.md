# 日志运维（项目版）

> 状态板（2025-08-18）：CLI 方案B可在分步/一键模式下初始化文件日志；perf.ndjson 已加入 p95_window；sql.ndjson 输出窗口参数；db-ping --verbose；check-mapping --out/--show-all。日志默认 json，可在 configs/logging.yaml 设置 format=text；支持 routing=by_module 将日志写入 logs/modules/<module>.log；运行首行输出参数与配置快照（默认不脱敏）。run-all 合并链路待修 prepare-dim 的 dim_metric_config 返回列。会话快照：docs/PLAYBOOKS/SESSION_SNAPSHOT_2025-08-18.md。

本手册定义日志文件的目录结构、轮转策略、保留期限、检索方法与故障排查，作为“唯一的日志运维文档”。日志格式与字段字典见《日志规范.md》。

## 1. 运行目录与多流输出

- 推荐按照“运行实例”分目录：D:/Augment/diwuban/logs/runs/YYYYMMDD/\<job_id>/
  - app.ndjson（INFO+）
  - error.ndjson（WARN+）
  - sql.ndjson（SQL 摘要/采样计划）
  - perf.ndjson（吞吐/耗时/背压）
  - summary.json（运行汇总）
  - env.json（脱敏配置快照，可选）
- by_module 路由（与实现对齐）：当 configs/logging.yaml 中 routing=by_module 时，日志将按 logger 名写入 logs/modules/<module>.log（例如 api.log/sql.log/perf.log/root.log）。服务端 API 日志由 app/api/middleware/logging.py 的 setup_api_logging 使用 structlog 输出；CLI 模式由 app/adapters/logging/init.py 输出多流（app/error/sql/perf）。

- 备选：单目录按天分流（app-YYYYMMDD.ndjson 等），实现简单，但排障不如按 run 隔离

## 2. 轮转与保留

- 按天轮转：每天新文件；过期压缩（.gz）
- 按大小轮转：单文件达 100MB 触发 size 轮转（最多 10 份）
- 保留策略：默认 14 天（可配置 retention_days）
- 退出顺序：先停止 QueueListener，再退出进程，确保刷盘；异常时退化到 stderr 最小字段集

## 3. 检索与分析

- 按 trace 关联：
  - `jq -c 'select(.trace_id=="t-1")' app.ndjson`
- 错误快速定位：
  - `tail -n 200 error.ndjson`
- SQL 慢操作 Top：
  - `jq -c 'select(.event=="db.exec" and .sql_state=="succeeded") | {sql_hash,sql_cost_ms}' sql.ndjson | sort -nr -k2 | head`
- 统计吞吐：
  - `jq -c 'select(.event=="align.merge.window") | {rows_merged,batch_cost_ms}' perf.ndjson`

## 4. 运维建议

- 开发：console=true + 文件 json；logging.sql.text=normalized（短期定位）
- 生产：console=false；logging.sql.text=summary/explain=on_error；启用 QueueHandler，flush_on_exit=true
- 采样与限流：开启 loop_log_every_n，限制 DEBUG 采样比例，避免日志洪泛
- 安全：启用 redaction，禁止记录敏感参数与完整 SQL

## 5. 故障排查

- 日志队列溢出：Queue 满时 ERROR，并触发 backpressure；检查队列深度与磁盘IO
- SQL 失败率升高：检查 sql.ndjson 的 pgcode/pgerror，必要时开启 explain 采样
- 背压持续：检查 perf.ndjson 的 p95/失败率/锁等待与调整动作（adjustment），按策略降并发或缩批
- 对齐异常：核查 task.summary 与 audit.mv，抽查 not_aligned=0 检查

## 6. 变更审计

- 记录日志配置变更（级别/采样/限流/队列）到 PLAYBOOKS/配置变更记录.md，并在 PR 中说明风险与回滚

## 7. 背压定位快速步骤与字段对照（建议）

- 快速步骤：

  1. 先看 error.ndjson 是否存在连接/重试类错误（pgcode/pgerror）
  1. 再看 perf.ndjson 的 P95 批次耗时/失败率/锁等待是否超阈
  1. 检索 app.ndjson 的 backpressure.enter/exit 与 guardrail.stop 事件
  1. 若长期 enter 无 exit，检查合并窗口设置、批大小与 workers 是否被持续下调
  1. 针对 SQL：在 sql.ndjson 中查看 sql_state 与 sql_cost_ms（必要时临时开启 explain 采样）

- 常见字段对照：

  - p95_batch_ms：批次处理 P95（ms）
  - fail_rate：失败率（0–1）
  - lock_waits：锁等待次数/时间（可选）
  - adjustment：自适应动作（shrink_batch/shrink_workers/recover）
  - from_batch/to_batch：批大小调整前后
  - new_workers：回升后的并发数
  - sql_state：started/succeeded/failed/retried
  - sql_cost_ms：SQL 耗时（ms）
  - pgcode/pgerror：PostgreSQL 错误码/错误信息（失败时）

## by_module 检索指引（里程碑2 最小实现）

- 目录：logs/modules/\*.log（按 logger 名分类）

- 常用查询（PowerShell）：

  - Select-String -Path logs/modules/sql.log -Pattern "db.exec.succeeded|db.exec.failed" -Context 0,1
  - Select-String -Path logs/modules/root.log -Pattern "align.merge.window|ingest.copy.batch|task.summary" -Context 0,1

- 故障排查：

  - 慢 SQL：grep sql_cost_ms 大于阈值的行；必要时切换 sql.text=full 并分析文本
  - 合并卡顿：按时间搜索 align.merge.window 与 backpressure.enter/exit 观察波峰

- 流程建议：

  1. 查看 logs/modules/sql.log 中 db.exec.failed，关注 error/explain
  1. 若 merge 卡顿：查看 root.log 中 align.merge.window 与 backpressure.enter/exit 时序
  1. 若导入异常：关注 ingest.copy.batch 的 rows/bytes/batch_cost_ms（预留字段，后续扩展）
