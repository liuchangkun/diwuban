# 应用接口说明（基于实际代码）（API v1）

> 来源代码路径：app/api/v1/router.py、app/api/v1/endpoints/*、app/models/*
> 数据库验证日期：2025-08-26
> 最近校对日期：2025-08-26

本文档基于实际 FastAPI 路由与 Pydantic 模型生成，所有字段与类型以 app/api 与 app/models 为准；涉及数据库行为以 docs/数据库函数参考.md 为权威。

- 基础路径：/api/v1
- 路由分组：/data、/monitoring、/logs
- 响应格式：application/json；错误使用 HTTPException，错误体形如 {"detail": "..."}

## 0. 根路径与静态资源（非版本化）

- GET /health（根路径）
  - 描述：应用根健康检查（非 /api/v1 前缀）。用于快速探活与最小可用状态确认。
  - 响应：object（包含 status、timestamp、checks/connection_pool 等字段；实现以 app/main.py 为准）
  - 实现：app/main.py 第153–169行附近
- GET /
  - 描述：若存在 app/static/index.html，则返回静态首页；否则返回占位信息
  - 实现：app/main.py 第218–237行附近

> 说明：本文档主体聚焦 /api/v1 下的版本化接口；为与当前代码一致，补充列出根路径健康探活与静态资源行为。

## 1. 数据接口（/api/v1/data）

### 1.1 GET /measurements（已废弃）

- 状态：410 Gone
- 描述：该端点已废弃，请使用以下新端点：
  - /api/v1/data/stations/{station_id}/measurements（泵站聚合数据）
  - /api/v1/data/devices/{device_id}/measurements（设备聚合数据）
  - /api/v1/data/stations/{station_id}/raw（泵站原始数据，format=wide/long）
  - /api/v1/data/devices/{device_id}/raw（设备原始数据，format=wide/long）
- 返回：HTTP 410，detail 中包含替代端点提示

### 1.2 GET /stations（泵站列表）

- 描述：获取所有泵站的概览信息
- 数据源：public.station_device_rated_params_view（视图）+ 最近数据时间 last_data_time 通过 fact_measurements 聚合获得
- 响应：List\[StationSummary\]（见 app/models/station.py）
- 字段说明（节选）：
  - station_id: string
  - name: string
  - region: string|null
  - status: string（active 等）
  - device_count: int
  - capacity: number|null
  - last_data_time: string|datetime|null

### 1.3 GET /stations/{station_id}/devices（设备列表）

- 描述：获取指定泵站的设备列表
- 数据源：public.station_device_rated_params_view（视图）+ 每设备 last_data_time 通过 fact_measurements 聚合获得
- 响应：List\[DeviceSummary\]（见 app/models/device.py）
- 字段说明（节选）：
  - device_id: string
  - station_id: string
  - name: string
  - type: string（pump/main_pipeline 等）
  - pump_type: string|null（variable_frequency 等）
  - status: string（active 等）
  - rated_power: number|null
  - last_data_time: string|datetime|null
  - station_name: string

### 1.4 GET /stations/{station_id}/measurements（泵站聚合数据）

- 描述：按泵站维度返回设备指标的时间序列“聚合”数据
- 数据源：reporting.get_metrics_auto_multi（数据库函数）
- 参数（Query）：
  - start_time: datetime，必填
  - end_time: datetime，必填（> start_time）
  - device_ids: List\[int\]，可选
  - metric_ids: List\[int\]，可选
  - granularity: string，默认 "auto"（hourly/daily 由函数内部判定）
  - limit: int，默认 1000，范围 \[1,10000\]
  - offset: int，默认 0
- 响应：TimeSeriesResponse
  - data\[\]：
    - ts: datetime
    - station_id: int
    - device_id: int
    - device_name: string
    - metric_id: int
    - metric_key: string
    - unit: string
    - cnt: int
    - avg: number
    - min: number
    - max: number
    - sum: number
  - metadata: { station_id, start_time, end_time, granularity, device_ids?, metric_ids? }
  - total_count: int
  - has_more: bool

### 1.5 GET /devices/{device_id}/measurements（设备聚合数据）

- 描述：按设备维度返回指标的时间序列“聚合”数据
- 数据源：reporting.get_metrics_auto_multi（数据库函数）
- 参数（Query）：
  - start_time: datetime，必填
  - end_time: datetime，必填（> start_time）
  - metric_ids: List\[int\]，可选
  - granularity: string，默认 "auto"
  - limit: int，默认 1000
  - offset: int，默认 0
- 响应：TimeSeriesResponse（结构同上）

### 1.6 GET /devices/{device_id}/raw（设备原始数据）

- 描述：按设备返回“原始（不聚合）”数据
- 数据源：public.get_device_metrics_by_time_range（数据库函数）
- 参数（Query）：
  - start_time: datetime，必填
  - end_time: datetime，必填（> start_time）
  - limit: int，默认 1000
  - format: string，默认 "wide"，可选 "wide"|"long"
- 响应：TimeSeriesResponse
  - 当 format=wide：
    - data\[\]：{ record_timestamp: datetime, metrics_data: object(JSON) }
    - 示例 metrics_data keys："设备名_指标显示名"
  - 当 format=long：
    - data\[\]：{ ts: datetime, metric: string, value: number|null }
  - metadata: { device_id, start_time, end_time, source: 'public.get_device_metrics_by_time_range', format }
  - total_count: int（来自函数 total_records）
  - has_more: bool

### 1.7 GET /stations/{station_id}/raw（泵站原始数据）

- 描述：按泵站（跨设备）返回“原始（不聚合）”数据
- 数据源：public.get_station_devices_metrics_by_time_range（数据库函数）
- 参数（Query）：
  - start_time: datetime，必填
  - end_time: datetime，必填（> start_time）
  - limit: int，默认 1000
  - format: string，默认 "wide"，可选 "wide"|"long"
- 响应：TimeSeriesResponse（结构同上；source 为 public.get_station_devices_metrics_by_time_range）

### 1.4 GET /stations/{station_id}/statistics

> 实库说明（补充）：当前数据库未检测到 public.station / public.device / public.operation_data 兼容表或视图。以下端点依赖该兼容层：/api/v1/data/stations、/api/v1/data/stations/{station_id}/devices、/api/v1/data/stations/{station_id}/statistics。建议：
>
> 1. 临时创建兼容视图映射到 dim\_\* 与 fact\_\*，或
> 1. 将端点改造为通过 dim\_\* + 聚合/物化视图（reporting.mv\_\*）提供相同语义的数据。

- 描述：获取泵站统计信息（近 hours 小时）
- 参数（Query）：hours: int，默认 24，范围 \[1,168\]
- 响应：object

### 1.5 GET /import-stats/{station_id}

- 描述：获取数据导入统计信息
- 响应：object

## 2. 监控接口（/api/v1/monitoring）

> 实现说明：监控部分端点当前仍使用兼容表/旧表名（station/device/operation_data）与视图（如 v_fully_adaptive_data）联合提供数据，后续将逐步收敛到统一的视图/函数接口，避免直接访问旧表。参考：app/api/v1/endpoints/monitoring.py 与 app/api/v1/endpoints/data.py。

### 2.1 GET /health

- 描述：系统健康检查（聚合 DB、连接池、服务可用性、数据质量）
- 响应：object（包含 status、checks、services、timestamp）

### 2.2 GET /db-health

- 描述：数据库健康检查
- 响应：object

### 2.3 GET /pool-stats

- 描述：连接池统计
- 响应：object（来源 app.adapters.db.pool.get_pool_stats）

### 2.4 GET /performance

- 描述：系统性能指标
- 响应：object

### 2.5 GET /devices

- 描述：设备状态列表
- 参数（Query）：
  - station_id: int，可选
  - status: string，可选，online/offline/warning
  - limit: int，默认 100，范围 \[1,1000\]
  - offset: int，默认 0，范围 \[0,+)
- 响应：DevicesResponse（定义于 app/api/v1/endpoints/monitoring.py）

### 2.6 GET /devices/{device_id}

- 描述：设备详情
- 响应：object

## 3. 日志接口（/api/v1/logs）

### 3.1 GET /search

- 描述：搜索 logs 目录下的日志文件（支持 JSON/Text 解析与过滤）
- 参数（Query，节选）：
  - level: string，可选
  - search: string，可选
  - start_time: datetime，可选
  - end_time: datetime，可选
  - limit: int，默认 100
  - offset: int，默认 0
- 响应：LogsResponse（定义于 app/api/v1/endpoints/logs.py）

### 3.2 GET /levels

- 描述：返回可用日志级别列表

### 3.3 GET /stats

- 描述：日志统计信息

## 4. 约束与边界

- 写入边界：所有写入应通过数据库函数（public/api/reporting/monitoring），详见 docs/数据库函数参考.md
- 时间语义：统一 UTC 秒级对齐；详见 docs/泵站时间对齐实现.md
- 模型权威：字段说明以 app/models/\* 中的 Pydantic 模型为准；本页不重复罗列字段，避免漂移

## 5. 示例（节选）

- 获取测量数据：/api/v1/data/measurements?station_id=1&start_time=2025-08-24T00:00:00Z&end_time=2025-08-25T00:00:00Z&limit=1000
- 获取健康检查：/api/v1/monitoring/health
- 搜索日志：/api/v1/logs/search?level=ERROR&search=merge

<!-- BEGIN:API_AUTO -->

## API 路由清单（自动生成）

- GET /data/measurements | name=get_measurements | resp=app.models.operation_data.TimeSeriesResponse | signature=(request: starlette.requests.Request, station_id: Optional\[str\] = Query(None), device_id: Optional\[str\] = Query(None), start_time: Optional\[datetime.datetime\] = Query(None), end_time: Optional\[datetime.datetime\] = Query(None), limit: int = Query(1000), offset: int = Query(0)) -> app.models.operation_data.TimeSeriesResponse -> app.models.operation_data.TimeSeriesResponse
- GET /data/stations | name=get_stations | resp=typing.List | signature=(request: starlette.requests.Request) -> List\[app.models.station.StationSummary\] -> typing.List
- GET /data/stations/{station_id}/devices | name=get_station_devices | resp=typing.List | signature=(station_id: str, request: starlette.requests.Request) -> List\[app.models.device.DeviceSummary\] -> typing.List
- GET /data/stations/{station_id}/statistics | name=get_station_statistics | resp=typing.Dict | signature=(station_id: str, hours: int = Query(24)) -> Dict\[str, Any\] -> typing.Dict
- GET /data/import-stats/{station_id} | name=get_import_statistics | resp=typing.Dict | signature=(station_id: str) -> Dict\[str, Any\] -> typing.Dict
- GET /monitoring/health | name=system_health_check | resp=typing.Dict | signature=() -> Dict\[str, Any\] -> typing.Dict
- GET /monitoring/db-health | name=db_health_check | resp=typing.Dict | signature=() -> Dict\[str, Any\] -> typing.Dict
- GET /monitoring/pool-stats | name=connection_pool_stats | resp=typing.Dict | signature=() -> Dict\[str, Any\] -> typing.Dict
- GET /monitoring/performance | name=system_performance | resp=typing.Dict | signature=() -> Dict\[str, Any\] -> typing.Dict
- GET /monitoring/devices | name=get_devices | resp=app.api.v1.endpoints.monitoring.DevicesResponse | signature=(station_id: Optional\[int\] = Query(None), status: Optional\[str\] = Query(None), limit: int = Query(100), offset: int = Query(0)) -> app.api.v1.endpoints.monitoring.DevicesResponse -> app.api.v1.endpoints.monitoring.DevicesResponse
- GET /monitoring/devices/{device_id} | name=get_device_detail | resp=typing.Dict | signature=(device_id: int) -> Dict\[str, Any\] -> typing.Dict
- GET /logs/search | name=search_logs | resp=app.api.v1.endpoints.logs.LogsResponse | signature=(request: starlette.requests.Request, level: Optional\[str\] = Query(None), search: Optional\[str\] = Query(None), start_time: Optional\[datetime.datetime\] = Query(None), end_time: Optional\[datetime.datetime\] = Query(None), limit: int = Query(100), offset: int = Query(0)) -> app.api.v1.endpoints.logs.LogsResponse -> app.api.v1.endpoints.logs.LogsResponse
- GET /logs/levels | name=get_log_levels | resp=- | signature=()
- GET /logs/stats | name=get_log_stats | resp=- | signature=()

<!-- END:API_AUTO -->
