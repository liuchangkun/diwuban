# 逐函数详解（附录）

说明

- 范围：按 schema（api/reporting/monitoring/public）汇总数据库函数签名、返回类型、中文说明与示例调用。
- 数据来源：docs/\_routines.tsv（只读采集于 2025-08-16）；若数据库后续变更，请先重新采集，再更新本文。
- 约定：示例以最小可运行为主，省略不必要参数；仅演示 SELECT 调用，不执行任何写操作副作用（删除/更新示例也保持只读语义说明）。

目录

- api：明细读写接口
- reporting：聚合查询与 MV 刷新
- monitoring：观测与 A/B
- public：工具与维护函数

______________________________________________________________________

## api（明细 CRUD 接口）

| 函数                              | 参数（节选）                                                                                                                                                                                           | 返回         | 说明                                               | 示例                                                                                                                                      |
| --------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------ | -------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------- |
| api.upsert_measurement            | (p_station_id bigint, p_device_id bigint, p_metric_id bigint, p_ts_raw timestamptz, p_value numeric, p_source_hint text)                                                                               | boolean      | 明细写入（UTC），入库端对齐至整秒并同秒合并        | SELECT api.upsert_measurement(1,10,101, now(), 12.34, 'demo');                                                                            |
| api.upsert_measurements_json      | (p_rows jsonb)                                                                                                                                                                                         | record       | 批量写入（JSON 数组），服务端逐行对齐/合并         | SELECT api.upsert_measurements_json('\[{"station_id":1,"device_id":10,"metric_id":101,"ts_raw":"2025-08-16T12:00:00Z","value":12.34}\]'); |
| api.get_measurements              | (p_station_ids bigint\[\], p_start_ts timestamptz, p_end_ts timestamptz, p_device_ids bigint\[\] DEFAULT NULL, p_metric_ids bigint\[\] DEFAULT NULL, p_limit int DEFAULT 1000, p_offset int DEFAULT 0) | setof record | 明细查询（分页）；返回列参见事实表                 | SELECT * FROM api.get_measurements(ARRAY\[1\], now()-interval '1 day', now(), NULL, NULL, 100, 0);                                        |
| api.update_measurement_value      | (p_station_id bigint, p_device_id bigint, p_metric_id bigint, p_ts_raw timestamptz, p_new_value numeric, p_source_hint text DEFAULT NULL)                                                              | integer      | 更新某一原始时间点对应记录的值（同秒合并语义保持） | -- 仅示例签名                                                                                                                             |
| api.delete_measurement            | (p_station_id bigint, p_device_id bigint, p_metric_id bigint, p_ts_raw timestamptz)                                                                                                                    | integer      | 删除某一原始时间点对应记录（对齐到秒定位）         | -- 仅示例签名                                                                                                                             |
| api.delete_measurements_by_filter | (p_station_ids bigint\[\], p_start_ts timestamptz, p_end_ts timestamptz, p_device_ids bigint\[\] DEFAULT NULL, p_metric_ids bigint\[\] DEFAULT NULL, p_batch_size int DEFAULT 5000)                    | integer      | 按条件批量删除（分批执行）                         | -- 仅示例签名                                                                                                                             |

备注：写入/更新/删除为变更性操作，生产需谨慎使用；本文示例不执行实际变更。

______________________________________________________________________

## reporting（聚合查询与刷新）

| 函数                               | 参数（节选）                                                                                                                                                                         | 返回         | 说明                                               | 示例                                                                                                               |
| ---------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------ | -------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| reporting.get_metrics_hourly       | (p_station_id bigint, p_start_ts timestamptz, p_end_ts timestamptz, p_metric_ids bigint\[\] DEFAULT NULL)                                                                            | setof record | 小时粒度聚合查询，优先命中 mv_measurements_hourly  | SELECT * FROM reporting.get_metrics_hourly(1, now()-interval '7 days', now(), ARRAY\[101\]);                       |
| reporting.get_metrics_hourly_multi | (p_station_ids bigint\[\], p_start_ts timestamptz, p_end_ts timestamptz, p_device_ids bigint\[\] DEFAULT NULL, p_metric_ids bigint\[\] DEFAULT NULL)                                 | setof record | 多站/设备/指标筛选的小时聚合                       | SELECT * FROM reporting.get_metrics_hourly_multi(ARRAY\[1\], now()-interval '7 days', now(), NULL, ARRAY\[101\]);  |
| reporting.get_metrics_daily        | (p_station_id bigint, p_start_date date, p_end_date date, p_metric_ids bigint\[\] DEFAULT NULL)                                                                                      | setof record | 天粒度聚合查询，优先命中 mv_measurements_daily     | SELECT * FROM reporting.get_metrics_daily(1, current_date-7, current_date, ARRAY\[101\]);                          |
| reporting.get_metrics_daily_multi  | (p_station_ids bigint\[\], p_start_date date, p_end_date date, p_device_ids bigint\[\] DEFAULT NULL, p_metric_ids bigint\[\] DEFAULT NULL)                                           | setof record | 多站/设备/指标筛选的日聚合                         | SELECT * FROM reporting.get_metrics_daily_multi(ARRAY\[1\], current_date-7, current_date, NULL, ARRAY\[101\]);     |
| reporting.get_metrics_auto         | (p_station_id bigint, p_start_ts timestamptz, p_end_ts timestamptz, p_metric_ids bigint\[\] DEFAULT NULL, p_threshold_days int DEFAULT 3)                                            | setof record | 自动路由：时间跨度小→小时/明细，大→日聚合          | SELECT * FROM reporting.get_metrics_auto(1, now()-interval '2 days', now(), ARRAY\[101\], 3);                      |
| reporting.get_metrics_auto_multi   | (p_station_ids bigint\[\], p_start_ts timestamptz, p_end_ts timestamptz, p_device_ids bigint\[\] DEFAULT NULL, p_metric_ids bigint\[\] DEFAULT NULL, p_threshold_days int DEFAULT 3) | setof record | 自动路由（多维过滤）                               | SELECT * FROM reporting.get_metrics_auto_multi(ARRAY\[1\], now()-interval '2 days', now(), NULL, ARRAY\[101\], 3); |
| reporting.refresh_mv_measurements  | (p_days int DEFAULT 2)                                                                                                                                                               | void         | 刷新小时/日物化视图（最近 N 天），支持并发刷新策略 | SELECT reporting.refresh_mv_measurements(2);                                                                       |

______________________________________________________________________

## monitoring（观测与 A/B）

| 函数                             | 参数                                                                                                      | 返回    | 说明                                                    | 示例                                                                           |
| -------------------------------- | --------------------------------------------------------------------------------------------------------- | ------- | ------------------------------------------------------- | ------------------------------------------------------------------------------ |
| monitoring.capture_pgss_snapshot | ()                                                                                                        | integer | 采集 pg_stat_statements 快照到 monitoring.pgss_snapshot | SELECT monitoring.capture_pgss_snapshot();                                     |
| monitoring.cleanup_pgss_snapshot | (retention_days int DEFAULT 7)                                                                            | integer | 清理过期快照数据                                        | SELECT monitoring.cleanup_pgss_snapshot(14);                                   |
| monitoring.ensure_active_indexes | (window_days int DEFAULT 7)                                                                               | integer | 为近窗口活跃分区确保必要索引                            | SELECT monitoring.ensure_active_indexes(7);                                    |
| monitoring.run_ab_test           | (p_station_id bigint, p_start_ts timestamptz, p_end_ts timestamptz, p_metric_ids bigint\[\] DEFAULT NULL) | bigint  | 运行一次 A/B，返回 run_id                               | SELECT monitoring.run_ab_test(1, now()-interval '1 day', now(), ARRAY\[101\]); |

______________________________________________________________________

## public（工具与维护）

| 函数                            | 参数（节选）                                                                                                             | 返回    | 说明                                 | 示例                                                                   |
| ------------------------------- | ------------------------------------------------------------------------------------------------------------------------ | ------- | ------------------------------------ | ---------------------------------------------------------------------- |
| public.safe_upsert_measurement  | (p_station_id bigint, p_device_id bigint, p_metric_id bigint, p_ts_raw timestamptz, p_value numeric, p_source_hint text) | boolean | 安全 UPSERT（整秒对齐 + 主键合并）   | SELECT public.safe_upsert_measurement(1,10,101, now(), 12.34, 'demo'); |
| public.ensure_week_partition    | (p_week_start date, p_modulus int DEFAULT 16, p_schema text DEFAULT 'public')                                            | void    | 创建/确保某周分区与站点 HASH 子分区  | SELECT public.ensure_week_partition(current_date, 16, 'public');       |
| public.batch_delete_old_data    | (p_cutoff_date timestamptz, p_batch_size int DEFAULT 10000)                                                              | text    | 分批删除某时间点前的数据（返回报告） | -- 仅示例签名                                                          |
| public.auto_space_reclaim       | ()                                                                                                                       | text    | 自动空间回收/膨胀治理报告            | SELECT public.auto_space_reclaim();                                    |
| public.auto_performance_tuning  | ()                                                                                                                       | text    | 自动性能调优策略报告                 | SELECT public.auto_performance_tuning();                               |
| public.check_data_consistency   | ()                                                                                                                       | record  | 一致性巡检（重复、约束、时间对齐等） | SELECT * FROM public.check_data_consistency();                         |
| public.check_performance_alerts | ()                                                                                                                       | text    | 性能告警策略与当前状态               | SELECT public.check_performance_alerts();                              |
| public.database_health_check    | ()                                                                                                                       | record  | 数据库健康巡检（综合）               | SELECT * FROM public.database_health_check();                          |
| public.get_performance_metrics  | ()                                                                                                                       | record  | 关键性能指标（摘要）                 | SELECT * FROM public.get_performance_metrics();                        |
| public.pg_stat_statements       | (showtext boolean, OUT ...)                                                                                              | record  | 核心扩展视图函数（需启用扩展）       | SELECT * FROM public.pg_stat_statements(false) LIMIT 10;               |
| public.pg_stat_statements_info  | (OUT ...)                                                                                                                | record  | 扩展状态                             | SELECT * FROM public.pg_stat_statements_info();                        |
| public.pg_stat_statements_reset | (userid oid DEFAULT 0, dbid oid DEFAULT 0, queryid bigint DEFAULT 0)                                                     | void    | 重置统计（需谨慎）                   | -- 仅示例签名                                                          |
| public.smart_vacuum_strategy    | ()                                                                                                                       | text    | VACUUM 策略建议与执行摘要            | SELECT public.smart_vacuum_strategy();                                 |

备注

- 若本文未列出某函数（如 safe_upsert_measurement_local），说明该函数当前未出现在采集清单；请在部署/迁移后重新采集并更新文档。
- 与应用接口对照：详见 docs/架构落地计划_v1.md 第 35 章。
