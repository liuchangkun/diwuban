# 项目技术选型

> 状态板（2025-08-18）：PostgreSQL 16 + APScheduler；CLI 方案B 与中文帮助已生效；标准 schema 使用 config/data_mapping.v2.json；run-all 待修 prepare-dim 的 dim_metric_config 返回列。参考：docs/PLAYBOOKS/SESSION_SNAPSHOT_2025-08-18.md。

> 更新（2025-08-19）：配置外置与启动快照

- 配置拆分：configs/{logging.yaml,ingest.yaml,database.yaml}（中文注释）
- 启动快照：env.json 写入 args_summary、config_snapshot 与 sources（来源 DEFAULT|YAML|ENV|CLI）
- 日志策略：format=json|text、routing=by_run|by_module（按模块日志便于排障）

## 概述

- 原则：以数据库事实为中心，服务端对齐与聚合，应用层薄。
- 当前状态：PostgreSQL 16（无 TimescaleDB）、APScheduler 调度；不使用 Docker/Kafka；可选 Redis 3.0.504 作为轻量缓存/任务状态。

## 数据库层（PostgreSQL 16）

- 选择理由：
  - 原生分区与丰富索引（BRIN/BTREE），足以满足当前时序写入与查询
  - 事务/约束完整、UPSERT 语义稳定，易于实现"秒级对齐 + 主键合并"
  - 生态成熟、Windows 可用、成本低
- 扩展与特性：
  - pg_stat_statements：查询观测；support 监控视图
  - 分区：周 RANGE + 站点 HASH 子分区（16片）
  - 索引：父表 BRIN(ts_bucket) + 叶子分区 btree(..., ts_bucket) INCLUDE(value)
- 替代方案与取舍：
  - TimescaleDB：时间分区与压缩强，但本项目需求可用原生 PG 实现，减少依赖
  - ClickHouse：分析极强，但写入事务/约束与生态集成成本高
  - DuckDB：嵌入式友好，但不适合本项目服务器化写入场景
- 版本与升级路径：
  - 要求 PostgreSQL 16.x；升级遵循"冷备+恢复+回归"流程；扩展与参数策略在 docs/性能基准与A_B验证.md

## 应用层（FastAPI + Pydantic v2 + psycopg3/asyncpg）

- 选择理由：
  - FastAPI：类型友好、异步支持、路由清晰
  - Pydantic v2：更快的数据校验与模型定义
  - psycopg3/asyncpg：现代 PG 客户端，支持异步与高性能
- 替代与取舍：
  - Flask：轻量但类型/异步生态弱
  - Django：重量级，ORM 与我们"以函数为接口"的策略不完全吻合
  - SQLAlchemy ORM：对象映射便利，但我们强调 DB 函数为接口，采用轻量 SQL 层
- 版本与升级：
  - FastAPI >=0.110，Pydantic v2，psycopg >=3.1 / asyncpg >=0.28
  - 升级遵循"接口稳定 + 集成测试先行"

## 调度层（APScheduler）

- 选择理由：
  - 跨平台、内嵌易用，满足小时/天级任务
  - 支持持久化与并发限制
- 对比：Windows 计划任务仅限本机、可观察性一般；Airflow/Prefect 过重
- 版本：APScheduler 3.x；计划任务与刷新策略见 reporting/monitoring 相关文档

## 测试框架（pytest/pytest-asyncio）

- 选择理由：生态成熟、与 FastAPI/异步兼容好
- 版本：pytest >=7，pytest-asyncio >=0.23
- 覆盖范围：解析/对齐/CRUD/聚合/质量

## 代码质量（ruff/mypy）

- 选择理由：
  - ruff：超快的 lint/格式
  - mypy：类型安全，提前发现问题
- 版本：ruff >=0.4，mypy >=1.8

## 依赖管理（Poetry vs requirements.txt）

- 当前采用：requirements.txt（如需切换 Poetry，需评估 CI 与部署）
- 选择对比：
  - Poetry：锁定/分发/脚本管理优秀，但迁移成本较高
  - requirements.txt：简单直接，配合 pip-tools 也可锁定
- 升级路径：
  - 短期：保留 requirements.txt，规范化版本与哈希
  - 中期：如需要脚本/多包管理，再评估 Poetry 切换时机

## 数据库连接池

项目实现了基于 psycopg 的数据库连接池管理，以提高数据库操作性能并减少连接建立/关闭的开销。

### 特性

- **连接复用**：避免频繁建立和关闭数据库连接
- **并发支持**：支持多线程并发访问
- **健康检查**：自动检测和处理连接超时、断开等问题
- **统计监控**：提供连接使用统计信息用于性能分析
- **自动恢复**：连接异常时自动重连

### 配置

- **min_size**：最小连接数，默认为 1
- **max_size**：最大连接数，默认为 10
- **max_inactive_connection_lifetime**：非活跃连接生存时间，默认为 3600 秒

### 使用

连接池在 CLI 程序启动时自动初始化，通过 `app.adapters.db.init_database()` 函数完成。

## 选型总表（速览）

- 数据库：PostgreSQL 16（pg_stat_statements，可选 Redis 3.0.504）
- 应用：FastAPI + Pydantic v2 + psycopg3/asyncpg
- 调度：APScheduler（替代 Windows 计划任务）
- 测试：pytest + pytest-asyncio
- 质量：ruff + mypy
- 依赖：requirements.txt（可能切换 Poetry）

备注

- 本文与 docs/表结构与数据库.md、docs/数据库函数参考.md、docs/性能基准与A_B验证.md 一致；若冲突以数据库事实与脚本为准。
