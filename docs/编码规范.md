# 编码规范（项目版）

本文档在“08-通用代码规范.md、python-coding-style-guide.md”的基础上，结合本项目现状（PostgreSQL、按泵站对齐、并发 COPY + 库端合并、MV 刷新与审计），形成可执行的编码规范，作为 app/ 程序的唯一编码标准。

## 1. 设计原则与边界

- 单一职责、KISS、DRY、最少惊讶；关键路径可观察（日志/指标）。
- 模块边界清晰：领域聚焦；跨层访问走网关（如 app/db）。
- 对外 API 少而稳；内部成员前缀 `_`；禁止导入期重 IO/重计算。

> 提示（MCP 建议）：提交改动前，先用 MCP 分解任务并自检受影响范围（文件/函数/依赖）；改动后用 MCP 跑最小验证并同步文档与 PLAYBOOKS。详见 docs/智能助手行为控制.md#使用-mcp-工具强制规则。

## 2. 目录与文件（app/ 程序）

- 目录建议：
  - app/ingest/{cli,config,io,copy_workers,merge,logging,utils}
  - scripts/sql/{staging_raw.sql, merge_staging_to_fact.sql}
- 文件大小 ≤ 500 行（建议）；>800 必拆分。
- 文件头 Docstring：职责/依赖/最小示例；路径统一 pathlib.Path。

## 3. 命名与风格

- 包/模块：小写蛇形；类：大驼峰；函数/变量：小写蛇形；常量：UPPER_SNAKE_CASE。
- 行宽 ≤ 100；UTF-8；`\n` 换行；导入顺序：标准库→第三方→本地；使用 isort/black/ruff。

## 4. 类型与文档

- 对外 API 必须类型注解；内部可推断；关键模块启用 mypy。
- Docstring 使用 Google 风格，描述参数/返回/异常/副作用，给最小示例。

## 5. 错误处理

- 禁止裸 except；仅捕获已知异常；不得吞异常。
- 入口层（CLI/任务）兜底捕获并输出标准化错误（error_code/message/hint/context/trace_id）。
- 可重试与不可重试错误分流；指数退避 + 抖动；幂等点才重试。

## 6. 日志与可观察性

- 遵循《docs/日志规范.md》《docs/日志运维.md》；默认 JSON 结构化；敏感信息统一脱敏；关键路径输出 rows/cost/affected。
- 使用 LoggerAdapter 注入 trace_id/job_id 等上下文；高吞吐启用 QueueHandler。

## 7. SQL 与数据访问

- 统一参数化，占位符 `%s`；严禁字符串拼接 SQL。
- 小批事务提交；单事务耗时超阈自动拆分。
- 禁止从 CSV 文件名/路径推断维度/指标；仅来自 data_mapping.json。

## 8. 并发与资源管理

- IO 密集用线程/协程，CPU 密集用进程；每线程独立连接；连接/游标/文件使用 with 释放。
- 并发与批次遵循“性能门禁”自适应策略；锁等待升高→先减小提交行数，再降并发。

## 9. 时间/时区与精度

- CSV 时间为本地时间字符串，严格 `%Y-%m-%d %H:%M:%S[.ms]`；时区来自 dim_stations.extra->>'tz'。
- 数据库内转换：ts_local → UTC → date_trunc('second') 得 ts_bucket；仅秒级；不要在 Python 端做对齐。

## 10. 文件与路径

- 使用 pathlib；读取 CSV 指定 encoding="utf-8", newline=""；大文件流式/分块处理。
- 安全：仅允许在配置的 allow_paths 下读写；禁止未校验的路径拼接。

## 11. JSON 与精度

- json.dumps(..., ensure_ascii=False, separators=(",", ":"))；避免在日志中输出大 JSON；必要时截断并标注 truncated。

## 12. 配置与依赖注入

- 配置来源：数据库/日志仅 YAML（configs/\*.yaml）；其余（如 ingest）遵循 CLI > ENV > YAML > 默认；启动打印快照（默认不脱敏）。
- 通过集中 settings 注入依赖；禁止在业务中散落读取 ENV；禁止可变全局单例。

## 13. 测试与门禁

- 单元/集成覆盖关键路径与异常分支；断点续跑/幂等/重试路径需覆盖。
- pre-commit 必须全绿（ruff/black/mypy/bandit/mdformat/yaml/memory-index）。

## 14. 提交与评审

- 小步提交；提交信息“动词+范围+结果”；评审检查：单一职责/完整注释/批量导入/幂等与对齐/测试覆盖。

## 15. 并发 COPY + 合并的专属规范

- COPY 会话内设置：synchronous_commit=off, client_encoding='UTF8'；必要时调大 work_mem。
- staging_raw 初始无索引；导入后可临时建轻索引 (station_name,device_name,metric_key) 支撑合并。
- 合并按时间窗口（周/日）执行：生成对齐去重集（同秒保留最新），INSERT … ON CONFLICT 合并。
- 合并后 ANALYZE 目标分区与 MV；必要时刷新 MV 与命中审计。

## 15A. 导入模式（auto/direct/staging）与选择

- 默认：mode=auto，阈值 total_mb=50 / per_file_mb=10 / max_file_count=20。
- 满足阈值倾向 direct（多线程直写，适合小量/验证/修复）；否则选择 staging（COPY→集合式合并）。
- CLI 可覆盖：--ingest-mode=auto|direct|staging。

## 16. 退出码与输出

- 退出码：0 成功；1 未知错误；2 配置/校验失败；3 下游不可用；4 输入无效。
- CLI 失败：stderr 输出人类提示；stdout 输出单行 JSON 摘要（包含 error_code/message/hint/context/trace_id）。

## 17. 安全与脱敏

- 绝不提交凭据；数据库/日志配置仅 YAML，不得通过 ENV/CLI 传递连接信息；严禁在代码中拼接 DSN；日志脱敏（见 docs/日志规范.md 与 docs/日志运维.md）。

## 18. 验收 Checklist（最小集）

- [ ] 类型/静态检查通过；\[ \] 单元/集成小样本通过；\[ \] SQL 参数化；\[ \] 无裸 except；\[ \] 日志字段齐备；\[ \] 文档已更新。

## 19. 配置/CLI 映射与快照

- 配置来源：数据库/日志仅 YAML；其余遵循 CLI > ENV > YAML > 默认；启动打印快照（隐藏敏感信息）。
- CLI 映射：`--concurrency` → `ingest.concurrency.max_workers`；`--window-start/--window-end` → `merge.window.*`。

## 20. 并发/批次自适应（性能门禁）

- 指标窗口：统计 `rows_* / batch_cost_ms / merge_cost_ms / failures / lock_waits`。
- 自适应：若 P95>2s 或失败率>1% → 降并发/缩批 50%；连续窗口恢复再回升。
- 输出 `backpressure.enter/exit` 与调整参数；连续不达标触发 `guardrail.stop`（按站点）。

## 21. 错误消息标准化

- 结构：`error_code/message/hint/context/trace_id`；CLI 失败：stderr 人类提示 + stdout 单行 JSON；退出码见第 16 节。
- 常见错误码：`CFG_SCHEMA/INVALID_INPUT/DOWNSTREAM/UNKNOWN`。

## 22. SQL 日志摘要与禁止项

- 禁止记录完整 SQL 与参数；仅记录摘要：`sql_op/target_table/tables/sql_cost_ms/affected_rows`。
- 严禁字符串拼接；必须参数化；变量与列表做白名单过滤。

## 23. 安全与脱敏细则

- 禁止提交凭据；`.env` 与密管注入；日志统一脱敏（见 docs/日志规范.md 与 docs/日志运维.md）。
- 文件访问仅限 allow_paths；禁止拼接未校验路径；Windows/Unix 路径兼容。

## 24. 测试细则

- 单元：Given-When-Then；异常/重试/取消/断点续跑均需覆盖。
- 集成：小样本 e2e（dry-run），验证导入→合并→对齐→刷新→审计；确保 not_aligned=0。
- 覆盖率目标：核心模块 ≥ 80%。

## 25. 依赖与版本固定

- 使用 `requirements.in` + `pip-tools` 固定版本；最小升级、可回滚；记录变更条目。

## 26. Do / Don't（速查）

- SQL：Do 参数化/小批/EXPLAIN；Don't 拼接/大事务/循环逐行 INSERT。
- 日志：Do 结构化/采样/脱敏；Don't 敏感信息/巨大 JSON/热路径频繁打点。
- 时间：Do 固定格式 + 库端对齐；Don't Python 端转换/隐式时区。

## 27. 目录与模块模板

- 包内 `__init__.py` 定义 `__all__`；入口模块 `__main__` 仅做 CLI 解析与调度。
- 模块 Docstring 必含职责/依赖/示例；公共 API 暴露在 `__all__` 中。

## 28. 并行/资源上限

- 全局并发/单站并发/批大小来自配置；任何时刻超过锁等待阈值优先减小批次，再降并发。
- 连接池上限与文件句柄上限可配置；默认保守值，逐步放量。

## 29. 影子运行与灰度

- 新算法/规则先影子运行（不落库）；比对差异后灰度放量，异常即回退；记录事件与参数。

## 30. 变更记录与回滚

- 每次变更提供“问题/原因/对策/验证/影响/回滚”；回滚脚本置于 `scripts/rollback_*`。

## 31. 模块范式（可复制模板）

## 31A. 拒绝垃圾代码与最小重复（强制）

- 禁止垃圾代码：

  - 禁止裸 except；必须捕获具体异常并记录上下文
  - 必须 Docstring（公开 API/类/函数），描述职责/参数/返回/异常/示例
  - 函数 > 200 行、文件 > 800 行需拆分；圈复杂度 ≤ 10（建议 ≤ 6）
  - 禁止魔法数字：集中定义常量
  - 禁止未使用代码/依赖；禁止复制粘贴未抽象的重复块
  - SQL 必须参数化；严禁字符串拼接
  - 对外 API 必须类型注解；关键模块启用 mypy strict

- 重复最小化：

  - 跨模块共性逻辑抽取到 adapters/core/utils
  - 启用重复检测门禁（pylint R0801/ruff 对应规则），初期警告、两周后阻断

- 分层建议：`app/ingest/{cli,config,io,copy_workers,merge,logging,utils,db}`

  - cli：命令入口与参数校验（不写业务）
  - config：配置加载/合并/脱敏快照
  - io：文件扫描/解压/读取迭代器（流式）
  - copy_workers：并发 COPY、连接与会话参数设置
  - merge：集合式 SQL 生成与执行、窗口控制、统计
  - logging：初始化、上下文、采样/限流、输出路由
  - db：网关（参数化 SQL、统一打点/脱敏/重试）
  - utils：共用工具（trace_id、时间格式、批次切分、背压调节）

模块模板：

```python
"""模块职责与最小示例。
依赖: app/ingest/db/gateway
示例:
    svc = Service(settings, db)
    stats = svc.run_window(window_start, window_end)
"""
from __future__ import annotations
from dataclasses import dataclass
from typing import Protocol

__all__ = ["Service", "Window"]

@dataclass
class Window:
    start: str  # YYYY-MM-DD
    end: str

class DbGateway(Protocol):
    def merge_window(self, w: Window) -> dict: ...  # 返回统计

class Service:
    def __init__(self, settings: dict, db: DbGateway) -> None:
        self.settings = settings
        self.db = db
    def run_window(self, start: str, end: str) -> dict:
        w = Window(start, end)
        return self.db.merge_window(w)
```

## 32. Type 标注样例（TypedDict/Enum/Protocol）

```python
from enum import Enum
from typing import TypedDict, Protocol

class SqlOp(str, Enum):
    INSERT = "INSERT"
    UPDATE = "UPDATE"
    SELECT = "SELECT"

class MergeStats(TypedDict):
    rows_input: int
    rows_deduped: int
    rows_merged: int
    batch_cost_ms: int

class SqlGateway(Protocol):
    def exec(self, sql: str, params: tuple|list|None = None) -> int: ...
    def exec_many(self, sql: str, batches: list[tuple]) -> list[int]: ...
```

mypy 建议：公开 API 全量注解；关键模块开启 strict 规则（见 pyproject）。

## 33. 错误码表（标准化输出）

| error_code    | 场景              | 说明                         | 建议处理          |
| ------------- | ----------------- | ---------------------------- | ----------------- |
| CFG_SCHEMA    | 配置/映射校验失败 | 缺字段/类型不符              | 修复配置后重试    |
| INVALID_INPUT | CLI/参数不合法    | 缺必填/格式不符              | 更正参数          |
| DOWNSTREAM    | 下游不可用        | 数据库/文件系统错误          | 稍后重试/联系运维 |
| DB_DEADLOCK   | 数据库死锁        | PostgreSQL deadlock detected | 指数退避重试      |
| DB_SERIAL     | 可重试序列化失败  | SQLSTATE 40001               | 重试              |
| UNKNOWN       | 未分类异常        | 见日志 stack                 | 报告并排查        |

标准化错误 JSON（stdout 单行、stderr 人类可读）：

```json
{"error_code":"CFG_SCHEMA","message":"mapping 校验失败","hint":"修复缺失字段","context":{"file":"config/data_mapping.json"}}
```

## 34. CLI 退出码/输出规范（可复制段落）

```python
import json, sys, typer
from typing import Any

class ExitCode:
    OK = 0
    UNKNOWN = 1
    CONFIG = 2

## 35. 程序目录规范（方案A，强制）

- 分层与子层命名（强制）：
  - app/core/{time_utils.py, config/, types/, backpressure/}
  - app/adapters/{db/, logging/, fs/}
  - app/services/ingest/{copy_workers.py, merge_service.py, run_all.py}
  - app/cli/main.py
- 职责边界（强制）：
  - 单一职责（SRP），跨层交互经网关/适配器
  - copy 层仅 COPY，不做业务判断；merge 层仅集合式合并与统计

典型文件清单（示例，约10行）：
- app/core/time_utils.py
- app/core/config/__init__.py
- app/adapters/db/gateway.py
- app/adapters/logging/init.py
- app/adapters/fs/reader.py
- app/services/ingest/copy_workers.py
- app/services/ingest/merge_service.py
- app/services/ingest/run_all.py
- app/cli/main.py

## 36. 并发与背压自适应契约（强制）

- 指标采集：rows_*, batch_cost_ms, merge_cost_ms, fail_rate, lock_waits
- 触发阈值（默认，可配置）：P95>2s 或 fail_rate>1%
- 调整动作：先 shrink_batch(50%) → 再 shrink_workers；恢复后渐进回升
- 事件：backpressure.enter/exit、guardrail.stop（统一结构化字段）

## 37. CSV 输入契约（强制）

- 固定列名：TagName（变量名称）、DataTime（数据时间）、DataValue（数据值）；大小写兼容
- 解析失败：沉淀到 staging_rejects（记录 error_msg），导入不中断
- 禁止从文件名/路径推断维度/指标（唯一来源：config/data_mapping.json）

## 38. 配置优先级与脱敏快照（强制）

- 覆盖优先级：数据库/日志仅 YAML；其余遵循 CLI > ENV > YAML > 默认
- 配置文件位置：configs/ingest.yaml、configs/logging.yaml（均位于 configs/ 根）
- 启动打印“脱敏快照”：隐藏密码/令牌/DSN 等敏感信息

    DOWNSTREAM = 3
    INVALID_INPUT = 4

def print_error_json(code: str, message: str, hint: str = "", context: dict[str, Any] | None = None):
    obj = {"error_code": code, "message": message}
    if hint:
        obj["hint"] = hint
    if context:
        obj["context"] = context
    sys.stdout.write(json.dumps(obj, ensure_ascii=False) + "\n")

app = typer.Typer()

@app.command()
def import_station(name: str, concurrency: int = 4, dry_run: bool = False) -> None:
    try:
        if not name:
            raise ValueError("name is empty")
        # 执行业务...
        typer.echo(f"导入站点: {name}, 并发: {concurrency}, dry_run={dry_run}")
        raise typer.Exit(ExitCode.OK)
    except ValueError as e:
        typer.echo("参数错误: " + str(e), err=True)
        print_error_json("INVALID_INPUT", str(e), hint="检查 --name 参数")
        raise typer.Exit(ExitCode.INVALID_INPUT)
    except Exception:
        typer.echo("执行失败", err=True)
        print_error_json("UNKNOWN", "执行失败", context={"name": name})
        raise typer.Exit(ExitCode.UNKNOWN)

if __name__ == "__main__":
    app()
```
