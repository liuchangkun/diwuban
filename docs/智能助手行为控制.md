# 智能助手行为控制（治理规范）

## 快速导航
- 使用 MCP 工具（强制）：见下文“使用 MCP 工具（强制规则）”
- 严格模式-核对清单（含 MCP 勾选）：docs/严格模式-核对清单.md
- PR 模板（含 MCP 区块）：.github/PULL_REQUEST_TEMPLATE.md




目的与范围
- 降低误操作风险、统一交互规范、保证可追溯性
- 范围：AI 助手在本仓库的读写、执行、文档与记忆操作

一、行为分级与默认立场
- 低风险（默认允许）：查看代码/文档、写笔记、改文档、运行本地只读命令、运行单元测试
- 中风险（需确认）：修改代码、变更配置、生成或更新脚本、添加依赖
- 高风险（禁止/双重确认）：安装依赖、迁移/删除数据库、部署、推送代码、读写 data/、操作 venv/、长耗时外部调用

二、明确禁止项与例外
- 禁止：未经许可更改系统状态、直接编辑包清单、扫描 venv/ 与 data/ 目录、写入生产数据库；在代码/ENV/CLI 中提供数据库或日志配置（统一仅 YAML 来源）；在代码中拼接 DSN
- 例外流程：需在对话中使用“授权口令”并记录到 PLAYBOOKS/决策记录.md

三、信息与执行策略
- 信息获取：优先 view/grep-search/codebase-retrieval；不扫描 venv/ 与 data/
- 执行验证（安全-by-default）：仅允许测试/静态检查/本地构建；危险操作需显式许可语句
- 包管理：仅允许使用包管理器命令；禁止直接改 package 文件


    - 效率提升与一致性（新增）：
      - 必须使用 MCP 工具（Context 7 + Sequential thinking）进行任务分解、信息检索与验证，减少人工遗漏、提升开发效率，并保证文档/审计同步；若临时不可用，需在 PR 中注明豁免原因与替代验证证据。

四、任务与文档同步
- 使用任务清单管理：调查→实施→验证→文档同步→PLAYBOOKS 记录
- 每次重要变更后：更新 PLAYBOOKS、保存记忆、同步 docs

五、日志与审计
- 记录：命令、cwd、退出码、关键日志（失败时最多重试2次）
- 超出重试上限：需人工确认后再继续

六、关键词触发与口令
- 触发自动“三步”（更新PLAYBOOKS、保存记忆、同步文档）的关键词：
  - “记录变更/更新 PLAYBOOKS/保存记忆/按照 PLAYBOOKS 流程完成/记忆和文档都更新了吗？/PLAYBOOKS”
- 高风险授权口令模板：
  - 我确认授权你在本地执行【操作】；允许使用【资源/权限】；仅在【环境】；若失败请停止并告知。

七、附录：示例与常见问题
- 正确示例：在修改多文件前先创建任务→实施→运行最小验证→更新文档与 PLAYBOOKS
- 错误示例：直接安装依赖/修改包清单；在未授权情况下运行可能改写数据的命令



## 严格模式执行规则与完成定义（DoD）

- 修改前（Why/What/Impact/Risk/Rollback 必填）
  - 说明目标、范围、影响面、风险与回滚方案；列出受影响文件/函数清单
  - 引用相关规范链接：流程/日志/数据库/表结构/行为控制等
  - 建立任务清单：调查→实施→验证→文档/PLAYBOOKS 同步
- 过程控制（最小改动）
  - 跨文件改动分步提交并逐步验证；禁止读写 venv/ 与 data/；不改包清单（依赖需授权且用包管理器）
  - 高风险守卫：部署/迁移/删除/写生产数据/CLI 覆盖 DB DSN（需 --allow-cli-dsn）等未授权一律拒绝
- 验证与完成定义
  - 必须运行低成本验证：单测/静态检查/最小 E2E；给出命令、cwd、退出码与关键日志
  - 成功标准：Exit=0、无明显错误；env.json 含 args_summary/config_snapshot/sources/ts/run_id/run_dir；日志可按模块检索
  - 失败≤2次小步修复，超出则暂停并请求决策
- 日志与可观测性
  - 输出事件规范：db.exec.started/succeeded/failed、align.merge.window 等；UTC + Z；必要字段脱敏；长文本采样/截断
- 文档与审计同步（强制三步）
  - 更新 PLAYBOOKS（决策/配置变更/错误与修复/经验教训）+ 保存关键记忆 + 同步相关 docs（可导航）
- PR 准入
  - 填写“严格模式核对 + E2E 验证与产物”；提供最小窗口命令与代表性日志；Commit/分支命名规范
- 性能与边界
  - 设定基本性能预算（如窗口段合并耗时、P95 目标）；异常时提供 cost_ms/affected_rows/EXPLAIN 线索
- 交互与澄清
  - 不确定/多解先澄清；阻塞>2次必须汇报并等待决策


## 使用 MCP 工具（强制规则）

- 目的
  - 通过 MCP 工具进行“任务分解—信息获取—执行—验证—审计”的全链路规范化，降低遗漏与误操作风险

- 适用范围
  - 凡涉及多文件/跨层改动、需要验证/运行命令、或对外部资源有潜在影响的工作，必须使用 MCP
  - 简单文档编辑可豁免，但仍建议用 MCP 做最小信息核对


- 默认启用工具集（MCP）
  - Context 7：用于库/框架文档检索与片段引用
  - Sequential thinking：用于任务分解、反思与多步验证
  - 约定：进行编码/改动时，默认使用上述工具完成“检索→规划→验证”的闭环；如工具不可用，需在记录中说明原因与补救措施

- 最小使用要求
  1) 任务分解：先用 MCP 建立任务清单（Investigate→实施→验证→文档/PLAYBOOKS），小步推进
  2) 信息获取：优先用 MCP 的检索/查看工具定位目标文件、函数签名、依赖关系
  3) 安全执行：通过 MCP 执行低风险验证命令（单测/静态检查/最小 E2E），捕获退出码与关键日志
  4) 审计记录：在 PLAYBOOKS 记录对应条目（DEC/CONF/IMP/LES/BENCH），并保存关键记忆
  5) 文档同步：用 MCP 更新相关 docs，保证导航可达与示例可复现

- 安全与边界
  - 不得通过 MCP 读写 data/ 与 venv/；不得安装依赖或部署/迁移/删除，除非获得明确授权口令
  - 覆盖 DB DSN 必须显式 --allow-cli-dsn；外部网络/高成本调用须事先确认
  - 输出/日志必须脱敏；长文本需采样或截断

- 成本与效率
  - “一次高信号”优先：同阶段避免多次等价调用；仅获取推进下一步所需最小信息
  - 失败退避：同类操作最多两次尝试；仍失败必须暂停并请求澄清/授权

- 验证与完成定义（DoD）
  - 通过 MCP 提交验证证据：命令、cwd、退出码、关键日志（Exit=0 且无明显错误视为成功）
  - 产物核对：env.json 含 args_summary/config_snapshot/sources/ts/run_id/run_dir；日志在 by_module 下可检索
  - 文档与 PLAYBOOKS 已更新；导航可达；关键记忆已保存

- 审计与可追溯
  - 每次关键 MCP 操作需注明：工具/目的/输入要点/结论，并与 DEC/CONF/IMP 条目互链
  - 高风险 MCP 操作需粘贴授权口令摘要与边界条件

- 异常与豁免
  - MCP 工具不可用：说明原因、临时替代、风险与补救，并在恢复后补录审计
  - 简单文档编辑豁免：在 PR 模板中说明“无需 MCP 的理由”，由 reviewer 确认


## 严格模式永久启用说明（必读）
- 默认状态：严格模式长期开启，适用于本仓库内所有由 AI 助手发起或协助的工作（阅读/编码/运行/文档/审计）。
- 执行承诺：
  - 必用 MCP 工具完成“检索→规划→验证→审计”闭环；非 trivial 任务先建任务清单（Investigate→实施→验证→文档/PLAYBOOKS）。
  - 未经授权，严禁安装依赖、读写 data/ 与 venv/、部署/迁移/删除数据库、推送代码、长耗时外部调用。
  - 高风险操作须按照“高风险授权口令模板”确认；执行后必须在 PLAYBOOKS 记录并同步文档。
  - 仅运行低成本验证（单测/静态检查/最小 E2E）；失败≤2次小步修复，超过即暂停等待决策。
- 例外与豁免：工具不可用或 trivial 文档编辑时，可提出豁免；需在 PR 模板中注明理由与替代验证证据，由 reviewer 确认。

## 质量与合规闸门（编码/日志/检查）
- 编码与注释要求（中文注释）
  - 模块/文件头：写明目的、主要职责、依赖与注意事项。
  - 公共函数/类：完整 docstring（参数/返回/异常/示例），类型注解覆盖到 100%（测试代码可放宽）。
  - 关键逻辑：中文行内注释解释“为什么”（非“代码做了什么”）。
  - 错误处理：异常信息应包含关键上下文（输入/配置/边界），建议给出修复指引。
  - 可配置项：严禁硬编码；配置来源（YAML/ENV/CLI）需在文档与注释中说明。
- 日志与可观测性要求
  - 统一使用结构化 JSON 日志（或 by_module 文本），事件名称遵循 docs/日志规范.md。
  - 必要上下文：run_id、window_start/window_end、成本（cost_ms）、影响行（affected_rows）等。
  - 采样与节流：进度类日志需 loop_log_every_n + min_interval_sec，避免日志风暴；敏感信息必须脱敏。
  - 失败日志：包含错误摘要、关键信息与（若可）EXPLAIN/诊断线索；限制长文本长度（截断）。
- 质量检查与自动化（建议清单）
  - 代码质量：ruff/black/isort/mdformat/markdownlint；mypy/pyright（类型检查）；import-linter（可选）。
  - 测试与覆盖：pytest（推荐门槛≥80%），新增/变更代码需附测试；慢测排队，核心用例先跑。
  - 构建与文档：docs 可构建、链接可达；示例命令可复现；内含日志/产物路径示例。
  - 安全扫描：secretlint/trufflehog（可选），确保无密钥泄露；SQL/Lua 等额外 linter 按需配置。
- 完成后自检流程（建议 5 步）
  1) 本地运行 pre-commit run -a（或等效 CLI）
  2) 运行 pytest -q 并查看关键日志；必要时添加最小 E2E 验证
  3) 更新/核对 docs 与导航：新增或变更的命令、参数、事件示例、路径
  4) 执行 PLAYBOOKS 三步：更新记录、保存记忆、同步相关文档
  5) 提交前对照 PR 模板“严格模式核对 + E2E 产物”逐项确认
- CLI 覆盖与安全边界（示例）
  - 覆盖 logging.sampling.min_interval_sec：--log-sampling-min-interval（仅限本地 DEV）
  - 覆盖 DB DSN：必须显式 --allow-cli-dsn（并在审计中标注来源）
