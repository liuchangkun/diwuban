# 表结构与数据库

> 写入边界：所有写入经 DB 函数；UTC 存储，秒级对齐，主键合并；CHECK 约束兜底。

- 事实表：fact_measurements（周分区）
  - 主键：(station_id, device_id, metric_id, ts_bucket)
  - 父表索引：BRIN(ts_bucket)
  - 叶子分区索引：btree(station_id, device_id, metric_id, ts_bucket) INCLUDE(value)
  - 对齐保护：CHECK(date_trunc('second', ts_bucket) = ts_bucket)（父表与分区 NOT VALID；后续 VALIDATE）
- 汇总层：mv_measurements_hourly / mv_measurements_daily（CONCURRENTLY 刷新建议）
- 函数：
  - public：safe_upsert_measurement、safe_upsert_measurement_local、smart_vacuum_strategy、auto_performance_tuning、auto_space_reclaim、database_health_check
  - api：get_measurements、upsert_measurement、upsert_measurements_json、update_measurement_value、delete_measurements_by_filter、delete_measurement
  - reporting：get_metrics_daily/hourly/\_multi/auto
  - monitoring：capture_pgss_snapshot/cleanup_pgss_snapshot、v_mv_hit_audit、v_active_partitions/\_last7d/\_index_coverage、v_query_coverage、ensure_active_indexes、run_ab_test

脚本索引：scripts/sql/constraints_time_alignment.sql、scripts/sql/safe_upsert_measurement_local.sql 等。

## 字段详表（自动采集于 2025-08-16）

文件：docs/\_columns.tsv（schema|table|column|data_type|is_nullable|default|comment）

- 说明：如注释出现乱码，后续通过 pg_description 定点修复（编码统一为 UTF-8）
- 示例（节选）：
  monitoring|pgss_snapshot|snapshot_time|timestamptz|NO|now()|采样时间
  …（详见 \_columns.tsv）

## 分区策略详解

- 周分区（fact_measurements_YYYYwWW）+ 站点 HASH 子分区（\_p0..\_p15）
- 父表 BRIN(ts_bucket)；叶子分区 btree(station_id, device_id, metric_id, ts_bucket) INCLUDE(value)
- 周期维护：monitoring.ensure_active_indexes(window_days)

更多全量逐表字段，请见：docs/表结构明细_附录.md

## 逐表字段（精选核心表，来自 docs/\_columns.tsv）

### public.dim_stations（泵站维表）

| 字段       | 类型        | 可空 | 默认                                     | 注释                                         |
| ---------- | ----------- | ---- | ---------------------------------------- | -------------------------------------------- |
| id         | bigint      | NO   | nextval('dim_stations_id_seq'::regclass) |                                              |
| name       | text        | NO   |                                          |                                              |
| extra      | jsonb       | YES  |                                          | 推荐包含 tz，如 extra->>'tz'='Asia/Shanghai' |
| created_at | timestamptz | YES  | now()                                    |                                              |

### public.dim_devices（设备维表）

| 字段       | 类型        | 可空 | 默认                                    | 注释               |
| ---------- | ----------- | ---- | --------------------------------------- | ------------------ |
| id         | bigint      | NO   | nextval('dim_devices_id_seq'::regclass) |                    |
| station_id | bigint      | NO   |                                         |                    |
| name       | text        | NO   |                                         | 同站内唯一         |
| type       | text        | NO   |                                         | pump               |
| pump_type  | text        | YES  |                                         | variable_frequency |
| extra      | jsonb       | YES  |                                         |                    |
| created_at | timestamptz | YES  | now()                                   |                    |

### public.dim_metric_config（指标配置）

| 字段            | 类型        | 可空 | 默认                                          | 注释                            |
| --------------- | ----------- | ---- | --------------------------------------------- | ------------------------------- |
| id              | bigint      | NO   | nextval('dim_metric_config_id_seq'::regclass) |                                 |
| metric_key      | text        | NO   |                                               | 唯一键，如 voltage_b / pressure |
| unit            | text        | NO   |                                               |                                 |
| unit_display    | text        | YES  |                                               |                                 |
| decimals_policy | text        | YES  | 'as_is'                                       | as_is                           |
| fixed_decimals  | smallint    | YES  |                                               |                                 |
| value_type      | text        | YES  |                                               |                                 |
| valid_min       | numeric     | YES  |                                               |                                 |
| valid_max       | numeric     | YES  |                                               |                                 |
| created_at      | timestamptz | YES  | now()                                         |                                 |
| updated_at      | timestamptz | YES  | now()                                         |                                 |

### public.device_rated_params（设备额定参数）

| 字段           | 类型        | 可空 | 默认                                            | 注释                                               |
| -------------- | ----------- | ---- | ----------------------------------------------- | -------------------------------------------------- |
| id             | bigint      | NO   | nextval('device_rated_params_id_seq'::regclass) |                                                    |
| device_id      | bigint      | NO   |                                                 | FK dim_devices.id                                  |
| param_key      | text        | NO   |                                                 | 如 rated_flow/rated_head/rated_power/pipe_diameter |
| value_numeric  | numeric     | YES  |                                                 | 与 value_text 二选一可空                           |
| value_text     | text        | YES  |                                                 | 与 value_numeric 二选一可空                        |
| unit           | text        | YES  |                                                 |                                                    |
| source         | text        | YES  |                                                 |                                                    |
| effective_from | timestamptz | YES  |                                                 |                                                    |
| effective_to   | timestamptz | YES  |                                                 |                                                    |
| created_at     | timestamptz | YES  | now()                                           |                                                    |
| updated_at     | timestamptz | YES  | now()                                           |                                                    |

### public.dim_mapping_items（映射快照）

| 字段         | 类型        | 可空 | 默认                                          | 注释 |
| ------------ | ----------- | ---- | --------------------------------------------- | ---- |
| id           | bigint      | NO   | nextval('dim_mapping_items_id_seq'::regclass) |      |
| mapping_hash | text        | NO   |                                               |      |
| station_name | text        | NO   |                                               |      |
| device_name  | text        | NO   |                                               |      |
| metric_key   | text        | NO   |                                               |      |
| source_hint  | text        | NO   |                                               |      |
| created_at   | timestamptz | YES  | now()                                         |      |

### public.fact_measurements（时序事实，分区父表结构）

| 字段        | 类型        | 可空 | 默认                                          | 注释                                 |
| ----------- | ----------- | ---- | --------------------------------------------- | ------------------------------------ |
| id          | bigint      | NO   | nextval('fact_measurements_id_seq'::regclass) |                                      |
| station_id  | bigint      | NO   |                                               |                                      |
| device_id   | bigint      | NO   |                                               |                                      |
| metric_id   | bigint      | NO   |                                               |                                      |
| ts_raw      | timestamptz | NO   |                                               | 原始时间（建议 UTC）                 |
| ts_bucket   | timestamptz | NO   |                                               | 对齐秒：date_trunc('second', ts_utc) |
| value       | numeric     | NO   |                                               |                                      |
| source_hint | text        | YES  |                                               |                                      |
| inserted_at | timestamptz | YES  | now()                                         |                                      |

## 附录A. 导入 staging 与集合式合并（方案A）

- staging_raw（UNLOGGED，强制）：
  - 字段：station_name text, device_name text, metric_key text, TagName text, DataTime text, DataValue text, source_hint text, loaded_at timestamptz default now()
  - 说明：TagName/DataTime/DataValue 与 CSV 固定列名一一对应；导入阶段无索引（建议）
- staging_rejects：
  - 字段同上 + error_msg text, rejected_at timestamptz
  - 用途：沉淀解析失败/校验失败行，导入不中断
- 合并主流程（强制）：
  - JOIN 维表/映射 → (sid,did,mid)
  - 时区与对齐：DataTime + 站点 tz → ts_utc → ts_bucket = date_trunc('second', ts_utc)
  - 去重：按 (sid,did,mid,ts_bucket) row_number()=1 保留最新 ts_utc
  - 合并：INSERT … ON CONFLICT DO UPDATE（value/source_hint/ts_raw）
  - 窗口：按 UTC ISO 周界（周一 00:00:00）对齐，WHERE ts_bucket ∈ \[start, end)
- 注意：不引入“中间并存”标准化列；转换后仅写入目标事实表字段
- 临时轻索引（可选）：合并性能不足时考虑 (station_name, device_name, metric_key) 轻索引，合并后清理

注：以上结构与各周/子分区表一致；父表具 BRIN(ts_bucket)；叶子分区具 btree(station_id,device_id,metric_id,ts_bucket) INCLUDE(value)。

### 合并 SQL 示例（节选，示意）

```sql
WITH parsed AS (
  SELECT
    s.station_id,
    d.device_id,
    m.metric_id,
    to_timestamp(sr."DataTime", 'YYYY-MM-DD HH24:MI:SS') AT TIME ZONE (st.extra->>'tz') AS ts_utc,
    sr."DataValue"::numeric AS val,
    sr.source_hint
  FROM staging_raw sr
  JOIN dim_stations st ON st.name = sr.station_name
  JOIN dim_devices d ON d.station_id = st.id AND d.name = sr.device_name
  JOIN dim_metric_config m ON m.metric_key = sr.metric_key
), dedup AS (
  SELECT *, date_trunc('second', ts_utc) AS ts_bucket,
         row_number() OVER (PARTITION BY station_id, device_id, metric_id, date_trunc('second', ts_utc) ORDER BY ts_utc DESC) AS rn
  FROM parsed
)
INSERT INTO fact_measurements(station_id, device_id, metric_id, ts_raw, ts_bucket, value, source_hint)
SELECT station_id, device_id, metric_id, ts_utc, ts_bucket, val, source_hint
FROM dedup
WHERE rn = 1 AND ts_bucket >= :window_start AND ts_bucket < :window_end
ON CONFLICT (station_id, device_id, metric_id, ts_bucket)
DO UPDATE SET value = EXCLUDED.value, source_hint = EXCLUDED.source_hint, ts_raw = EXCLUDED.ts_raw;
```
