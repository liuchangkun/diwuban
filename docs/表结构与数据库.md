# 表结构与数据库

> 状态板（2025-08-18）：标准 schema（config/data_mapping.v2.json）启用；导入模式默认 auto（total_mb=50/per_file_mb=10/max_file_count=20 满足倾向 direct，否则 staging）；日志默认 json，可在 configs/logging.yaml 切换 text；参数与配置快照默认不脱敏；已修复 dim_metric_config 默认单位与 RETURNING 列、dim_mapping_items 的 mapping_hash/source_hint 约束、设备类型归一；CSV 头支持 BOM；日志 JSON 支持 default=str 序列化。会话快照：docs/PLAYBOOKS/SESSION_SNAPSHOT_2025-08-18.md。

> 更新（2025-08-19）：运行产物与配置外置

- run-all 产出 env.json（args_summary + config_snapshot + sources）与 summary.json（copy/merge 用时、背压、tz_fallback）
- 配置外置：configs/{logging.yaml,ingest.yaml,database.yaml}（中文注释）；优先级 CLI>ENV>YAML>默认；base_dir 固定 data
- 日志：format=json|text、routing=by_run|by_module（按模块输出便于溯源 SQL 与性能）

> 写入边界：所有写入经 DB 函数；UTC 存储，秒级对齐，主键合并；CHECK 约束兜底。

- 事实表：fact_measurements（周分区 + 实测包含 HASH 子分区）

  - 主键：(station_id, device_id, metric_id, ts_bucket)
  - 索引（数据库实况）：
    - BRIN(ts_bucket)：历史范围检索
    - btree(device_id, ts_bucket)：按设备时间检索
    - btree(station_id, ts_bucket, device_id, metric_id) INCLUDE(value)：主查询覆盖索引
  - 对齐保护：CHECK(date_trunc('second', ts_bucket) = ts_bucket)

- 汇总层：当前实例检测到 reporting.mv_measurements_hourly（物化视图，见快照）

- 实库核对（psql=16.10 直连）：

  - schemas: api, monitoring, public, reporting
  - matviews: reporting.mv_measurements_daily、reporting.mv_measurements_hourly（两者均存在）
  - views: monitoring.*(6个)、public.pg_stat_statements/pg_stat_statements_info、public.station\_*\_view、reporting.v_metrics_daily
  - 兼容视图 v_adaptive_horizontal/v_fully_adaptive_data：当前库均未检测到（to_regclass 为空）。API 将回退到“明细透视（v_fully_adaptive_data）”路径，现实例最终走明细透视方案。

- 函数与视图（数据库实况，2025-08-26）：

  - public：safe_upsert_measurement、safe_upsert_measurement_local、smart_vacuum_strategy、auto_performance_tuning、auto_space_reclaim、database_health_check
  - reporting：get_metrics_daily/hourly/\_multi/auto、mv_measurements_hourly（matview）
  - monitoring：capture_pgss_snapshot/cleanup_pgss_snapshot、v_mv_hit_audit、v_active_partitions/\_last7d/\_index_coverage、v_query_coverage、ensure_active_indexes、run_ab_test
  - 兼容视图（public）：station、device、operation_data、v_fully_adaptive_data、v_adaptive_horizontal（供 API 使用）

脚本索引：scripts/sql/constraints_time_alignment.sql、scripts/sql/safe_upsert_measurement_local.sql 等。

## 字段详表（自动采集于 2025-08-16）

文件：docs/\_columns.tsv（schema|table|column|data_type|is_nullable|default|comment）

- 说明：如注释出现乱码，后续通过 pg_description 定点修复（编码统一为 UTF-8）
- 示例（节选）：
  monitoring|pgss_snapshot|snapshot_time|timestamptz|NO|now()|采样时间
  …（详见 \_columns.tsv）

## 分区策略详解

- 周分区（fact_measurements_YYYYwWW）+ 站点 HASH 子分区（\_p0..\_p15）

- 父表 BRIN(ts_bucket)；叶子分区 btree(station_id, device_id, metric_id, ts_bucket) INCLUDE(value)

- 周期维护：monitoring.ensure_active_indexes(window_days)

- 视图选择策略（与 API 对齐）：/api/v1/data/measurements 在仅提供 station_id 且未指定 device_id 时，优先使用 v_adaptive_horizontal（若存在且窗口内有数据）；否则回退 v_fully_adaptive_data 透视。

- 合并前分区保障：合并服务会在进入窗口时尽力确保对应周分区与 16 个 HASH 子分区存在，并为子分区建立包含列索引；异常将忽略并继续合并流程（详见 app.adapters.db.gateway.run_merge_window）。

更多全量逐表字段，请见：docs/表结构明细_附录.md

## 数据库连接池

项目实现了基于 psycopg 的数据库连接池管理，以提高数据库操作性能并减少连接建立/关闭的开销。

### 特性

- **连接复用**：避免频繁建立和关闭数据库连接
- **并发支持**：支持多线程并发访问
- **健康检查**：自动检测和处理连接超时、断开等问题
- **统计监控**：提供连接使用统计信息用于性能分析
- **自动恢复**：连接异常时自动重连

### 配置

- **min_size**：最小连接数，默认为 1
- **max_size**：最大连接数，默认为 10
- **max_inactive_connection_lifetime**：非活跃连接生存时间，默认为 3600 秒

### 使用

连接池在 CLI 程序启动时自动初始化，通过 `app.adapters.db.init_database()` 函数完成。在数据库操作中，优先使用连接池获取连接，未初始化时回退到直连模式。

## 逐表字段（精选核心表，来自 docs/\_columns.tsv）

### public.dim_stations（泵站维表）

| 字段       | 类型        | 可空 | 默认                                     | 注释                                         |
| ---------- | ----------- | ---- | ---------------------------------------- | -------------------------------------------- |
| id         | bigint      | NO   | nextval('dim_stations_id_seq'::regclass) |                                              |
| name       | text        | NO   |                                          |                                              |
| extra      | jsonb       | YES  |                                          | 推荐包含 tz，如 extra->>'tz'='Asia/Shanghai' |
| created_at | timestamptz | YES  | now()                                    |                                              |

### public.dim_devices（设备维表）

| 字段       | 类型        | 可空 | 默认                                    | 注释               |
| ---------- | ----------- | ---- | --------------------------------------- | ------------------ |
| id         | bigint      | NO   | nextval('dim_devices_id_seq'::regclass) |                    |
| station_id | bigint      | NO   |                                         |                    |
| name       | text        | NO   |                                         | 同站内唯一         |
| type       | text        | NO   |                                         | pump               |
| pump_type  | text        | YES  |                                         | variable_frequency |
| extra      | jsonb       | YES  |                                         |                    |
| created_at | timestamptz | YES  | now()                                   |                    |

### public.dim_metric_config（指标配置）

| 字段            | 类型        | 可空 | 默认                                          | 注释                            |
| --------------- | ----------- | ---- | --------------------------------------------- | ------------------------------- |
| id              | bigint      | NO   | nextval('dim_metric_config_id_seq'::regclass) |                                 |
| metric_key      | text        | NO   |                                               | 唯一键，如 voltage_b / pressure |
| unit            | text        | NO   |                                               |                                 |
| unit_display    | text        | YES  |                                               |                                 |
| decimals_policy | text        | YES  | 'as_is'                                       | as_is                           |
| fixed_decimals  | smallint    | YES  |                                               |                                 |
| value_type      | text        | YES  |                                               |                                 |
| valid_min       | numeric     | YES  |                                               |                                 |
| valid_max       | numeric     | YES  |                                               |                                 |
| created_at      | timestamptz | YES  | now()                                         |                                 |
| updated_at      | timestamptz | YES  | now()                                         |                                 |

- 默认策略与 UPSERT 规则（2025-08-18）：
  - 默认单位：frequency=Hz, voltage\_*=V, current\_*=A, power=kW, kwh=kWh, power_factor=无量纲, pressure=MPa, flow_rate=m3/h, cumulative_flow=m3
  - 默认校验策略：
    - voltage\_*/current\_*: value_type=number, \[0, 1000\]
    - frequency: number, \[0, 100\]
    - power: number, \[0, 10000\]
    - kwh/cumulative_flow: number, \[0, +∞)
    - power_factor: number, \[0, 1\]
  - prepare_dim 插入 dim_metric_config 时：ON CONFLICT(metric_key) 以 COALESCE 仅补齐缺失字段（unit/unit_display/decimals_policy/value_type/valid_min/valid_max），不覆盖已有配置。

### public.device_rated_params（设备额定参数）

| 字段           | 类型        | 可空 | 默认                                            | 注释                                               |
| -------------- | ----------- | ---- | ----------------------------------------------- | -------------------------------------------------- |
| id             | bigint      | NO   | nextval('device_rated_params_id_seq'::regclass) |                                                    |
| device_id      | bigint      | NO   |                                                 | FK dim_devices.id                                  |
| param_key      | text        | NO   |                                                 | 如 rated_flow/rated_head/rated_power/pipe_diameter |
| value_numeric  | numeric     | YES  |                                                 | 与 value_text 二选一可空                           |
| value_text     | text        | YES  |                                                 | 与 value_numeric 二选一可空                        |
| unit           | text        | YES  |                                                 |                                                    |
| source         | text        | YES  |                                                 |                                                    |
| effective_from | timestamptz | YES  |                                                 |                                                    |
| effective_to   | timestamptz | YES  |                                                 |                                                    |
| created_at     | timestamptz | YES  | now()                                           |                                                    |
| updated_at     | timestamptz | YES  | now()                                           |                                                    |

### public.dim_mapping_items（映射快照）

| 字段         | 类型        | 可空 | 默认                                          | 注释 |
| ------------ | ----------- | ---- | --------------------------------------------- | ---- |
| id           | bigint      | NO   | nextval('dim_mapping_items_id_seq'::regclass) |      |
| mapping_hash | text        | NO   |                                               |      |
| station_name | text        | NO   |                                               |      |
| device_name  | text        | NO   |                                               |      |
| metric_key   | text        | NO   |                                               |      |
| source_hint  | text        | NO   |                                               |      |
| created_at   | timestamptz | YES  | now()                                         |      |

### public.fact_measurements（时序事实，分区父表结构）

| 字段        | 类型        | 可空 | 默认                                          | 注释                                 |
| ----------- | ----------- | ---- | --------------------------------------------- | ------------------------------------ |
| id          | bigint      | NO   | nextval('fact_measurements_id_seq'::regclass) |                                      |
| station_id  | bigint      | NO   |                                               |                                      |
| device_id   | bigint      | NO   |                                               |                                      |
| metric_id   | bigint      | NO   |                                               |                                      |
| ts_raw      | timestamptz | NO   |                                               | 原始时间（建议 UTC）                 |
| ts_bucket   | timestamptz | NO   |                                               | 对齐秒：date_trunc('second', ts_utc) |
| value       | numeric     | NO   |                                               |                                      |
| source_hint | text        | YES  |                                               |                                      |
| inserted_at | timestamptz | YES  | now()                                         |                                      |

## 附录A. 导入 staging 与集合式合并（方案A）

- staging_raw（UNLOGGED，强制）：
  - 字段：station_name text, device_name text, metric_key text, TagName text, DataTime text, DataValue text, source_hint text, loaded_at timestamptz default now()
  - 说明：TagName/DataTime/DataValue 与 CSV 固定列名一一对应；导入阶段无索引（建议）
- staging_rejects：
  - 字段同上 + error_msg text, rejected_at timestamptz
  - 用途：沉淀解析失败/校验失败行，导入不中断
- 合并主流程（强制）：
  - JOIN 维表/映射 → (sid,did,mid)
  - 时区与对齐：DataTime + 站点 tz → ts_utc → ts_bucket = date_trunc('second', ts_utc)
  - 去重：按 (sid,did,mid,ts_bucket) row_number()=1 保留最新 ts_utc
  - 合并：INSERT … ON CONFLICT DO UPDATE（value/source_hint/ts_raw）
  - 窗口：按 UTC ISO 周界（周一 00:00:00）对齐，WHERE ts_bucket ∈ \[start, end)
- 注意：不引入"中间并存"标准化列；转换后仅写入目标事实表字段
- 临时轻索引（可选）：合并性能不足时考虑 (station_name, device_name, metric_key) 轻索引，合并后清理

注：以上结构与各周/子分区表一致；父表具 BRIN(ts_bucket)；叶子分区具 btree(station_id,device_id,metric_id,ts_bucket) INCLUDE(value)。

### 合并 SQL 示例（节选，示意）

```sql
WITH parsed AS (
  SELECT
    s.station_id,
    d.device_id,
    m.metric_id,
    to_timestamp(sr."DataTime", 'YYYY-MM-DD HH24:MI:SS') AT TIME ZONE (st.extra->>'tz') AS ts_utc,
    sr."DataValue"::numeric AS val,
    sr.source_hint
  FROM staging_raw sr
  JOIN dim_stations st ON st.name = sr.station_name
  JOIN dim_devices d ON d.station_id = st.id AND d.name = sr.device_name
  JOIN dim_metric_config m ON m.metric_key = sr.metric_key
), dedup AS (
  SELECT *, date_trunc('second', ts_utc) AS ts_bucket,
         row_number() OVER (PARTITION BY station_id, device_id, metric_id, date_trunc('second', ts_utc) ORDER BY ts_utc DESC) AS rn
  FROM parsed
)
INSERT INTO fact_measurements(station_id, device_id, metric_id, ts_raw, ts_bucket, value, source_hint)
SELECT station_id, device_id, metric_id, ts_utc, ts_bucket, val, source_hint
FROM dedup
WHERE rn = 1 AND ts_bucket >= :window_start AND ts_bucket < :window_end
ON CONFLICT (station_id, device_id, metric_id, ts_bucket)
DO UPDATE SET value = EXCLUDED.value, source_hint = EXCLUDED.source_hint, ts_raw = EXCLUDED.ts_raw;
```
