# 配置与快照-示例（里程碑1）

本页展示如何使用“配置外置 + 启动快照（sources 来源标注）”，以及常见覆盖路径示例。

## 1. 配置外置（YAML/ENV/CLI/默认）
- 配置文件（中文注释模板）：configs/{logging.yaml, ingest.yaml, database.yaml}
- 优先级：CLI > ENV > YAML > 默认
- 固定规则：ingest.base_dir 固定为 data（不可覆盖）

## 2. 启动命令与快照
- 启动：
  - python -m app.cli.main run-all config/data_mapping.v2.json \
    --window-start 2025-02-28T02:00:00Z --window-end 2025-02-28T03:00:00Z \
    --log-run --log-dir logs/runs/demo --log-format text --log-routing by_module \
    --log-level DEBUG --ingest-workers 8 --ingest-commit-interval 500000
- 产物：logs/runs/demo/env.json（args_summary + config_snapshot + sources + ts）

## 3. sources 示例（节选）
```
{
  "logging": {"level": "DEBUG", "format": "text", "routing": "by_module", ...},
  "sources": {
    "logging": {"level": "CLI", "format": "CLI", "routing": "CLI"},
    "ingest": {"workers": "CLI", "commit_interval": "CLI"},
    "db": {"dsn_read": "YAML", "dsn_write": "YAML"}
  },
  "ts": "2025-08-19T03:12:05Z"
}
```

## 4. DSN 覆盖的安全开关
- 出于安全考虑，默认拒绝通过 CLI 覆盖 DB DSN：
  - --db-dsn-read / --db-dsn-write 只有在提供 --allow-cli-dsn 时才生效
- 示例：
  - python -m app.cli.main run-all ... --db-dsn-read postgresql://... --allow-cli-dsn

## 5. 常见覆盖路径建议
- 开发现场调试：优先用 CLI 覆盖日志格式/路由/级别（sources 标注为 CLI）
- CI 环境：优先 ENV 覆盖，避免在流水线参数中透出 DSN；必要时启用 --allow-cli-dsn
- 生产环境：以 YAML+ENV 为主，CLI 覆盖仅用于紧急止血且需审计

## 6. 验收要点（最小）
- env.json 同时包含 args_summary、config_snapshot 与 sources
- sources 标注 DEFAULT|YAML|ENV|CLI 与实际行为一致
- DSN 覆盖需显式 --allow-cli-dsn；未启用时应报错退出

