# 数据库完成项清单（自动核对于 2025-08-16）

> 连接：localhost:5432 / db=pump_station_optimization / user=postgres（现场免密环境）
> 说明：仅做只读核对；如文档与数据库不一致，以数据库为准。

## 1. 已存在的 Schema

- api
- monitoring
- public
- reporting

## 2. 物化视图（pg_matviews）

- reporting.mv_measurements_daily
- reporting.mv_measurements_hourly

## 3. 函数（information_schema.routines）

- api：
  - delete_measurement
  - delete_measurements_by_filter
  - get_measurements
  - update_measurement_value
  - upsert_measurement
  - upsert_measurements_json
- monitoring：
  - capture_pgss_snapshot
  - cleanup_pgss_snapshot
  - ensure_active_indexes
  - run_ab_test
- public：
  - auto_performance_tuning
  - auto_space_reclaim
  - batch_delete_old_data
  - check_data_consistency
  - check_performance_alerts
  - database_health_check
  - ensure_week_partition
  - get_performance_metrics
  - pg_stat_statements / pg_stat_statements_info / pg_stat_statements_reset

## 4. 表（information_schema.tables / BASE TABLE）

- monitoring：ab_test_results, ab_test_runs, pgss_snapshot
- public：
  - 维表：dim_stations, dim_devices, dim_metric_config, dim_mapping_items, device_rated_params
  - 事实表：fact_measurements（父表）
  - 分区：fact_measurements_2025w33..fact_measurements_2025w45（含 \_p0..\_p15 子分区）

## 5. 索引与大小（建议采集命令）

- 采集命令（psql）：

```
SELECT schemaname, tablename, indexname, indexdef,
       pg_size_pretty(pg_relation_size(indexname::regclass)) AS index_size
FROM pg_indexes
WHERE schemaname IN ('public','reporting','monitoring','api')
ORDER BY 1,2,3;
```

- 说明：
  - 父表建议：BRIN(ts_bucket)
  - 叶子分区建议：btree(station_id, device_id, metric_id, ts_bucket) INCLUDE(value)
  - 报表层/视图可能存在覆盖索引（视业务需要）

## 6. 统计信息与对象大小（建议采集命令）

```
-- 表大小
SELECT nspname, relname, pg_size_pretty(pg_total_relation_size(c.oid)) AS total_size
FROM pg_class c JOIN pg_namespace n ON n.oid=c.relnamespace
WHERE nspname IN ('public','reporting','monitoring','api') AND relkind IN ('r','m')
ORDER BY 3 DESC;

-- 索引数量
SELECT schemaname, tablename, count(*) AS index_count
FROM pg_indexes
WHERE schemaname IN ('public','reporting','monitoring','api')
GROUP BY 1,2 ORDER BY 1,2;
```

## 7. 已完成项与任务清单

- Schema/表/分区/MV/函数：如上 1~4 节
- 视图：monitoring.v_mv_hit_audit, v_active_partitions, v_active_partitions_last7d, v_active_index_coverage, v_query_coverage, v_missing_indexes_last7d
- 任务（建议由 APScheduler 管理）：
  - snapshot_pgss（30m）、smart_vacuum（4h）、auto_analyze（30m）、refresh_mv_hourly（15m）、refresh_mv_daily（02:30）

## 8. 备注与差异

- 已确认 MV 两张（hourly/daily）；函数清单与文档一致
- 分区已存在多周与 16 子分区结构；与文档一致
- 若后续对象变更，请同步 docs/表结构与数据库.md 与 docs/数据库函数参考.md
