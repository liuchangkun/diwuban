# 程序工作流程

> 目标：严格依据 config/data_mapping.json 的配置，生成并维护维表数据与映射快照，为后续事实数据入库（fact_measurements）提供前置条件与约束。严禁从 CSV 文件名/路径反推站点/设备/指标信息。

## 一、配置来源（唯一事实源）

- 配置文件：config/data_mapping.json
  - 顶层键：泵站名称（例如："二期供水泵房"、"二期取水泵房"）
  - 二级键：设备名称（例如："二期供水泵房1#泵"、"二期供水泵房总管"、"总管" 等）
  - 设备属性：
    - type：设备类型（如 pump、Main_pipeline），数组形式，取第一个为主值
    - pump_type：泵的类型（如 variable_frequency、soft_start）；非泵/总管类设备填 null
    - 指标键（metric_key）：如 frequency、voltage_a、current_a、power、kwh、power_factor、pressure、flow_rate、cumulative_flow 等；其值为来源文件路径数组（仅作为来源提示 source_hint，不参与维度定义）

说明：维表与配置表信息严格以 data_mapping.json 的“站点名/设备名/type/pump_type/metric_key”为准，不允许从 CSV 文件名与路径反推出站点/设备/指标语义。

## 二、涉及的数据库对象（摘要）

见 docs/表结构与数据库.md（以下为与本流程直接相关的表）：

- public.dim_stations（泵站维表）：id, name, extra(jsonb 推荐包含 tz)
- public.dim_devices（设备维表）：id, station_id(FK), name(同站内唯一), type, pump_type, extra
- public.dim_metric_config（指标配置）：id, metric_key(唯一), unit, unit_display, decimals_policy, fixed_decimals, value_type, valid_min, valid_max
- public.dim_mapping_items（映射快照）：id, mapping_hash, station_name, device_name, metric_key, source_hint
- public.fact_measurements（时序事实，分区父表结构）：id, station_id, device_id, metric_id, ts_raw, ts_bucket(秒对齐), value, source_hint, inserted_at

约束提醒：

- fact_measurements 主键：(station_id, device_id, metric_id, ts_bucket)；ts_bucket 必须整秒对齐（CHECK）。
- 写入建议使用 DB 函数：safe_upsert_measurement（UTC）/safe_upsert_measurement_local（本地时间+站点时区）。

## 三、生成/维护规则

1. 站点维表 dim_stations

- 规则：对 data_mapping.json 顶层每个站点名，若不存在则创建一条记录；name=站点名
- extra：建议包含 {"tz": "Asia/Shanghai"} 等时区信息（若配置无 tz，请在落地前补充）

2. 设备维表 dim_devices

- 规则：对每个站点下的每个设备名，若不存在则创建一条记录；
  - station_id：必须引用对应 dim_stations.id（外键语义）
  - name：= 设备名（同一 station_id 内唯一）
  - type：来自 data_mapping.json 的 type\[0\]
  - pump_type：来自 pump_type\[0\]；若 type != "pump"（如 Main_pipeline），则设为 null
- 注意：dim_devices.station_id 必须与 dim_stations.id 关联，确保设备归属泵站明确

3. 指标配置 dim_metric_config

- 规则：收集所有设备声明过的 metric_key（去重），为缺失项补充配置行；
  - metric_key：如 frequency、voltage_a、current_a、power、kwh、power_factor、pressure、flow_rate、cumulative_flow
  - unit / unit_display：按常用物理量给出默认值（可后续调整）：
    - frequency: Hz
    - voltage_a/voltage_b/voltage_c: V
    - current_a/current_b/current_c: A
    - power: kW（如原始为 W，请在导入时统一换算或将 unit 设置为 W）
    - kwh: kWh
    - power_factor: 1（无量纲，可置空 unit 或使用 ""）
    - pressure: MPa（或 kPa，依数据源单位选择其一并保持一致）
    - flow_rate: m3/h（或 L/s，依数据源单位选择其一并保持一致）
    - cumulative_flow: m3
  - decimals_policy：默认 as_is；fixed_decimals/value_type/valid_min/valid_max 视数据质量策略后续迭代

4. 映射快照 dim_mapping_items

- 规则：为每个 (站点名, 设备名, metric_key) 生成一条映射记录
  - mapping_hash：可用 hash(站点名 + "|" + 设备名 + "|" + metric_key)
  - source_hint：固定为 "data_mapping.json"（不写入任何 CSV 文件名/路径）
- 用途：形成稳定、可审计的“配置→维度→指标”映射快照

5. 事实表 fact_measurements（入库约束与建议）

- 入库前提：对应的 station_id/device_id/metric_id 必须已存在并正确关联
- 时间约束：ts_bucket 必须为整秒（date_trunc('second', ts_utc)），建议统一 UTC 存储
- 写入方式：优先通过 safe_upsert_measurement / safe_upsert_measurement_local，保证主键冲突时按策略合并
- source_hint：可写入 "ingest"/"convert" 等来源标签；不依赖文件名

## 四、流程步骤（建议实施顺序）

1. 解析 data_mapping.json
   - 遍历顶层站点名、二级设备名、读取 type/pump_type/metric_key 列表
1. 同步 dim_stations
   - 若不存在则 INSERT；建议补充 extra.tz
1. 同步 dim_devices
   - 依据站点与设备名 upsert；写入 type、pump_type（非泵设 null）
1. 同步 dim_metric_config
   - 依据全量 metric_key 集合 upsert；按上表填充 unit/decimals_policy 等默认值
1. 生成 dim_mapping_items 快照
   - 对每个 (站点, 设备, metric_key) 生成/更新一条记录；source_hint 固定为 "data_mapping.json"
     6.（可选）导入数据与验证
   - 按接口将数据写入 fact_measurements（与本流程解耦）；
   - 执行一致性检查：所有 fact 行的外键三元组 (station_id, device_id, metric_id) 必须在各维表中有效存在

## 五、数据加载与时间对齐（整合《泵站时间对齐实现》）

- 前提：dim_stations、dim_devices、dim_metric_config、dim_mapping_items 已根据 data_mapping.json 生成并校验无误
- CSV 加载：开始加载 CSV 数据，按站点驱动对齐；严禁从文件名/路径反推维度与指标
- 对齐规则（来自《泵站时间对齐实现》）：
  - 统一 UTC：写入时间统一转换为 UTC
  - 秒级对齐：ts_bucket = date_trunc('second', ts_utc)
  - 主键： (station_id, device_id, metric_id, ts_bucket)
  - 冲突合并：ON CONFLICT(...) DO UPDATE，按策略合并 value/source_hint
  - 时区优先级：入参 tz > dim_stations.extra->>'tz' > 默认 UTC
  - CHECK 兜底：CHECK(date_trunc('second', ts_bucket) = ts_bucket)
- 推荐写入函数：
  - public.safe_upsert_measurement(station_id, device_id, metric_id, ts_utc, value, source_hint)
  - public.safe_upsert_measurement_local(station_id, device_id, metric_id, ts_local, value, source_hint)
- 典型流程（可视作简化版）：
  1. 解析 CSV 记录，定位对应的 station_id/device_id/metric_id（三者必须已存在）
  1. 若记录时间含 tz，则转 UTC；否则查 dim_stations.extra->>'tz' 转 UTC
  1. 取整秒 ts_bucket 并调用 safe_upsert\_\* 完成写入与合并
- 参考：详见 docs/泵站时间对齐实现.md（原理、示例与自检 SQL）

## 五、校验与注意事项

- 禁止从 CSV 文件名/路径推断维度与指标：仅以 data_mapping.json 的结构信息为准
- CSV 中 DataVersion、DataQuality 字段忽略，不参与维度/指标映射
- 单位一致性：若数据源单位与 dim_metric_config 默认不一致，请统一换算后入库（或调整 dim_metric_config.unit 并全程保持一致）
- 时区与对齐：按项目总纲，写入统一为 UTC，ts_bucket 秒级对齐；本地时间写入需携带站点时区（见 safe_upsert_measurement_local）
- 幂等与可追溯：建议使用 UPSERT 与映射快照，配合 PLAYBOOKS 记录变更

## 六、扩展与后续

- 若后续为设备补充额定参数，请使用 device_rated_params（如 rated_flow、rated_head 等）
- 若需为汇总层（mv_measurements_hourly/daily）提供指标覆盖，请确保 metric_key 与单位与事实层保持一致

______________________________________________________________________

附：常见 metric_key 与含义（可按需扩展）

- frequency：变频器频率
- voltage_a/b/c：三相电压
- current_a/b/c：三相电流
- power：有功功率
- kwh：正向有功电度
- power_factor：功率因数
- pressure：压力
- flow_rate：瞬时流量
- cumulative_flow：累计流量
