# 程序工作流程（重排版）
> 来源代码路径：app/cli/main.py、app/services/ingest/*、app/adapters/db/*、scripts/sql/**
> 数据库验证日期：2025-08-26
> 最近校对日期：2025-08-26






## 1. 目标与范围（强制）

- 唯一事实源：config/data_mapping.json（禁止从文件名/路径推断维度/指标）

## 命令列表与示例（基于运行时 --help 与 app/cli/main.py）

- version：打印版本/存活检查
  - 示例：python -m app.cli.main version --log-run --log-dir logs/runs/demo
- prepare-dim：从 config/data_mapping.json 准备 dim_* 与映射
  - 示例：python -m app.cli.main prepare-dim config/data_mapping.json
- create-staging：创建/幂等 staging_raw 与 staging_rejects（UNLOGGED）
  - 示例：python -m app.cli.main create-staging
- ingest-copy：并发 COPY CSV 到 staging_raw
  - 示例：python -m app.cli.main ingest-copy config/data_mapping.json
- merge-fact：集合式合并（tz→UTC→秒对齐→去重→UPSERT）
  - 示例：python -m app.cli.main merge-fact --window-start 2025-02-27T18:00:00Z --window-end 2025-02-27T19:59:59Z
- run-all：按顺序执行 prepare-dim → create-staging → ingest-copy → merge-fact
  - 示例：python -m app.cli.main run-all --log-run
- data-report：生成数据质量报表（覆盖/拒绝/越界等）
  - 示例：python -m app.cli.main data-report --window-start ...Z --window-end ...Z
- check-mapping：只读一致性检查与路径建议（支持 --out 导出 JSON）
  - 示例：python -m app.cli.main check-mapping config/data_mapping.json --out mapping_report.json
- db-ping：免密连接测试（--verbose 打印 host/db/user(脱敏)/tz/version）
  - 示例：python -m app.cli.main db-ping --verbose
- admin-clear-db：危险操作，清空 public 架构所有表（仅 DEV）
  - 示例：python -m app.cli.main admin-clear-db

## 执行链路（run-all 实际行为）
- 顺序：prepare-dim → create-staging → ingest-copy → merge-fact
- 日志：可通过 --log-run/--log-dir 启用与复用运行目录，生成 args/config 快照
- API 服务：app/api/middleware/logging.py 提供 APILoggingMiddleware 与 setup_api_logging（结构化日志，敏感头过滤）；主应用在 app/main.py 中注册中间件与路由（含根 /health）。

- 时间窗口：未传 window 时按 ingest.default_window；当 process_all_data=true 时基于 staging_raw 实际时间范围
- 直连与连接池：init_database 启动连接池；get_conn 在连接池不可用时回退直连并设置语句超时

- CSV 固定列：TagName（变量名称）、DataTime（数据时间）、DataValue（数据值）
- 对齐与合并：UTC 秒级对齐（ts_bucket），PRIMARY KEY(station_id,device_id,metric_id,ts_bucket) UPSERT

## 2. 涉及对象与契约（强制）

- 维表/映射：dim_stations、dim_devices、dim_metric_config、dim_mapping_items
- 事实：fact_measurements（见《表结构与数据库》）

## 3. 程序目录与责任边界（强制）

- 采用方案A分层：app/core, app/adapters, app/services, app/cli（详见《编码规范》§35）
- 跨层经网关/适配器；copy 只 COPY，不做业务判断；merge 只做集合式合并与统计

## 4. CSV 列定义与校验（强制）

- 列名固定：TagName/DataTime/DataValue（大小写兼容）
- 解析失败：行写入 staging_rejects（error_msg、rejected_at），统计 bad_rows/decoder_errors

## 5. 文件路径定位策略（强制）

- 规则：data_mapping.json 记录相对 data/ 的路径；程序支持 base_dir（configs/ingest.yaml）
- 迁移适配（可选）：仅在 base_dir 内进行受限 globFallback；记录 event=ingest.path.resolve → summary.json 汇总

## 6. 高性能导入（方案A）流程（强制）

- 模式选择：ingest.mode 支持 auto|direct|staging（默认 auto）。当总量/单文件/文件数满足阈值（total_mb=50、per_file_mb=10、max_file_count=20）时优先 direct 直写；否则 staging。

1. prepare-dim：由 mapping 生成/更新维表与映射
1. direct（小量快速）：多线程读取→tz→UTC→秒对齐→safe_upsert_measurement(\_local) UPSERT
1. staging（大吞吐）：并发 COPY CSV → UNLOGGED staging_raw（流式，低内存）
1. 集合式合并（staging 路径）：JOIN 维度/映射 → DataTime+tz → ts_utc → ts_bucket → 去重 → INSERT…ON CONFLICT
1. 刷新 MV：小时/天；审计命中率与对齐自检

## 7. 并发与背压自适应（强制）

- 默认：workers=6；commit_interval 建议 1,000,000 行/段
- 窗口：按 UTC ISO 周界（周一 00:00:00 UTC）对齐，窗口 \[start, end)
- 背压阈值：P95>2s 或失败率>1% → 先缩批 50%，再降并发；恢复后渐进回升
- 事件：backpressure.enter/exit、guardrail.stop（见《日志规范》）

## 8. 配置与参数（强制）

- configs/ingest.yaml：base_dir, workers, commit_interval, window
- configs/logging.yaml：logging.sql.text/explain, sampling.loop_log_every_n, redaction.enable, retention_days
- 覆盖顺序：CLI > ENV > YAML > 默认；启动打印"脱敏快照"

## 9. 验收标准与自检（强制）

### 配置片段示例（ingest 与 logging）

```yaml
# configs/ingest.yaml（示例）
ingest:
  base_dir: "data"
  workers: 6
  commit_interval: 1000000
merge:
  window:
    size: "7d"   # 或使用 start/end：
    # start: "2025-08-11T00:00:00Z"
    # end:   "2025-08-18T00:00:00Z"
```

```yaml
# configs/logging.yaml（示例）
level: INFO
format: json
performance:
  queue_handler: true
logging:
  sql:
    text: summary      # summary|normalized|full_debug
    explain: on_error  # on_error|sampled|always
sampling:
  loop_log_every_n: 1000
redaction:
  enable: true
retention_days: 14
```

### 运行产物（里程碑0 基线）

- env.json：包含 args_summary（命令与关键参数）与 config_snapshot（完整 Settings，不脱敏）、ts、run_id、run_dir；用于后续排障与复现

- summary.json：包含 copy/merge 用时、backpressure enter/exit、tz_fallback_count；后续版本将补充合并影响行数/冲突比等；用于质量与性能基线

- 功能：not_aligned=0；UPSERT 合并验证；MV 刷新命中

### 配置外置与来源标注（里程碑1 最小实现）

- 配置拆分：configs/{logging.yaml, ingest.yaml, database.yaml}（中文注释）

- 优先级：CLI > ENV > YAML > 默认；base_dir 固定 data（不可覆盖）

- 启动快照：env.json 中包含 args_summary、config_snapshot 以及 sources（字段来源：DEFAULT|YAML|ENV|CLI）

- 示例（节选）：

  - sources.logging.format=CLI、sources.logging.routing=CLI（当通过 --log-format/--log-routing 覆盖时）

- CLI 覆盖键（里程碑1 扩展）

  - --log-format json|text（sources.logging.format=CLI）
  - --log-routing by_run|by_module（sources.logging.routing=CLI）
  - --log-level DEBUG|INFO|WARNING|ERROR（sources.logging.level=CLI）
  - --db-dsn-read / --db-dsn-write（sources.db.dsn_read/dsn_write=CLI）
  - --ingest-workers / --ingest-commit-interval（sources.ingest.workers/commit_interval=CLI）

- 日志：runs/YYYYMMDD/\<job_id>/ 下 app/error/sql/perf/summary/env 多流齐备，字段与开关合规

- 性能：吞吐/延迟/失败率/锁等待达标（可本地化目标）

### 里程碑2 最小实现（状态）

- 已完成：logging.format=text、logging.routing=by_module、db.exec.\* 埋点（prepare_dim/merge）
- 验证参考：docs/测试指南.md 最小窗口端到端验证步骤

## 10. 风险、回滚与审计（建议）

- 回滚：清理 staging；按窗口删除回滚；降级 SQL 文本输出
- 审计：PLAYBOOKS 登记变更与验证；summary.json 汇总关键证据

## 11. 数据库连接池（新增）

项目实现了基于 psycopg 的数据库连接池管理，以提高数据库操作性能并减少连接建立/关闭的开销。

### 连接池特性

- **连接复用**：避免频繁建立和关闭数据库连接
- **并发支持**：支持多线程并发访问
- **健康检查**：自动检测和处理连接超时、断开等问题
- **统计监控**：提供连接使用统计信息用于性能分析
- **自动恢复**：连接异常时自动重连

### 配置参数

- **min_size**：最小连接数，默认为 1
- **max_size**：最大连接数，默认为 10
- **max_inactive_connection_lifetime**：非活跃连接生存时间，默认为 3600 秒

### 使用方式

1. 在应用启动时调用 `init_database(settings)` 初始化连接池
2. 使用 `get_connection()` 上下文管理器获取连接
3. 在应用关闭时调用 `cleanup_database()` 清理资源

### 日志事件

连接池相关操作会生成以下日志事件：
- `pool.initialized`：连接池初始化完成
- `pool.connection.created`：创建新连接
- `pool.connection.acquired`：获取连接成功
- `pool.connection.create_failed`：创建连接失败
- `pool.closed`：连接池关闭

______________________________________________________________________

# 程序工作流程

> 目标：严格依据 config/data_mapping.json 的配置，生成并维护维表数据与映射快照，为后续事实数据入库（fact_measurements）提供前置条件与约束。严禁从 CSV 文件名/路径反推站点/设备/指标信息。

## 一、配置来源（唯一事实源）

- 配置文件：config/data_mapping.v2.json
  - 顶层键：泵站名称（例如："二期供水泵房"、"二期取水泵房"）
  - 二级键：设备名称（例如："二期供水泵房1#泵"、"二期供水泵房总管"、"总管" 等）
  - 设备属性：
    - type：设备类型（如 pump、Main_pipeline），数组形式，取第一个为主值
    - pump_type：泵的类型（如 variable_frequency、soft_start）；非泵/总管类设备填 null
    - 指标键（metric_key）：如 pump_frequency、pump_voltage_a、pump_voltage_b、pump_current_c、pump_active_power、pump_kwh、pump_power_factor、main_pipeline_outlet_pressure、cumulative_flow 等；其值为来源文件路径数组（仅作为来源提示 source_hint，不参与维度定义）

说明：维表与配置表信息严格以 data_mapping.json 的"站点名/设备名/type/pump_type/metric_key"为准，不允许从 CSV 文件名与路径反推出站点/设备/指标语义。

## 二、涉及的数据库对象（摘要）

见 docs/表结构与数据库.md（以下为与本流程直接相关的表）：

- public.dim_stations（泵站维表）：id, name, extra(jsonb 推荐包含 tz)
- public.dim_devices（设备维表）：id, station_id(FK), name(同站内唯一), type, pump_type, extra
- public.dim_metric_config（指标配置）：id, metric_key(唯一), unit, unit_display, decimals_policy, fixed_decimals, value_type, valid_min, valid_max
- public.dim_mapping_items（映射快照）：id, mapping_hash, station_name, device_name, metric_key, source_hint
- public.fact_measurements（时序事实，分区父表结构）：id, station_id, device_id, metric_id, ts_raw, ts_bucket(秒对齐), value, source_hint, inserted_at

约束提醒：

- fact_measurements 主键：(station_id, device_id, metric_id, ts_bucket)；ts_bucket 必须整秒对齐（CHECK）。
- 写入建议使用 DB 函数：safe_upsert_measurement（UTC）/safe_upsert_measurement_local（本地时间+站点时区）。

## 三、生成/维护规则

1. 站点维表 dim_stations

- 规则：对 data_mapping.json 顶层每个站点名，若不存在则创建一条记录；name=站点名
- extra：建议包含 {"tz": "Asia/Shanghai"} 等时区信息（若配置无 tz，请在落地前补充）

2. 设备维表 dim_devices

- 规则：对每个站点下的每个设备名，若不存在则创建一条记录；
  - station_id：必须引用对应 dim_stations.id（外键语义）
  - name：= 设备名（同一 station_id 内唯一）
  - type：来自 data_mapping.json 的 type\[0\]
  - pump_type：来自 pump_type\[0\]；若 type != "pump"（如 Main_pipeline），则设为 null
- 注意：dim_devices.station_id 必须与 dim_stations.id 关联，确保设备归属泵站明确

3. 指标配置 dim_metric_config

- 规则：收集所有设备声明过的 metric_key（去重），为缺失项补充配置行；
  - metric_key：如 frequency、voltage_a、current_a、power、kwh、power_factor、pressure、flow_rate、cumulative_flow
  - unit / unit_display：按常用物理量给出默认值（可后续调整）：
```

<!-- BEGIN:CLI_AUTO -->

## 命令帮助（自动生成）

````text
Usage: python -m app.cli.main [OPTIONS] COMMAND [ARGS]...



 CSV 高性能导入（方案A）：prepare-dim / create-staging / ingest:copy /

 merge:fact / run-all





+- Options -------------------------------------------------------------------+

| --install-completion          Install completion for the current shell.     |

| --show-completion             Show completion for the current shell, to     |

|                               copy it or customize the installation.        |

| --help                        Show this message and exit.                   |

+-----------------------------------------------------------------------------+

+- Commands ------------------------------------------------------------------+

| version          打印版本/存活检查。 示例：python -m app.cli.main version   |

|                  --log-run --log-dir logs/runs/demo 常见问题：无            |

| prepare-dim      准备维表与映射：从 data_mapping.json 插入/更新 dim_*       |

|                  与映射；示例：python -m app.cli.main prepare-dim           |

|                  config/data_mapping.json；常见错误：JSON 结构缺失          |

|                  name/key/files、数据库连接失败                             |

| create-staging   创建/幂等 staging_raw 与                                   |

|                  staging_rejects（UNLOGGED）；示例：python -m app.cli.main  |

|                  create-staging；常见错误：数据库连接失败                   |

| ingest-copy      并发 COPY 导入 CSV 到 staging_raw；示例：python -m         |

|                  app.cli.main ingest-copy                                   |

|                  config/data_mapping.json；常见错误：路径带 data/           |

|                  前缀、文件不存在、CSV 列头缺失                             |

| merge-fact       集合式合并：tz→UTC→秒级对齐→去重→UPSERT；示例：python -m   |

|                  app.cli.main merge-fact --window-start ...Z --window-end   |

|                  ...Z；常见错误：时间格式不正确                             |

| run-all          一键执行：prepare-dim → create-staging → ingest-copy →     |

|                  merge-fact；支持 --log-run/--log-dir                       |

| data-report      生成数据质量报表：覆盖/越界/拒绝统计；示例：python -m      |

|                  app.cli.main data-report --window-start ...Z --window-end  |

|                  ...Z                                                       |

| check-mapping    只读一致性检查与路径建议；支持 --out 导出                  |

|                  JSON；常见错误：路径在 data/ 外或含 data/ 前缀             |

| db-ping          免密连接测试；--verbose 输出                               |

|                  host/db/user(脱敏)/时区/版本；常见错误：.pgpass            |

|                  无效、用户/库不匹配                                        |

| admin-clear-db   危险：清空 public 架构所有表数据（TRUNCATE + RESTART       |

|                  IDENTITY + CASCADE）；仅限 DEV                             |

+-----------------------------------------------------------------------------+
````

<!-- END:CLI_AUTO -->
