# 配置说明（database/logging/ingest 全量字段）

> 来源代码路径：app/core/config/loader.py、app/core/config/loader_new.py、configs/\*.yaml
> 最近校对日期：2025-08-26

本文件描述项目的三份配置文件与 Settings 数据类映射关系、默认值与使用建议。所有字段均附中文说明。

注意与规则：

- 配置分层：db/logging 仅 YAML 来源；ingest 支持 ENV 覆盖（INGEST\_\*）。
- 安全与一致性：禁止从 CLI/ENV 覆盖数据库 DSN 与日志格式/路由（仅 YAML）。
- base_dir 固定为 data/；路径自适配（glob）默认禁用。

## 一、database.yaml（仅 YAML）

- host: 默认 localhost

- name: 默认 pump_station_optimization

- user: 默认 postgres

- dsn_read/dsn_write: 可选完整 DSN；若为空则使用 host/name/user 组合

- pool:

  - min_size: 默认 1
  - max_size: 默认 10
  - max_inactive_connection_lifetime: 默认 3600（秒）

- timeouts（毫秒）:

  - connect_timeout_ms: 默认 5000（连接超时）
  - statement_timeout_ms: 默认 30000（语句超时）
  - query_timeout_ms: 默认 60000（一般复杂查询上限，供上层策略参考）

- retry:

  - max_retries: 默认 3
  - retry_delay_ms: 默认 1000
  - backoff_multiplier: 默认 2.0

建议：

- 开发环境优先用 .pgpass/pg_hba 免密；DSN 仅在需要隔离测试库时使用。
- 重试仅对"临时性失败"有效；谨慎设置最大值，避免放大负载。

## 二、logging.yaml（仅 YAML）

- level: 默认 INFO

- format: json|text（默认 json）

- routing: by_run|by_module（默认 by_run）

- rotation：轮转策略

  - max_bytes: 104857600（按大小轮转的单文件上限，100MB）
  - backup_count: 7（保留份数）
  - rotation_interval: 86400（按秒轮转；>0 时启用按时间轮转，否则使用 size）

- formatting：格式化参数

  - timestamp_format: "%Y-%m-%d %H:%M:%S.%f"（format/strptime 语法）
  - max_message_length: 8192（超过将被截断并追加省略号）
  - field_order: \["timestamp","level","message","extra"\]（JSON 字段排序偏好）

- performance：性能参数

  - buffer_size: 8192（保留字段）
  - flush_interval: 1.0（保留字段）
  - async_handler_queue_size: 1000（QueueHandler 队列最大长度）
  - queue_handler: true（是否启用 QueueHandler/Listener 异步落盘）

- sampling：采样与节流

  - loop_log_every_n: 1000（循环进度每 N 次输出一次）
  - min_interval_sec: 1.0（同类事件的最小时间间隔）
  - default_rate: 1.0（默认采样率）
  - high_frequency_events: { "ingest.copy.batch": 0.1 }（特定事件单独采样率）
  - burst_limit: 100（突发限制）

- redaction:

  - enable: false（本项目默认不脱敏，开发环境使用）

- retention_days: 14（日志保留天数）

## 三、ingest.yaml（仅 YAML）

- backpressure：阈值（第一轮配置化）

  - thresholds.p95_ms：默认 2000（ms）
  - thresholds.fail_rate：默认 0.01（0~1）
  - thresholds.min_batch：默认 1000
  - thresholds.min_workers：默认 1

- mode: auto|direct|staging（auto）

- workers: 6

- commit_interval: 1000000（初始批大小，亦作为 copy_workers 的默认 batch_size）

- p95_window: 20（计算 p95 的滑动窗口批次数）

- csv：CSV 方言

  - delimiter: ","
  - encoding: "utf-8"
  - quote_char: '"'
  - escape_char: "\\"
  - allow_bom: true

- batch：批处理

  - size: 50000（推荐实际 COPY 每批量，若未接入处保持默认）
  - max_memory_mb: 256
  - parallel_batches: 2

- error_handling：错误处理

  - max_errors_per_file: 100
  - error_threshold_percent: 5.0
  - continue_on_error: true

- performance：性能

  - read_buffer_size: 65536
  - write_buffer_size: 65536
  - connection_pool_size: 5

ENV 覆盖（仅以下白名单）：

- INGEST_WORKERS、INGEST_COMMIT_INTERVAL、INGEST_P95_WINDOW、INGEST_ENHANCED_SOURCE_HINT、INGEST_BATCH_ID_MODE

- site_timezone: "Asia/Shanghai"（站点默认时区，用于归一化 naive 时间戳）

## 四、web.yaml（仅 YAML）

- server：host/port/reload/workers（示例：127.0.0.1:8000，开发 reload=true）
- api：title/description/version/docs_url/redoc_url/minimal_window_minutes（示例：/docs、/redoc；最小窗口默认 60 分钟，用于 /data/measurements 默认查询范围）
- app：debug/log_requests/cors_enabled/cors_origins（CORS 可在生产按白名单开启）
- performance：request_timeout/max_request_size/keepalive_timeout

说明：app/main.py 通过 load_settings 读取 web 配置，创建 FastAPI 实例与中间件；CLI 不依赖 web。

新增：/data/measurements 端点默认未传 start_time 时，将回退为最近 minimal_window_minutes 分钟，以降低大查询风险。

## 五、system.yaml（仅 YAML）

- directories：data/logs/configs/temp/backup（当前 data、logs、configs 生效；temp/backup 为预留）
- timezone：default/storage/display（默认 Asia/Shanghai；存储 UTC）
- system：encoding/locale/max_workers

说明：loader_new.Settings.system 提供统一系统默认值，避免硬编码；ingest/base_dir 等路径由系统目录派生。

## 六、merge.yaml（仅 YAML）

- window：size/start/end（示例 7d，支持绝对窗口）
- tz：default_station_tz/allow_missing_tz/missing_tz_policy（default|utc|reject）
- segmented：enabled/granularity（示例 1h；分段合并开关）

说明：合并与对齐策略在 services/ingest/merge_service.py 等处应用；文档与配置需同步。

## 七、时间与时区处理策略

为保证数据在不同环境（开发机、服务器、数据库）下的一致性与可移植性，项目遵循以下时间处理原则：

1. **内部统一使用 UTC**：系统所有内部操作，包括数据库存储、时间戳比较、窗口计算等，全部强制使用带时区的 UTC 时间（`TIMESTAMPTZ`）。
1. **在数据源头归一化**：所有来自外部 CSV 文件的时间戳（`DataTime` 字段），在数据接入层（`copy_workers.py`）即被转换为 UTC 标准时间。
1. **配置驱动时区**：
   - `ingest.yaml` 中的 `site_timezone` 字段用于指定站点的本地时区（例如 `Asia/Shanghai`）。
   - 如果输入的时间戳字符串**不包含**时区信息（naive datetime），系统将使用 `site_timezone` 作为其默认时区，然后再转换为 UTC。
   - 如果输入的时间戳字符串**已包含**时区信息（例如 `2025-02-27T18:00:00+08:00`），则以其自身时区为准进行 UTC 转换。

此策略旨在消除所有对服务器本地时区、数据库 `TimeZone` 设置的隐式依赖，确保数据处理的幂等性与准确性。

## 五、接入与使用

- 日志模块：app/adapters/logging/init.py（服务端启动由 app/main.py 使用 setup_api_logging 初始化 API 日志；CLI 使用 init_logging + write_run_snapshot 写入快照）

  - 使用 rotation/formatting/performance/采样；by_run 写 app/error/sql/perf，多文件按轮转策略管理
  - 可选 QueueHandler（settings.logging.queue_handler=true），避免主线程阻塞

- 数据库模块：app/adapters/db（gateway.py、pool.py、__init__.py）

  - 连接池：基于 psycopg；在应用或 CLI 启动时通过 init_database(settings) 初始化，通过 get_connection() 获取连接，cleanup_database() 关闭
  - 直连回退：get_conn(settings) 在连接池不可用时回退到直连，并按 settings.db.timeouts/retry 设置 connect_timeout 与 statement_timeout
  - 连接池配置：min_size=1, max_size=10，max_inactive_connection_lifetime=3600（见 configs/database.yaml）

- 导入模块：app/services/ingest/

  - copy_workers 使用 settings.ingest.commit_interval 作为初始批，采样节流读取 logging.sampling
  - 后续将接入 csv 方言、batch.size、error_handling 阈值与 performance 参数

## 六、验证与排障

- 运行 pytest -q
- 运行 run-all 并检查 logs/runs/<job>/env.json（config_snapshot 中有新增字段）
- 若日志未轮转或字段格式不符：检查 configs/logging.yaml 的 rotation/formatting
- 若连接超时：检查 database.yaml 的 timeouts.connect_timeout_ms；确认数据库可达
- 数据库连接池状态：可通过日志中的 db.pool 相关事件查看连接池初始化和使用情况
