# 功能说明总览（骨架）

> 说明：本文件为骨架版本。将基于实际代码持续补充，所有条目附“来源代码路径”。

## 1. 系统能力地图

- Web/API：FastAPI（app/main.py，app/api/v1/\*）
- 配置系统：loader_new（app/core/config/loader_new.py，读取 configs/\*.yaml）
- 数据库访问：psycopg 连接池（app/adapters/db/{__init__,pool,gateway}.py）
- 数据导入：CSV→校验→staging（app/services/data_import.py 及 ingest 子模块）
- SQL/DDL：scripts/sql 与 create_tables_pump_station_optimization.sql

## 2. 入口与生命周期（app/main.py）

- lifespan：初始化日志、加载配置、初始化连接池、关闭清理
- 路由注册：app/api/v1/router.py
- 静态资源：app/static（如存在）

## 3. API 概览（v1）

- data：数据查询相关端点（app/api/v1/endpoints/data.py）
- monitoring：健康/监控（app/api/v1/endpoints/monitoring.py）
- logs：日志相关（app/api/v1/endpoints/logs.py）

## 4. 配置与参数

- configs/database.yaml：数据库主配置
- configs/web.yaml：FastAPI 标题、地址、端口、文档开关
- configs/ingest.yaml：CSV、批处理、背压、默认路径、时间窗口

## 5. 数据库设计（摘要）

- 维表：dim_stations、dim_devices、dim_metric_config、dim_mapping_items
- 事实：fact_measurements（按周分区 + station_id 哈希子分区）
- 新表：device_rated_params（设备额定参数）

## 6. 数据导入流程

- CSV 解读 → 行级校验 → 导入 staging（COPY 或批量）→（可选）合并到事实表
- 背压自适应：基于 p95、失败率、最小批大小与并发下限

## 7. 脚本索引（迁移后）

- scripts/tools/：check\_*/verify\_*/create\_*view*.py
- scripts/sql/：\*.sql（DDL/视图）
- scripts/analysis/：*\_example*.py、analyze\_\*.py
- scripts/debug/：fix\_\*.py、simple_fix.py
- scripts/test/：独立/临时测试脚本

## 8. 代码-文档映射（将补充清单）

- 端点 → 函数签名/参数/响应模型一览
- 模型 → app/schemas 与 app/models 字段表
- 配置 → Settings 字段与 YAML 键对照
- SQL → 表/索引/约束列表

## 9. 变更与维护

- 每次改动需更新对应章节
- 通过 docs/reports/文档对照差异报告.md 追踪不一致
