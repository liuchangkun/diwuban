# 文档计划.md

> 本计划覆盖“数据补齐 + 计算 + 优化 + 可视化 + API + 监控 + 测试”的端到端开发任务。每个任务均包含：要做什么（What）、为什么（Why）、怎么做（How）、怎么验收（Accept）。
> 注：时间与负责人可在执行前由项目经理标注（建议：D1–D14 两周节奏）。

---

## 里程碑与交付
- M1（D1–D2）：数据库函数接入与基础表就绪（completion_*/compute_*/optimize_*）
- M2（D3–D6）：补齐最小可用（FFILL→MEAN）与计算流程（qcalc/hcalc/etacalc）打通
- M3（D7–D10）：优化在线步骤（gate/resid/update/freeze/log）与可视化 API 完成
- M4（D11–D14）：REG 模型补齐、离线曲线版本、监控与测试验收

---

## 任务一：数据库函数提效接入（get_*_by_time_range）
- What（要做什么）
  - 在“按时间范围读取设备/站点指标”的场景中，优先使用：
    - public.get_device_metrics_by_time_range(device_id, start_ts, end_ts, limit)
    - public.get_station_devices_metrics_by_time_range(station_id, start_ts, end_ts, limit)
  - API 层与服务层统一透传 limit，避免大结果集搬运；保留 reporting.get_metrics_auto_multi 作为跨长窗口聚合回退。
- Why（为什么）
  - 数据库端 JSONB 整形、limit 下推、索引友好，显著降低带宽与序列化开销，提高响应性能与稳定性。
- How（怎么做）
  - 核对与引用签名：参考 docs/数据库函数参考.md；
  - 复用现有封装：app.adapters.db.gateway.get_*_by_time_range；
  - API 示例：app/api/v1/endpoints/data.py 已采用函数调用风格，统一返回包裹结构；
  - 文档已补充“数据库函数提效”章节与三处落位提示（结合/只读API/秒级处理）。
- Accept（怎么验收）
  - 功能：相同查询条件下，返回数据字段与旧实现一致（记录数差距≤1%）；
  - 性能：小时级窗口（≤24h）P95 响应时间 ≤ 200ms（本地/预发标准可放宽）；
  - 资源：API 实例 CPU/内存占用不高于旧实现；
  - 可靠性：空数据/极端 limit/越界时间范围均返回 200 + 空集合或合规错误码；
  - 通过 2 条端到端用例与 3 条异常用例单测（pytest 标记）。

---

## 任务二：数据补齐服务最小可用（FFILL→MEAN）
- What
  - 建表：completion_runs、completion_steps、completion_audit（含索引）；
  - 服务：app/services/data_completion.py，支持窗口内缺失检测、FFILL/MEAN 插补、批量 UPSERT 写回 fact_measurements；
  - 留痕：rules_json 记录阈值命中明细，output_json 输出补齐统计；
  - 调度：app/tasks/jobs/completion_job.py 最小可用（分钟微批）。
- Why
  - 保证计算/优化链路的连续性与稳定性，避免缺口放大对下游指标造成干扰。
- How
  - 缺失检测：按秒 generate_series 与 fact_measurements 左连接，或直接以窗口读取后在内存对齐；
  - 策略：优先 FFILL（短缺口），再 MEAN（中等缺口）；超过 L_max 放弃仅记审计；
  - 写回：UPSERT 设置 source_hint='imputed_*'，并记录 run_id/imputation_version；
  - 代码骨架与 SQL 按 docs/数据补齐可视化.md“补齐”章节落地。
- Accept
  - 功能：指定 1 个设备/指标/时间窗的人工制造缺口，服务可自动补齐并写审计；
  - 数据质量：补齐后值连续、单调约束不被破坏（如 Q≥0），审计记录与统计数一致；
  - 性能：1 分钟窗内 10 台设备、6 个关键指标补齐 ≤ 5s；
  - 可观测：completion_steps.rules_json 含阈值命中明细；
  - 单测：构造 gap 段的参数化用例，校验 FFILL/MEAN 选择与 UPSERT 行数。

---

## 任务三：计算流程（qcalc/hcalc/etacalc）
- What
  - 建表：compute_runs、compute_steps、compute_metrics；
  - 实现 8 步计算：ingest/validate/gate/select/qcalc/hcalc/etacalc/persist；
  - 单位统一：压力 MPa；扬程 H≈((p_out−p_in)×1e6)/(ρg)；效率 η=(ρg(Q/3600)H)/(P×1000)。
- Why
  - 形成可视化/报表的核心指标闭环；为优化与推荐提供输入。
- How
  - 分摊：w_i=(P_i^α·f_i^β)/Σ；Q_i=C_Q·(Q_total·w_i)+b_Q；
  - 阈值：f_thr/P_thr/稳态判定写入 rules_json；
  - 落库：compute_metrics(ts,pump_id,pump_flow_rate,pump_head,pump_efficiency,...)。
- Accept
  - 功能：给定 10 分钟窗口，产出 compute_metrics 非空且随源数据变化；
  - 正确性：用 3 组已知样例（手工算 H、η）对齐误差≤1%；
  - 可观测：每步 compute_steps 记录输入/输出/阈值命中；
  - 性能：10 分钟窗口计算 ≤ 10s；
  - 单测：公式/单位转换/边界值（负压、零流量）覆盖。

---

## 任务四：优化流程（在线）
- What
  - 建表：optimize_runs、optimize_steps、calibration_log、pump_calibration、optimization_recommendations；
  - 在线步骤：gate/resid/update/freeze/log，带限幅与冻结策略。
- Why
  - 持续校准参数与提供节能/运行建议，使系统具备自优化能力。
- How
  - 残差：r_Qbal、r_HQ、r_QP；
  - 参数更新：C_Q/b_Q 用 RLS，α/β 小步长梯度，b_H/b_pout 中位数方向，全部带 clip；
  - 记录：calibration_log 写 old/new、learn_rate、clip_hit 与残差快照。
- Accept
  - 功能：稳定样本下参数有收敛趋势；异常比例高时进入冻结/降级；
  - 数据：calibration_log 每次更新写 1 行，字段完整；
  - 可视化：optimize_steps.rules_json 展示门控/限幅命中；
  - 单测：残差计算与限幅策略覆盖 5 种边界。

---

## 任务五：只读 API（compute/opt/completion）
- What
  - 提供 runs/steps/metrics（compute）、runs/steps/calibration-log/recommendations（opt）、runs/steps/audit（completion）端点；统一返回包裹。
- Why
  - 供前端页面与外部系统消费，保证一致性与可追踪性。
- How
  - 数据源：优先 public.get_*_by_time_range，自适应 reporting.get_metrics_auto_multi；
  - 契约：{"code":0,"message":"ok","trace_id":"...","data":{...}}；
  - 性能：分页/limit 透传，避免一次性大载荷。
- Accept
  - Swagger/Redoc 可用；
  - 契约回归：字段与示例与文档一致；
  - 压测：P95 ≤ 300ms（开发/预发标准），错误码覆盖 400/401/403/404/409/429/500/503。

---

## 任务六：可视化页面（横向流程卡片）
- What
  - docs/compute_pipeline_h.html、docs/optimize_pipeline_h.html 横向卡片（标题/状态/耗时/输入/输出/阈值命中明细/Trace 链接）。
- Why
  - 让“补齐/计算/优化”的过程透明可审计，支持排障与复盘。
- How
  - 数据：/api/compute/runs/{run_id}/steps、/metrics；/api/opt/runs/{run_id}/steps、/calibration-log；
  - 交互：阈值命中明细折叠，Trace 跳转；
  - 性能：首屏 2s 内。
- Accept
  - 页面可按 run_id 渲染卡片；
  - 关键字段渲染正确（中文标题、耗时、阈值命中清单）；
  - 简单 UI 回归用例通过。

---

## 任务七：REG 模型补齐（增强）
- What
  - 在补齐策略中新增 REG（回归）选项：Q̂ = θ0 + θ1·P + θ2·f + θ3·(P·f) + ...，稳态样本训练；
  - 质量门槛：R²≥阈值、样本数≥阈值，否则降级到 FFILL/MEAN。
- Why
  - 在协变量充分且相关性强时提高补齐准确度，降低误差传播。
- How
  - 训练：滑动窗口或递推最小二乘（RLS）；
  - 特征：P、f、交互项、温度等；
  - 安装第三方库需审批（若需 sklearn 等），或用 numpy 实现最小二乘；
  - 物理约束：补齐后强制 Q≥0，超界则降级。
- Accept
  - 模拟数据集上对比 FFILL/MEAN，MAPE 至少下降 10%；
  - 质量门槛生效（低 R² 自动降级）；
  - 审计：completion_audit.method='REG' 且 confidence 随质量提升。

---

## 任务八：离线曲线拟合与版本发布
- What
  - 每日/每周拟合 H–Q / P–Q / η–Q 曲线，写入 curve_versions 并维护状态；
  - 计算流程按最新 active 版本读取参数。
- Why
  - 提升长期拟合精度与稳定性，为优化提供真实曲线支撑。
- How
  - 拟合：最小二乘/稳健回归，异常剔除；
  - 指标：RMS 下降%、边界满足率；
  - 发布：曲线状态切换（draft→active），记录 validated_metrics。
- Accept
  - 曲线版本管理表完整；
  - 版本切换对下游计算生效（回归用例校验）；
  - 指标看板展示新旧对比。

---

## 任务九：监控与追踪
- What
  - 运行监控：steps.duration_ms、affected_rows、异常比例、P95 响应；
  - 追踪：run_id/trace_id/trace_url 贯通。
- Why
  - 快速定位瓶颈与异常，保障稳定运行。
- How
  - 指标埋点：API/服务/数据库层；
  - 报警阈值：响应>阈值、异常比例>阈值；
  - Dashboards：基础可视化看板。
- Accept
  - 指标可查询，报警可触发；
  - 压测阶段输出稳定。

---

## 任务十：测试与验收
- What
  - 单元测试、集成测试、E2E 冒烟；
  - 公式/阈值/插补/UPSERT/API 契约/性能回归覆盖。
- Why
  - 降低回归风险，保证功能与性能目标达成。
- How
  - 测试数据：构造缺口/异常/稳态样本；
  - 命令：pytest -q；必要时添加基准测试；
  - 不安装新依赖的前提下优先使用现有工具链。
- Accept
  - 覆盖率（核心模块）≥ 70%；
  - 关键用例全部通过；
  - 性能指标达标（见各任务验收）。

---

## 风险与回退
- 插补过度：限制缺口阈值、置信度与物理约束，明确降级到 FFILL/MEAN；
- 模型漂移：增加冻结/限幅策略与异常占比开关；
- 数据量增长：优先数据库函数 get_*_by_time_range + 报表视图组合；
- 回退：保留旧实现与配置开关（百分比灰度）。

