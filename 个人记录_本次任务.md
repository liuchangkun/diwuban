里程碑0（E2E 最小解锁）

已实现
端到端：prepare_dim → create_staging → copy_from_mapping → merge_window
run-all 收尾写 summary.json
需要修复
PLAYBOOKS 基线记录（错误与修复、会话快照）未补录
字段口径不一致：rows_in（日志扩展）vs rows_input（目标/报表）

里程碑1（配置外置与启动快照）

部分实现
load_settings 能读 configs/*；env.json 合并/回填 run_id、run_dir、config_snapshot
未实现/需要修复
三份中文模板：configs/{logging,ingest,database}.yaml
来源标注：CLI > ENV > YAML > 默认 的合并与 sources 标注
首行快照写 app.ndjson（args_summary + config_snapshot 含来源）
单测与文档同步

里程碑2（日志文本模式与按模块路由）

部分实现
by_run JSON 稳定；by_module 路由已实现；TextFormatter 存在
需要修复
文本模式字段模板（最小集：level/ts/logger/event/window/rows/sql_op/msg）
关键事件字段族补齐：ingest.load.、ingest.path.resolve、db.exec.（sql_text/pgcode/pgerror/affected_rows/sql_cost_ms）、backpressure.*、task.summary（慢 SQL Top）

里程碑3（参数贯通与可观测）

已实现：run_id 贯通
未实现/需要修复：首行快照到 app.ndjson；错误输出规范（stderr 中文提示 + stdout 单行 JSON）；单测/文档
里程碑4（CSV 三态：auto/direct/staging）

已实现：staging 并发 COPY→合并；分区保障
未实现/需要修复：auto 决策与事件、direct 模式（UPSERT/重试/rejects）、CLI --ingest-mode 覆盖、指定窗口直写验证、文档
里程碑5（编码规范与门禁）

已实现：本地 ruff/black/mypy/pytest/pre-commit 全绿
需要修复：收紧规则（裸 except/Docstring/圈复杂度/重复/SQL 参数化/类型注解）、新增工具（pylint/radon/pydocstyle/bandit）与文档







------------------------------------------

结构化完成度清单与后续“混合模式”任务清单
已完成/部分/未完成/需修复清单

里程碑0：已实现；需修复 PLAYBOOKS 记录、字段口径一致（rows_input）
里程碑1：部分实现；未实现 来源标注与首行快照/模板/单测/文档
里程碑2：部分实现；需修复 文本模板与关键事件字段族
里程碑3：未实现关键输出规范与单测
里程碑4：staging 已实现；auto/direct 未实现
里程碑5：门禁基本全绿；需修复 加强规则与新工具链
混合模式任务清单（含步骤/验证/完成标准）

S1-QuickWins-1：data_quality 安全与健壮化
实施：group_by 白名单（Literal/Enum）；perf.ndjson 行流式解析+parse_errors；无 perf 时默认结构并记录 data_report.perf.missing
验证：构造坏行 perf.ndjson；检查 parse_errors/default 输出；pytest/ruff/mypy/pre-commit 全绿
完成：generate_report 可靠产出并具备容错
S1-QuickWins-2：报表产物与事件
实施：从 run_dir/env.json 读取 run_id；输出 reports/data_quality_report..json；记录 event=data_report.generated（run_id/window/report_path/groups_count）
验证：运行一次生成报表；app.ndjson 存在事件；路径正确
完成：产物与事件可追溯
里程碑0 收尾（文档/PLAYBOOKS）
实施：补 PLAYBOOKS/错误与修复记录、会话快照 baseline；统一文档字段 rows_input
验证：文件存在且字段/链接正确
完成：证据链完备
里程碑1 配置外置与快照
实施：三份中文模板；来源标注合并（CLI>ENV>YAML>默认）；首行快照到 app.ndjson；单测；文档同步
验证：切换 ENV/CLI 观察 sources 变化；pytest 通过
完成：启动可观测、可追溯
里程碑2 文本模式与按模块路由
实施：Text 模板补齐最小集；关键事件字段族补齐；文档更新
验证：json/text、by_run/by_module 互切验证；样例与产出一致
完成：文本可读与事件齐备
里程碑3 参数贯通与错误输出
实施：stderr 中文提示 + stdout JSON 错误；单测；文档
验证：模拟错误输出核对；pytest
完成：错误输出规范化
里程碑4 CSV 三态
实施：auto 决策日志 ingest.mode.selected；direct 模式最小实现与 CLI 覆盖；指定窗口直写验证；文档
验证：小样本 direct 正确；auto 日志存在
完成：三态闭环
里程碑5 门禁增强
实施：引入 pylint/radon/pydocstyle/bandit；分阶段阻断与豁免列表；规则收紧
验证：本地/CI 全绿
完成：质量门禁升级








A. copy_workers 逻辑与汇总位置优化
当前 task.summary 的 diagnostics 汇总位于批循环内部（每处理一批后即可触发），存在“多次输出”的风险
目标行为：按“本文件处理完成后输出一次”或“整次 run 结束输出一次”
 
B. high_frequency_events 配置样例与默认建议
代码已支持，但 configs/logging.yaml 尚未提供背压事件的样例（文档已说明）
拟新增样例（注释形式，默认不启用）：
high_frequency_events:
ingest.copy.batch: 0.1
backpressure.enter: 1.0
backpressure.exit: 1.0
C. 事件常量统一替换的覆盖面
已替换 copy_workers 的 ingest.path.resolve / ingest.error.threshold / backpressure.\* / ingest.copy.batch
建议继续“第二轮常量替换”扫描：
其他模块中残留的 "event": "xxx.yyy" 魔法字符串（例如对齐/合并、报错事件族等）
产出提交：仅替换事件名为常量，不改业务逻辑；保障零回归
D. E2E 管道历史遗留修复（混合修复重点）
prepare_dim 中 dim_metric_config RETURNING 列名不匹配（历史记录中“待修”）：需将 RETURNING metric_id 改为实际列 id 或对齐表定义
run-all 端到端再次验证（dev 环境，免密配置已就绪）
数据质量报表（data-report）联动：验证 summary.json / perf.ndjson / app.ndjson 字段一致性
E. 测试与 CI 覆盖增强
新增配置加载单测已落地（test_config_loading.py）
建议补充：
事件采样单测：设置 high_frequency_events 对 backpressure.enter/exit = 1.0 时应有日志；=0.0 时应无日志（使用 caplog）
汇总位置单测：确保 task.summary 仅输出一次（per-file 或 per-run），避免重复