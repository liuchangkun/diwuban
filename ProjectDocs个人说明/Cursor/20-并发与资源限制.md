______________________________________________________________________

## alwaysApply: true description: 并发与资源限制（上限、阈值、背压与降速、批大小动态调整）

# 并发与资源限制

## 上限与阈值

- 全局并发上限：由 `ingest.concurrency.max_workers` 控制（见 app.yaml），默认 4。
- 单站点并发：`ingest.concurrency.station_parallel` 控制，默认 2。
- 单批最大行数：`ingest.batch.max_rows`；单事务提交行数：`ingest.batch.commit_rows`。
- 单事务最大耗时阈值：默认 2s；超过阈值需拆分更小批；超过 5s 触发降并发 50%。

## 观测窗口与指标

- 指标采样窗口：最近 N 个批次（默认 N=10），观测 `batch_cost_ms/merge_cost_ms/rows_*` 与失败率。
- 热点：锁等待/重试次数/连接池排队时间，用于判断是否应降并发或减小批。

## 自适应算法（建议）

- 初始化：并发 = 配置上限的 50%，提交行数 = `commit_rows`。
- 若 P95 批次耗时 > 阈值 或 失败率 > 阈值（见 23/40）：
  - 并发 = max(1, 并发 × 0.5)；提交行数 = max(5000, 提交行数 × 0.75)。
- 连续 5 批达标（低于阈值）：
  - 并发 = min(上限, 并发 × 1.25)；提交行数 = min(`commit_rows`, 提交行数 × 1.25)。
- 任何时刻出现 DB 锁等待或死锁骤增：优先减小提交行数，再降并发。

伪代码：

```python
if p95_batch_ms > ms_threshold or failure_rate > fail_threshold:
    concurrency = max(1, int(concurrency * 0.5))
    commit_rows = max(5000, int(commit_rows * 0.75))
elif ok_batches >= 5:
    concurrency = min(max_concurrency, int(concurrency * 1.25))
    commit_rows = min(config_commit_rows, int(commit_rows * 1.25))
```

## 背压与降速

- 一旦触发背压：记录 `event=backpressure.enter`，携带窗口指标与调整后的参数；退出背压时记录 `backpressure.exit`。
- 背压期间限制新任务入队，优先清理在途批次；必要时进入只读/冻结（见 46/47/48）。

## 配置映射（app.yaml）

- `ingest.concurrency.max_workers`、`ingest.concurrency.station_parallel`
- `ingest.batch.max_rows`、`ingest.batch.commit_rows`
- `performance.slo.p95_latency_ms`、`performance.backpressure.error_rate_threshold`
- 可通过 CLI 覆盖：`--concurrency --batch-max-rows --commit-rows`（见 04/48）

## 验收

- 连续 3 个窗口内无背压、P95 ≤ 阈值、失败率 ≤ 阈值；
- 参数调整有日志与配置快照（对齐 10/54）。
