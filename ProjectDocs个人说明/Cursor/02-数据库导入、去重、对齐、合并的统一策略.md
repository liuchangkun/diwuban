______________________________________________________________________

## alwaysApply: true globs: *.py,*.sql description: 数据库导入、去重、对齐、合并的统一策略

# DB 导入与对齐规则

## 会话参数

- 必须开启 `local_infile=1`、`SET NAMES utf8mb4`。
- 若存在 `secure-file-priv` 限制，使用 LOCAL 方式导入。

## 临时表与导入

- 每会话创建：`TEMPORARY TABLE tmp_raw(TagName VARCHAR(255), DataTime DATETIME, DataValue DECIMAL(20,6))`。
- 导入示例：

```sql
LOAD DATA LOCAL INFILE '{file}'
INTO TABLE tmp_raw
CHARACTER SET utf8
FIELDS TERMINATED BY ',' ENCLOSED BY '"'
LINES TERMINATED BY '\r\n'
IGNORE 1 LINES
(TagName, @dt, @ver, @qual, DataValue)
SET DataTime = STR_TO_DATE(SUBSTRING_INDEX(@dt, '.', 1), '%Y-%m-%d %H:%i:%s');
```

## 去重与对齐

- 去重：按秒保留最早 `DataTime`。参考：

```sql
CREATE TEMPORARY TABLE tmp_dedup AS
SELECT TagName, MIN(DataTime) AS DataTime, ANY_VALUE(DataValue) AS DataValue
FROM tmp_raw
GROUP BY TagName, DATE_FORMAT(DataTime, '%Y-%m-%d %H:%i:%s');
```

- 对齐：按泵站与设备，将同一秒的字段合并成 JSON。

## 幂等合并

- 键：`(device_id, standard_time)`。
- 合并：

```sql
INSERT INTO aligned_data (station_id, device_id, standard_time, data_json, data_quality, data_hash)
SELECT {station_id}, {device_id}, DataTime,
       JSON_OBJECT('{field_key}', DataValue), 1,
       MD5(CONCAT({device_id}, '_', DataTime, '_', JSON_OBJECT('{field_key}', DataValue)))
FROM tmp_dedup
ON DUPLICATE KEY UPDATE
  data_json = JSON_MERGE_PATCH(aligned_data.data_json, VALUES(data_json)),
  updated_at = CURRENT_TIMESTAMP;
```

## 时间与迟到

- 不做时区转换；仅截断到秒。
- 缺秒不补；迟到数据按合并规则补齐 JSON；禁止跨分区大范围覆盖（见 37）。

## 冲突与日志

- 多来源冲突：按 \[33\] 处置；
- 日志字段：`event=align.conflict`、`device_id`、`standard_time`、`field_key`、`value_earliest`、`value_late`、`diff_pct`、`chosen=earliest|primary`。
