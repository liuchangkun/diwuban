______________________________________________________________________

## description: CSV加载与数据库插入性能优化高级规范（内存管理、I/O优化、连接池、索引策略、监控告警）

# CSV加载与数据库插入性能优化高级规范

## 内存管理与缓冲

### 文件读取缓冲

- 读取缓冲区：默认64KB-1MB，根据文件大小自适应调整；
- 流式读取：大文件（>100MB）使用逐块读取，避免内存爆炸；
- 预读策略：后台预读下一批数据，减少I/O等待；
- 内存监控：设置内存使用上限（默认可用内存的70%），超限触发GC或降速。

### 数据结构优化

- 批量容器：使用高效数据结构（如numpy array、pandas DataFrame）；
- 列式存储：内存中按列组织数据，提高缓存局部性；
- 零拷贝：避免不必要的数据复制，直接传递引用；
- 对象池：重用临时对象，减少GC压力。

## I/O优化策略

### 磁盘I/O

- 顺序读取：确保文件按顺序访问，避免随机I/O；
- 异步I/O：使用异步读取，CPU与I/O并行；
- 压缩支持：支持gzip/lz4压缩文件直接读取；
- SSD优化：针对SSD特性调整读取块大小（通常4KB-64KB）。

### 网络I/O

- 连接复用：数据库连接池，避免频繁建连；
- 批量网络包：减少网络往返次数；
- 压缩传输：启用MySQL压缩协议（compress=True）；
- 超时设置：读写超时分别设置，避免无限等待。

## MySQL性能优化

### 会话级优化

- 关键参数：
  ```sql
  SET SESSION local_infile = 1;
  SET SESSION bulk_insert_buffer_size = 256M;
  SET SESSION read_buffer_size = 2M;
  SET SESSION sort_buffer_size = 4M;
  SET SESSION tmp_table_size = 128M;
  SET SESSION max_heap_table_size = 128M;
  ```
- 事务控制：
  - 禁用自动提交：`SET autocommit = 0`；
  - 批量提交：每N行或每T秒提交一次；
  - 锁超时：`SET innodb_lock_wait_timeout = 10`。

### 表优化策略

- 临时表引擎：使用MEMORY引擎提高性能：
  ```sql
  CREATE TEMPORARY TABLE tmp_raw (
    TagName VARCHAR(255),
    DataTime DATETIME,
    DataValue DECIMAL(20,6),
    INDEX idx_tag_time (TagName, DataTime)
  ) ENGINE=MEMORY;
  ```
- 分区策略：按时间分区，提高查询效率；
- 预分配空间：使用`ALTER TABLE ... ROW_FORMAT=FIXED`固定行格式。

### 索引策略

- 最小索引：导入期间禁用非必要索引；
- 覆盖索引：确保查询使用覆盖索引；
- 索引统计：定期更新索引统计信息：`ANALYZE TABLE`；
- 外键约束：导入期间临时禁用外键检查。

## 连接池管理

### 连接池配置

- 池大小：
  - 最小连接：2-4个（保持活跃）；
  - 最大连接：CPU核心数×2-4；
  - 空闲超时：30-60秒；
  - 连接生命周期：4-8小时。
- 连接验证：
  - 获取时验证：`SELECT 1`；
  - 空闲时验证：定期ping检查；
  - 重连机制：连接断开自动重连，最大重试3次。

### 负载均衡

- 读写分离：读取操作使用只读实例；
- 连接分配：按权重分配连接；
- 故障转移：主库故障自动切换到备库；
- 监控指标：连接使用率、等待队列长度、错误率。

## 并发控制与资源限制

### 并发策略

- 文件级并发：多个文件可并行处理；
- 站点级并发：同一站点内串行，避免锁竞争；
- 动态调整：根据系统负载动态调整并发度；
- 资源隔离：不同优先级任务使用不同资源池。

### 背压机制

- 触发条件：
  - CPU使用率 > 80%；
  - 内存使用率 > 85%；
  - 数据库连接池使用率 > 90%；
  - 磁盘I/O等待 > 50%。
- 降级策略：
  - 减少并发度（50% → 25% → 单线程）；
  - 增大批次间隔；
  - 暂停低优先级任务；
  - 启用数据压缩。

## 监控与告警

### 性能指标

- 吞吐量指标：
  - 文件读取速率（MB/s）；
  - 行处理速率（行/秒）；
  - 数据库写入速率（行/秒）；
  - 端到端延迟（文件→数据库）。
- 资源指标：
  - CPU/内存/磁盘/网络使用率；
  - 数据库连接数、锁等待时间；
  - GC频率与耗时；
  - 缓存命中率。

### 告警规则

- 性能告警：
  - 吞吐量下降30%持续5分钟；
  - P95延迟超过阈值3倍；
  - 错误率超过5%；
  - 连接池耗尽。
- 资源告警：
  - 内存使用率 > 90%；
  - 磁盘空间 \< 10%；
  - 数据库连接数接近上限；
  - 网络丢包率 > 1%。

### 自动恢复

- 重试机制：指数退避重试，最大重试次数3次；
- 降级模式：性能不达标时自动切换到保守模式；
- 熔断保护：连续失败达到阈值时暂停处理；
- 健康检查：定期检查系统健康状态，自动恢复。

## 大文件处理策略

### 分块处理

- 文件分割：按大小（如100MB）或行数（如100万行）分块；
- 并行处理：多个分块并行处理，结果合并；
- 进度跟踪：记录每个分块的处理进度；
- 断点续传：支持从中断点恢复处理。

### 流式处理

- 逐行读取：避免将整个文件加载到内存；
- 管道处理：读取→解析→验证→写入的流水线；
- 缓冲控制：控制内存中缓冲的数据量；
- 实时反馈：提供实时处理进度反馈。

## 错误处理与恢复

### 错误分类

- 可重试错误：网络超时、连接中断、锁等待超时；
- 不可重试错误：数据格式错误、约束冲突、权限不足；
- 系统错误：内存不足、磁盘满、数据库崩溃；
- 业务错误：数据质量问题、映射配置错误。

### 恢复策略

- 自动重试：可重试错误自动重试，指数退避；
- 跳过处理：数据错误跳过当前记录，继续处理；
- 回滚机制：严重错误时回滚到最近检查点；
- 人工介入：复杂问题标记为需要人工处理。

## 性能调优指南

### 硬件优化

- CPU：多核心处理器，支持并行处理；
- 内存：足够大的内存，避免磁盘交换；
- 存储：SSD存储，提高I/O性能；
- 网络：高带宽、低延迟网络连接。

### 软件优化

- 操作系统：调整内核参数，优化网络栈；
- 数据库：调整缓冲池、日志设置等参数；
- 应用程序：使用高效算法和数据结构；
- 监控工具：部署性能监控工具。

### 配置调优

- 批次大小：根据内存和网络条件调整；
- 并发度：根据CPU核心数和I/O能力设置；
- 超时设置：根据网络和数据库响应时间调整；
- 缓存配置：根据数据访问模式调整缓存策略。

## 测试与验证

### 性能测试

- 基准测试：建立性能基线；
- 压力测试：测试系统极限性能；
- 长期测试：验证系统稳定性；
- 回归测试：确保优化不引入问题。

### 验证指标

- 功能正确性：数据完整性、一致性验证；
- 性能指标：吞吐量、延迟、资源使用率；
- 稳定性：长期运行稳定性；
- 可扩展性：负载增加时的性能表现。
