______________________________________________________________________

## description: 字段单位表规范与初始化规则

# `field_units` 表规范

## 表结构

- 唯一允许新增的持久表。
- 字段：
  - `id` BIGINT PK 自增
  - `field_key` VARCHAR(100) 唯一（如 `power`、`kwh`、`voltage_a`、`current_a`、`power_factor`、`frequency`、`pressure`、`flow_rate`、`cumulative_flow`）
  - `unit` VARCHAR(50)（如 W、kWh、V、A、Hz、kPa、m3/h、m3）
  - `description` VARCHAR(255) 可空
  - `created_at`/`updated_at` TIMESTAMP
- 索引：`UNIQUE(field_key)`，`idx_unit`

## 允许单位（白名单）

- 频率：Hz
- 电压：V
- 电流：A
- 功率：W（如输入为 kW，需换算 ×1000）
- 电能：kWh
- 压力：kPa（如输入 MPa，需换算 ×1000）
- 瞬时流量：m3/h（如输入 L/s，需换算 ×3.6）
- 累计流量：m3
- 温度：°C；振动：mm·s^-1

## 单位转换准则

- 所有单位转换在导入前完成（见 30/32）；
- 转换表应集中维护在 `app/units/`，并具备单测；
- 任何新增单位需先评审并更新白名单与转换表。

## 初始化与 upsert 示例

- 初始化脚本见 `sql/field_units_init.sql`（使用 INSERT IGNORE 幂等）；
- upsert 示例：

```sql
INSERT INTO field_units(field_key, unit, description)
VALUES('power','W','有功功率')
ON DUPLICATE KEY UPDATE unit=VALUES(unit), description=VALUES(description), updated_at=CURRENT_TIMESTAMP;
```

## 校验要求

- 映射校验（verify-mapping）需检查所有字段是否在 `field_units` 登记；
- 导入前若发现未登记字段/非白名单单位，应拒绝并输出修复建议。
