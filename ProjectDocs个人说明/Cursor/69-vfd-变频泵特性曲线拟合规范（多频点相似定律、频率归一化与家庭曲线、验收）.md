______________________________________________________________________

## description: 变频泵特性曲线拟合规范（多频点/相似定律、频率归一化与家庭曲线、验收）

# 变频泵特性曲线拟合规范

## 多频点数据

- 收集多频点稳态数据；剔除启动/停机瞬态；单位标准化；
- 稳态筛选：各频点内滑窗方差阈值与一阶差分阈值。

## 归一化与家庭曲线

- 归一化：Q'=Q/n, H'=H/n^2, P'=P/n^3 到参考频率 n_ref；
- 家庭曲线：在 n_ref 空间拟合单泵曲线（见 66），上线按实时 n 反推 Q/H/P；
- 或直接拟合 (Q,n)→H 的二维表面（约束单调+平滑）。

## 二维表面拟合（(Q,n)→H）

- 基函数：双变量样条/核回归/轻量 GPR；
- 正则化与平滑：λ·||θ||² + TV/二阶导平滑；
- 物理约束：∂H/∂Q ≤ 0，∂H/∂n ≥ 0，H ≥ 0；可通过罚项或投影保持。

## 约束与验收

- 物理约束：单调/非负/边界平滑；
- 指标：各频点残差与整体 RMSE、MAPE；
- 输出有效频率范围与外推警示。

## 验收与服务化

- 验收：各频点 RMSE/整体 RMSE、物理约束满足率（≥99%）、有效频率/流量区间；
- 服务化：输入 (Q,n) 返回 H 与置信区间；超界返回边界与外推标记。

## 版本与产物

- 目录：`models/vfd_pump_curve/<device_id>/<version>/`；
- 元数据含频点清单、n_ref、拟合方法、误差指标、环境与作者。

## 频率归一与家庭曲线一致性（扩展）

- 归一变量：q=Q/n，h=H/n²，p=P/n³；在基准频率 n_ref 上训练，再映射各频点；
- 横截一致：固定 n 的截面与基准截面缩放后形状相近（允许小偏差惩罚）；
- 绑参数：跨频率共享主形状参数，频率仅调节缩放与少量微调项。

## 表面拟合与形状约束（细化）

- 低秩因式分解：H(Q,n)≈∑\_{k=1..r} a_k(Q)·b_k(n)，r 小；
- 单调/非负：∂H/∂Q≤0，∂H/∂n≥0，H≥0；
- 核/高斯过程：使用虚拟导数观测 enforcing monotonicity；或采用形状约束样条网格；
- 平滑：二阶差分/薄板样条惩罚，避免等高线皱褶。

## 电机与驱动约束

- 电流/转矩：I≤I_rated，T=P/ω≤T_rated；V/f 比限制，n≤n_max；
- 软饱和：靠近极限时添加 barrier/罚函数，避免不可行解。

## 验收与交付

- 频点留一验证：逐频 hold-out，报告整体与逐频 RMSE/约束满足率；
- 置信带：在 (Q,n) 网格上输出 CI 热力图；
- 产物：`family_curves.json`（各频点截面）、`surface_H.json/surface_P.json/surface_eta.json`、`metadata.json`、`report.json`；
- 接口：`evaluate(Q,n)` → `{H,P,eta,ci,extrapolation}`；超界返回边界与外推标记。

## 家族曲线共享与分层贝叶斯

- 共享潜变量：H(Q,n)≈∑\_{k=1..r} a_k(Q)·b_k(n)，频点间共享 a_k，b_k 平滑于 n；
- 分层贝叶斯：频点参数从公共先验抽样，弱数据频点被强数据频点“拉动”，抑制过拟合；
- 置信带来自后验抽样，天然度量跨频点不确定性。

## 非理想相似定律校正

- 引入校正因子：H(Q,n)=n²·H0(Q/n)·(1+δ_H(Q,n))，P 类似；
- δ_H, δ_P 采用小幅度平滑函数，中心在低速/高黏度区域；
- 通过正则限制 ||δ||∞ ≤ ε，确保与相似定律不过度偏离。

## 驱动与电机效率映射

- 变频器效率 η_vfd(n,load)、电机效率 η_m(n,load) 作为查表/样条引入；
- 轴功率与输入功率关系：P_in = P_h/(η·η_m·η_vfd)；
- 热约束：I≤I_rated，T≤T_rated，定子温升 ≤ T_max；
- 弱磁区：n>n_base 时限制扭矩，并标注精度下降区间。

## 单调张量样条与坐标变换

- 使用张量积 I-spline/E-spline 网格，系数非负实现 ∂H/∂Q≤0、∂H/∂n≥0；
- 或采用坐标变换 (u=Q/n, v=n) 先做单调，再映回 (Q,n)。

## 动态试验与滞后补偿

- 频率爬升/下降实验：校验沿线一致性与测量滞后，使用一阶滞后模型补偿；
- 记录沿程误差并在服务层给出动态修正提示。

## 实施清单（Checklist）

- 一致：频点缩放一致性与家族曲线形状一致；
- 物理：单调/非负/电机与驱动边界/弱磁区处理 OK；
- 误差：逐频与整体 RMSE/满足率达标，CI 合理；
- 动态：爬升/下降实验通过，滞后补偿生效；
- 交付：family_curves/surface/metadata/report 完整，接口联调通过；
- 回退：上版模型与服务降级路径确认。

## V/f 与转矩区域

- 基速以下：恒转矩区，V∝f，T≈const；基速以上：弱磁区，P≈const，T 随 n 下降；
- 约束：I≤I_rated，T≤T_rated，n≤n_max；弱磁区结果标注精度降低。

## 吸上与汽蚀跨频点

- NPSH 随 n 与 Q 变化；保持 NPSH_a − NPSH_r(Q,n) ≥ margin；
- 低频大流量易汽蚀，服务层给出风险提示与降额建议。

## 共振与噪声带

- 避免机械/管路共振频带：n∉B_forbidden；
- 目标中加入驻留惩罚，路径规划时绕行或快速通过。

## 损耗与谐波

- 变频器谐波与附加损耗：η_vfd(n,load) 降低；温升约束强化；
- 建议维护效率查表并定期校准。

## 数据设计与交叉验证

- 采样：在 (Q,n) 网格均匀覆盖边界与 BEP 附近；
- 验证：跨频留一、时间滑窗、区域外推测试；
- 产物：补充 `forbidden_bands.json`、`limits.json`（I/T/n/NPSH）供服务层快速判定。

## 服务降级

- 超出有效域：优先使用相似定律从基频曲线缩放，附 `degraded=true`；
- 失败安全：返回保守边界 + 告警。

## 轻量化与蒸馏

- 将张量样条/GPR 蒸馏为小型形状约束网络或分段多项式；
- 蒸馏损失 = 预测误差 + 物理违例罚项，保证形状一致。

## 网格化缓存与插值

- 预计算 (Q,n) 规则网格表，运行时双线性/样条插值；
- 缓存命中率与内存上限权衡，网格密度按误差上限自适应。

## 频率步进与路径规划

- 给定目标 (Q\*,n\*)，规划平滑路径约束 |dn/dt|、|dQ/dt|、共振禁带绕行；
- 输出控制序列与预计到达时间，供 PLC/PID 参考。

## 个体化与迁移

- 使用元学习/分层贝叶斯，少量该泵数据细化共享家族曲线；
- 迁移后保留物理约束与频点一致性。

## SLA 与降级

- `evaluate(Q,n)` P95 ≤ 5 ms；
- 异常或超界：回退相似定律缩放，标注 `degraded=true`；
- 指标：约束满足率、外推率、缓存命中率、延迟。

## 二维/多任务拟合方法目录

- 树模型：XGBoost/LightGBM `monotone_constraints={Q:-1, n:+1}`；CatBoost（对数值单调支持有限，需后处理）；
- GPR：核为 SE⊗SE 或 Matern⊗Matern；虚拟导数观测 enforcing ∂H/∂Q≤0、∂H/∂n≥0；
- TF Lattice：2D 单调格子 + 边界夹紧（clamping）；
- MLP：共享编码器 + 三头输出（H/P/η），导数罚 + 非负/单峰约束；
- PINN：加相似定律与能量一致性弱约束，跨频点共享主形状参数。

## 多任务损失（2D）

L = Σ w_H·MSE(H−Ĥ(Q,n)) + w_P·MSE(P−P̂(Q,n)) + w_η·MSE(η−η̂(Q,n))

- λ_Q·E\[(∂Ĥ/∂Q)_+^2\] + λ_n·E\[(−∂Ĥ/∂n)_+^2\]
- λ_e·E\[(P̂−ρgQ·Ĥ/η̂)^2\] + λ_r·||θ||²

* 说明：对 Ĥ 的 Q 方向单调递减、n 方向单调递增；含能量一致性与正则。

## 单调树/后处理

- 树模型难以严格保证二阶平滑，可用等值层压平（leveling）与单调投影；
- 端点裁切：对网格外 (Q,n) 采用边界值 + `extrapolation=true`。

## 训练细则与超参

- 树：max_depth 4-6, n_estimators 500±, learning_rate 0.03-0.1, monotone_constraints 开启；
- GPR：诱导点/稀疏近似（m=256~1024），噪声 σ² 学习；
- MLP：宽度 64-128、层数 2-3，权重非负约束或谱归一化，λ_Q/λ_n 1e−2~1；
- Lattice：每维 8-16 网格，单调校准器 + 边界夹紧；
- 采样：在 (Q,n) 网格均匀 + BEP 与边界加权。

## 跨频协同拟合

- 低秩分解：H(Q,n) ≈ Σ\_{r=1..R} a_r(Q) b_r(n)（CP），或 A×_1B×_2C（Tucker）；
- 先验：b_r(n) 单调递增并非负；a_r(Q) 单调递减并非负；
- 训练：交替最小二乘 + 形状约束投影；R=2~4 足够；
- Co-kriging：不同频点视作共克里金多任务，相关核 K_ν(n_i,n_j)×K_Q(Q_i,Q_j)。

## 单调网络参考架构

- 输入：Q,n；
- 校准：单调分段线性到 \[0,1\]；
- 主干：非负权重层（ReLU/SoftPlus），残差受限为非负或非正以控制导数符号；
- 输出：H=SoftPlus(h) 保非负；η=sigmoid(s)；P=SoftPlus(p)；
- 罚项：∂H/∂Q≤0、∂H/∂n≥0、能量一致性、η 单峰。

## 网格缓存与误差上界

- 构建 (Q,n) 均匀网格，双线性插值；
- 误差上界：若 Ĥ 二阶导数在区域内有界 M，则插值误差 ≤ C·M·h²（h 为网格步长）；
- 自适应：按局部曲率调整网格密度，保证全域误差 ≤ ε。

## Co-Kriging 与多任务核

- 结构核：K((Q,n),(Q',n'))=K_Q(Q,Q')·K_n(n,n')；
- 任务间相关：K_n 采用指数/SE 核，长度尺度反映频点相关性；
- 低频数据补强高频：联合训练提升稀疏频点精度；
- 约束：虚拟导数观测 enforcing ∂H/∂Q≤0、∂H/∂n≥0。

## 相似定律+残差建模

- 先以相似定律缩放得到 H_aff(Q,n)；
- 拟合残差 r(Q,n)=H_true−H_aff，使用小容量模型（Lattice/GBDT/小型 MLP），并施加形状约束；
- 组合：Ĥ=H_aff + r̂，稳定且物理一致。

## 随机森林/单调 GBDT 训练细则

- 随机森林：大树深度会破坏平滑，推荐后处理单调投影与边界夹紧；
- LightGBM/XGBoost：开启 `monotone_constraints={Q:-1,n:+1}`；注意分裂增益受限需加大 n_estimators；
- 校准：等概率分箱 + Isotonic/Platt（回归用等值层压），减少系统性偏差；
- 不确定性：集成方差/分位数回归（Quantile）/共形预测。

## 更多二维/跨频拟合方法（补充目录）

- 张量核方法：核为 K_Q ⊗ K_n，支持多任务/协同；

- 多保真 Co-Kriging：基于相似定律的低保真 + 实测高保真融合；

- 单调提升树（Monotone Gradient Boosting）：对 (Q,n) 实施符号约束与投影；

- 形状约束张量样条：在张量网格上约束一阶导符号与非负；

- 稀疏字典/符号回归：以 φ、ψ、π 组合项为字典，L1 稀疏选择；

- 分位数/共形 2D：在网格上输出上下分位面与覆盖率控制；

- 低秩+残差：低秩主形状 + 小模型残差（GBDT/小 MLP）。

- 高维/非参数扩展：

  - 薄板样条（2D平滑，跨(Q,n)）；
  - 核回归（Nadaraya-Watson 2D）；
  - k近邻回归（局部加权，频点插值）；
  - 小波变换（2D多尺度分析）。

- 深度学习2D：

  - VAE（潜变量编码频点依赖）；
  - Transformer（频点序列建模）；
  - 卷积神经网络（CNN，2D特征提取）；
  - 注意力机制（频点-流量交互建模）。

- 时间序列/动态：

  - ARIMA（频率指令时间依赖）；
  - 动态因子（多频点共同趋势）；
  - 粒子滤波（频率切换状态估计）；
  - Neural ODE（连续频率动态）。

- 优化高级：

  - 半定规划（2D单调约束）；
  - 锥优化（电机约束锥）；
  - 进化算法（多目标频率优化）；
  - 变分推断（频点不确定性）。

### 选型速查（更新）

- 频点稀疏：多任务核/Co-Kriging 或 迁移学习；
- 需要强物理一致：张量样条（形状约束）或 低秩+残差；
- 快速与轻量：单调提升树 或 网格缓存 + 插值 + 端点裁切；
- 置信区间：2D 分位数或共形预测 或 贝叶斯方法；
- 2D复杂曲面：薄板样条 或 CNN；
- 频率动态：Neural ODE 或 粒子滤波；
- 大规模优化：进化算法 或 SDP。

## 变频曲线拟合后验证

- 截面一致：各频点截面 Ĥ(Q,n_k) 与缩放基准一致性误差 ≤ ε_align；
- 偏导物理：Pr\[∂Ĥ/∂Q≤0\]≥99.5%，Pr\[∂Ĥ/∂n≥0\]≥99.5%；
- 能量一致：网格上 RMSE(P̂ − ρgQ·Ĥ/η̂) ≤ ε_P；
- 电机边界：I≤I_rated，T≤T_rated，n≤n_max，弱磁区标注；
- NPSH：min (NPSH_a − NPSH_r(Q,n)) ≥ m_min；
- 动态回放：频率爬升/下降 |dn/dt|≤r_n_max，压力波动 ≤ 门槛。

## 报告模板字段（新增）

- sections: {align_rmse_by_freq: {...}}
- derivatives: {dq_mono_rate, dn_mono_rate}
- energy: {energy_rmse}
- motor_limits: {i_pass, t_pass, n_pass}
- npsh: {npsh_pass}
- dynamics: {dn_dt_max, pressure_ripple}

## 专业公式速查

- 相似定律：Q∝n，H∝n²，P∝n³；
- V/f：基速以下恒转矩，以上弱磁区 P≈const；
- 功率/转矩：P_in = P_h/(η·η_m·η_vfd)，T = P/ω。

## 直径/频率缩放一致性

- 同一泵在不同 n：按相似定律归一到 n_ref 后 ψ(φ) 对齐误差 ≤ ε_align；
- 不同 D：按直径缩放曲线后对齐；
- 以截面误差与全域 RMSE 报告。

## ISO 9906 频点截面验收

- 逐频截面按容差带判定（关死/BEP/runout 与若干等距点）；
- 不通过频点标注并禁止上线作为插值节点（仅作离线参考）。

## 残差与动态

- 残差自相关与异方差检查；
- 动态回放：频率步进/斜坡，验证迟滞与压力波动门槛。

## 可逆映射（2D）

- 对固定 n，提供 H→Q 的单调表；
- 对固定 H，提供 Q→n 的单调表（用于快速反解频率指令）；
- 报告反查误差与违例率。

## 相似定律边界

- 低 Re、弱磁区、汽蚀临界区是相似定律的误差高发区；
- 在这些区域提升不确定性与降级提示，避免过度信赖缩放。

## 频点离散与指令量化

- 频率步进 Δn 与最小保持时间 τ_min；
- 模型/服务需在允许频点集合上投影，并输出量化误差与到达时间估计。

## 低速冷却与热约束

- 低速气冷风扇效率下降：n\<n_cool_min 时额外约束 P·t 积分与温升；
- 建议设置 n_service_min，低于则提示并回退到保守功率限制。

## 在线自校准与漂移

- 滑窗校准：对小偏差做线性修正（α,β）且加以平滑；
- 漂移超阈触发重训/回滚；
- 记录校准历史用于审计与回溯。

## 抗饱和与 Anti-windup

- 对频率/电流/电压饱和路径，输出限幅并标注；
- 为下游 PID 提供 Anti-windup 建议（跟随/复位时间常数）。
