______________________________________________________________________

## description: 单泵特性曲线拟合规范（数据条件、模型族、约束与验收、版本治理）

# 单泵特性曲线拟合规范

## 数据条件

- 输入：`flow_rate`、`head/pressure`、`power`、`frequency`（变频）及环境条件；
- 预处理：
  - 稳态筛选：滑窗方差/一阶差分阈值（如 P95(|ΔX|) \< ε）；
  - 去噪：中值滤波/Huber 损失；
  - 单位标准化（见 30/field_units）、时间去重（同秒最早，见 02/40）。

## 模型族与优化

- 模型：多项式（≤3阶）、分段线性、单调样条（I-spline/shape-constrained spline）、物理先验（相似定律）。
- 目标函数：加权最小二乘（对高流量段适度加权）；鲁棒损失（Huber/SoftL1）。
- 约束：
  - H(Q) 非增、η(Q) 先增后减（可通过单调样条/分段约束实现）；
  - 边界非负、曲率平滑（正则化 λ）；
  - 外推封顶：超过训练区间使用边界值（避免不合理外推）。

## 变频折算与族曲线

- 相似定律：Q∝n、H∝n²、P∝n³；
- 将不同 n 折算至额定 n_ref 再拟合，或直接拟合 (Q,n)→H 的家庭曲线（见 69）。

## 验收与阈值

- 误差：RMSE(H) ≤ 阈值、MAPE(H) ≤ 阈值（默认 5%）；
- 物理一致性：单调/非负/边界约束满足率 ≥ 99%；
- 异常占比：剔除样本 ≤ 10%；
- 需输出：训练窗口、样本量、有效区间、禁外推提示。

## 漂移监测与回滚

- 按周/月检测 RMSE/分布漂移（KS/PSI）；
- 超阈则回退到 `previous` 版本并触发重拟合工单。

## 版本与可复现

- 产物目录：`models/pump_curve/<device_id>/<version>/`；
- `metadata.json`：版本、窗口、特征、误差、环境、作者、来源依赖（见 61/52）。

## 不确定性与置信带（可选）

- Bootstrap/交叉验证生成置信带；
- 在线服务返回点估计 + 置信区间，便于控制器保守决策。

## 算法与机理模型（细化）

- 经验/参数化模型：
  - 扬程曲线：H(Q) ≈ H0 − a Q^2（二次项为主），或分段线性/单调样条；
  - 功率：P(Q) ≈ p0 + p1 Q + p2 Q^2（或依据相似定律）；
  - 效率：η(Q) 近似抛物线（峰值附近二次项），两侧单调下降。
- 机理先验与相似定律：Q∝n, H∝n², P∝n³；在额定工况上拟合，或进行频率归一（见 69）。
- 约束最小二乘：
  - 变量 θ 最小化 ∑ w_i · ρ(y_i − f(Q_i; θ))，ρ 为 Huber/SoftL1；
  - 约束：H'(Q) ≤ 0、η'(Q) 在峰值前 ≥0、峰值后 ≤0、H(Q) ≥ 0、P(Q) ≥ 0；
  - 正则化：λ · ||θ||² 与样条平滑项，避免过拟合与振荡。

## 数值稳健性与实现建议

- 归一化：Q/H/P 先做零均值/范围缩放，降低病态；
- 初值：二次回归/分段最小二乘作为 warm-start；
- 约束求解：
  - 单调样条可用 I-spline/E-spline + 非负系数约束；
  - 线性/二次约束可用 QP/二次规划或投影梯度法；
- 异常与权重：对边界/稀疏区间降低权重，RANSAC 剔出孤立异常点。

## 验证协议与报告

- 切分：时间/工况切分（防泄漏）；K 折或留出最后时段；
- 指标：RMSE/MAE/MAPE/R²，物理一致性满足率（单调/非负），有效区间覆盖率；
- 报告：训练窗口、样本量、剔除比例、有效区间、阈值是否达标、外推警示；
- 置信区间：Bootstrap 95% CI，记录在 `metadata.json`（见 61）。

## 边界与外推

- 只在训练有效区间内提供“可信”出参；超出区间：返回边界值并 `extrapolation=true` 标记；
- 允许在 API/服务层配置“保守系数”对边界结果降额。

## 数据要求与预处理（扩展）

- 数据源：优先使用按秒对齐的 `aligned_data`，字段键遵循字典（见 30），单位与 `field_units` 一致（见 03）。
- 清洗：
  - 去重：按秒取最早；
  - 异常：越界/突变/平线/复位按质量策略（见 31）做软/硬处置；
  - 单位标准化：功率(W)、压力(kPa)、流量(m3/h)、频率(Hz)。
- 采样覆盖：包含关死点(Q≈0)、BEP 附近、额定区、临界流量区，避免拟合外推。

## 物理约束（扩展）

- 几何与单调：
  - 关死扬程：H(Q=0)=H0，H0≥0；
  - 单调：dH/dQ ≤ 0；效率在 BEP 前 dη/dQ≥0，BEP 后 dη/dQ≤0；
  - 非负：H(Q)≥0, P(Q)≥0, 0≤η(Q)≤1。
- 设备极限：
  - 额定功率/电机转矩：P(Q) ≤ P_rated，T(Q)=P/ω ≤ T_rated；
  - NPSH：NPSH_a − NPSH_r(Q) ≥ margin≥m_min；
  - 允许流量区：Q_min ≤ Q ≤ Q_max（由铭牌/系统约束决定）。
- 系统一致：与典型系统曲线 H_sys(Q)=k1·Q²+k2·Q+k3 的交点存在且稳定（避免多重交点区间内震荡）。

## 优化问题（标准形）

min_θ Σ_i w_i·ρ(H_i − Ĥ(Q_i;θ)) + λ_s·Ω_smooth(θ) + λ_r·||θ||²
s.t.

- dĤ/dQ ≤ 0；Ĥ≥0；
- dη̂/dQ sign 服从 BEP 单峰；0≤η̂≤1；
- P̂(Q)≤P_rated；T̂(Q)≤T_rated；
- （可选）与系统曲线交点稳定性罚项。
  实现建议：
- 形状约束样条：I-spline/E-spline，系数非负实现单调；
- BEP 约束：在 Q_bep 处固定峰值或加峰值惩罚项；
- 求解器：QP/二次规划 或 投影梯度；非凸项采用次梯度 + 罚函数/交替投影。

## 不确定性与鲁棒

- 损失函数：Huber/SoftL1；权重按区段密度与质量评分动态调整；
- 置信带：Bootstrap 1000 次，输出 95% CI（随 Q 的带宽）；
- 异常窗口冻结：连续超过阈值的区段不参与拟合，单独记录隔离。

## 校准与偏差修正

- 传感器偏差：y = α·y_raw + β（α/β 通过对齐工况与铭牌点最小二乘估计）；
- 时间漂移：分段校准，段内系数平滑过渡（样条过渡，不引入阶跃）。

## 验收门槛与回退

- 指标：RMSE≤阈值、MAPE≤阈值、R²≥0.98、物理约束满足率≥99.5%、有效区覆盖率≥95%；
- 失败回退：保留上版模型，当前训练标记为 `rejected`，触发告警与差异报告；
- 灰度：仅在验证通过后替换 `current` 指针。

## 产物与接口

- 产物目录：`models/pump_single/<station>/<device>/<version>/`
- 文件：
  - `curve_H.json`（样条节点/二次参数）、`curve_P.json`、`curve_eta.json`；
  - `metadata.json`（窗口/样本/阈值/CI/哈希/父版本）；
  - `report.json`（指标与约束满足率、外推警示）。
- 服务接口（建议）：`evaluate(Q)` → `{H,P,eta,ci,extrapolation}`；超界返回边界与 `extrapolation=true`。

## 基础水力学与相似定律（适用边界）

- 相似定律仅在几何相似、雷诺数足够大且汽蚀不过早的条件下近似成立：
  - Q∝n、H∝n²、P∝n³；
  - 黏度升高/小型机组/低速区会破坏严格比例，需引入校正项（见下）。
- Reynolds 与黏度影响：在低 Re 区，效率与扬程退化明显，应当按黏度修正系数进行校正。

## BEP（最佳效率点）识别与单峰约束

- 识别：对 η(Q) 做局部二次拟合或单峰样条，求峰值 Q_bep 并要求左右单调性成立；
- 约束实现：
  - 显式引入峰值位置参数 Q_bep，对 η(Q) = η_max − a·(Q−Q_bep)² + r(Q)（r 为小扰动）并约束 a>0；
  - 或采用 I-spline/E-spline，分段规定导数符号；
  - 训练时对违例点加入大权重罚项，确保单峰。

## 能量一致性与物理残差

- 定义水力功率与轴功率一致性罚项：
  - P_h(Q) = ρ g Q H(Q)，P_m(Q) = P̂(Q)；
  - 目标增加 α·Σ (P_m − P_h/η̂)²，约束 η̂∈(0,1\]；
- 作用：把 H/P/η 三条曲线耦合，减少不物理外形与数据噪声引起的漂移。

## 黏度/温度修正

- 依据 Hydraulic Institute/ISO 指南，引入效率/扬程修正因子：
  - η_corr = c_η(ν,T,scale)·η_meas，H_corr = c_H(ν,T)·H_meas（系数可参数化拟合或查表插值）；
- 数据入模前统一修正到参考温度与黏度，或在模型中把修正作为外生输入项。

## 噪声与加权（异方差）

- 噪声模型：Var\[ε(Q)\] 随流量与工况变化，采用 WLS 或分段权重 w(Q)∝1/σ²(Q)；
- 离群稳健：RANSAC 识别孤立异常点；Huber/SoftL1 减少大残差影响。

## 形状约束实现技巧

- 非负重参数化：H(Q)=exp(h(Q)) 或 SoftPlus(h(Q))，保证非负；
- 单调 via 累积和：令 H'(Q)=exp(u(Q))·(−1)，积分得到单调递减 H(Q)；
- η 上下界：η(Q)=sigmoid(s(Q))，天然限制在 (0,1)。

## 数据充分性与病态性门槛

- 条件数门槛：设计矩阵 κ(X)≤κ_max（默认 1e4），超过则降维/加强正则/扩大采样区间；
- 覆盖度：BEP±ΔQ 区至少占样本的 30%，关死点与大流量端各≥10% 样本。

## 漂移监测与重训触发

- 线上监测指标：MAPE_rolling、约束违例率、能量残差；
- 触发：连续 N 窗口（默认 3）超阈触发重训，重训前先做传感器/工况变更排查。

## 实施清单（Checklist）

- 数据：单位/去重/异常/覆盖 OK；
- 物理：单调/单峰/非负/NPSH/额定功率/扭矩 OK；
- 一致：能量残差达标；
- 数值：条件数/正则/CI 达标；
- 交付：metadata/report/曲线参数/接口联调通过；
- 回退：上版可用、报警阈值与影子对比完成。

## 汽蚀与吸上特性（NPSH）

- 定义：NPSH_a = (P_in−P_v)/(ρg) + z_in − v_in²/(2g)；要求 NPSH_a − NPSH_r(Q) ≥ margin（≥ m_min）。
- 吸上专速：N_ss = n·√Q / (NPSH_r)^{3/4}；限制 N_ss≤N_ss,max（由机组与厂家建议）。
- 约束在拟合中以硬约束或大罚项纳入，违例样本降权或隔离。

## 曲线端点与运行区

- 关死点（shutoff）：H(Q=0)=H0≥0；运行不可长期停留；
- 最小连续稳定流量（MCSF）：Q≥Q_min；大流量端（runout）：Q≤Q_max；
- 拟合/服务层对区外请求采用边界裁切并标注 `extrapolation=true`。

## 磨损/老化漂移模型

- 形变：H_t(Q)=H_0(Q)·(1−δ_H(t))，η_t(Q)=η_0(Q)·(1−δ_η(t))，δ\_\* 随时间缓慢上升；
- 估计：分段时间窗 joint 拟合，跨窗平滑正则 ||Δθ||；
- 运维：当 δ\_\* 超阈发出维护建议（叶轮间隙、清污、轴封）。

## 测量通道一致性与换算

- 扬程换算：H = (P_out−P_in)/(ρg) + (z_out−z_in) + (v_out²−v_in²)/(2g)；
- 单位检查：压力(kPa)↔Pa、流量(m3/h)↔m3/s、密度/重力常数取现场值；
- 传感器对齐：静压零点、差压跨径、安装高度修正纳入 metadata。

## 版本与可复现

- 模型版本：semver；记录训练窗口、软件版本、随机种子、输入哈希；
- 产物签名：SHA256 与父版本指针；回滚策略：始终保留上版 `current_prev`。

## 模型选择与超参搜索

- 备选模型：二次/分段线性/单调样条/形状约束多项式/核回归/轻量 GPR；
- 选择准则：AICc/BIC、K 折/时间留出、LOO（对 GPR）；
- 约束优先：若无约束模型指标略优但违背物理，优先选择满足物理约束者；
- 超参：样条结点数、正则 λ、Huber δ、RANSAC 阈值、单峰罚权 α_bep；
- 搜索：网格/贝叶斯优化（TPE）；记录搜索空间、最优点与次优解差距。

## 诊断与可解释

- 残差图/QQ 图/残差随 Q 的结构性偏差；
- 物理导数曲线：dH/dQ、dη/dQ 单峰性；
- 能量残差：P_m − P_h/η；
- 灵敏度：∂H/∂θ_k、∂η/∂θ_k，识别不稳定参数并加正则或冻结。

## 在线推理与 SLA

- 时延：P95 ≤ 2 ms（本地）、≤ 10 ms（服务）；
- 回退：主模型不可用 → 上版/基线多项式；外推 → 边界裁切 + 标记；
- 观测：QPS、失败率、外推率、物理违例计数；
- 开关位：`--strict-physics`（违例拒绝）/`--warn-only`（打标放行）。

## 资源与部署

- 体积：参数文件 ≤ 200 KB；
- 内存：推理常驻 ≤ 50 MB；
- 设备：无 GPU 依赖；
- 版本兼容：新旧参数文件向后兼容字段，未知字段忽略。

## 合规与审计

- 不落敏：不存储原始凭据/连接串；
- 记录：配置快照（脱敏）、输入哈希、版本/时间窗/门槛；
- 追溯：每次更新生成变更摘要与可回滚指针。

## 拟合方法与算法目录（扩展）

- 经典：二/三次多项式（受约束）、分段线性（PWL，SOS2）、单调样条（I/E-spline）、贝叶斯线性回归；
- GPR：带虚拟导数观测的“单调 GP”；核选择 SE/Matern，边界点加权；
- SVR：线性/RBF 核 + 单调罚项（对相邻 Q 的差分约束）；
- 树模型：随机森林回归、梯度提升（XGBoost/LightGBM/CatBoost）；支持/模拟单调约束，后处理单调投影；
- 形状约束网络：TensorFlow Lattice（单调校准器+格子）、单调 MLP（非负权重+排序层）、NAC/NAF；
- PINN：在损失中加入能量一致性与物理边界，弱形式罚项稳定训练。

## 多任务目标函数（H/P/η 联合）

L(θ)=w_H·MSE(H−Ĥ)+w_P·MSE(P−P̂)+w_η·MSE(η−η̂)
+λ_m·E\[(∂Ĥ/∂Q)_+^2\]+λ_u·E\[(sign(Q−Q_bep)·∂η̂/∂Q)_+^2\]
+λ_e·E\[(P̂−ρgQ·Ĥ/η̂)^2\]+λ_r·||θ||²

- 说明：第一行数据项；第二行为单调与单峰罚；第三行为能量一致性；另含正则。

## 形状与物理约束（算法手段）

- 单调：
  - 样条：I-spline 非负系数；
  - 树：XGBoost/LightGBM `monotone_constraints={Q:-1}`；
  - NN：非负权重 + 积分层/排序层；
- 非负：SoftPlus/exp 重参数化；
- 单峰（η）：Q_bep 分治（两侧单调）或“差分两递增函数”结构；
- 额定/扭矩：在采样网格评估硬约束或大罚项；
- NPSH：对低流量/高流量端加入可行域屏蔽与罚项。

## 机器学习/深度计算方法（建议组合）

- 小样本高噪声：形状约束样条 + Huber；
- 中样本：LightGBM（单调约束）+ Isotonic 校准；
- 中到大样本：TF Lattice 或 单调 MLP + 导数罚；
- 需要不确定性：GPR/深度集合（MC Dropout/深度集成）。

## 超参参考（速查）

- 样条结点：8-20；Huber δ：1.0×IQR；λ_m/λ_u：1e−2~1；λ_e：1e−3~1e−1；
- XGBoost：max_depth 3-6, n_estimators 300-800, learning_rate 0.03-0.1；
- TF Lattice：每维 8-16 网格，格子 L2 正则 1e−4~1e−2。

## 训练/验证与泄漏防护

- 时间留出或滚动验证；同一工况段不跨集；
- BEP 附近与端点样本在验证集中占比≥各 10%。

## 上线风控与回退

- 黑盒保护：上线仅接入“受约束模型”；
- 违规兜底：若检测到单调/能量违例 → 投影裁剪 + 告警；
- 回退优先级：当前→上版→基线（二次/样条）。

## PWL-SOS2 近似与 MILP 模板（速用）

- 断点：{(Q_k, H_k)}\_{k=1..K} 按 Q 升序；
- 变量：λ_k ≥ 0, Σ_k λ_k = 1, SOS2(λ)；
- 近似：Q = Σ_k λ_k Q_k，Ĥ = Σ_k λ_k H_k；
- 多目标：可同时近似 P/η（各自断点或共享 Q 断点）；
- 组装：并入泵组 MILP 时，每台泵一组 λ_k，启停 x_i=0 → 约束 λ=0，x_i=1 正常；
- 求解：设置 MIPGap 与时间限额，热启动用上周期解。

## 树/GBDT/随机森林/TF Lattice/GPR/SVR 配置速查

- LightGBM（单泵 H(Q) 单调递减）：
  - monotone_constraints: {Q:-1}
  - params: max_depth=4-6, num_leaves=31-63, learning_rate=0.05, n_estimators=600±, min_child_samples=40
  - 后处理：单调投影/等值层压，端点夹紧
- XGBoost：`monotone_constraints="(-1)"`（仅对 Q）；`max_depth=5, n_estimators≈800`
- 随机森林：`n_estimators=500`，启用等值层压或等距网格后做等单调回归投影
- TF Lattice：
  - calibrators：单调分段线性标定；lattice_sizes: \[8\]；lattice 正则 L2=1e-3；
  - 边界夹紧，输出 SoftPlus 保证非负
- GPR：核 SE 或 Matern ν=1.5；长度尺度对 Q 做对数尺度；诱导点 m=512（稀疏近似）；
  - 单调：虚拟导数观测或在采样点对 dH/dQ 加软约束
- SVR：RBF 核，C=10~100，ε=0.01~0.1，γ=1/(2·σ²)；相邻差分加单调罚项

## 报告与评测表头建议

- 指标：rmse, mae, mape, r2, phys_violation_rate, energy_residual_rmse
- 区段：q_min, q_bep, q_max, coverage_bep, coverage_ends
- 训练：samples_train, samples_val, hubs_delta, lambda_m, lambda_e
- 运行：latency_p95_ms, extrapolation_rate, rollback_used

## 无量纲系数与相似定律拓展

- 流量系数 φ = Q/(n·D³)，扬程系数 ψ = g·H/(n²·D²)，功率系数 π = P/(ρ·n³·D⁵)；
- 归一曲线：ψ(φ)、η(φ) 更稳健，适合跨型号/相似泵对齐；
- 特定转速 Ns = n·√Q / H^{3/4}，用于机组分类与先验约束；
- 黏度修正：η_corr = f_η(ν,Re,φ)·η，ψ_corr = f_ψ(ν,Re,φ)·ψ，系数可查表或参数化拟合。

## 统计学习：GAM/SCAM 与单调加性

- GAM：H(Q)=β₀+Σ_j s_j(Q)，用样条 s_j；通过差分/惩罚保证单调与平滑；
- SCAM（shape-constrained additive models）：支持单调/凸凹等形状约束；
- 优点：可解释、稳定；缺点：复杂非线性区域需更高阶项或分段处理。

## 不确定性量化（UQ）与区间

- 频率法：Bootstrap/Jackknife；
- 贝叶斯：BLR/GPR 后验；
- 集成：深度/树的集成方差；
- 共形预测：基于残差的分位数校准，输出 (L,U) 置信区间，覆盖率可控。

## OOD（分布外）检测与守护

- 基于特征的马氏距离/核密度，或基于残差的控制图（CUSUM/EWMA）；
- 触发：标注 OOD=true，降级为保守输出并建议回收样本补数。

## 数据契约（输入/输出）

- 输入字段：Q, H_meas, P_meas, η_meas, ρ, g, ν, T, meta（泵径 D、Ns、铭牌功率等）；
- 输出：曲线参数、评测指标、CI、外推/违例标记；
- 校验：单位/范围/缺失率阈值，失败即拒绝训练。

## 更多曲线拟合方法（补充目录）

- 有理函数/Padé 逼近：
  - 形式：H(Q)≈(a0+a1Q+…+apQ^p)/(1+b1Q+…+bqQ^q)；
  - 约束：分母极点不在有效域，dH/dQ≤0；
  - 适用：端点曲率差异大、二次/样条难以兼顾的场景。
- 正交多项式：切比雪夫/勒让德展开 + L2/TV 正则 + 形状约束；
- 总变差（TV）样条/趋势滤波（L1）：消除高频振荡，保留单调边；
- 等单调回归（Isotonic, PAVA）+ 平滑：先保证单调，再以样条/LOESS 细化；
- 凸/凹回归（Convex/Concave Regression）：
  - 对关死段扬程/效率峰两侧采用局部凸凹约束，提高可解释与稳健性；
- BART/单调 BART：贝叶斯加性回归树，支持单调先验与不确定性；
- 符号回归（Physics-guided）：以 ψ(φ)、η(φ) 的字典项做稀疏搜索，结合相似定律先验；
- 分位数/期望分位回归（Quantile/Expectile）：面向偏态/异方差，直接给出上下分位曲线；
- 局部回归 LOESS/LOWESS + 单调重排（Rearrangement）：局部拟合后做单调化投影；
- Bezier/样条控制点法：以控制点约束实现单调/非负，几何可解释。

### 选型速查

- 端点与峰附近曲率差异大：优先有理函数/Padé 或 正交多项式 + 形状约束；
- 强噪声且需形状保真：TV 样条/趋势滤波 + 单调投影；
- 小样本 + 需置信区间：单调 BART/贝叶斯样条；
- 快速上线/可解释：Isotonic→样条细化 或 Bezier 控制点法。

## 拟合后验证/物理一致性/相似定律/专业公式速查

- 数值指标（建议门槛）：RMSE≤阈值、MAPE≤阈值、R²≥0.98、外推率≤1%、物理违例率≤0.5%。
- 单调性：Pr\[dĤ/dQ≤0\]≥99.5%；端点梯度有限且与历史同号。
- 单峰（η）：存在且唯一 Q_bep，左右导数符号满足；Q_bep 偏移 ≤ 5% 额定流量。
- 能量一致：RMSE(P̂ − ρgQ·Ĥ/η̂) ≤ ε_P（按功率比例设定）。
- 额定与扭矩：max P̂ ≤ P_rated、max T̂ ≤ T_rated（T̂=P̂/ω）。
- NPSH：min (NPSH_a − NPSH_r(Q)) ≥ m_min；违例样本=0。
- 系统一致：与 H_sys(Q) 唯一交点且 |dH_group/dQ| > |dH_sys/dQ|（稳定）。

## 相似定律一致性校验

- 归一变量：φ=Q/(nD³), ψ=gH/(n²D²), π=P/(ρn³D⁵)。
- 曲线对齐：不同 n（或 D）的 ψ(φ)、η(φ) 叠加误差 ≤ ε_align；
- 频点缩放回放：将不同频点缩放到基准 n_ref 后的 RMSE 报告。

## 基准点与区段误差

- 关死扬程：|Ĥ(0) − H0_meas| ≤ ε_H0；
- BEP 区：η̂ 峰值误差 ≤ ε_η，Q_bep 偏移 ≤ 5%；
- 大流量端（runout）：Ĥ、P̂ 不负，斜率与历史一致；
- 覆盖率：BEP±ΔQ 占比≥30%，端点各≥10%。

## 报告模板字段（新增）

- physics: {mono_rate, unimodal_pass, energy_rmse, npsh_pass, rated_guard_pass}
- similarity: {align_rmse, n_ref, eps_align}
- benchmarks: {h0_err, q_bep_shift_pct, eta_peak_err}
- stability: {unique_intersection: true/false, slope_margin}

## 专业公式速查

- Bernoulli：p/ρg + v²/2g + z = 常数（忽略损失时）。
- Darcy–Weisbach：ΔH = f(L/D)·(v²/2g) + ΣK(v²/2g)。
- 水力功率：P_h = ρgQH；效率：η = P_h / P_input；转矩：T=P/ω。
- 吸上：NPSH_a = (p_in − p_v)/(ρg) + z − v²/2g，要求 NPSH_a ≥ NPSH_r + margin。

## 直径缩放相似律（叶轮切割/更换）

- 直径相似：同转速 n 下，不同直径 D1→D2 的缩放：
  - Q₂ ≈ Q₁·(D₂/D₁)
  - H₂ ≈ H₁·(D₂/D₁)²
  - P₂ ≈ P₁·(D₂/D₁)³
- 用途：
  - 以 D_ref 曲线外推出 D_target 曲线的先验；
  - 多型号归一后联合拟合，提高稀疏区间稳定性；
- 警示：大幅切割后效率下降，需在 η 上加入惩罚或独立修正项。

## ISO 9906 验收（容差带）

- 采用标准容差带（如 1B/1E 等级）对 H/Q/η/P 的相对误差进行判定；
- 报告：对基准点（关死/BEP/runout）与若干等距点输出“是否在容差带内”的通过率；
- 超限处置：保留模型但标注 `acceptance=false`，并建议补充样本或回归到保守模型。

## 残差诊断（拟合后）

- 正态性/偏态：QQ 图、Shapiro（仅参考，不作为硬门禁）；
- 自相关：Durbin–Watson / Ljung–Box，拒绝显著一阶/周期性自相关（暗示系统性拟合偏差）；
- 异方差：残差随 Q 的散点与分箱方差图，必要时采用加权或分段模型。

## 不确定性传播

- Delta 法：Var\[g(y)\]≈(g'(μ))² Var\[y\]，对 H/P/η 的小扰动评估；
- Monte Carlo：对参数后验/Bootstrap 重采样，传播至 H/Q/P/η 与 KPI；
- 报告：在 `report.json` 中输出区间宽度随 Q 的曲线与 P95 指标。

## 可逆映射与一一性

- 需求：系统解算常以 H_sys(Q) 与 H_pump(Q) 交汇；也需 Q(H) 的稳定单调逆；
- 方法：
  - 若采用单调样条，以 Q 为自变量的 H(Q) 直接可逆（增设查找表与单调插值）；
  - 其他模型以网格表 (Q,H) 构建 Q(H) 单调插值，保证无回跳；
- 门槛：逆映射残差 RMSE 与单调性违例率（≤0.5%）。

## Cavitation 指标（Thoma 系数）

- σ = NPSH_a / H；要求 σ ≥ σ_min（由机组经验与工况给定）；
- 在报告中输出 σ 曲线与最小裕度位置，提示潜在汽蚀风险区。

## 二阶形状与 BEP 邻域约束

- 二阶导数偏好：在 \[0, Q_bep\] 区域优先 H''(Q) ≤ 0（凹），BEP 右侧允许轻微拐点但禁止“波浪”振荡；
- 实现：二阶差分惩罚 ∑(Δ²H)² 与不等式 H''(Q)≤ε；η 在峰附近二阶负且对称性误差≤阈值。

## 保守包络与外推治理

- 包络：以分位/共形得到上/下包络 B_upper/B_lower；服务层输出 clamp(Ĥ, B_lower, B_upper)；
- 外推优先级：边界裁切 > 相似定律缩放 > 上版基线；均附 `extrapolation/degraded` 标记。

## 标定与试验台修正（Bench Correction）

- 压力/流量计溯源证书周期与漂移曲线；
- 管路损失回算：试验台 H_meas ← H_meas − ΔH_loss；
- 零点/跨度在线自检：静止压与零流量校验，超限拒绝训练。

## 区域化权重与采样策略

- 关死/BEP/大流量端加权：w∝1/σ²(Q)；
- 稀疏区间追加合成样本（相似定律缩放/数据增强）并降权，避免误导；
- 训练-验证分布对齐：分层抽样保证三端覆盖一致。

## 多来源一致性与合并

- 主来源优先级 > 同秒最早（见合并与冲突策略）；
- 归一后进行曲线级对齐与离群剔除；
- 记录差异统计并入 report。

## 方法总览与选型指南（汇总）

- 物理/参数化：
  - 抛物线/二次或分段二次（H≈H0−aQ²；P≈p0+p1Q+p2Q²；η 单峰二次）；
  - 有理函数/Padé；正交多项式（切比雪夫/勒让德）+ 形状约束；
  - 相似定律/直径缩放先验 + 残差修正；
  - 能量一致耦合（联合拟合 H/P/η 并加 P≈ρgQH/η 约束）。
- 形状约束/非参数：
  - 单调样条（I-/E-spline）、Bezier 控制点；
  - PWL–SOS2 分段线性（MILP 友好）；
  - TV 样条/趋势滤波；Isotonic/PAVA + 二次平滑；
  - 凸/凹回归（关死段/峰左右局部几何）。
- 统计/贝叶斯：
  - GAM/SCAM（形状约束加性模型）；
  - 贝叶斯样条、单调 BART；
  - GPR/单调 GP（虚拟导数约束）；
  - 贝叶斯线性回归（带先验与区间）。
- 机器学习/深度：
  - SVR（RBF/线性）+ 单调差分罚；
  - 随机森林/GBDT（LightGBM/XGBoost/CatBoost）+ 单调约束 + 单调投影；
  - TF Lattice（单调校准器+格子）；
  - 单调 MLP/NAF/NAC（非负权重+导数罚）；
  - 符号回归（物理引导字典）；
  - 分位数/共形回归（上下包络）。
- 鲁棒/组合：
  - RANSAC/Huber/SoftL1；
  - Mixture-of-Experts（分工况专家）；
  - 低秩主形状 + 小模型残差。
- 双向/反演：
  - 直接拟合 Q(H) 与 H(Q) 的单调互逆，支持调度快速反解。
- 非参数/局部方法：
  - LOESS/LOWESS（局部加权回归）+ 单调重排；
  - k近邻回归（局部平均）+ 距离加权；
  - 核回归（Nadaraya-Watson）+ 带宽选择；
  - 径向基函数（RBF）+ 形状约束。
- 信号处理/频域：
  - 小波变换（多尺度分析）+ 阈值去噪；
  - 总变差（TV）去噪/趋势滤波（保边平滑）；
  - 傅里叶级数/频域滤波（周期性数据）。
- 深度学习高级：
  - 变分自编码器（VAE）+ 潜变量约束；
  - Transformer（序列建模，时变特性）；
  - 神经常微分方程（Neural ODE）+ 连续时间动态；
  - 图神经网络（GNN，管网拓扑建模）。
- 学习范式：
  - 元学习（few-shot适应，跨泵型）；
  - 迁移学习（预训练+微调）；
  - 多保真融合（CFD仿真+实测）；
  - 在线学习（流式数据更新）。
- 树方法扩展：
  - 决策树回归（CART，可解释）+ 单调后处理；
  - 梯度提升变种（NGBoost不确定性，TabNet深度表格）。
- 时间序列扩展：
  - ARIMA/GARCH（时间依赖建模）；
  - 动态因子模型（共同趋势提取）；
  - 粒子滤波（非线性状态估计）；
  - 隐马尔可夫模型（HMM，状态切换）。
- 优化高级：
  - 半定规划（SDP，多项式优化）；
  - 锥优化（二阶锥/半定锥约束）；
  - 进化算法（遗传/差分进化）；
  - 粒子群优化（PSO）、模拟退火（SA）。
- 其他方法：
  - 变分推断（近似贝叶斯）；
  - 薄板样条（2D平滑）；
  - 共形预测（分布无关置信区间）；
  - 集成方法（Bagging/Boosting变种）。
- 稀疏/压缩感知：
  - 压缩感知（Compressed Sensing）稀疏恢复；
  - 字典学习（Dictionary Learning）+ 稀疏编码；
  - 主成分分析（PCA）+ 回归；
  - 独立成分分析（ICA）信号分离。
- 分布/概率建模：
  - 混合高斯模型（GMM）+ EM算法；
  - 狄利克雷过程（Dirichlet Process）非参数；
  - 泊松过程建模（故障/维护事件）；
  - 极值理论（EVT）极端工况建模。
- 图论/网络方法：
  - 谱聚类（Spectral Clustering）模式识别；
  - 社区发现算法（运行模式聚类）；
  - 图信号处理（Graph Signal Processing）；
  - 网络嵌入（Network Embedding）特征学习。
- 量子/启发式：
  - 量子退火（Quantum Annealing）组合优化；
  - 蚁群算法（ACO）路径优化；
  - 人工蜂群算法（ABC）参数搜索；
  - 布谷鸟搜索（Cuckoo Search）全局优化。
- 混合/组合方法：
  - 物理+数据混合建模（Physics+Data Hybrid）；
  - 多尺度建模（Multiscale Modeling）；
  - 动静态混合（Static+Dynamic Fusion）；
  - 确定+随机混合（Deterministic+Stochastic）。
- 快速选型（更新）：
  - 小样本高噪声：单调样条 + Huber 或 TV去噪 + Isotonic；
  - 中样本、上线快：LightGBM 单调 + 等值层压投影；
  - 需不确定性：单调 GPR/单调 BART 或 共形预测；
  - 需与 MILP 联动：PWL–SOS2（共享断点、可热启动）；
  - 时变/在线：RLS/卡尔曼 或 在线学习；
  - 跨泵型：元学习/迁移学习 + 相似定律先验。

## 可拟合特性曲线清单与方法速查（单泵）

- 核心水力

  - H–Q（扬程-流量）
    - 数据：吸/排压或压差、密度ρ、重力g、几何高度差与动能修正（换算H）。
    - 方法：单调样条（I/E-spline）、有理函数/Padé、PWL–SOS2、正交多项式+形状约束、GPR（单调）、TF Lattice、LightGBM（单调）。
  - Pshaft–Q / Pin–Q（轴功率/输入功率-流量）
    - 数据：轴功率或输入功率、电机/驱动效率（若要区分）。
    - 方法：二次/分段二次、GBDT/随机森林、GAM、GPR；与 H/η 联合拟合并加能量一致性罚项。
  - η–Q（效率-流量）
    - 数据：H、Q、Pin（或Pshaft）。
    - 方法：单峰二次/单峰样条、SCAM、TF Lattice（单峰通过分治或罚项）、单调 BART；保证 0≤η≤1 且单峰。
  - NPSHr–Q（汽蚀余量需求-流量）
    - 数据：厂家表/试验推定、汽蚀识别事件。
    - 方法：形状约束样条（单调上升）、Isotonic + 平滑；可叠加 Thoma σ 约束。
  - Δp–Q（压差-流量）
    - 数据：差压传感器。
    - 方法：同 H–Q，保持单调与非负。
  - Q–H（反查曲线）
    - 数据：由 H–Q 推导。
    - 方法：单调互逆映射（表格+单调插值），保证无回跳。

- 电气/机电派生

  - I–Q、PF–Q、ω–Q、T–Q（T≈Pshaft/ω）、Ploss–Q（Pin−Ph）
    - 数据：电流/功率因数/频率/功率。
    - 方法：回归（GAM/GBDT/MLP/GPR），加边界与非负约束；与主曲线联合训练可提高一致性。

- 家族/扩展

  - H(Q,n)、P(Q,n)、η(Q,n)（频率–流量–性能曲面，变频）
    - 方法：张量样条/低秩+残差、TF Lattice 2D、GPR（多任务，导数约束），见 69。
  - H(Q;D)、η(Q;D)（直径家族曲线）
    - 方法：直径缩放先验 + 残差小模型；跨型号联合拟合。
  - σ–Q（Thoma 系数）
    - 方法：由 NPSHa/H 推导并平滑，报告汽蚀裕度最小区间。

- 运行与健康

  - η_peak–t（峰值效率随时间漂移）、H0–t（关死扬程漂移）
    - 方法：滑窗回归/状态空间平滑，触发维护阈值。
  - 振动/噪声–Q、温升–n/负载
    - 方法：分段/加性模型，设定安全阈值。

- 选型提示

  - 快速上线：LightGBM（单调）/TF Lattice；
  - MILP 联动：PWL–SOS2（共享断点，易热启动）；
  - 高噪声小样本：单调样条 + Huber；
  - 需区间：单调 GPR/单调 BART/分位数+共形；
  - 强物理一致：联合目标（H/P/η + 能量一致）与单调/单峰/非负/额定/ NPSH 约束。
