# æµ‹è¯•ä¸è´¨é‡ä¿è¯æŠ€æœ¯è§„èŒƒ

## ğŸ§ª å¦‚ä½•æ‰§è¡Œæµ‹è¯•ä¸è´¨é‡é—¨ç¦

1. åŒæ­¥ä¾èµ–ä¸ç¯å¢ƒï¼šä½¿ç”¨é¡¹ç›®çº§ .venvï¼Œå®‰è£… requirements.txtï¼›Python 3.13.6ã€‚
1. è´¨é‡æ£€æŸ¥é¢„è®¾ï¼šruff lint+format â†’ mypy/pyright â†’ pytestï¼ˆé»˜è®¤è·³è¿‡æ…¢æµ‹ï¼‰ã€‚
1. è¦†ç›–ç‡é—¨æ§›ï¼šå…¨å±€ â‰¥ 70%ï¼Œæ ¸å¿ƒæ¨¡å—ä¼˜å…ˆï¼›ç”Ÿæˆ XML æŠ¥å‘Šå½’æ¡£ã€‚
1. æ•°æ®é›†å‡†å¤‡ï¼šä½¿ç”¨ä»“åº“æä¾›çš„åˆæˆæ ·æœ¬ï¼›å›ºå®šéšæœºç§å­ã€‚
1. è¾“å‡ºï¼šä¸­æ–‡æ—¥å¿—ï¼Œå…³é”®æ­¥éª¤è®°å½•â€œå‚æ•°/è€—æ—¶/ç»“æœ/å¼‚å¸¸â€ã€‚

ç‰ˆæœ¬ï¼šv1.0 | é€‚ç”¨èŒƒå›´ï¼šå•å…ƒ/é›†æˆ/E2E æµ‹è¯•ã€æ•°æ®ä¸ç®—æ³•ç²¾åº¦éªŒè¯ã€æ€§èƒ½æµ‹è¯•ã€è´¨é‡é—¨ç¦ä¸æŠ¥å‘Š

ç›®æ ‡ï¼š

- å°†â€œç²¾åº¦éªŒè¯ä¸è´¨é‡ä¿è¯â€ç­‰åˆ†æ•£å†…å®¹ä»æ€»æŠ€æœ¯è§„èŒƒä¸­æ‹†åˆ†ï¼Œé™ä½å•æ–‡ä»¶è¡Œæ•°å¹¶å¼ºåŒ–å¯æ‰§è¡Œæ ‡å‡†ã€‚
- å»ºç«‹è¦†ç›–æ•°æ®å¤„ç†ã€ä¼˜åŒ–ç®—æ³•ã€å®æ—¶é“¾è·¯çš„ç«¯åˆ°ç«¯è´¨é‡ä½“ç³»ï¼Œç¡®ä¿å¯å›å½’ã€å¯åº¦é‡ã€å¯è¿½æº¯ã€‚
- ä¸é¡¹ç›®å·¥ç¨‹åŒ–åŸºçº¿ä¸€è‡´ï¼šPython 3.13.6ï¼›.venvï¼›ä¾èµ–é›†ä¸­ç®¡ç†ï¼›CI å¯ç”¨ lint + type + test è´¨é‡é—¨ç¦ã€‚

## 1. æ€»ä½“è´¨é‡é—¨æ§›

- ä»£ç é£æ ¼ï¼šRuff ç»Ÿä¸€ lint + formatï¼›æ— é«˜/ä¸­ç­‰çº§ lint è¿è§„ã€‚
- ç±»å‹æ£€æŸ¥ï¼šmypy/pyright å¿…é¡»é€šè¿‡ï¼›å¯¹å¤–/å…³é”®å‡½æ•°å‡æä¾›ç²¾ç¡®ç±»å‹æ³¨è§£ï¼ˆé¿å… Anyï¼‰ã€‚
- å•å…ƒæµ‹è¯•è¦†ç›–ç‡ï¼šå…¨å±€è¡Œè¦†ç›–ç‡ â‰¥ 70%ï¼ˆé˜ˆå€¼åœ¨ CI å¼ºåˆ¶ï¼‰ï¼›æ ¸å¿ƒæ¨¡å—ä¼˜å…ˆä¿éšœã€‚
- æ—¥å¿—ä¸å¯è§‚æµ‹ï¼šæ‰€æœ‰è‡ªåŠ¨åŒ–æµ‹è¯•è¾“å‡ºä¸­æ–‡æ—¥å¿—ï¼›å…³é”®æ­¥éª¤è®°å½•è€—æ—¶ä¸å…³é”®å‚æ•°ã€‚

## 2. æµ‹è¯•åˆ†å±‚ä¸èŒè´£

- å•å…ƒæµ‹è¯•ï¼ˆUnitï¼‰
  - èŒƒå›´ï¼šçº¯å‡½æ•°/ç±»çš„å°ç²’åº¦è¡Œä¸ºï¼›é•¿åº¦ â‰¤ 50 è¡Œçš„å‡½æ•°ä¼˜å…ˆè¦†ç›–ã€‚
  - è¦æ±‚ï¼šArrange-Act-Assert ç»“æ„æ¸…æ™°ï¼›éšæœºæ€§å›ºå®šç§å­ï¼›éš”ç¦» I/Oï¼ˆä½¿ç”¨ mockï¼‰ã€‚
  - å¤±è´¥å®šä½ï¼šæ–­è¨€æ¶ˆæ¯åŒ…å«è¾“å…¥å‚æ•°è¦ç‚¹ä¸æœŸæœ›-å®é™…å¯¹æ¯”ã€‚
- ç»„ä»¶/é›†æˆæµ‹è¯•ï¼ˆIntegrationï¼‰
  - èŒƒå›´ï¼šæ•°æ®åº“ã€ç¼“å­˜ã€å¤–éƒ¨æ¥å£é€‚é…å™¨ã€æ¶ˆæ¯é€šé“ï¼›è¦†ç›–åè®®è¾¹ç•Œä¸åºåˆ—åŒ–/ååºåˆ—åŒ–ã€‚
  - ç­–ç•¥ï¼šä¼˜å…ˆä½¿ç”¨ fake/æ¨¡æ‹ŸæœåŠ¡ï¼›å¿…è¦æ—¶ä½¿ç”¨ä¸´æ—¶æµ‹è¯•ç¯å¢ƒã€‚
- ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆE2Eï¼‰
  - èŒƒå›´ï¼šä»æ•°æ®é‡‡é›† â†’ æµå¼å¤„ç† â†’ è´¨é‡ç›‘æ§ â†’ å­˜å‚¨/ä¼˜åŒ– â†’ å¯¹å¤–æ¥å£/æ¨é€çš„å…³é”®è·¯å¾„ã€‚
  - éªŒæ”¶ï¼šä»¥ä¸šåŠ¡æŒ‡æ ‡ä¸ºå‡†ï¼ˆæ­£ç¡®æ€§ã€æ—¶æ•ˆã€å¹‚ç­‰ï¼‰ã€‚

## 3. æ•°æ®è´¨é‡ä¸ CSV æ ¡éªŒæµ‹è¯•

- è¯»å–ï¼špandas read_csv æŒ‡å®š dtype/parse_datesï¼Œç¦æ­¢éšå¼æ¨æ–­ï¼›å¤§æ–‡ä»¶åˆ†å—è¯»å–ç”¨ä¾‹éªŒè¯å†…å­˜å ç”¨ä¸Šé™ã€‚
- ç»“æ„æ ¡éªŒï¼šåˆ—åã€å¿…å¡«åˆ—ã€æšä¸¾å€¼èŒƒå›´ã€æ—¶é—´æˆ³æ—¶åŒºï¼ˆç»Ÿä¸€ UTCï¼‰ã€‚
- å¼‚å¸¸æ•°æ®ï¼šç¼ºå¤±ã€æç«¯/ç¦»ç¾¤å€¼æ£€æµ‹ä¸å¤„ç†ç­–ç•¥ï¼ˆä¸¢å¼ƒ/æ’è¡¥ï¼‰çš„ä¸€è‡´æ€§æµ‹è¯•ã€‚
- å¹‚ç­‰æ€§ï¼šé‡å¤å¯¼å…¥/é‡è¯•ä¸äº§ç”Ÿé‡å¤è®°å½•æˆ–æ±¡æŸ“ã€‚

## 4. æ›²çº¿æ‹Ÿåˆç²¾åº¦éªŒè¯ï¼ˆæ•°æ®å¤„ç†æ¨¡å—ï¼‰

- æŒ‡æ ‡ï¼šRÂ²ã€RMSEã€MAE å¿…æµ‹ï¼›åŸºå‡†é˜ˆå€¼ RÂ² â‰¥ 0.95ï¼ˆé™¤éåœºæ™¯ç‰¹æ‰¹å¹¶è¯´æ˜ï¼‰ã€‚
- äº¤å‰éªŒè¯ï¼šk-foldï¼ˆå»ºè®® k=5 æˆ– 10ï¼‰ï¼›æŠ¥å‘ŠæŠ˜å†…/æŠ˜å¤–æŒ‡æ ‡åˆ†å¸ƒï¼ˆå‡å€¼ã€æ–¹å·®ã€P95ï¼‰ã€‚
- ç‰©ç†ä¸€è‡´æ€§ï¼šå•è°ƒæ€§/è¾¹ç•Œæ¡ä»¶/å•ä½è½¬æ¢æ­£ç¡®æ€§ï¼›å¯¹å¼‚å¸¸æ‹Ÿåˆè¾“å‡ºç»™å‡ºåˆ¤å®šä¸å›é€€ç­–ç•¥æµ‹è¯•ã€‚
- æ®‹å·®åˆ†æï¼šæ®‹å·®å‡å€¼â‰ˆ0ã€æ— ç³»ç»Ÿæ€§è¶‹åŠ¿ï¼›è‹¥å­˜åœ¨åç§»éœ€æµ‹è¯•æ˜¯å¦è§¦å‘é‡æ‹Ÿåˆ/å‘Šè­¦åˆ†æ”¯ã€‚

## 5. ä¼˜åŒ–ç®—æ³•éªŒè¯ï¼ˆå•/å¤šç›®æ ‡ï¼‰

- å•ç›®æ ‡ï¼ˆå«è´å¶æ–¯ä¼˜åŒ–ï¼‰
  - åˆå§‹é‡‡æ ·ï¼šæ‹‰ä¸è¶…ç«‹æ–¹/éšæœºè¦†ç›–åº¦è¯„ä¼°ï¼›è¾¹ç•Œç‚¹/å¯è¡ŒåŸŸè¦†ç›–æµ‹è¯•ã€‚
  - é‡‡é›†å‡½æ•°ï¼šEI/PI/UCB è¡Œä¸ºç”¨ä¾‹ï¼ˆåœ¨æ§åœºæ™¯ä¸‹æœŸæœ›é€‰ç‚¹ä¸æ”¹è¿›å¹…åº¦ï¼‰ã€‚
  - æ”¶æ•›æ€§ï¼šæ ‡å‡†åŸºå‡†å‡½æ•°ï¼ˆSphereã€Rosenbrockã€Rastriginï¼‰ä¸Šç»˜åˆ¶å¹¶æ–­è¨€æ”¶æ•›æ›²çº¿è¶‹åŠ¿ä¸æœ€ç»ˆè¯¯å·®é˜ˆå€¼ã€‚
  - å¤ç°å®éªŒï¼šå›ºå®šéšæœºç§å­ï¼Œç»“æœæ–¹å·®ä¸è¶…è¿‡è®¾å®šé˜ˆå€¼ï¼ˆä¾‹å¦‚æœ€ä½³å€¼æ ‡å‡†å·® â‰¤ 5%ï¼‰ã€‚
- å¤šç›®æ ‡ï¼ˆNSGA-IIï¼‰
  - æ­£ç¡®æ€§ï¼šéæ”¯é…æ’åºã€æ‹¥æŒ¤è·ç¦»è®¡ç®—çš„è¾¹ç•Œç”¨ä¾‹ï¼ˆé‡å¤ç‚¹ã€é€€åŒ–å‰æ²¿ï¼‰ã€‚
  - åŸºå‡†ï¼šZDT1/2/3 ç­‰é—®é¢˜çš„å¸•ç´¯æ‰˜è¿‘ä¼¼å‰æ²¿ï¼›è¶…ä½“ç§¯ï¼ˆHypervolumeï¼‰éšä»£æ•°å•è°ƒä¸Šå‡çš„ç»Ÿè®¡æ£€éªŒã€‚
  - é€‰æ‹©/äº¤å‰/å˜å¼‚ï¼šå‚æ•°åŒ–ç”¨ä¾‹è¦†ç›–ï¼ˆäº¤å‰æ¦‚ç‡ã€å˜å¼‚ç‡ï¼‰ï¼Œæ–­è¨€å¤šæ ·æ€§ä¸æ”¶æ•›å¹³è¡¡ã€‚

## 6. å®æ—¶é“¾è·¯ä¸æµå¼è®¡ç®—æµ‹è¯•

- é‡‡é›†ç¼“å†²ï¼šè¾¾åˆ°å®¹é‡/å®šæ—¶æ¡ä»¶è§¦å‘ flush çš„æ—¶åºä¸€è‡´æ€§ï¼›å¹¶å‘æºï¼ˆModbus/OPC UA/MQTTï¼‰äº’ä¸é˜»å¡ã€‚
- èƒŒå‹ï¼šå¤„ç†å»¶è¿Ÿä¸Šå‡æ—¶é‡‡é›†é€Ÿç‡è‡ªé€‚åº”é™é€Ÿï¼›é˜ˆå€¼/é€€é¿ç­–ç•¥ç¬¦åˆé…ç½®ã€‚
- è´¨é‡ç›‘æ§ï¼šè´¨é‡åˆ†æ•°è®¡ç®—ï¼ˆæ—¶é—´æ–°é²œåº¦ã€å–å€¼èŒƒå›´ã€å˜åŒ–ç‡ï¼‰ä¸é˜ˆå€¼å‘Šè­¦è§¦å‘çš„å‡†ç¡®æ€§ï¼›æœ€è¿‘ N æ¡å†å²æˆªæ–­é€»è¾‘ã€‚
- WebSocketï¼šè®¢é˜…è¿‡æ»¤ã€é€Ÿç‡é™åˆ¶ï¼ˆæ¯è¿æ¥ â‰¤ N æ¡/ç§’ï¼‰ã€å¿ƒè·³ä¸æ–­çº¿é‡è¿çš„ç”¨ä¾‹è¦†ç›–ã€‚

## 7. API æµ‹è¯•

- è¾“å…¥æ ¡éªŒï¼šJSON schema/ç±»å‹/èŒƒå›´/å¿…å¡«æ ¡éªŒï¼›è·¯å¾„ä½¿ç”¨ pathlib ç™½åå•ã€‚

## 8. æ€§èƒ½ä¸å®¹é‡æµ‹è¯•

- ç›®æ ‡ï¼š
  - æ•°æ®å¯¼å…¥ï¼šâ‰¥ 100 MB/sï¼ˆåŸºå‡†æ ·æœ¬é›†ï¼‰
  - ä¼˜åŒ–æ”¶æ•›æ—¶é—´ï¼šâ‰¤ 5 åˆ†é’Ÿï¼ˆç»™å®šè§„æ¨¡ï¼‰
  - æ•°æ®åº“æŸ¥è¯¢ P95ï¼šâ‰¤ 100 msï¼›å¹¶å‘ç”¨æˆ· â‰¥ 100
  - èµ„æºï¼šCPU â‰¤ 70%ï¼Œå†…å­˜ â‰¤ 80%
- æ–¹æ³•ï¼š
  - å‹æµ‹å·¥å…·ï¼ˆå¯è‡ªé€‰ï¼‰å¯¹ API/å®æ—¶æ¨é€/æ•°æ®åº“è¿›è¡Œå‹æµ‹ï¼›æ”¶é›† P50/P95/P99 ä¸é”™è¯¯ç‡ã€‚
  - è®°å½•ç³»ç»ŸæŒ‡æ ‡ï¼ˆCPU/å†…å­˜/ç£ç›˜/ç½‘ç»œï¼‰å¹¶ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Šã€‚

## 9. å¯é æ€§ä¸æ•…éšœæ³¨å…¥

- ç½‘ç»œæŠ–åŠ¨/è¶…æ—¶/é‡è¿ï¼›æ¶ˆæ¯é‡å¤/ä¹±åºï¼›æ—¶é’Ÿåç§»ï¼›å¤–éƒ¨ä¾èµ–é™çº§ä¸å›é€€è·¯å¾„ã€‚

## 10. CI/CD è´¨é‡é—¨ç¦ï¼ˆå»ºè®®æµç¨‹ï¼‰

- æ­¥éª¤é¡ºåºï¼š
  1. åŒæ­¥ä¾èµ– â†’ 2) ruff lint+format æ£€æŸ¥ â†’ 3) mypy/pyright ç±»å‹æ£€æŸ¥ â†’ 4) pytestï¼ˆé»˜è®¤è·³è¿‡æ…¢æµ‹è¯•ï¼‰ â†’ 5) è¦†ç›–ç‡é˜ˆå€¼æ£€æŸ¥ï¼ˆâ‰¥ 70%ï¼‰ â†’ 6) åˆ¶å“ä¸éƒ¨ç½²ã€‚
- åˆ†æ”¯ä¿æŠ¤ï¼šä¸»å¹²ç¦æ­¢ç›´æ¥æäº¤ï¼›PR å¿…é¡»é€šè¿‡æ‰€æœ‰é—¨ç¦å¹¶ç» Code Reviewã€‚
- æ„ä»¶ä¸è¿½è¸ªï¼šç”Ÿæˆ JUnit XMLã€Coverage XMLã€æµ‹è¯•è¶‹åŠ¿å›¾ï¼Œå½’æ¡£åˆ° CI å¹³å°ã€‚

### 10.1 pytesté…ç½®æ–‡ä»¶ (pytest.ini)

```ini
[tool:pytest]
# æµ‹è¯•å‘ç°
testpaths = tests
python_files = test_*.py *_test.py
python_classes = Test* *Tests
python_functions = test_*

# å¹¶è¡Œæ‰§è¡Œ
addopts =
    --strict-markers
    --strict-config
    --verbose
    --tb=short
    --cov=src
    --cov-report=term-missing
    --cov-report=xml:coverage.xml
    --cov-report=html:htmlcov
    --cov-fail-under=70
    --durations=10

# æ ‡è®°å®šä¹‰
markers =
    slow: æ ‡è®°ä¸ºæ…¢æµ‹è¯•ï¼Œé»˜è®¤è·³è¿‡
    integration: é›†æˆæµ‹è¯•ï¼Œéœ€è¦æ•°æ®åº“è¿æ¥
    e2e: ç«¯åˆ°ç«¯æµ‹è¯•ï¼Œéœ€è¦å®Œæ•´ç¯å¢ƒ
    performance: æ€§èƒ½æµ‹è¯•ï¼Œéœ€è¦ç‰¹æ®Šç¯å¢ƒ
    unit: å•å…ƒæµ‹è¯•ï¼ˆé»˜è®¤ï¼‰
    smoke: å†’çƒŸæµ‹è¯•ï¼Œå¿«é€ŸéªŒè¯æ ¸å¿ƒåŠŸèƒ½

# è¿‡æ»¤å™¨
filterwarnings =
    ignore::UserWarning
    ignore::DeprecationWarning:pkg_resources.*
```

### 10.2 æµ‹è¯•å¤¹å…·é…ç½® (conftest.py)

```python
"""
æµ‹è¯•é€šç”¨é…ç½®ä¸å¤¹å…·
æä¾›æ•°æ®åº“è¿æ¥ã€æµ‹è¯•æ•°æ®ã€Mockå¯¹è±¡ç­‰é€šç”¨æµ‹è¯•èµ„æº
"""
import pytest
import numpy as np
import pandas as pd
from typing import Dict, Any, List
import tempfile
import os
from decimal import Decimal
from datetime import datetime, timedelta


@pytest.fixture(scope="session")
def test_config() -> Dict[str, Any]:
    """æµ‹è¯•ç¯å¢ƒé…ç½®"""
    return {
        "database_url": "sqlite:///:memory:",
        "redis_url": "redis://localhost:6379/15",  # æµ‹è¯•ä¸“ç”¨æ•°æ®åº“
        "log_level": "DEBUG",
        "test_data_path": "tests/data",
        "timeout_seconds": 30
    }


@pytest.fixture
def sample_pump_data() -> pd.DataFrame:
    """
    æ°´æ³µç‰¹æ€§æ›²çº¿æ ·æœ¬æ•°æ®
    åŒ…å«æµé‡ã€æ‰¬ç¨‹ã€åŠŸç‡ã€æ•ˆç‡ç­‰å…³é”®å‚æ•°
    """
    np.random.seed(42)  # å›ºå®šéšæœºç§å­ç¡®ä¿å¯é‡ç°

    flow_rates = np.linspace(10, 100, 20)  # æµé‡èŒƒå›´ 10-100 mÂ³/h

    # æ¨¡æ‹ŸçœŸå®æ°´æ³µç‰¹æ€§æ›²çº¿
    heads = 120 - 0.8 * flow_rates - 0.01 * flow_rates**2  # æ‰¬ç¨‹æ›²çº¿
    powers = 15 + 0.5 * flow_rates + 0.008 * flow_rates**2  # åŠŸç‡æ›²çº¿
    efficiencies = np.where(
        flow_rates <= 60,
        0.2 + 0.012 * flow_rates - 0.0001 * flow_rates**2,  # ä¸Šå‡æ®µ
        0.85 - 0.005 * (flow_rates - 60)  # ä¸‹é™æ®µ
    )

    # æ·»åŠ é€‚é‡å™ªå£°
    heads += np.random.normal(0, 1, len(heads))
    powers += np.random.normal(0, 0.5, len(powers))
    efficiencies += np.random.normal(0, 0.02, len(efficiencies))

    # ç¡®ä¿æ•ˆç‡åœ¨åˆç†èŒƒå›´å†…
    efficiencies = np.clip(efficiencies, 0.1, 0.95)

    return pd.DataFrame({
        'flow_rate': flow_rates,
        'head': heads,
        'power': powers,
        'efficiency': efficiencies,
        'timestamp': [datetime.now() - timedelta(minutes=i) for i in range(len(flow_rates))]
    })


@pytest.fixture
def temp_csv_file(sample_pump_data: pd.DataFrame) -> str:
    """åˆ›å»ºä¸´æ—¶CSVæ–‡ä»¶ä¾›æµ‹è¯•ä½¿ç”¨"""
    with tempfile.NamedTemporaryFile(mode='w', suffix='.csv', delete=False, encoding='utf-8') as f:
        sample_pump_data.to_csv(f.name, index=False)
        yield f.name

    # æ¸…ç†
    if os.path.exists(f.name):
        os.unlink(f.name)


@pytest.fixture
def curve_fitting_tolerance() -> Dict[str, float]:
    """æ›²çº¿æ‹Ÿåˆç²¾åº¦å®¹å¿åº¦é…ç½®"""
    return {
        "r_squared_min": 0.85,  # RÂ²æœ€å°å€¼
        "rmse_max": 5.0,        # RMSEæœ€å¤§å€¼
        "mape_max": 0.15,       # MAPEæœ€å¤§å€¼ (15%)
        "prediction_tolerance": 0.1  # é¢„æµ‹å®¹å¿åº¦ (10%)
    }


@pytest.fixture
def optimization_bounds() -> Dict[str, tuple]:
    """ä¼˜åŒ–ç®—æ³•è¾¹ç•Œæ¡ä»¶"""
    return {
        "frequency": (30.0, 50.0),  # é¢‘ç‡èŒƒå›´ Hz
        "flow_rate": (10.0, 100.0), # æµé‡èŒƒå›´ mÂ³/h
        "pressure": (0.1, 1.0),     # å‹åŠ›èŒƒå›´ MPa
        "efficiency": (0.3, 0.95)   # æ•ˆç‡èŒƒå›´
    }
```

### 10.3 æ›²çº¿æ‹Ÿåˆæµ‹è¯•ç¤ºä¾‹

```python
"""
æ›²çº¿æ‹Ÿåˆæ¨¡å—å•å…ƒæµ‹è¯•
æµ‹è¯•å¤šé¡¹å¼ã€å¹‚å‡½æ•°ã€æŒ‡æ•°ã€SVRã€ç¥ç»ç½‘ç»œç­‰æ‹Ÿåˆæ–¹æ³•
"""
import logging
import pytest
import numpy as np
from unittest.mock import Mock, patch
import pandas as pd
from typing import Dict, Any

# é…ç½®æ—¥å¿—
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# å‡è®¾è¿™äº›æ˜¯æˆ‘ä»¬è¦æµ‹è¯•çš„ç±»ï¼ˆä»æŠ€æœ¯è§„èŒƒæ–‡æ¡£ä¸­å¼•ç”¨ï¼‰
from src.fitting.polynomial import PolynomialFitter
from src.fitting.power import PowerFitter
from src.fitting.exponential import ExponentialFitter
from src.fitting.svr import SVRFitter


class TestPolynomialFitter:
    """å¤šé¡¹å¼æ‹Ÿåˆå™¨æµ‹è¯•ç±»"""

    def test_init_default_degree(self):
        """æµ‹è¯•é»˜è®¤åˆå§‹åŒ–"""
        fitter = PolynomialFitter()
        assert fitter.degree == 2
        assert fitter.coefficients is None
        assert fitter.r_squared == 0.0

    def test_init_custom_degree(self):
        """æµ‹è¯•è‡ªå®šä¹‰é˜¶æ•°åˆå§‹åŒ–"""
        fitter = PolynomialFitter(degree=3)
        assert fitter.degree == 3

    def test_init_invalid_degree_raises_error(self):
        """æµ‹è¯•æ— æ•ˆé˜¶æ•°æŠ›å‡ºå¼‚å¸¸"""
        with pytest.raises(ValueError, match="å¤šé¡¹å¼é˜¶æ•°å¿…é¡»ä¸ºæ­£æ•´æ•°"):
            PolynomialFitter(degree=0)

        with pytest.raises(ValueError, match="å¤šé¡¹å¼é˜¶æ•°å¿…é¡»ä¸ºæ­£æ•´æ•°"):
            PolynomialFitter(degree=-1)

    def test_fit_normal_case(self, sample_pump_data: pd.DataFrame, curve_fitting_tolerance: Dict[str, float]):
        """æµ‹è¯•æ­£å¸¸æ‹Ÿåˆæƒ…å†µ"""
        fitter = PolynomialFitter(degree=2)

        x = sample_pump_data['flow_rate'].values
        y = sample_pump_data['head'].values

        coefficients = fitter.fit(x, y)

        # éªŒè¯è¿”å›å€¼
        assert coefficients is not None
        assert len(coefficients) == 3  # äºŒæ¬¡å¤šé¡¹å¼æœ‰3ä¸ªç³»æ•°
        assert isinstance(coefficients, dict)
        assert 'coefficients' in coefficients

        # éªŒè¯æ‹Ÿåˆè´¨é‡
        assert fitter.r_squared >= curve_fitting_tolerance['r_squared_min']
        assert fitter.coefficients is not None

    def test_fit_mismatched_length_raises_error(self):
        """æµ‹è¯•è¾“å…¥æ•°æ®é•¿åº¦ä¸åŒ¹é…"""
        fitter = PolynomialFitter()
        x = np.array([1, 2, 3])
        y = np.array([4, 5])  # é•¿åº¦ä¸åŒ¹é…

        with pytest.raises(ValueError, match="xå’Œyæ•°æ®é•¿åº¦å¿…é¡»ç›¸ç­‰"):
            fitter.fit(x, y)

    def test_fit_insufficient_data_raises_error(self):
        """æµ‹è¯•æ•°æ®ç‚¹ä¸è¶³"""
        fitter = PolynomialFitter(degree=3)
        x = np.array([1, 2])  # åªæœ‰2ä¸ªç‚¹ï¼Œä¸è¶³ä»¥æ‹Ÿåˆ3æ¬¡å¤šé¡¹å¼
        y = np.array([4, 5])

        with pytest.raises(ValueError, match="æ•°æ®ç‚¹æ•°é‡ä¸è¶³ä»¥æ‹Ÿåˆ"):
            fitter.fit(x, y)

    def test_predict_before_fit_raises_error(self):
        """æµ‹è¯•æœªæ‹Ÿåˆå°±é¢„æµ‹æŠ›å‡ºå¼‚å¸¸"""
        fitter = PolynomialFitter()

        with pytest.raises(RuntimeError, match="æ¨¡å‹å°šæœªè®­ç»ƒ"):
            fitter.predict(np.array([1, 2, 3]))

    def test_predict_after_fit(self, sample_pump_data: pd.DataFrame):
        """æµ‹è¯•æ‹Ÿåˆåçš„é¢„æµ‹åŠŸèƒ½"""
        fitter = PolynomialFitter(degree=2)

        x_train = sample_pump_data['flow_rate'].values
        y_train = sample_pump_data['head'].values

        fitter.fit(x_train, y_train)

        # é¢„æµ‹æ–°ç‚¹
        x_test = np.array([25.0, 50.0, 75.0])
        y_pred = fitter.predict(x_test)

        assert len(y_pred) == len(x_test)
        assert all(np.isfinite(y_pred))  # ç¡®ä¿é¢„æµ‹å€¼æœ‰æ•ˆ

        # é¢„æµ‹å€¼åº”è¯¥åœ¨åˆç†èŒƒå›´å†…ï¼ˆåŸºäºæ°´æ³µç‰¹æ€§ï¼‰
        assert all(50 <= y <= 120 for y in y_pred)

    @pytest.mark.parametrize("degree,expected_coeffs", [
        (1, 2),  # çº¿æ€§ï¼š2ä¸ªç³»æ•°
        (2, 3),  # äºŒæ¬¡ï¼š3ä¸ªç³»æ•°
        (3, 4),  # ä¸‰æ¬¡ï¼š4ä¸ªç³»æ•°
    ])
    def test_different_degrees(self, degree: int, expected_coeffs: int, sample_pump_data: pd.DataFrame):
        """æµ‹è¯•ä¸åŒé˜¶æ•°çš„å¤šé¡¹å¼æ‹Ÿåˆ"""
        fitter = PolynomialFitter(degree=degree)

        x = sample_pump_data['flow_rate'].values
        y = sample_pump_data['head'].values

        result = fitter.fit(x, y)

        assert len(result['coefficients']) == expected_coeffs
        assert fitter.r_squared > 0.0  # åº”è¯¥æœ‰ä¸€å®šæ‹Ÿåˆæ•ˆæœ


class TestPowerFitter:
    """å¹‚å‡½æ•°æ‹Ÿåˆå™¨æµ‹è¯•ç±»"""

    def test_fit_positive_values(self):
        """æµ‹è¯•æ­£å€¼æ•°æ®æ‹Ÿåˆ"""
        fitter = PowerFitter()

        # æ„é€ å¹‚å‡½æ•°æ•°æ® y = 2 * x^0.5
        x = np.array([1, 4, 9, 16, 25, 36])
        y = 2 * np.sqrt(x)

        params = fitter.fit(x, y)

        assert 'a' in params
        assert 'b' in params

        # éªŒè¯æ‹Ÿåˆå‚æ•°æ¥è¿‘çœŸå®å€¼
        assert abs(params['a'] - 2.0) < 0.1
        assert abs(params['b'] - 0.5) < 0.1
        assert fitter.r_squared > 0.95

    def test_fit_with_zero_or_negative_x_raises_error(self):
        """æµ‹è¯•åŒ…å«é›¶æˆ–è´Ÿå€¼çš„xæŠ›å‡ºå¼‚å¸¸"""
        fitter = PowerFitter()

        x = np.array([-1, 0, 1, 2])
        y = np.array([1, 2, 3, 4])

        with pytest.raises(ValueError, match="å¹‚å‡½æ•°æ‹Ÿåˆè¦æ±‚xä¸ºæ­£å€¼"):
            fitter.fit(x, y)

    def test_fit_with_zero_or_negative_y_raises_error(self):
        """æµ‹è¯•åŒ…å«é›¶æˆ–è´Ÿå€¼çš„yæŠ›å‡ºå¼‚å¸¸"""
        fitter = PowerFitter()

        x = np.array([1, 2, 3, 4])
        y = np.array([1, -1, 3, 4])

        with pytest.raises(ValueError, match="å¹‚å‡½æ•°æ‹Ÿåˆè¦æ±‚yä¸ºæ­£å€¼"):
            fitter.fit(x, y)


@pytest.mark.integration
class TestFittingIntegration:
    """æ‹Ÿåˆå™¨é›†æˆæµ‹è¯•"""

    def test_multiple_fitters_comparison(self, sample_pump_data: pd.DataFrame):
        """æµ‹è¯•å¤šç§æ‹Ÿåˆå™¨åœ¨åŒä¸€æ•°æ®é›†ä¸Šçš„è¡¨ç°å¯¹æ¯”"""
        x = sample_pump_data['flow_rate'].values
        y = sample_pump_data['head'].values

        # åˆå§‹åŒ–æ‰€æœ‰æ‹Ÿåˆå™¨
        fitters = {
            'polynomial': PolynomialFitter(degree=2),
            'power': PowerFitter(),
            'exponential': ExponentialFitter()
        }

        results = {}

        for name, fitter in fitters.items():
            try:
                if name == 'power':
                    # ç¡®ä¿æ•°æ®ä¸ºæ­£å€¼
                    x_pos = x[x > 0]
                    y_pos = y[:len(x_pos)]
                    y_pos = y_pos[y_pos > 0]
                    x_pos = x_pos[:len(y_pos)]

                    if len(x_pos) < 3:
                        continue

                    fitter.fit(x_pos, y_pos)
                else:
                    fitter.fit(x, y)

                results[name] = {
                    'r_squared': fitter.r_squared,
                    'fitter': fitter
                }
            except Exception as e:
                logger.error(f"{name} æ‹Ÿåˆå¤±è´¥: {e}")
                continue

        # éªŒè¯è‡³å°‘æœ‰ä¸€ç§æ–¹æ³•æˆåŠŸ
        assert len(results) > 0

        # éªŒè¯å¤šé¡¹å¼æ‹Ÿåˆé€šå¸¸è¡¨ç°è¾ƒå¥½
        if 'polynomial' in results:
            assert results['polynomial']['r_squared'] > 0.7


@pytest.mark.slow
class TestSVRFitter:
    """æ”¯æŒå‘é‡å›å½’æ‹Ÿåˆå™¨æµ‹è¯•ç±»"""

    def test_svr_initialization(self):
        """æµ‹è¯•SVRåˆå§‹åŒ–"""
        fitter = SVRFitter()
        assert fitter.C == 1.0
        assert fitter.epsilon == 0.1
        assert fitter.kernel == 'rbf'
        assert fitter.model is None
        assert fitter.r_squared == 0.0

    def test_svr_custom_parameters(self):
        """æµ‹è¯•è‡ªå®šä¹‰SVRå‚æ•°"""
        fitter = SVRFitter(C=10.0, epsilon=0.01, kernel='linear')
        assert fitter.C == 10.0
        assert fitter.epsilon == 0.01
        assert fitter.kernel == 'linear'

    def test_svr_fit_and_predict(self, sample_pump_data: pd.DataFrame):
        """æµ‹è¯•SVRæ‹Ÿåˆå’Œé¢„æµ‹"""
        fitter = SVRFitter(C=1.0, epsilon=0.1)

        x = sample_pump_data['flow_rate'].values
        y = sample_pump_data['head'].values

        # æ‹Ÿåˆæ¨¡å‹
        result = fitter.fit(x, y)

        assert result is not None
        assert 'r_squared' in result
        assert fitter.model is not None
        assert fitter.r_squared > 0.0

        # é¢„æµ‹æµ‹è¯•
        x_test = np.array([25.0, 50.0, 75.0])
        y_pred = fitter.predict(x_test)

        assert len(y_pred) == len(x_test)
        assert all(np.isfinite(y_pred))

    def test_svr_insufficient_data_raises_error(self):
        """æµ‹è¯•SVRæ•°æ®ä¸è¶³æƒ…å†µ"""
        fitter = SVRFitter()
        x = np.array([1])
        y = np.array([2])

        with pytest.raises(ValueError, match="SVRæ‹Ÿåˆè‡³å°‘éœ€è¦2ä¸ªæ•°æ®ç‚¹"):
            fitter.fit(x, y)

    @pytest.mark.parametrize("kernel", ['linear', 'poly', 'rbf', 'sigmoid'])
    def test_svr_different_kernels(self, kernel: str):
        """æµ‹è¯•ä¸åŒæ ¸å‡½æ•°çš„SVR"""
        # æ„é€ éçº¿æ€§æ•°æ®
        np.random.seed(42)
        x = np.linspace(0, 10, 20)
        y = np.sin(x) + 0.1 * np.random.randn(len(x))

        fitter = SVRFitter(kernel=kernel)
        result = fitter.fit(x, y)

        assert result is not None
        assert fitter.r_squared > 0.0


class TestExponentialFitter:
    """æŒ‡æ•°å‡½æ•°æ‹Ÿåˆå™¨æµ‹è¯•ç±»"""

    def test_exponential_initialization(self):
        """æµ‹è¯•æŒ‡æ•°æ‹Ÿåˆå™¨åˆå§‹åŒ–"""
        fitter = ExponentialFitter()
        assert fitter.a is None
        assert fitter.b is None
        assert fitter.r_squared == 0.0

    def test_exponential_fit_positive_trend(self):
        """æµ‹è¯•æ­£æŒ‡æ•°è¶‹åŠ¿æ‹Ÿåˆ"""
        # æ„é€ æŒ‡æ•°æ•°æ® y = 2 * exp(0.1 * x)
        x = np.array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9])
        y = 2 * np.exp(0.1 * x)

        fitter = ExponentialFitter()
        result = fitter.fit(x, y)

        assert 'a' in result
        assert 'b' in result
        assert abs(result['a'] - 2.0) < 0.5  # å®¹å¿ä¸€å®šè¯¯å·®
        assert abs(result['b'] - 0.1) < 0.05
        assert fitter.r_squared > 0.95

    def test_exponential_fit_negative_trend(self):
        """æµ‹è¯•è´ŸæŒ‡æ•°è¶‹åŠ¿æ‹Ÿåˆï¼ˆè¡°å‡ï¼‰"""
        # æ„é€ è¡°å‡æ•°æ® y = 10 * exp(-0.2 * x)
        x = np.array([0, 1, 2, 3, 4, 5])
        y = 10 * np.exp(-0.2 * x)

        fitter = ExponentialFitter()
        result = fitter.fit(x, y)

        assert result['a'] > 0  # å¹…åº¦å‚æ•°åº”ä¸ºæ­£
        assert result['b'] < 0  # æŒ‡æ•°å‚æ•°ä¸ºè´Ÿï¼ˆè¡°å‡ï¼‰
        assert fitter.r_squared > 0.95

    def test_exponential_with_zero_or_negative_y_raises_error(self):
        """æµ‹è¯•åŒ…å«é›¶æˆ–è´Ÿå€¼çš„yæŠ›å‡ºå¼‚å¸¸"""
        fitter = ExponentialFitter()

        x = np.array([1, 2, 3, 4])
        y = np.array([1, -1, 3, 4])  # åŒ…å«è´Ÿå€¼

        with pytest.raises(ValueError, match="æŒ‡æ•°å‡½æ•°æ‹Ÿåˆè¦æ±‚yä¸ºæ­£å€¼"):
            fitter.fit(x, y)

    def test_exponential_predict_after_fit(self):
        """æµ‹è¯•æŒ‡æ•°æ‹Ÿåˆåçš„é¢„æµ‹"""
        x = np.array([0, 1, 2, 3, 4])
        y = np.array([1, 2.7, 7.4, 20.1, 54.6])  # è¿‘ä¼¼ exp(x)

        fitter = ExponentialFitter()
        fitter.fit(x, y)

        # é¢„æµ‹æ–°ç‚¹
        x_test = np.array([5, 6])
        y_pred = fitter.predict(x_test)

        assert len(y_pred) == len(x_test)
        assert all(y > 0 for y in y_pred)  # æŒ‡æ•°å‡½æ•°è¾“å‡ºåº”ä¸ºæ­£


class TestNeuralNetworkFitter:
    """ç¥ç»ç½‘ç»œæ‹Ÿåˆå™¨æµ‹è¯•ç±»"""

    @pytest.fixture
    def nn_config(self):
        """ç¥ç»ç½‘ç»œé…ç½®å¤¹å…·"""
        return {
            'hidden_layers': [32, 16],
            'epochs': 50,  # æµ‹è¯•æ—¶ä½¿ç”¨è¾ƒå°‘è½®æ¬¡
            'learning_rate': 0.001,
            'device': 'cpu'  # æµ‹è¯•ç¯å¢ƒä½¿ç”¨CPU
        }

    def test_nn_initialization(self, nn_config):
        """æµ‹è¯•ç¥ç»ç½‘ç»œåˆå§‹åŒ–"""
        fitter = NeuralNetworkFitter(**nn_config)
        assert fitter.hidden_layers == [32, 16]
        assert fitter.epochs == 50
        assert fitter.learning_rate == 0.001
        assert fitter.model is None
        assert fitter.r_squared == 0.0

    @pytest.mark.slow
    @pytest.mark.ml
    def test_nn_fit_nonlinear_data(self, nn_config):
        """æµ‹è¯•ç¥ç»ç½‘ç»œæ‹Ÿåˆéçº¿æ€§æ•°æ®"""
        # æ„é€ å¤æ‚éçº¿æ€§æ•°æ®
        np.random.seed(42)
        x = np.linspace(-2, 2, 100)
        y = x**3 - 2*x**2 + x + 1 + 0.1 * np.random.randn(len(x))

        fitter = NeuralNetworkFitter(**nn_config)
        result = fitter.fit(x, y)

        assert result is not None
        assert 'r_squared' in result
        assert 'loss_history' in result
        assert fitter.model is not None
        assert fitter.r_squared > 0.7  # ç¥ç»ç½‘ç»œåº”èƒ½è¾ƒå¥½æ‹Ÿåˆéçº¿æ€§æ•°æ®

    @pytest.mark.ml
    def test_nn_predict_after_fit(self, nn_config):
        """æµ‹è¯•ç¥ç»ç½‘ç»œæ‹Ÿåˆåé¢„æµ‹"""
        # ç®€å•æ•°æ®ï¼Œå¿«é€Ÿæµ‹è¯•
        x = np.array([1, 2, 3, 4, 5], dtype=np.float32)
        y = np.array([2, 4, 6, 8, 10], dtype=np.float32)  # çº¿æ€§å…³ç³»

        fitter = NeuralNetworkFitter(
            hidden_layers=[8],
            epochs=20,
            learning_rate=0.01,
            device='cpu'
        )
        fitter.fit(x, y)

        # é¢„æµ‹
        x_test = np.array([6, 7], dtype=np.float32)
        y_pred = fitter.predict(x_test)

        assert len(y_pred) == len(x_test)
        assert all(np.isfinite(y_pred))
        # å¯¹äºçº¿æ€§æ•°æ®ï¼Œé¢„æµ‹å€¼åº”æ¥è¿‘çœŸå®å€¼
        expected = np.array([12, 14])
        assert np.allclose(y_pred, expected, atol=2.0)  # å…è®¸ä¸€å®šè¯¯å·®

    def test_nn_insufficient_data_raises_error(self, nn_config):
        """æµ‹è¯•ç¥ç»ç½‘ç»œæ•°æ®ä¸è¶³æƒ…å†µ"""
        fitter = NeuralNetworkFitter(**nn_config)
        x = np.array([1])
        y = np.array([2])

        with pytest.raises(ValueError, match="ç¥ç»ç½‘ç»œæ‹Ÿåˆè‡³å°‘éœ€è¦5ä¸ªæ•°æ®ç‚¹"):
            fitter.fit(x, y)


@pytest.mark.integration
class TestDataProcessingIntegration:
    """æ•°æ®å¤„ç†æ¨¡å—é›†æˆæµ‹è¯•"""

    def test_csv_reading_with_encoding(self, temp_csv_file: str):
        """æµ‹è¯•CSVè¯»å–ä¸ç¼–ç å¤„ç†"""
        # æµ‹è¯•pandasè¯»å–CSVçš„é…ç½®
        df = pd.read_csv(
            temp_csv_file,
            encoding='utf-8',
            dtype={
                'flow_rate': np.float64,
                'head': np.float64,
                'power': np.float64,
                'efficiency': np.float64
            },
            parse_dates=['timestamp']
        )

        assert not df.empty
        assert 'flow_rate' in df.columns
        assert 'head' in df.columns
        assert df['timestamp'].dtype.name.startswith('datetime')

        # éªŒè¯æ•°æ®èŒƒå›´åˆç†æ€§
        assert df['flow_rate'].min() >= 0
        assert df['efficiency'].max() <= 1.0

    def test_data_validation_pipeline(self, sample_pump_data: pd.DataFrame):
        """æµ‹è¯•æ•°æ®éªŒè¯ç®¡é“"""
        # æ¨¡æ‹Ÿæ•°æ®éªŒè¯å‡½æ•°
        def validate_pump_data(df: pd.DataFrame) -> Dict[str, Any]:
            """æ°´æ³µæ•°æ®éªŒè¯å‡½æ•°"""
            validation_results = {
                'missing_values': df.isnull().sum().to_dict(),
                'range_violations': {},
                'outliers': {},
                'is_valid': True
            }

            # æ£€æŸ¥èŒƒå›´è¿è§„
            if (df['flow_rate'] < 0).any():
                validation_results['range_violations']['flow_rate'] = 'å­˜åœ¨è´Ÿæµé‡'
                validation_results['is_valid'] = False

            if (df['efficiency'] > 1.0).any():
                validation_results['range_violations']['efficiency'] = 'æ•ˆç‡è¶…è¿‡100%'
                validation_results['is_valid'] = False

            # æ£€æŸ¥å¼‚å¸¸å€¼ï¼ˆä½¿ç”¨3-sigmaå‡†åˆ™ï¼‰
            for col in ['flow_rate', 'head', 'power']:
                mean_val = df[col].mean()
                std_val = df[col].std()
                outliers = df[(df[col] < mean_val - 3*std_val) | (df[col] > mean_val + 3*std_val)]
                if not outliers.empty:
                    validation_results['outliers'][col] = len(outliers)

            return validation_results

        # æ‰§è¡ŒéªŒè¯
        results = validate_pump_data(sample_pump_data)

        assert 'missing_values' in results
        assert 'range_violations' in results
        assert 'outliers' in results
        assert 'is_valid' in results

        # æ ·æœ¬æ•°æ®åº”è¯¥é€šè¿‡åŸºæœ¬éªŒè¯
        assert results['is_valid'] is True

    def test_interpolation_accuracy(self):
        """æµ‹è¯•æ’å€¼ç®—æ³•ç²¾åº¦"""
        # æ„é€ å·²çŸ¥å‡½æ•°æ•°æ®
        x_known = np.array([0, 1, 2, 3, 4, 5])
        y_known = x_known ** 2  # äºŒæ¬¡å‡½æ•°

        # æ’å€¼ç‚¹
        x_interp = np.array([0.5, 1.5, 2.5, 3.5, 4.5])
        y_true = x_interp ** 2  # çœŸå®å€¼

        # ä½¿ç”¨æ ·æ¡æ’å€¼
        from scipy.interpolate import interp1d
        interpolator = interp1d(x_known, y_known, kind='cubic')
        y_interp = interpolator(x_interp)

        # éªŒè¯æ’å€¼ç²¾åº¦
        max_error = np.max(np.abs(y_interp - y_true))
        assert max_error < 0.1  # æ’å€¼è¯¯å·®åº”å°äº0.1


@pytest.mark.slow
class TestPerformanceFitting:
    """æ‹Ÿåˆå™¨æ€§èƒ½æµ‹è¯•"""

    def test_large_dataset_performance(self):
        """æµ‹è¯•å¤§æ•°æ®é›†æ‹Ÿåˆæ€§èƒ½"""
        # ç”Ÿæˆå¤§é‡æ•°æ®
        np.random.seed(42)
        x = np.linspace(1, 1000, 10000)
        y = 100 - 0.5 * x + 0.001 * x**2 + np.random.normal(0, 5, len(x))

        fitter = PolynomialFitter(degree=2)

        import time
        start_time = time.time()
        fitter.fit(x, y)
        execution_time = time.time() - start_time

        # æ€§èƒ½è¦æ±‚ï¼š10Kæ•°æ®ç‚¹æ‹Ÿåˆåº”åœ¨1ç§’å†…å®Œæˆ
        assert execution_time < 1.0
        assert fitter.r_squared > 0.8

    @pytest.mark.parametrize("dataset_size", [1000, 5000, 10000])
    def test_scalability_by_dataset_size(self, dataset_size: int):
        """æµ‹è¯•ä¸åŒæ•°æ®é›†å¤§å°çš„å¯æ‰©å±•æ€§"""
        np.random.seed(42)
        x = np.linspace(1, 100, dataset_size)
        y = 50 - 0.3 * x + 0.001 * x**2 + np.random.normal(0, 2, len(x))

        fitter = PolynomialFitter(degree=2)

        import time
        start_time = time.time()
        fitter.fit(x, y)
        execution_time = time.time() - start_time

        # æ€§èƒ½è¦æ±‚ï¼šæ‰§è¡Œæ—¶é—´åº”ä¸æ•°æ®é‡å‘ˆçº¿æ€§å…³ç³»
        time_per_point = execution_time / dataset_size
        assert time_per_point < 0.0001  # æ¯ä¸ªæ•°æ®ç‚¹å¤„ç†æ—¶é—´åº”å°äº0.1ms

    @pytest.mark.ml
    def test_memory_usage_large_datasets(self):
        """æµ‹è¯•å¤§æ•°æ®é›†å†…å­˜ä½¿ç”¨"""
        import psutil
        import os

        # è·å–åˆå§‹å†…å­˜ä½¿ç”¨
        process = psutil.Process(os.getpid())
        initial_memory = process.memory_info().rss / 1024 / 1024  # MB

        # ç”Ÿæˆå¤§æ•°æ®é›†
        np.random.seed(42)
        x = np.linspace(1, 1000, 50000)  # 5ä¸‡ä¸ªæ•°æ®ç‚¹
        y = 100 - 0.5 * x + 0.001 * x**2 + np.random.normal(0, 5, len(x))

        fitter = PolynomialFitter(degree=3)
        fitter.fit(x, y)

        # è·å–æ‹Ÿåˆåå†…å­˜ä½¿ç”¨
        final_memory = process.memory_info().rss / 1024 / 1024  # MB
        memory_increase = final_memory - initial_memory

        # å†…å­˜å¢é•¿åº”åœ¨åˆç†èŒƒå›´å†…ï¼ˆå°äº100MBï¼‰
        assert memory_increase < 100
```

## 11. æŠ¥å‘Šä¸ç¼ºé™·ç®¡ç†

- æŠ¥å‘Šï¼šæ¯æ¬¡æµæ°´çº¿ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šä¸è¶‹åŠ¿ï¼›å…³é”®æŒ‡æ ‡ï¼ˆå¤±è´¥ç‡ã€é‡è¯•æ¬¡æ•°ã€å¹³å‡/æœ€å¤§è€—æ—¶ï¼‰ã€‚
- ç¼ºé™·ï¼šæŒ‰ä¸¥é‡åº¦åˆ†çº§ï¼ˆé˜»æ–­/é«˜/ä¸­/ä½ï¼‰ï¼›ä¿®å¤éœ€é™„å¯¹åº”è‡ªåŠ¨åŒ–å›å½’ç”¨ä¾‹ã€‚

## 12. æµ‹è¯•æ•°æ®ä¸åŸºçº¿

- æ•°æ®é›†ï¼šæä¾›åˆæˆæ ·æœ¬ï¼›ä¿è¯å¯å…¬å¼€å…±äº«ä¸ç¨³å®šå¤ç°ã€‚
- éšæœºæ€§ï¼šç»Ÿä¸€éšæœºç§å­ï¼›åŸºå‡†å‡½æ•°ä¸è¶…å‚æ•°çš„åŸºçº¿é…ç½®ä¿å­˜åœ¨ç‰ˆæœ¬åº“ã€‚
- ç›®å½•å»ºè®®ï¼štests/unitã€tests/integrationã€tests/e2eã€tests/perfï¼›æ…¢æµ‹è¯•åŠ æ ‡è®°ï¼Œé»˜è®¤è·³è¿‡ã€‚

â€”â€”
æœ¬è§„èŒƒæç‚¼è‡ªåŸ technical_specifications.md ä¸­â€œç²¾åº¦éªŒè¯ä¸è´¨é‡ä¿è¯â€ç­‰ç›¸å…³å†…å®¹ï¼Œå¹¶ç»“åˆå·¥ç¨‹åŒ–è´¨é‡é—¨ç¦è¦æ±‚ç»Ÿä¸€åˆ° CI/CD æµæ°´çº¿ä¸­æ‰§è¡Œã€‚
