______________________________________________________________________

## description: 端到端追责ID贯穿（从 CLI→日志→任务→DB 操作→报表 的 trace_id 统一规范）

# 端到端追责ID贯穿

## 目标

- 为每次任务/操作分配唯一 `trace_id`，确保从入口到落地的全链路可追溯、可审计、可回放。

## 标识体系

- 必备标识：`trace_id`（全局唯一）、`job_id`（一次导入/对齐作业）、`batch_id`（批次）、`station_id/device_id`（上下文）。
- 生成规则：默认 `uuid4`，或 `prefix-<timestamp>-<random>`；允许通过 CLI `--trace-id` 外部传入。

## CLI 入口

- 参数：`--trace-id` 可选；未提供则自动生成并回显。
- 输出：所有控制台输出首条打印 `trace_id`；结束时在 JSON 摘要中包含 `trace_id/job_id`。

## 日志与事件（对齐 10-logging-spec）

- 每条日志必须包含：`trace_id`、`job_id`（阶段内复用）、`batch_id`（按批生成）。
- 关键事件（ingest/align/checkpoint/summary）统一携带标识字段，便于检索与聚合。

## 任务与并发

- `trace_id` 在同一顶层任务内保持不变；子任务共享 `trace_id`，各自派生 `job_id/batch_id`。
- 并发执行时，通过任务上下文/线程局部存储传递 `trace_id`。

## DB 侧关联（不改表 Schema）

- 不向表新增列；通过日志与操作摘要关联 DB 行变更。
- 合并写入前后，记录带 `trace_id` 的事件，包含：`device_id/standard_time/rows/affected/sql_cost_ms`。
- 可选：在会话注释（如 `/* trace_id=... */`）中附加，用于审计（谨慎使用，避免污染计划缓存）。

## 报表与对账

- 日/周/月报表的汇总项包含 `trace_id` 示例链接（便于回溯）；
- 对账与稽核（见 50）可按 `trace_id` 过滤与关联到运行日志。

## 工具与实现

- 上下文管理器：`with TraceContext(trace_id=...)` 自动注入日志与子任务；
- 适配并发：线程/进程/协程安全的上下文传递；
- 失败与重试：同一次重试保留原 `trace_id`，新增 `attempt` 字段（对齐 10/44）。

## 验收

- e2e 验证：给定 `trace_id`，可在日志检索到入口→批次→合并→摘要全链路；
- 产生 `trace_id` 的任务可被 `scripts/verify_*` 通过 ID 回放或复盘。
