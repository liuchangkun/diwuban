______________________________________________________________________

## alwaysApply: true description: 数据插入/时间对齐/性能守护与验收门禁（集中约束与可度量标准）

# 数据插入·时间对齐·性能守护与验收门禁

> 本规则集中定义插入/对齐/性能的强约束与可度量验收项，补位并引用：
> [02-db-import-align.mdc](mdc:.cursor/rules/02-db-import-align.mdc),
> [20-concurrency-resource-spec.mdc](mdc:.cursor/rules/20-concurrency-resource-spec.mdc),
> [23-performance-slo.mdc](mdc:.cursor/rules/23-performance-slo.mdc),
> [30-34 业务规则](mdc:.cursor/rules/30-domain-dictionary.mdc)

## 一、数据插入（强约束）

- 导入方式：仅允许 `LOAD DATA LOCAL INFILE` → 会话级 `TEMPORARY TABLE tmp_raw(TagName, DataTime, DataValue)`；禁止逐行 INSERT。
- 事务与批：`commit_rows` ≤ `batch.max_rows`；单事务耗时超阈值（默认 2s）需自动拆分更小批；超 5s 直接降并发 50%。
- 幂等与合并：以 `(device_id, standard_time)` 为唯一约束；`INSERT ... ON DUPLICATE KEY UPDATE data_json = JSON_MERGE_PATCH(...)`；`null` 不覆盖有效值。
- JSON 精度：按 \[32\] 规则统一舍入（电气/工艺 2 位；比率/频率 3 位）；写入前完成舍入，避免多来源冲突扩大。
- 输入方言：CSV 仅支持 UTF-8、`\r\n`、逗号分隔、首行表头；异常行落 `logs/bad_rows`，不中断主流程。

## 二、时间对齐（强约束）

- 截断到秒：`DataTime = STR_TO_DATE(SUBSTRING_INDEX(@dt, '.', 1), '%Y-%m-%d %H:%i:%s')`；禁止时区转换。
- 去重：同秒保留“最早 `DataTime`”，其余丢弃；去重结果必须计数并入日志事件 `ingest.dedup.summary`。
- 缺秒：不补；多秒：丢弃多余；迟到数据：按合并规则补齐 JSON（禁止跨分区大范围覆盖，见 \[37\]）。
- 多来源冲突：按 \[33\] 来源优先级与阈值策略处置；冲突事件必须记录（含样本值与差异）。

## 三、性能守护（SLO+自适应）

- 目标（默认，可在 `configs/app.yaml` 中调参）：
  - 吞吐：≥ 50,000 行/秒（本地 SSD 基线）
  - P95 批次耗时：≤ 2,000 ms
  - 失败率：≤ 1%
- 背压与降速（见 \[20\]）：
  - 失败率>2% 或 P95>阈值 → 降并发 50%，扩大提交频率（更小批次）。
  - 连续 5 批达标 → 逐步恢复并发与批大小（每次 +25%）。
- 观测与门禁（见 \[10\]/\[24\]）：必须输出 `rows_loaded/rows_deduped/rows_merged/rows_failed`、`batch_cost_ms/merge_cost_ms` 指标；连续 3 批不达标应停止本站点导入并告警。

## 四、验收与失败处理（Fail Fast）

- 启动前校验：映射 Schema/路径存在性/站点设备一致性（见 `scripts/verify_mapping.py`），失败即中止。
- 运行中门禁：当“批次耗时/失败率/锁等待”任一指标连续 N 批超阈（N=3）→ 自动降级；再超阈 → 停止并报警。
- 结束摘要：输出总行数、去重率、合并覆盖/新增比例、失败与重试统计；摘要落 `logs/app.log`，便于审计。

## 五、配置关联

- 关键参数从 `configs/app.yaml` 读取：批次大小、并发、背压阈值、SLO 目标；日志行为见 `configs/logging.yaml`。
- CLI 必须允许覆盖关键参数：`--concurrency --batch-max-rows --commit-rows --since --until --dry-run`。

## 六、与业务规则一致性

- 字段白名单/单位/范围校验严格遵循 \[30\]/\[31\]；超出范围的值按 \[31\] 丢弃或打标，不得入库污染。
- `data_json` 必须符合 \[32\] 设备类型 Schema；新增字段需先更新 `field_units` 与字典后再导入。

## 七、CLI 覆盖示例

- `python -m app.cli import-station --name "二期供水泵房" --concurrency 4 --batch-max-rows 100000 --commit-rows 50000 --since 2025-02-01 --until 2025-02-28`

## 八、异常与门禁联动

- 一旦门禁触发停止本站点导入：记录 `event=guardrail.stop`，附最近窗口指标与建议操作；恢复后记录 `guardrail.resume`。
