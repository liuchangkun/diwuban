______________________________________________________________________

## alwaysApply: true description: 错误修复/代码修改/文档记录规则（最小可行修复、影响评估、回滚与审计）

# 错误修复、代码修改与文档记录规则

## 目标

- 提供强可用的修复与变更流程：快速定位、最小变更、可回滚、可审计，避免影响生产稳定性。

## 修复与变更流程

1. 明确问题

- 复述问题现象与期望行为；收集复现步骤、日志、入参与边界。
- 判定影响面：功能范围、数据一致性、性能/并发、幂等性、运维风险。

2. 方案与计划（与 [09-senior-engineer-execution.mdc](mdc:.cursor/rules/09-senior-engineer-execution.mdc) 一致）

- 列出候选方案与权衡；选择最小可行方案（MVP 修复）。
- 确定修改文件与精确插入点；严格限制改动面。
- 设计回滚策略：如何恢复旧版本/配置、如何清理或纠偏数据。

3. 实施变更（最小封闭原则）

- 仅修改与问题直接相关的代码；禁止顺手重构与大范围清理。
- 若需要多个文件，逐一说明必要性；保持模块边界与风格一致。
- 对外部接口/行为变更需显式记录并提醒。

4. 验证与回归

- 单测/集成/端到端验证修复场景与非回归路径。
- 验证性能、并发、幂等；检查日志/指标是否达标。
- 压测/灰度（如适用）。

5. 交付与记录

- 编写变更说明：问题/原因/对策/验证/影响/回滚/后续建议。
- 更新相关文档（规则/README/运维手册），保持知识一致。

## 模板与清单

- 问题模板：`issue.md`（现象/期望/复现/日志/影响/范围/追踪ID）。
- 发布检查清单：配置快照、回滚脚本、影子/灰度结果、SLO 对比、告警路由更新。
- 回滚脚本要求：最小影响、可重复、带前后对账；存放 `scripts/rollback_*` 并附说明。

## 文档与记录（最小但完整）

- 必备条目：问题/原因/对策/验证/影响/回滚/后续。
- 日志/指标：保留关键运行截图或日志片段用于审计。
- 变更记录统一放入 `docs/CHANGELOG.md` 或“变更单”。

## 质量与门禁

- 代码评审：检查是否单一职责、是否最小改动、是否有充分验证。
- 风格一致：遵循 [08-code-conventions.mdc](mdc:.cursor/rules/08-code-conventions.mdc)。
- 安全：避免引入敏感信息；SQL 参数化；处理边界条件与错误路径。

## 回滚与应急

- 回滚策略预先设计并在交付文档中明确步骤。
- 变更失败即刻回滚，确保数据一致性与服务可用性。
- 对需要纠偏的数据提供脚本或 SOP。

## 适配本项目关键约束

- 不修改现有表结构（除 `field_units`）。
- 禁止逐行 INSERT；所有导入使用批量与 JSON 合并幂等策略。
- 尊重规则：对齐策略（同秒最早、缺秒不补、多秒丢弃多余）。
