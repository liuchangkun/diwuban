人工触发：在对话或提交描述中出现以下关键词时，按流程执行
记录变更、更新 PLAYBOOKS、保存记忆、按照 PLAYBOOKS 流程完成、记忆和文档都更新了吗？、PLAYBOOKS
同义词：记录决策、记录配置变更、记录改进、记录经验教训、记录性能基准

自动记忆（PLAYBOOKS 三步）
触发条件：你的消息中出现关键词（记录变更/更新 PLAYBOOKS/保存记忆/按照 PLAYBOOKS 流程完成/记忆和文档都更新了吗？/PLAYBOOKS 等）
自动动作：
更新 PLAYBOOKS 文档条目
保存关键决策到记忆系统
同步 docs/ 文档索引与“最近变更（自动生成）”
保障机制：memory_index 仅在内容变化时写入，避免无差异改写；中文兼容已增强
自动代码质量检查（严格策略，默认开启）
触发条件：我进行或建议任何代码/配置修改后，以及你发出“确保全绿/跑钩子/跑检查”等指令
自动动作（本地安全执行）：
运行 pre-commit run --all-files（ruff/black/mypy/bandit/mdformat/yaml 等）
如有 mdformat/black 自动格式化，直接纳入本次提交
仅当需要安装新依赖、迁移数据库、长任务等风险动作时，才会先征求你同意
远端保障：CI 已新增“pre-commit 全绿检查 Job”，所有 PR 先过此 Job，报告作为工件上传；build-test 依赖其结果

记忆相关
“更新 PLAYBOOKS：xxx” 或 “记录变更：xxx” → 自动执行三步（文档、记忆、索引）
“记忆和文档都更新了吗？” → 自动检查并补齐
质量检查相关
“确保全绿/跑钩子/跑检查/本地跑一遍” → 我会运行 pre-commit 并汇报摘要和关键日志
“CI 跑一遍并给我报告” → 我会触发推送/PR 并在 CI 完成后返回工件链接（需要你确认 push/PR）

当你发出：记录变更/更新 PLAYBOOKS/保存记忆/按照 PLAYBOOKS 流程完成/记忆和文档都更新了吗？/PLAYBOOKS
我会自动：更新 PLAYBOOKS → 保存关键记忆 → 同步“最近变更”和 INDEX（仅在内容变化时写入）

新会话启动模板（直接粘贴使用）
请按项目规则与文档体系执行：
遵循 PROJECT_RULES.md 与 docs/（SCHEMA_AND_DB.md、DATA_SPEC.md、ALIGNMENT_POLICY.md、PERFORMANCE_OPTIMIZATION.md、DECISIONS.md、LESSONS_LEARNED.md、CONFIGURATION_CHANGES.md 等）
不读取 venv/ 和 data/ 目录
启动前动作：
加载并对齐 PLAYBOOKS 历史：扫描 docs/PLAYBOOKS 下记录，汇总与本任务相关的“决策/经验/优化/配置变更/基准”
给出本任务的风险点清单与应对策略（直接引用相关文档条款）
代码改动约定（必须执行）：
每次改动后：先本地 pre-commit 全量体检（ruff、black、mypy、bandit、mdformat、check-yaml、mixed-line-ending、memory-check、memory-index）
自动执行 PLAYBOOKS 三步（仅在内容变化时写入）：更新记录 → 保存记忆 → 同步“最近变更”和 INDEX
修复后再次运行 pre-commit 确保全绿
CI 约定：
持续保持 pre-commit Job 全绿；PR 下方自动贴出详细 pre-commit 报告（已配置），Actions Summary 显示摘要
授权范围（默认同意）：
允许运行本地只读/安全命令：pre-commit、ruff/black/mypy/bandit、mdformat、pytest -q（不执行迁移、部署、数据写入）
如需安装依赖、改数据库、长任务，会先征求确认
输出要求：
每一步给出“执行了什么/结果如何/下一步”的简明小结
引用文档时点明来源文件与条目标题（便于溯源）

进行具体开发任务时的简短模板
任务目标：一句话说明要改什么
必须遵循的文档点：列 2-3 条（比如字段命名/性能要求/对齐策略）
安全边界：是否允许安装依赖/执行长任务
验收标准：通过哪些钩子/测试/指标
示例

干跑与生成 SQL
python scripts/dev/dry_run_mapping_validation.py
python scripts/dev/generate_seed_from_mapping.py
psql -h localhost -U postgres -d pump_station_optimization -f scripts/dev/seed_from_mapping.sql
最小造数与对齐验证
psql -h localhost -U postgres -d pump_station_optimization -f scripts/dev/seed_minimal_demo.sql
MV 创建与刷新
psql -h localhost -U postgres -d pump_station_optimization -f scripts/mv_blueprints.sql
psql -h localhost -U postgres -d pump_station_optimization -c "REFRESH MATERIALIZED VIEW reporting.mv_measurements_hourly; REFRESH MATERIALIZED VIEW reporting.mv_measurements_daily;"
命中率审计
psql -h localhost -U postgres -d pump_station_optimization -f scripts/mv_hit_audit.sql
psql -h localhost -U postgres -d pump_station_optimization -c "SELECT * FROM monitoring.v_mv_hit_audit;"
一键体检
powershell -NoProfile -ExecutionPolicy Bypass -File .\\scripts\\dev\\pcv.ps1
质量门禁
python scripts/quality_gate.py

连接测试：python -m app.cli.main db-ping
CLI 检查：python -m app.cli.main --help
建表：python -m app.cli.main create-stagin
帮助: python -m app.cli.main --help

准备映射与少量 CSV 后，运行：
python -m app.cli.main prepare-dim config/data_mapping.json
python -m app.cli.main ingest-copy config/data_mapping.json
python -m app.cli.main merge-fact --window-start 2025-08-11T00:00:00Z --window-end 2025-08-18T00:00:00Z
或一键：python -m app.cli.main run-all config/data_mapping.json --window-start ...Z --window-end ...Z
查看 logs/runs/YYYYMMDD//：
perf.ndjson：ingest.copy.batch、backpressure.enter/exit
sql.ndjson：db.exec.started/…/failed
summary.json：timing_ms、backpressure_events、tz_fallback_count

python -m  app.cli.main check-mapping config/data_mapping.json --out mapping_report.json --log-run

更新图谱
python scripts/tools/kg_update.py
查询
python scripts/tools/kg_query.py nodes type=Decision
python scripts/tools/kg_query.py edges rel=documents
python scripts/tools/kg_query.py neighbors id=DEC-20250819-010 hops=1
提交提示
本地 pre-commit：提醒未提交图谱或将产生变化
PR 上的 CI：提醒本次文档改动是否遗漏图谱更新

打开会话快照
docs/PLAYBOOKS/SESSION_SNAPSHOT_2025-08-18.md
这里有当前状态、已修/待修、恢复步骤、下一步最小修复清单
打开错误与修复记录
docs/PLAYBOOKS/错误与修复记录.md
我会据此优先修复 FIX-20250818-001，然后执行 run-all 验证
三步自检命令
python -m app.cli.main db-ping --verbose
python -m app.cli.main check-mapping config/data_mapping.v2.json --out mapping_report_v2.json --log-run
修复 prepare_dim 的 RETURNING 后，执行：
python -m app.cli.main run-all config/data_mapping.v2.json --window-start ...Z --window-end ...Z --log-run
快速入口文档
docs/文档地图与导航.md（有“程序现状快照”与最近变更）
README.md/CONTRIBUTING.md/PROJECT_RULES.md（新增“当前程序现状/快速恢复步骤”）

docs/CSV导入-使用指南.md（命令参考、方案B日志开关、迁移到标准schema）

使用方法速览
更新图谱
python scripts/tools/kg_update.py
查询
python scripts/tools/kg_query.py nodes type=Decision
python scripts/tools/kg_query.py edges rel=documents
python scripts/tools/kg_query.py neighbors id=DEC-20250819-010 hops=1
提交提示
本地 pre-commit：提醒未提交图谱或将产生变化
PR 上的 CI：提醒本次文档改动是否遗漏图谱更新

!!!!!!!!!!!!!!!1：时间对齐后的数据严重缺失。
2：dim_devices表中pump_type字段没有填写。
3：dim_stations 表中 extra字段填写的时区为空，让我

总体结论
B 溯源增强：已完成并验证（v2：data/相对路径|batch=…|ver=2）。
C 合并性能优化（第一阶段）：已完成（分段合并默认1h；分区与HASH子分区+轻索引）。
D 数据质量报表：基础版已上线（你已明确“暂不深化”）。
按你刚给出的“里程碑0–5”要求对照，以下是“为达成全部里程碑还需完成的工作清单”。

里程碑0（E2E最小解锁）
已完成

prepare_dim 的 INSERT 已改为 RETURNING id（且采用 UPSERT+COALESCE 不覆盖人工配置）
最小窗口 run-all 可成功（已有多次窗口验证）
待完成

产出 baseline 的 summary.json（目前仅有 env.json；需在 run-all 收尾生成 summary.json，包含运行时长、rows、吞吐、冲突/失败计数等）
文档/记录：PLAYBOOKS/错误与修复记录.md、SESSION_SNAPSHOT 状态板需要补充本轮E2E基线的条目
验证

logs/runs/YYYYMMDD/\* 下同时存在 env.json 与 summary.json，summary.json 内容字段完整
里程碑1（配置外置与启动快照）
已完成

load_settings 基本可读 configs/\*；局部功能已有
待完成

配置拆分与中文注释模板落地：
configs/logging.yaml：格式/路由/采样/轮转/脱敏/SQL详情级别
configs/ingest.yaml：导入模式（auto/direct/staging）、并发/批次、CSV解析、阈值、重试
configs/database.yaml：读写DSN/连接池/超时
优先级机制：CLI > ENV > YAML > 默认（需要在 loader 中实现合并叠加与“来源”标注）
启动首行“参数与配置脱敏快照”输出（你当前要求“不脱敏”→默认不脱敏；同时写入 env.json）
单测：覆盖来源（CLI/ENV/YAML/DEFAULT）、类型校验、必填项检查
文档同步：README、文档地图、程序工作流程、日志规范补充“配置外置与快照”章节
验证

运行时首行 args_summary + config_snapshot 输出；修改 ENV/CLI 后重跑，快照中“来源标注”变化正确
单测通过：覆盖来源优先级逻辑
里程碑2（日志文本模式与按模块路由）
已完成

JSON日志与关键事件存在（perf/sql部分有输出）
待完成

logging.format 切换：json（默认）/ text（增强可读）
logging.routing 切换：by_run（现结构）/ by_module（输出到 logs/modules/\*.log，按模块名/文件名路由）
关键事件补齐与字段族统一（最小集按你清单）：
ingest.load.begin/progress/end（扫描/读取/吞吐/已读字节/rows_read）
ingest.path.resolve（auto 决策日志：bytes_total/per_file_max/file_count 与阈值）
align.merge.window（窗口参数/影响行数/UPSERT冲突/去重比）
db.exec.started/succeeded/failed/retried（sql_op/sql_text/sql_cost_ms/affected_rows/pgcode/pgerror）
backpressure.enter/exit（p95_batch_ms/fail_rate/动作）
task.summary（耗时、吞吐、失败率、背压次数、慢SQL Top）
文本模式输出模板与 by_module 的文件命名规则
验证

两种格式/两种路由可随时切换
关键事件与字段齐备；慢SQL/背压/窗口统计在文本模式可读
里程碑3（参数贯通与可观测）
已完成

CLI 参数基本贯通至 ingest/merge（run_id 已贯通）
待完成

启动首行：
args_summary：CLI 参数快照（无脱敏）
config_snapshot：最终生效配置 + 来源标记（CLI/ENV/YAML/DEFAULT）
两者同时写 env.json
失败输出规范：
stderr：中文提示 + 快速定位建议
stdout：单行 JSON 错误（error_code/message/hint/context），便于工具解析
单测：参数传递链路、快照正确性、错误输出格式、来源标记一致性
验证

制造一个可控错误（参数校验失败等），stderr/stdout 输出符合规范；快照完整
里程碑4（CSV 对齐导入：auto/direct/staging 三态）
已完成

staging 流程（并发 COPY → 合并）稳定；分段合并与分区保障已上线
待完成

auto 模式决策：
扫描 base_dir（bytes_total/per_file_max/file_count），与阈值对比
规则（可配）：total_mb=50、per_file_mb=10、max_file_count=20
输出 ingest.mode.selected 决策日志（包含指标/阈值/选择/可覆盖提示）
direct 模式实现（小量直写）：
多线程读取 → 解析固定列 → 时区解析（入参 > 站点tz > UTC）→ UTC秒对齐
安全 UPSERT（同秒合并）、小批提交、指数退避重试、错误落表与日志
staging 模式保持（大吞吐默认）
CLI 强制覆盖：--ingest-mode=direct|staging
指定窗口 2025-08-11 ~ 2025-08-18 的实际写表验证与性能/质量快照
验证

小样本 E2E 正确；auto 决策合理且可被 CLI 覆盖
not_aligned=0（或在容忍范围内）；perf/sql 日志完整
里程碑5（编码规范与门禁）
已完成

pre-commit/CI 基线与部分规则；项目已有规范与模板
待完成

规则收紧与落地：
禁止裸 except、Docstring 必须、函数>200行/文件>800行需拆分、圈复杂度阈值、魔法数字集中定义、重复检测（R0801）、SQL 参数化、API 类型注解
CI 工具链分阶段启用为阻断：
ruff：严格规则集（import/order/complexity）
mypy：关键模块 strict，其余 basic
pylint：启用重复检测等必要规则
radon：圈复杂度（平均≤6，单体≤10）
pydocstyle：公开 API 必须 Docstring
bandit：安全基线（即使目前“不脱敏”，仍保留安全扫描）
文档：在编码规范与 CONTRIBUTING/PROJECT_RULES 中明确强制条款与豁免流程
验证

本地 pre-commit 全绿；CI 通过；违规报告清晰且可修复
建议的执行顺序（以最小阻力推进）
里程碑0收尾：summary.json + PLAYBOOKS/SESSION_SNAPSHOT 更新（0.5 天）
里程碑1落地：配置拆分/优先级/首行快照 + 单测 + 文档（0.5–1 天）
里程碑2：日志 format/routing + 关键事件补齐（0.5–1 天）
里程碑3：参数贯通可观测 + 错误规范化 + 单测（0.5 天）
里程碑4：auto/direct 实现 + 指定窗口演练（1–2 天）
里程碑5：门禁收紧与CI强化（0.5 天，分阶段）
我可以直接开始的最小改动包
run-all 生成 summary.json（含 rows/时长/失败/冲突摘要）
logging.init 增加 format/routing 配置与 text formatter 框架（先不切换默认）
loader 支持 YAML 拆分+优先级合并（先不改大量调用点）
CLI 首行 args_summary 输出（先最小覆盖）
文档/PLAYBOOKS 更新与“配置外置模板”提交
确认后，我将按上述顺序依次提交，并在每步：

跑一次最小验证
更新 PLAYBOOKS 与 docs
给出回滚与影响面说明
是否现在就从“里程碑0收尾 + 里程碑1最小实现”开始推进？

 
 数据库表dim_metric_config里面的内容，不用根据导入文件配置内容生成，因为没有配置全部数据，每次需要生成dim_metric_config表内的数据时候，只需要先情况表，然后导入dim_metric_config.sql。
注意，要保证现在的流程正常，数据库内其他表格的数据都能正常生成，正常关联。

解决这个问题后，通过日志和数据库内容，判断是否成功。