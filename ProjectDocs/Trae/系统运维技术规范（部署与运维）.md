# 系统运维技术规范（部署与运维）

## 🔧 如何使用本规范
- 部署前准备：第2章环境版本确认→第3章部署规范检查→第5章CI/CD流水线测试
- 日常运维：第6章监控指标配置→告警阈值设置→第8章变更发布流程
- 故障处理：检查健康接口→查看中文日志→按第9章SLO指标定位问题
- 上线清单：CI全绿→预发验证→灰度发布→观测正常→全量部署

---

本文档提炼自原技术文档“15. 部署架构与运维”，对部署、编排、流水线与监控等运维要点进行结构化规范，便于查阅与落地实施。

## 1. 目标与范围
- 统一部署与运维标准，降低环境差异带来的风险。
- 支持开发/测试/生产多环境部署与运维。
- 覆盖CI/CD、监控告警、备份与恢复的核心规范。

## 2. 环境与版本
- 基础运行时：Python 3.13；使用项目级虚拟环境（.venv）。
- 依赖管理：主版本锁定，集中在 pyproject.toml 或 requirements.txt；CI 强制同步依赖。
- 配置管理：使用环境变量/.env（提供 .env.example）；按 dev/test/prod 分层配置。

## 3. 部署规范
- 运行环境：Python 3.13；只暴露必要端口（默认 8000）。
- 健康检查：暴露 /health 与 /ready 接口；每 30s 检测一次，超时 10s，重试 3 次。
- 日志：统一输出到文件系统；日志内容使用中文。
- 文件管理：数据与日志目录独立管理，避免临时文件污染。

## 5. CI/CD 流水线规范
- 触发策略：
  - CI：对 main/develop 分支 push 与 PR 触发。
  - CD：main 分支构建完成后触发生产部署。
- CI 阶段：
  1) 依赖安装（Poetry/或 pip），缓存 .venv 加速构建。
  2) Lint/Format：ruff check + ruff format --check。
  3) 类型检查：mypy 覆盖 src/，禁止忽略错误。
  4) 测试：pytest 生成覆盖率（阈值≥70%），上传报告与构件。

- 构建与制品：
  - 构建Python包并进行版本管理。
  - 版本标签：分支、PR、SHA、latest（默认分支）。
- 部署：
  - 使用脚本进行应用更新；确保部署成功。
  - 部署后执行冒烟测试：/health 与 /api/v1/health 均需返回 2xx。

## 6. 运维监控与告警
- 监控范围：CPU、内存、磁盘使用率、网络 IO、进程数、系统负载等。
- 采样与阈值：默认 30s 采样；阈值建议 CPU>80%、内存>85%、磁盘>90% 触发预警（≥95% 升级为严重）。
- 指标存储：
  - Redis：保存最近 N（如 1000）条实时指标与最近 100 条告警，便于界面即席查询。
  - 数据库：持久化指标用于长期趋势分析与容量规划。
- 告警通道：默认记录到 Redis 与日志；可扩展邮件/短信/Webhook/IM 通知。
- 性能摘要：提供最近 1 小时样本的均值/最大/最小与最后更新时间。



## 8. 变更与发布管理
- 变更分类：功能、配置、依赖、基础设施；均需评估影响面与回滚方案。
- 发布流程：PR 评审通过 → CI 全绿 → 预发环境验证 → 生产灰度发布 → 观测指标正常后全量。
- 回滚策略：保留上一稳定版本与配置；脚本一键回滚。

## 9. 运维 SLO/指标建议
- 可用性：月度服务可用性 ≥ 99.9%。
- 性能：P95 接口响应时间（健康检查/关键 API）在约定阈值内（示例：≤ 1000ms）。
- 故障响应：高严重级事件 5 分钟内确认，30 分钟内缓解。
- 变更失败率：≤ 5%；平均恢复时间（MTTR）持续优化。

— 以上规范为实施最小集合，细节以环境与规模调整。