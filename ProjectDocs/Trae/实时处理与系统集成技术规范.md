# 实时处理与系统集成技术规范

版本：v1.0  |  适用范围：实时采集、流式处理、质量监控、对外系统集成与实时推送

- 目标：
  - 将实时数据采集与流式处理从总技术规范中拆分，降低单文件行数，提升可维护性。
  - 统一实时链路的接口与约束，覆盖数据采集、质量监控、系统集成、WebSocket 实时推送等。
- 环境：Python 3.13.6；项目级虚拟环境 .venv；依赖集中管理并锁定主版本；配置走环境变量/外部配置。

## 如何使用本规范

### 🚀 快速导航（开发-测试-运维）
- 开发：先阅第2-3章接口/管道设计，按规范实现采集器与处理器；日志与观测按第8章。
- 测试：依据第9章编写单测与集成测试，覆盖边界与失败重试；覆盖率≥70%。
- 运维：参照第10与第12章设容量目标、限流/退避策略与发布回滚流程。

### ✅ 上线检查清单
- [ ] 统一UTC时区与事件时间戳携带
- [ ] 关键I/O与网络操作有打点与重试
- [ ] 质量分数与阈值配置到位，告警链路可追踪
- [ ] 配置按环境分层，敏感信息不入仓
- [ ] WebSocket 速率限制与心跳/重连策略验证通过

---

## 1. 总体架构与数据流

数据源（Modbus/OPC UA/MQTT/外部系统）→ 实时采集器（缓冲区+背压）→ 流式处理器（过滤/计算/标准化）→ 数据质量监控（阈值与告警）→ 存储/分析/优化模块 → 对外系统（SCADA/ERP 等）与 WebSocket 实时推送。

- 时序与语义：默认至少一次（at-least-once）；关键幂等操作需通过业务主键实现去重。
- 时间基准：统一 UTC，消息需携带事件时间戳与处理时间戳。
- 可观测性：对采集、处理、告警、推送关键路径记录中文日志与耗时；指标输出处理量、失败率、重试次数。

## 2. 数据采集规范

- 数据结构：SensorReading
  - 字段：sensor_id(str)、timestamp(datetime, UTC)、value(float)、unit(str)、quality(float, 0-1)、metadata(dict)。
- 采集器 CSVDataLoader：
  - 支持CSV文件批量加载，按时间戳排序处理数据。
  - 文件监控：监控指定目录下的新CSV文件，自动加载处理。
  - 数据验证：检查必需字段、数据类型、时间戳格式等。
  - 错误处理：记录文件路径、行号、错误类型等详细信息。
  - 处理状态：跟踪文件处理进度，支持断点续传。

## 3. 流式处理规范

- 架构：StreamProcessor 管道模式（filters → processors）。
- 过滤器：仅透传合法数据（单位合法、取值范围、时间戳新鲜度等）。
- 处理器：幂等、短小（≤50 行）、单一职责；可进行标准化、异常检测、特征计算。
- 时窗与聚合（可选）：支持滚动与滑动窗口（例如 1m/5m），明确事件时间与迟到策略（默认允许 60s 迟到）。
- 错误处理：禁止裸 except；按异常类型记录上下文（sensor_id/窗口范围/参数），必要时熔断单条。

## 4. 数据质量实时监控

- 质量分数：综合时间新鲜度、数值合理性（按类型阈值）、变化率（近 10 条对比）等；历史仅保留最近 N（默认 100）。
- 阈值：可按传感器/类型配置，默认 0.8；低于阈值触发质量告警事件（包含传感器、分数、阈值、取值、时间等）。
- 告警处理：异步回调，保证至少一次投递；处理失败重试并限流；告警需写入监控存储并留最近 100 条索引。

## 5. 系统集成与接口设计

- 接口抽象：ExternalSystemInterface
  - 能力：connect()/disconnect()/send_data()/receive_data()；实现需显式超时、幂等与错误语义。
- 参考实现：
  - SCADAInterface（HTTP/REST）：配置 base_url/timeout；健康检查 /api/health；数据端点 /api/data 与 /api/data/latest。
  - ERPInterface（SOAP/模拟）：配置 soap_url；用于设备/维护计划同步。
- 集成管理器：IntegrationManager
  - 连接与断开：统一生命周期管理；失败记录详细上下文。
  - 同步循环：默认 5 分钟周期；receive → 处理 → 准备发送 → send；错误退避 1 分钟。
  - 数据契约：统一字段命名、单位、时间戳；保证重复发送幂等（去重键建议为 source+id+timestamp）。

## 6. WebSocket 实时接口（摘要）


- 频道建议：
  - sensor.readings：实时传感器读数
  - quality.alerts：数据质量告警
  - performance.metrics：系统性能指标
- 消息包封装：
  - envelope：{ type, ts, trace_id, payload }
  - 示例 payload（读数）：{ sensor_id, value, unit, event_time }
  - 速率限制：每连接默认 ≤ 10 条/秒；支持按订阅过滤（传感器/站点/类型）。
- 可靠性：心跳 ping/pong；服务端 backpressure（逐出最老未消费消息）；异常关闭码与重连退避策略公开。

## 7. 配置管理

- 配置来源：环境变量/.env/外部配置文件；按 dev/test/prod 分层。
- 路径与文件：统一 pathlib；I/O 指定 encoding='utf-8'。

## 8. 日志与观测性

- 日志：统一中文，包含“谁、做什么、参数、结果/耗时/异常”；关键 I/O、网络、重试必须打点。
- 指标：处理量（条/秒）、端到端延迟（P95）、丢弃率、重试次数；暴露到监控（Prom/自研均可）。

## 9. 测试与质量保证

- 单测：核心处理/质量评分/集成管理器均需覆盖；I/O/协议走集成测试，使用 mock/fake 服务。
- 结构：Arrange-Act-Assert；慢测试打标记，默认跳过；覆盖率阈值 ≥ 70%。
- 类型检查：开启 mypy/pyright；避免 Any；容器类型使用精确注解（如 list[str]）。

## 10. 性能与容量

- 目标：
  - 端到端延迟：P95 ≤ 2s
  - 吞吐：单实例 ≥ 2k msg/s（示例目标，可按部署环境校准）
  - 资源：CPU ≤ 70%，内存 ≤ 80%
- 策略：
  - CPU 密集计算分离到批处理或专用算子；I/O 密集使用 asyncio/线程池。
  - 背压与丢弃策略可配置；必要时引入队列中间件（如 Redis Stream/Kafka）。

## 11. 接口与数据结构约定（JSON 摘要）

- SensorReading
  - { "sensor_id": "str", "event_time": "ISO-8601 UTC", "value": 1.23, "unit": "kPa", "quality": 0.98, "metadata": {"site": "S1"} }
- QualityAlert
  - { "sensor_id": "str", "event_time": "ISO-8601 UTC", "quality_score": 0.61, "threshold": 0.8, "value": 12.3, "alert_type": "data_quality" }
- External Sync（示例）
  - { "source": "ERP", "type": "maintenance_schedule", "items": [...], "ts": "ISO-8601 UTC" }

## 12. 变更与发布

- 配置项、协议字段的新增/变更需向下兼容；为移除项提供至少 1 个版本的废弃期（标注 deprecated）。
- 上线流程纳入 CI/CD 与回滚预案；实时链路具备灰度与限流开关。

---
本规范对应原 technical_specifications.md 中“9. 实时数据处理与流式计算”与“10. 系统集成与接口设计”两章的提炼与结构化，细节实现以代码与 API 文档为准。