
# 项目结构与数据流总览

## 目标与边界
- 当前核心：高效导入超大 CSV（忽略 DataVersion/DataQuality），按泵站秒级对齐，JSON 合并幂等写入。
- 数据库：使用 `pump_monitoring_db`，只读/写现有表 `stations`、`devices`、`aligned_data`、`features_device_minute`，仅允许新增 `field_units`。
- 文件编码：UTF-8；不进行时区转换。
- 对齐策略：同秒取最早；缺秒不补；多秒丢弃多余。
- 幂等：以 `(device_id, standard_time)` 为唯一约束，`JSON_MERGE_PATCH` 合并。

## 目录约定
- `app/config/`：加载与校验映射 [config/data_mapping.json](mdc:config/data_mapping.json)、运行参数、单位配置。
- `app/db/`：MySQL 连接池、会话 `local_infile=1`、SQL 片段与数据网关。
- `app/ingest/`：大 CSV → `TEMPORARY TABLE` → 去重 → 批量写入。
- `app/align/`：按泵站/设备秒级对齐，生成字段级 `data_json` 并合并。
- `app/units/`：`field_units` DDL 与幂等初始化。
- 预留扩展：
  - `app/processing/`：质量检测、缺失/异常报告（默认不做插值）。
  - `app/features/`：分钟级特征聚合，写入 [sql/features_device_minute.sql](mdc:sql/features_device_minute.sql) 对应表。
  - `app/ml/`：训练/推理流水线，产物落本地 `models/`。
  - `app/curve_fit/`：泵/泵组特性曲线拟合与版本管理。
- `app/tasks/`：任务编排（全量/按站/单文件）、断点续跑、校验、干跑。
- `app/utils/`：日志、时间、断点、并发、度量、校验。
- `configs/`：`.env`、`logging.yaml`、`app.yaml`。
- `state/`：断点/指纹文件；`logs/`：运行与坏行日志；`models/`：模型与拟合产物；`docs/`：架构与运维文档；`tests/`：测试。

## 数据流（高层）
1. 校验映射：名称必须与 `stations/devices` 一致。
2. `LOAD DATA LOCAL INFILE` → `tmp_raw(TagName, DataTime, DataValue)`（忽略 DataVersion/DataQuality）。
3. SQL 去重：同秒保留最早 `DataTime`。
4. 生成字段 JSON → 合并写入 `aligned_data`：
   - `INSERT ... ON DUPLICATE KEY UPDATE data_json = JSON_MERGE_PATCH(aligned_data.data_json, VALUES(data_json))`
5. 批量、分站并行，断点续跑，坏行落盘。

## 禁区
- 不修改现有表结构（除新增 `field_units` 表）。
- 禁止逐行 INSERT；必须批量导入与批量合并。