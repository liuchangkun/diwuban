---
description: API 版本兼容与弃用（语义化版本、向后兼容期、弃用公告与灰度）
---
# API 版本兼容与弃用

## 版本策略（SemVer）
- 采用语义化版本：MAJOR.MINOR.PATCH。
- 接口路径或头部携带版本：`/v{major}/...` 或 `X-API-Version: {major.minor}`；禁止无版本接口。
- MINOR/PATCH 必须后向兼容；MAJOR 可引入破坏式变更（需走弃用流程）。

## 向后兼容原则
- 仅新增字段（可选、带默认）不破坏；禁止改变字段含义/类型/必填性。
- 响应中新增字段需保证老客户端可忽略；请求新增字段须为可选。
- 保留旧行为的“兼容开关/参数”，默认保持旧行为，逐步灰度。

## 发布与灰度
- vNext 在预发/灰度环境先放量：影子流量/金丝雀验证（参见 83/54）。
- 发布物包含：变更清单、兼容说明、回滚方案、迁移指引、样例。
- 失败或指标不达标（见 23/40）立即回退至上一稳定版本。

## 弃用流程（Deprecation → Sunset）
- 公告：在响应头加入 `Deprecation: true`、`Sunset: <RFC 1123 datetime>` 与文档链接；在变更日志与公告板同步。
- 过渡期：维持双版本服务（Dual-Stack），最短维持期 T（建议 ≥90 天）。
- 监控：按版本统计调用量与错误率，低于阈值后执行下线；保留离线备份。

## 契约与契约测试
- 统一契约：REST 用 OpenAPI（yaml）、gRPC 用 Proto；纳入版本库并评审。
- 兼容性检查：CI 中做向后/向前兼容检测（breaking-change 门禁）。
- 合同测试（Consumer-Driven）：关键下游以契约生成校验用例。

## 幂等与重试
- PUT/DELETE/重试场景提供 `Idempotency-Key`（或基于资源键幂等）。
- 错误码与可重试矩阵与 44 对齐；返回 `Retry-After` 提示退避。

## 观察与告警
- 指标分版本打点：QPS/错误率/延迟/调用方画像；
- 对旧版本的使用量/失败率设置阈值与过渡期告警，辅助下线决策。

## 安全与访问控制
- 版本与授权范围（scope）绑定；新版本默认最小权限；
- 严禁通过版本升级扩大敏感字段的暴露范围（见 21/94）。

## 文档与示例
- 每个版本完整文档、示例请求/响应、典型用法与迁移指南；
- 文档内链接使用 `mdc:` 指向相关规则与实现文件，保持可追溯。