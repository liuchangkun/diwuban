---
alwaysApply: true
description: 配置与校验规范（优先级、必填项、强校验与回退）
---
# 配置与校验规范

## 优先级
- CLI > ENV > YAML(`configs/app.yaml`) > 默认值；启动即加载并校验。
- 建议将关键 ENV 与 CLI 名称与 YAML 字段一一对应，便于可观察与审计。

## 必填项与字段清单（最小集）
- database: `host`/`port`/`user`/`password`/`name`、pool（min_size/max_size/timeout）、session（local_infile/charset）。
- ingest: file_whitelist、csv（encoding/line_ending/has_header/columns）、batch（max_rows/commit_rows）、concurrency（max_workers/station_parallel）。
- align/merge: dedup.per_second_keep、align.timezone/missing_seconds/multi_values、merge.mode、quality_default。
- performance: slo（throughput_rows_per_sec/p95_latency_ms/failure_rate）、backpressure（error_rate_threshold/increase_after_ok_batches/decrease_factor）。
- security: allow_paths、redact.enable。
- compute（见 42）: mode（trigger|offline）。
- feature_flags: 开关位集合（按模块分组）。

## 强校验
- 类型/范围/枚举/依赖项；失败即停止并给出修复建议。
- 交叉校验：`commit_rows ≤ batch.max_rows`；`ingest.concurrency.max_workers ≥ 1`；`throughput_rows_per_sec > 0`。
- 路径白名单：所有输入文件必须匹配 `security.allow_paths`。

## 失败处理
- 启动前校验失败：立即退出并输出机器可读 JSON 摘要（见 48）。
- 运行中变更（若支持热更新）：先做影子校验，失败则拒绝生效（见 54/88）。

## 示例（字段对应）
- CLI: `--concurrency` → `ingest.concurrency.max_workers`；`--batch-max-rows` → `ingest.batch.max_rows`；`--commit-rows` → `ingest.batch.commit_rows`；`--dry-run` 控制不落库。
- ENV: `DB_HOST/DB_PORT/DB_USER/DB_PASSWORD/DB_NAME` → `database.*`；`LOG_LEVEL/LOG_FORMAT` → `logging.*`。

## 文档与追溯
- `configs/app.yaml` 中为关键项添加注释，指向对应规则（mdc 链接）。
- 每次运行打印配置快照（脱敏），便于回溯（见 10）。