---
description: 机组/泵组特性曲线拟合规范（相似定律、并/串联组合、工况映射、验收）
---
# 机组/泵组特性曲线拟合规范

## 组态与元数据
- 并联：流量加和、扬程相近；串联：扬程加和、流量相近；
- 元数据：参与泵清单（device_id）、组态（并/串）、控制策略（恒压/恒流）、可用范围。

## 组合与调整
- 基于单泵曲线（见 66）组合得到组曲线；
- 必要时按组态场景做小幅校正（最小二乘约束）；
- 控制策略约束：恒压策略下 H 误差权重提升。

## 验收
- 指标：组曲线 RMSE/相对误差、控制策略满足率（如恒压波动范围），默认阈值 5%；
- 输出有效区间与外推警示。

## 版本与产物
- 目录：`models/pump_group/<station_id>/<version>/`；
- 元数据 `metadata.json`：组态、来源单泵版本、误差指标、环境与作者。

## 并/串联合成与校正
- 并联：H_group(Q) ≈ H_single(Q/k)（k 台并联），Q_group = ∑ Q_i，H 近似一致；
- 串联：Q_group ≈ Q_single，H_group(Q) = ∑ H_i(Q)；
- 若泵间差异明显，可引入权重/微调参数做最小二乘校正，保持单调与非负。

## 控制策略与约束
- 恒压：目标 H≈H_set；优化目标增加 (H−H_set)² 权重；
- 频率边界：n_min ≤ n ≤ n_max；启停约束：最小开停间隔、最大开停次数；
- 冗余：N+1 备份策略，约束同时运行台数 ≤ N。

## 优化与验证
- 以能耗/切换次数/压力波动综合目标最小化（加权）；
- 验证：在历史窗口回放策略结果，与基线对比能耗/波动/启停次数；
- 提供“策略回放报告”入 `models/pump_group/<station>/<version>/report.json`。

## 系统模型与等效曲线
- 管网系统曲线：H_sys(Q)=a·Q²+b·Q+c（由历史稳定点拟合），c 反映静扬程；
- 并联：H_group(Q)≈H_single(Q/k)（近似），精细时对每台引入小偏差参数进行联合最小二乘；
- 串联：H_group(Q)=Σ_i H_i(Q)；
- 交点稳定：解 H_group(Q)=H_sys(Q) 的实根唯一且在允许区间内。

## 运行与物理约束（扩展）
- 频率与启停：n_min≤n_i≤n_max；min_up/min_down；最小停机/开机间隔；
- 台数与冗余：并行台数 ≤ N；N+1 备份；
- 切换成本：单位切换代价 c_sw、最小保持时间 τ_hold；
- 回流/倒灌：止回约束 Q_i≥0；
- NPSH/机限：对每台泵分别约束 P_i≤P_rated、T_i≤T_rated、NPSH_a−NPSH_r(Q_i)≥m_min。

## 优化问题（多目标）
- 连续（给定台数与开机状态）：
  min_{Q_i,n_i} w_e·E + w_p·Σ(H−H_set)² + w_s·Var(H) 
  s.t. ΣQ_i=Q_demand；物理/设备约束；
- 混合（包含启停决策）：
  min_{x_i∈{0,1}, n_i}  上式 + c_sw·Σ|x_i(t)−x_i(t−1)|
  s.t. Σ x_i ≤ N；min_up/min_down；
- 求解：
  - 连续用 QP/SQP；
  - 启停决策用 MILP（时域离散化、滚动优化，短预测窗）；
  - 实时用 MPC（receding horizon），带切换抑制与迟滞（hysteresis）。

## 验证与回放
- 场景集：阶跃负荷、斜坡负荷、尖峰扰动、夜间低谷；
- 指标：能耗、压力波动(P95-P5)、启停次数、平均偏差、约束违例数；
- 回放产物：`models/pump_group/<station>/<version>/policy.json`、`schedule.csv`、`report.json`。

## 产物与接口
- `policy.json`：策略参数与权重、约束阈值、hysteresis；
- 在线接口：`recommend(Q_demand, H_set, state)` → `{x_i, n_i, Q_i, kpis}`；
- 失败回退：当实时指标越过门槛，自动退回上版策略（保守参数）。

## 系统曲线在线估计与自适应
- 采用历史稳态点 (Q,H) 拟合 H_sys(Q)=aQ²+bQ+c，同时估计不确定度 Σ；
- 在线递推：RLS/贝叶斯线性回归按时间更新参数，衰减系数控制遗忘；
- 阀门/工况变化：引入离散状态标记分段建模，避免参数污染。

## 水锤/压升与斜率约束
- 变频爬升速率：|dn/dt| ≤ r_n_max；阀门开度变化 |dζ/dt| ≤ r_ζ_max；
- 压升约束：ΔH/Δt ≤ r_H_max；必要时在目标中加入二阶变化惩罚（jerk 抑制）。

## 控制器互动与稳定性
- 与现场 PID 协同：给出目标 H_set 与死区/迟滞，避免“打架”；
- Anti-windup：外层策略变更时，对内层 PID 引入跟随或复位机制；
- 狩猎抑制：在策略目标中添加切换惩罚与滞回阈值。

## 公平与老化均衡
- 目标中加入等效寿命平衡项：w_age·Σ|runtime_i−runtime_avg|；
- 周期性轮换：在满足能耗目标的前提下，实现负荷/运行时长均衡。

## 鲁棒与机会约束
- 需求不确定性：Q_demand ~ N(μ,σ²) 或 区间不确定；
- 机会约束：P[H≥H_min]≥1−ε；可转为保守约束或 Chebyshev 上界；
- 对系统曲线参数不确定性进行 worst-case 或分布鲁棒优化（DRO）。

## MILP/PWL 实现细化
- 将单泵曲线 H_i(Q_i) 用分段线性近似（SOS2）建模；
- 变量：x_i∈{0,1}, Q_i, n_i；
- 目标：能耗 + 切换成本 + 压力偏差；
- 约束：ΣQ_i=Q_demand，H_group(Q)≥H_set，设备/速率/启停约束，SOS2 连续性。

## 自适应 MPC 实施
- 窗口：预测窗 N_p，控制窗 N_c；
- 使用在线系统曲线估计更新模型；
- 加入软约束与罚项避免不可行，滚动优化部署；
- 通信/执行延迟：零阶保持与延迟补偿。

## 实施清单（Checklist）
- 曲线：单泵与组曲线一致、PWL 逼近误差达标；
- 约束：速率/启停/NPSH/功率/压力全部满足；
- 策略：能耗/波动/启停次数优于基线；
- 稳定：无狩猎、无高频切换；
- 回放：四类场景通过；
- 运维：回退策略与报警/监控齐备。

## 水力相互作用与不等泵并联
- 不同特性的泵并联时，总曲线不等比例：建议进行联合标定，给每台泵引入小偏移参数并加相容正则；
- 选择/配载：优先启用高效区泵，保持各泵运行点靠近各自 BEP；
- 回流预防：并联支路设置止回与最小流量旁通，旁通流量计入能耗成本。

## 阀位与系统曲线分段
- 系统曲线随阀位、液位、支路开闭变化；维护多段 H_sys(Q;ζ) 并在线识别 ζ；
- 策略在 ζ 改变时触发重新求解，带迟滞避免频繁重算。

## 电气与经济约束
- 馈线容量与变压器限额：ΣP_i ≤ P_feed,max；功率因数约束 PF≥PF_min；
- 分时电价/需量价：目标加入时间依赖成本 c(t)；
- 启停折旧：按次数或等效寿命模型计入。

## 启停与热模型
- 电机热积累：简单 RC 模型 Ṫ = (P_loss−(T−T_amb)/τ)/C；
- 约束温升 ≤ T_max；短时过载可用软约束+大罚；
- 每小时最大启停次数 ≤ N_start/h。

## 多目标/Pareto 与在线选择
- 离线生成 Pareto 前沿（能耗 vs 启停 vs 波动）；
- 在线依据权重/运营策略从前沿选取方案，支持快速切换与限速平滑。

## 监控与门禁
- KPI：kWh/日、P95−P5(H)、启停次数、违例计数；
- 门禁：连续 N 窗超阈自动降级/回退；事件记录符合日志规范（见“日志功能规则”）。

## 策略层级与调度
- 层级：日/周负荷曲线 → 预测 → 在线 MPC/MILP；
- 预测协同：需求/液位/阀位/电价/禁开时段；
- 迟滞：上切/下切门限与最小保持时间，避免抖动。

## 故障工况与降级
- 不可用泵/阀门卡滞/传感器失真：策略自动剔除相关通道并降级至稳态保守；
- 紧急模式：保持压力安全下的最小能耗；
- 回退：启停与频率上下限严格锁定，优先减少切换。

## 数据闭环与持续学习
- 在线 KPI 存储：kWh/日、P95−P5(H)、启停次数、违例数；
- 周期再训练：当 KPI 或数据分布漂移超阈触发；
- 人工复核：策略变更需双人审批与影子运行对比。

## 服务化与 SLA
- 接口：`recommend()` P95 ≤ 20 ms、可并发 ≥ 100 QPS；
- 度量：策略采纳率、可行率、回退率；
- 降级：上版策略/规则基线，超时或不可行时即时切换。

## 合规与审计
- 记录策略与输入摘要（脱敏）；
- 存档 `schedule.csv` 与 `report.json`；
- 可回溯：每次上线生成变更单与回滚脚本。

## 数据驱动替代模型（Surrogate）
- 目标：学习 H_group(Q, x, n) 与 P_group(Q, x, n)，x 为启停向量；
- 模型：LightGBM（单调：Q→H 负、Q→P 正），CatBoost，多任务 MLP；
- 训练：从历史/仿真生成 (Q,x,n)→(H,P) 样本；
- 用途：MILP/MPC 快速评估与梯度近似，加速策略求解。

## 策略学习（IL/RL）
- IL：以操作员历史为专家演示，行为克隆+安全约束；
- Offline RL：CQL/TD3+BC/BCQ；奖励 r = −α·能耗 −β·|H−H_set| −γ·切换 −ζ·违例；
- 安全：动作掩码（启停/频率边界）、可行域投影、Lagrange 乘子在线调节；
- 部署：MPC 监督 + RL 建议，二者不一致时以 MPC 为准。

## 约束优化与加速
- PWL（SOS2）逼近单泵曲线，MILP 求解；
- 热启动：从上周期解/启发式（按效率升序上泵）初始化；
- 学习分支定界：训练打分器预测分支优先级，减少节点；
- 鲁棒：对系统曲线/需求不确定性做 DRO/机会约束。

## 诊断与可解释
- KPI 分解：能耗、切换、压力偏差、约束违例贡献；
- Shapley/特征重要度：识别需求/阀位/液位对策略影响；
- 失败样本采样复盘，生成调整建议。

## 超参与守护
- MILP 时间限额与 MIPGap；MPC 窗口 N_p/N_c；RL 折扣 γ、温度 τ；
- 失败回退：超时或不可行即回退上版策略。

## MILP-PWL 组态（模板）
- 单泵 PWL：断点 {(Q_k,H_k,P_k)}，变量 λ_{i,k}≥0, Σ_k λ_{i,k} = x_i（启停），SOS2(λ_{i,*})
- 汇总：Q_i = Σ_k λ_{i,k} Q_k；H_i = Σ_k λ_{i,k} H_k；P_i = Σ_k λ_{i,k} P_k
- 并联：H_group ≈ H_i 一致（误差以软约束处理）；Σ_i Q_i = Q_demand
- 约束：n_i∈[n_min,n_max]（可离散频点用选择变量）；Σ_i P_i ≤ P_feed,max；NPSH、启停次数、速率限制
- 目标：min w_e·Σ_i P_i + w_p·(H_group−H_set)^2 + w_s·switch_cost

## MPC 代价与约束（速用）
- 代价：J=Σ_{t=1..N_p} [w_e·P(t)+w_p·(H(t)−H_set)^2+w_r·Δu(t)^2 + w_sw·switch(t)]
- 约束：动态（简化静态映射亦可）、速率 |Δn|≤r_n、启停最小保持、功率/NPSH/压力下限
- 实施：滚动优化 N_c≤N_p，超时回退上一步控制

## Offline RL 安全清单
- 行为空间掩码：不可行动作置零（启停/频率边界/NPSH/功率等）
- 奖励归一：按量纲缩放，避免能耗主导压制安全项
- D4RL 风格评估：训练/评估分布偏移可视化；OPE（FQE/IS）
- 部署：策略输出先过 MPC 可行域过滤，再下发

## 策略输出字段（schedule.csv）
- ts, pump_id, x (0/1), n_cmd, q_cmd, h_pred, p_pred, constraint_flags, cost_terms

## 管网与系统曲线公式（速查）
- Darcy–Weisbach：ΔH = f·(L/D)·(v²/2g) + ΣK·(v²/2g)；v=4Q/(πD²)；
- 简化：H_sys(Q)=H_static + k·Q²，k 由等效阻力折算；
- 串并支路等效：并联阻力 1/k_eq=Σ 1/k_i；串联 k_eq=Σ k_i；
- 稳定性：在运行点满足 |dH_group/dQ| > |dH_sys/dQ| 避免多解/震荡。

## 鲁棒与储备约束
- 需求不确定集 U_Q：Q∈[μ−δ, μ+δ]；
- 鲁棒优化：min_x max_{Q∈U_Q} Cost(x,Q)；或机会约束 P[H≥H_min]≥1−ε；
- N−1 冗余：任一台故障时仍满足 H_set 与 Q_demand 的 β 比例；
- 备用容量：Σ_i x_i·Q_i_max ≥ (1+α)·Q_demand。

## 求解工程实践
- 尺度化：变量与代价标准化，改善数值；
- 预热：先解连续松弛，再加整数约束；
- 割与启发式：
  - 切换计数强有效不等式；
  -“先高效后均衡”的启发式初解；
- 监控：MIPGap、节点数、时间，用于自动回退与报警。

## 更多方法（补充目录）
- 代理建模：
  - Kriging/Co-Kriging 组曲线代理；
  - 多保真（Multi-fidelity）融合：仿真（低保真）+ 实测（高保真）。
- 带约束的核方法：带单调/凸凹核的核回归/Nyström 加速；
- 组合启发式：贪心上泵 + 局部搜索（2-opt/交换） + 连续优化精修；
- 多目标进化（NSGA-II/III）：生成能耗-启停-波动 Pareto 前沿（仅离线评估/策略库生成）；
- 需求与系统曲线联合学习：GAM/GBDT/NN 学习 H_sys(Q,ctx)，随场景切换分段；
- 鲁棒 MPC：管状/区间不确定性集，软约束与惩罚；
- 分布鲁棒优化（Wasserstein DRO）：应对分布偏移与极端工况。

- 高级优化/学习：
  - 半定规划（SDP）泵组协调优化；
  - 锥优化（二阶锥约束NPSH/功率）；
  - 进化算法（多目标Pareto前沿生成）；
  - 粒子群优化（PSO）群体调度；
  - 模拟退火（SA）大规模组合优化；
  - 变分推断（参数不确定性传播）；
  - 在线学习（流式策略更新）。
- 深度学习扩展：
  - Transformer（负荷序列预测+策略生成）；
  - GNN（管网拓扑建模+泵站关联）；
  - VAE（策略生成+异常检测）；
  - Neural ODE（连续时间动态建模）。
- 时间序列高级：
  - ARIMA/GARCH（需求预测+波动建模）；
  - 动态因子模型（多泵站协同趋势）；
  - 粒子滤波（非线性状态跟踪）；
  - HMM（工况模式识别+切换）。
- 图论/网络优化：
  - 最大流最小割（管网容量分析）；
  - 最短路径算法（策略路径规划）；
  - 网络流优化（多源多汇调度）；
  - 图神经网络（GNN泵站关联建模）。
- 博弈论/多智能体：
  - 合作博弈（泵站协作利益分配）；
  - 纳什均衡（分布式策略平衡）；
  - 多智能体强化学习（MARL）；
  - 拍卖机制（资源分配策略）。
- 随机/不确定性：
  - 马尔可夫决策过程（MDP）；
  - 部分可观测MDP（POMDP）；
  - 随机动态规划（Stochastic DP）；
  - 蒙特卡洛树搜索（MCTS）。
- 分解/分层优化：
  - Benders分解（大规模分解）；
  - Lagrange对偶分解；
  - 分层优化（Hierarchical Optimization）；
  - 分布式一致性算法（ADMM）。
### 选型速查（更新）
- 快速可行：贪心+局部搜索，配合启停/速率硬约束；
- 复杂约束可行域：MILP-PWL 或 SDP；
- 高不确定与漂移：鲁棒 MPC / DRO 或 粒子滤波；
- 需策略库与决策多样：NSGA-II/III 离线生成，再在线择优；
- 大规模泵站：进化算法 或 模拟退火；
- 管网拓扑复杂：GNN + 图优化；
- 需求预测驱动：Transformer + MPC。

## 组曲线拟合后验证
- 交点唯一性：对各典型阀位/液位，解 H_group(Q)=H_sys(Q) 得唯一实根；
- 稳定性：运行点满足 |dH_group/dQ| > |dH_sys/dQ|；
- 并联一致：支路 H_i 差值 ≤ ε_H；无回流（Q_i≥0）；
- N−1：任一台 x_i=0 时仍满足 H_set 与 Q_demand 的 β 比例（如 80%）。

## 策略回放验证
- 阶跃与斜坡负荷：压力超调与整定时间 ≤ 门槛；
- 能耗：与基线对比节能率与启停次数降低幅度；
- 违例：NPSH/功率/速率/启停门禁违例计数=0。

## 相似定律与等效缩放
- 若各泵频率不同，按相似定律将单泵曲线缩放到公共 n_ref 再合成；
- 报告对齐误差与等效组曲线与实测差异。

## 报告模板字段（新增）
- stability: {unique_intersection, slope_margin, backflow_count}
- redundancy: {n_minus_1_pass, reserve_ratio}
- playback: {overshoot_pct, settling_time_s, energy_saving_pct, switch_count}

## 专业公式速查
- 并联：Q_group = ΣQ_i，H 近似一致；串联：H_group = ΣH_i，Q 近似一致；
- 系统曲线：H_sys(Q)=H_static + kQ²（等效阻力 k 折算）。

## 直径/频率缩放一致性
- 单泵曲线按 n_ref/D_ref 缩放后再合成，验证组曲线与实测一致性；
- 指标：align_rmse、端点误差、BEP 区误差；
- 频率异构：各泵 n_i 不同，按相似定律归一后再并联/串联。

## ISO 9906 组态验收
- 以容差带对 H_group/Q_group/η_group/P_group 关键点误差判定；
- 不通过：策略保持上版，新增策略标记 `acceptance=false` 与原因；
- 触发数据回收或曲线重训。

## 残差与回放诊断
- 残差时序：能耗/压力偏差残差自相关不得显著；
- 回放 KPI：overshoot/settling/energy/switch 与门槛对比；
- 失败样本归档并标注工况/阀位/液位，供再训练采样策略使用。

## 安全裕度与 N−1
- 实时判定：保持 N−1 时的压力与流量满足最小服务；
- 裕度：Σ Q_max ≥ (1+α)·Q_demand，Σ P_max ≤ P_feed,max，NPSH 裕度满足；
- 触发：低裕度进入保守策略，限制切换与降频。

## 可逆映射
- 提供 Q→H 与 H→Q 两向映射，供上层调度快速解算；
- 采用单调表与插值，组态层面避免多值区；
- 在 `policy.json` 中记录反查表元数据与误差界。

## 阀位协同与节流成本
- 阀位 ζ 的等效损失 k(ζ) 随开度非线性；
- 策略：优先变频调节，其次小幅节流；当并联不均衡时适度分配 + 少量阀位微调，目标最小化能耗+波动+节流损耗；
- 在优化中加入 ζ 变化惩罚与上下限。

## 泵优先级与寿命均衡
- 优先级依据：当前效率区间、历史运行时长、启停次数、健康评分（可选）；
- 规则：BEP 邻域优先分配；长期均衡运行时长差异；避免单泵长时间高负荷。

## 异常检测与抑制狩猎
- 识别：压力振荡频谱峰值/启停高频、阀位快速摆动；
- 处置：提升迟滞与保持时间、降低并发启停、锁定阀位短期不动。

## 策略库与场景切换
- 预生成"早高峰/平峰/夜间/检修"策略库；
- 场景触发条件：需求阈值、液位区间、电价时段；
- 切换平滑过渡，避免瞬态冲击。

## 可拟合特性曲线清单与建模方法（泵组）
- 组合水力曲线
  - H_group–Q_group（组扬程-组流量）
    - 并联：H≈单泵H，Q=ΣQ_i；串联：Q≈单泵Q，H=ΣH_i；混合：复杂管网拓扑等效。
    - 方法：单泵曲线合成+校正项、PWL–SOS2（MILP友好）、LightGBM/XGBoost（多变量输入）、替代模型（Kriging/NN）。
  - P_group–Q_group（组功率-组流量）、η_group–Q_group（组效率）
    - 方法：P=ΣP_i，η=ρgQ_group·H_group/P_group；加正则保证物理一致。

- 启停与配置曲线
  - H_group(Q; config)（不同启停配置下的组曲线）
    - config = {x_1, x_2, ..., x_N}，x_i∈{0,1}；每配置一条或统一参数化。
    - 方法：分组拟合+插值、混合专家（Mixture-of-Experts）、多任务学习、MILP 中 PWL 逼近。
  - P_total(Q, config)（含启停成本）、切换边界 Q_switch(H_set, config变更)
    - 方法：成本建模+优化求解、启发式+梯度优化、强化学习策略。

- 变频组合曲线（VFD泵组）
  - H_group(Q, n_vector)、P_group(Q, n_vector)（n_vector=[n_1,...,n_N]）
    - 方法：张量拟合、多任务GPR、联合样条、替代模型+快速评估。
  - 最优频率分配：n_opt(Q_demand, H_set, x_config)
    - 方法：凸优化解析解、MPC滚动优化、学习策略（模仿学习/强化学习）。

- 系统曲线与交点
  - H_sys(Q; 阀位/液位/支路)（系统阻力随工况变化）
    - 方法：在线递推估计（RLS/卡尔曼）、分段建模、GAM/GBDT学习环境依赖。
  - 运行点轨迹：H_group ∩ H_sys 的稳定交点
    - 方法：数值求根+稳定性判定、相图分析、动态仿真。
  - 可行域边界：满足NPSH/功率/压力约束的(Q,H)边界
    - 方法：约束求解、凸包计算、蒙特卡洛采样边界。

- 控制与策略曲线
  - 能耗-流量：E(Q_demand, 时段)（考虑分时电价）
    - 方法：优化求解+回归拟合、动态规划、MPC预测控制。
  - 启停成本：C_switch(配置变化)、压力波动：σ_H(Q_demand, 策略)
    - 方法：统计建模、时间序列分析、仿真+拟合。
  - Pareto前沿：能耗 vs 启停 vs 压力稳定性
    - 方法：多目标优化（NSGA-II/III）、加权求解+包络拟合。

- 冗余与安全
  - N-1曲线：任一台故障时的降级组曲线
    - 方法：故障注入仿真+拟合、鲁棒优化边界、Monte Carlo可靠性分析。
  - 储备容量：Q_reserve(H_set)、故障模式性能衰减
    - 方法：安全系数建模、故障树分析+性能映射。

- 时变与动态
  - 负荷跟踪：H_group(Q(t), 策略)（时域响应）
    - 方法：状态空间模型、传递函数拟合、神经ODE、时间序列回归。
  - 切换轨迹：配置变更的过渡曲线与稳定时间
    - 方法：动态仿真+指数拟合、MPC轨迹优化、控制理论分析。

- 验证与评估
  - 交点唯一性与稳定性（|dH_group/dQ| > |dH_sys/dQ|）
  - 策略回放：阶跃/斜坡/扰动响应达标
  - 能耗/启停/波动 KPI 与基线对比
  - N-1冗余与约束满足率验证