# 曲线拟合规范：使用所有可用方法（RULE）

版本：v1.1（与 06-extensions 及 `app/curve_fit/` 对齐；合并展示规范）

## 目标与边界
- 目标：对泵/泵组特性曲线（如 H–Q、η–Q、P–Q 等）进行全面的多方法拟合，自动选择/集成最优结果，产出版本化拟合产物。
- 边界：实现位于 `app/curve_fit/`；产物落地 `models/`；不修改业务表结构；不覆盖原始测量数据。

## 方法组合（“尽可能全”且可配置）
- 多项式回归：阶数 1–5（默认 2–3），含岭/套索正则（L2/L1）。
- 有理函数（分式）拟合：低阶 p/q（如 [1/1]、[2/1]）。
- 指数/幂律/对数模型：y=a·exp(bx)、y=a·x^b、y=a+b·ln x。
- 样条与分段：三次样条（自然/边界）、分段线性（单调约束）。
- 局部回归：LOESS/LOWESS（稳健核权重，可设 span）。
- 稳健回归：Huber/RANSAC/Theil–Sen（抗离群）。
- 支持向量回归：SVR（RBF/线性/多项式核，轻量网格）。
- 高斯过程回归（可选）：RBF/Matérn 核（样本较少时）。
- 分位数回归（可选）：估计不同分位带（抗偏态）。
- 组合/集成：简单加权平均/堆叠（stacking）（仅在显著提升且不过拟合时启用）。

备注：默认启用“多项式/样条/稳健/LOESS/SVR/有理”六类；其余可通过配置开启。

## 物理与工程约束
- 单调性：按曲线物理含义约束（示例：H–Q 通常随 Q 非增；η–Q 在有效区间单峰）。
- 非负性与界限：H≥0，Q≥0，η∈[0,1]，P≥0；超界裁剪或惩罚。
- 可解释性优先：若多方法差距不大，优先更简洁/可解释模型（低阶多项式/样条）。

## 训练与评估
- 数据切分：时间感知/站点分层；留出/滚动验证；避免泄漏。
- 评价指标：RMSE、MAE、R²、MAPE（对 Q≈0 段屏蔽）；物理一致性评分（单调/界限违例率）。
- 选择准则：
  - 主指标：加权综合分（如 RMSE 与物理一致性）；
  - 次指标：模型复杂度惩罚（AIC/BIC 近似、自由度罚项）。
- 稳健性：K 折/滚动窗口稳定度（指标方差/排名稳定）。

## 超参与资源
- 网格/贝叶斯搜索应受限：每类方法默认≤10 组；并行线程受限；统一超时与重试策略。
- 数据前处理：去重/按秒对齐后的有效样本；可选中值/滑动平滑仅用于训练，不回写。

## 产物与版本管理
- 产物内容：模型文件（方法/超参）、度量摘要、训练窗口、输入特征字典、单位、物理约束报告、数据指纹（hash）。
- 存放：`models/{station}/{device}/{curve}/{version}/`；version 由日期+hash 组成，写入 `MODEL.json` 元信息。
- 不可变：已发布版本只读；新版本以新目录落地；提供软链接 `latest` 指向当前生效版本。

## 运行与接口（约定）
- CLI：`curve-fit fit --station ... --device ... --curve hq|etaq|pq --since ... --until ... [--methods all|poly,spline,...] [--dry-run]`。
- 评估：`curve-fit eval --artifact ...` 输出度量与物理约束报告。
- 上线：`curve-fit publish --artifact ...` 写入 `latest` 链接与版本记录（不碰数据库）。

## 质量与审计
- 日志事件：`curvefit.begin/end`、`curvefit.method.eval`、`curvefit.select`、`curvefit.publish`；包含 station/device/curve/method/metrics/constraints。
- 报告：生成 `REPORT.md`（度量对比、方法排名、物理约束违例、选择理由）。
- 失败与回滚：若线上监测退化（指标恶化/约束违例上升），自动回滚到上一个 `latest`。

## 依赖与资源
- 依赖建议：`numpy/scipy/scikit-learn/statsmodels`；可选 `patsy/cvxpy/gpytorch`。
- 资源限制：轻量网格；受控并行；优先最小可行方案与复现稳定性。

## 与其它规则的关系
- 与 06-extensions：本规范落实“曲线拟合与版本管理”扩展边界与产物落地。
- 与 08-code-conventions：遵循单一职责、注释/文档、日志结构化、可回滚；不在导入期做重 IO/重计算。
- 与 数据流总览：不改动 `aligned_data` 等业务表；产物仅落 `models/`。

## 默认策略（全方法启用）
1) 启动方法池：多项式/样条/稳健/LOESS/SVR/有理。
2) 搜索轻量超参并并行训练；记录物理违例率与度量。
3) 先选“物理一致+RMSE 最优”的单模型；若集成（加权/堆叠）显著提升且无过拟合，再选择集成。
4) 产出版本化模型与报告；保留回滚路径；不写入数据库，仅供下游使用。

## 结果展示（合并自 84）
- 产物目录：`models/{station}/{device}/{curve}/{version}/`，包含 REPORT.md、metrics.json、fit.png、residuals.png、parity.png 等。
- 图表：轴含单位；统一风格；置信带 95%；残差分析与一致性图必备；区外预测用虚线提示。
- 表格：方法对比（Top-N）、物理约束报告、数据概览、元信息（station/device/curve/version/hash）。
- 发布：`latest` 软链接指向当前生效版本；索引文件汇总最新度量与路径。

