# 代码注释与文档注释规范（RULE）

版本：v1.1（与 08-code-conventions 对齐，Python 为主；删除安全相关条目）

## 目标与边界
- 目标：提升可读性、可维护性与可审计性，确保“为什么/约束/边界”被准确传达。
- 边界：不改变代码行为；注释与文档属同一变更的“必要产物”，受 PR 门禁与版本化管理。

## 总体原则（必须遵循）
- 注释写“为什么/约束/权衡/副作用/性能/安全边界”，不要复述代码“做了什么”。
- 面向读者：优先中文，专业名词可带英文括注；公式可用 LaTeX（行内/块）。
- 注释不得包含凭据/连接串/隐私数据。
- 与实现一致：代码改动必须同步更新注释；过时注释视为缺陷。

## 文档注释覆盖面（最低要求）
- 模块级（文件顶部）：必须。有职责说明、关键依赖、使用示例/典型调用路径、限制与边界。
- 公共类/函数/方法：必须。有清晰 docstring（Google 风格）。
- 内部/私有函数：建议。复杂逻辑/非直观边界必须写。
- 非平凡脚本/CLI 入口：必须说明参数语义、返回码、示例。

## Docstring 风格（Google 风格，Python）
- 三引号 """，首句不超过 ~72 字符；其后空行再展开描述。
- 段落顺序：简述 → Args → Returns → Raises → Notes → Examples。
- 统一类型注解由代码提供，docstring 中类型描述为可选补充。

示例（函数）
```
"""计算并分摊单泵流量（A→A0→B→C）。

依据站点总管瞬时流量与可用权重（压力/功率/频率），在门禁与尾差修正后，
为“运行泵”写入近似流量，保证幂等与不覆盖真实测量。

Args:
    station_id: 站点 ID。
    second_ts: 秒级标准时刻（UTC，无时区转换）。
    weights: 预计算的权重快照（按方法优先级）。

Returns:
    affected: 本秒成功写回的泵数量。

Raises:
    ValueError: 参数不合法或权重集合为空。
"""
```

示例（模块头）
```
"""
模块: curve_fit.hq
职责: 对 H–Q 曲线进行多方法拟合、评估与产物落地（只写 models/）。
依赖: numpy, scipy, sklearn；与 app/curve_fit/interfaces 对齐。
限制: 不写业务表，不在导入期做重 IO/重计算。
用法:
    fitter = HQFitter(config)
    artifact = fitter.fit(station_id, device_id, since, until)
    fitter.publish(artifact)
"""
```

## 何时写注释（判定清单）
- 含有“非直观选择/权衡”的地方（性能、准确性、幂等、锁/并发、重试策略）。
- 依赖外部约束（协议、方言、SQL 行为、时区/精度），或与上游/下游契合的假设。
- 容易误解/脆弱的代码（边界条件、溢出/精度损失、递归/惰性求值）。
- 复杂算法/数学公式/单位换算（给出公式来源与单位说明）。
- 兼容/降级/回滚路径（为什么这样做、何时删除）。

## 何时避免注释
- 复述显而易见的语句；
- 与命名/类型重复的信息（应改进命名与类型注解，而非加注释）；
- TODO 代替实现。若确需 TODO：使用 `TODO(user|issue): 说明，deadline`，并在 PR 描述中引用。

## 写法与位置
- Python：docstring 放在模块/类/函数定义内部首行；
- 代码块注释：置于代码上方一行（不写行尾注释）；短句、直达重点；
- 尽量避免内联注释；正则/SQL 建议给“语义说明与示例片段”。

## 必备内容（公共 API）
- 职责一句话 + 关键约束（参数关系、幂等、事务边界、重试语义）；
- 参数与返回：语义、单位、可空、默认、取值范围；
- 异常：明确抛出类型与触发条件；
- 副作用：写库/网络/文件；锁/并发影响；
- 示例：最小可运行调用（可省略真实路径/连接）。

## 质量门禁（PR 级）
- 新/改公共 API 未提供 docstring → 直接拦截；
- 模块无头部注释 → 拦截；
- 注释与实现不一致/过时 → 拦截；
- 含敏感信息 → 拦截并要求脱敏；
- 语言/格式：统一 Google 风格，允许 NumPy 风格但需保持一致。

## 工具与自动化
- ruff/pydocstyle：检查 docstring 存在性与基本规范；
- pre-commit：black/isort/ruff + docstring 规则；
- CI：对公开模块抽样生成文档索引（pdoc/mkdocs），发现缺漏。

## 与现有规则的关系
- 08-code-conventions：本规范细化“完整注释”要求与示例；
- 106-documentation-and-runbook-standards：文件/运行手册对应的文档标准；

## 验收清单（提交前）
- [ ] 模块/公共 API 是否有 docstring 且内容完整？
- [ ] 是否解释“为什么/约束/边界/副作用”？
- [ ] 是否提供单位、范围与异常？
- [ ] 是否避免复述代码/含敏感信息？
- [ ] 注释与实现是否一致？

